---
phase: 10-chat-bank-vault-scoping
plan: 03
type: verify
wave: 3
depends_on: [10-01, 10-02]
files_modified:
  - tests/integration/chat-vault-scoping.test.ts (NEW)
  - .planning/phases/10-chat-bank-vault-scoping/10-VERIFICATION.md (NEW)
autonomous: true

must_haves:
  truths:
    - "User in Bank A cannot see recordings from Bank B via chat"
    - "Vault-scoped chat only searches recordings in that vault"
    - "User without VaultMembership sees no vault content"
    - "Chat respects bank/vault context for all 14 RAG tools"
  artifacts:
    - path: "tests/integration/chat-vault-scoping.test.ts"
      provides: "Integration tests for multi-tenant chat isolation"
    - path: ".planning/phases/10-chat-bank-vault-scoping/10-VERIFICATION.md"
      provides: "Manual verification checklist and test results"
  key_links:
    - from: "chat-stream-v2"
      to: "vault_memberships"
      via: "hybrid_search_transcripts_scoped"
      pattern: "user can only see content in vaults they have membership to"
---

<objective>
Verify multi-tenant isolation is working correctly for chat searches across banks and vaults.

Purpose: Ensure security and data isolation is properly enforced.
Output: Documented verification that chat respects bank/vault boundaries.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-chat-bank-vault-scoping/10-CONTEXT.md
</context>

<tasks>

<task type="manual">
  <name>Task 1: Create test scenario with multi-bank, multi-vault data</name>
  <files>
    Local database
  </files>
  <action>
Set up test data in local Supabase:

1. Create two banks:
   - Bank A: "Test Company Alpha"
   - Bank B: "Test Company Beta"

2. Create vaults in each bank:
   - Bank A, Vault 1: "Sales Calls" (vault_type: 'private')
   - Bank A, Vault 2: "Support Calls" (vault_type: 'private')
   - Bank B, Vault 3: "Demo Calls" (vault_type: 'private')

3. Create test user memberships:
   - User 1: BankMembership in Bank A + VaultMembership in Vault 1 only
   - User 1: BankMembership in Bank B + VaultMembership in Vault 3
   - User 2: BankMembership in Bank A + VaultMembership in Vault 1 AND Vault 2

4. Add sample recordings and vault_entries:
   - Recording R1 in Bank A, VaultEntry in Vault 1 (Sales)
   - Recording R2 in Bank A, VaultEntry in Vault 2 (Support)
   - Recording R3 in Bank B, VaultEntry in Vault 3 (Demo)

5. Ensure fathom_transcripts exist for each recording (for search to work)

SQL script to create test data:
```sql
-- Run this in Supabase SQL editor for local testing
-- (Replace UUIDs with actual values from your test environment)

-- Banks (if not already created)
INSERT INTO banks (id, name, owner_user_id) VALUES 
  ('bank-a-uuid', 'Test Company Alpha', 'test-user-1-uuid'),
  ('bank-b-uuid', 'Test Company Beta', 'test-user-1-uuid');

-- Vaults
INSERT INTO vaults (id, bank_id, name, vault_type) VALUES
  ('vault-1-uuid', 'bank-a-uuid', 'Sales Calls', 'private'),
  ('vault-2-uuid', 'bank-a-uuid', 'Support Calls', 'private'),
  ('vault-3-uuid', 'bank-b-uuid', 'Demo Calls', 'private');

-- Bank Memberships
INSERT INTO bank_memberships (bank_id, user_id, role) VALUES
  ('bank-a-uuid', 'test-user-1-uuid', 'owner'),
  ('bank-b-uuid', 'test-user-1-uuid', 'admin'),
  ('bank-a-uuid', 'test-user-2-uuid', 'member');

-- Vault Memberships
INSERT INTO vault_memberships (vault_id, user_id, role) VALUES
  ('vault-1-uuid', 'test-user-1-uuid', 'owner'),
  ('vault-3-uuid', 'test-user-1-uuid', 'owner'),
  ('vault-1-uuid', 'test-user-2-uuid', 'member'),
  ('vault-2-uuid', 'test-user-2-uuid', 'member');

-- Recordings (with legacy_recording_id for transcript linking)
INSERT INTO recordings (id, bank_id, owner_user_id, title, legacy_recording_id) VALUES
  ('rec-1-uuid', 'bank-a-uuid', 'test-user-1-uuid', 'Sales Call with Acme', 12345),
  ('rec-2-uuid', 'bank-a-uuid', 'test-user-1-uuid', 'Support Ticket Review', 12346),
  ('rec-3-uuid', 'bank-b-uuid', 'test-user-1-uuid', 'Product Demo for Client', 12347);

-- Vault Entries
INSERT INTO vault_entries (vault_id, recording_id) VALUES
  ('vault-1-uuid', 'rec-1-uuid'),
  ('vault-2-uuid', 'rec-2-uuid'),
  ('vault-3-uuid', 'rec-3-uuid');
```
  </action>
  <verify>
- All test data created successfully
- Can query vault_memberships and see correct assignments
- Recordings exist with vault_entries linking them to vaults
  </verify>
  <done>
- Multi-bank, multi-vault test scenario set up
- User memberships configured for isolation testing
- Sample recordings and vault_entries created
  </done>
</task>

<task type="manual">
  <name>Task 2: Test vault-scoped chat isolation</name>
  <files>
    Browser (localhost:8080)
  </files>
  <action>
Test User 1 (has Vault 1 in Bank A, Vault 3 in Bank B):

1. Log in as User 1
2. Select Bank A (context should auto-select first vault or show bank-level)
3. Select Vault 1 (Sales Calls)
4. In chat, ask: "What was discussed in the Acme call?"
   - Expected: Results from R1 (Sales Call with Acme) ONLY
   - NOT expected: Results from R2 (Support Ticket) or R3 (Demo)

5. Ask: "Show me all support tickets"
   - Expected: No results (User 1 doesn't have Vault 2 membership)

6. Switch to bank-level view (no vault selected in Bank A)
7. Ask: "What calls do I have?"
   - Expected: ONLY R1 (Sales) - because that's the only vault User 1 has access to in Bank A

8. Switch to Bank B
9. Select Vault 3 (Demo Calls)
10. Ask: "Tell me about the product demo"
    - Expected: Results from R3 (Product Demo) ONLY
    - NOT expected: Any results from Bank A

Test User 2 (has Vault 1 AND Vault 2 in Bank A):

11. Log in as User 2
12. Select Bank A
13. Select bank-level view (no vault selected)
14. Ask: "What calls do I have?"
    - Expected: Both R1 (Sales) AND R2 (Support)

15. Select Vault 2 (Support Calls) only
16. Ask: "What calls do I have?"
    - Expected: ONLY R2 (Support)
  </action>
  <verify>
- Vault-scoped chat returns only content from selected vault
- Bank-level chat returns content from all vaults user has membership in
- User cannot see content from vaults they don't have membership to
- Cross-bank isolation is enforced (Bank A user can't see Bank B data)
  </verify>
  <done>
- Vault isolation verified for User 1
- Bank-level aggregation verified for User 2
- Cross-bank isolation verified
  </done>
</task>

<task type="manual">
  <name>Task 3: Test edge cases and error handling</name>
  <files>
    Browser (localhost:8080)
  </files>
  <action>
1. Test no vault membership:
   - Create User 3 with BankMembership to Bank A but NO VaultMemberships
   - Log in as User 3
   - Try to chat in Bank A
   - Expected: Chat returns no results (graceful empty state)

2. Test vault scope indicator in UI:
   - Select a specific vault
   - Verify chat header shows which vault is selected (filter chip pattern)
   - Verify results include vault attribution badge

3. Test out-of-scope query response:
   - As User 1 in Vault 1, ask about content that's in Vault 2
   - Expected: "No results found" - NO hints about other vaults

4. Test folder filter within vault:
   - If folders exist within Vault 1, apply folder filter
   - Verify search is scoped to folder WITHIN the vault
   - Confirm folder filter doesn't break vault scoping

5. Test context switching:
   - Start chat in Vault 1
   - Switch to Vault 2
   - Expected: Chat clears (new context = new conversation)
   - Previous conversation should not leak vault context
  </action>
  <verify>
- User without VaultMembership sees empty results
- Vault scope indicator visible in chat header
- Out-of-scope queries return "not found" without hints
- Folder filters work within vault scope
- Context switching clears chat appropriately
  </verify>
  <done>
- Edge cases handled gracefully
- No information leakage between vaults
- UI correctly reflects vault scope
  </done>
</task>

<task type="auto">
  <name>Task 4: Document verification results</name>
  <files>
    .planning/phases/10-chat-bank-vault-scoping/10-VERIFICATION.md
  </files>
  <action>
Create verification document with test results:

```markdown
# Phase 10: Chat Bank/Vault Scoping - Verification

**Verified:** [DATE]
**Verified By:** Claude
**Status:** [PASS/FAIL]

## Test Environment
- Supabase URL: localhost:54321
- Frontend URL: localhost:8080
- Test Users: User 1, User 2, User 3

## Test Scenarios

### 1. Vault-Scoped Chat Isolation
| Test Case | Expected | Actual | Status |
|-----------|----------|--------|--------|
| User 1 in Vault 1 asks about Vault 1 content | Results from R1 only | [result] | [PASS/FAIL] |
| User 1 in Vault 1 asks about Vault 2 content | No results | [result] | [PASS/FAIL] |
| User 1 in Vault 3 (Bank B) asks about Bank A content | No results | [result] | [PASS/FAIL] |

### 2. Bank-Level Chat Aggregation
| Test Case | Expected | Actual | Status |
|-----------|----------|--------|--------|
| User 1 bank-level Bank A | Only Vault 1 content (R1) | [result] | [PASS/FAIL] |
| User 2 bank-level Bank A | Vault 1 + Vault 2 content (R1, R2) | [result] | [PASS/FAIL] |

### 3. Edge Cases
| Test Case | Expected | Actual | Status |
|-----------|----------|--------|--------|
| User with no VaultMembership | Empty results | [result] | [PASS/FAIL] |
| Out-of-scope query | "Not found" no hints | [result] | [PASS/FAIL] |
| Context switch (vault change) | Chat clears | [result] | [PASS/FAIL] |

## Success Criteria Verification
- [ ] GAP-INT-01: Chat backend respects bank/vault context
- [ ] Frontend sends bank_id/vault_id in chat request body
- [ ] chat-stream-v2 filters searches to active bank/vault only
- [ ] User in Bank A cannot see recordings from Bank B via chat
- [ ] Vault-scoped chat only searches recordings in that vault

## Notes
[Any observations or issues found]

## Conclusion
Phase 10 verification [COMPLETE/INCOMPLETE].
All success criteria [MET/NOT MET].
```
  </action>
  <verify>
- Verification document created
- All test results documented
- Success criteria checklist completed
  </verify>
  <done>
- Phase 10 verification documentation complete
- All scenarios tested and results recorded
- GAP-INT-01 closure verified
  </done>
</task>

</tasks>

<success_criteria>
1. User in Bank A cannot see recordings from Bank B via chat
2. Vault-scoped chat only searches recordings in that vault
3. User without VaultMembership sees no vault content
4. Bank-level chat shows union of accessible vaults only
5. No information leakage about inaccessible vaults
6. Context switching clears chat appropriately
7. GAP-INT-01 verified as closed
</success_criteria>

<verification>
All test cases documented in 10-VERIFICATION.md with PASS status.
Phase 10 complete when all success criteria verified.
</verification>
