---
phase: 10-chat-bank-vault-scoping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/chat-stream-v2/index.ts
  - src/pages/Chat.tsx
autonomous: true

must_haves:
  truths:
    - "chat-stream-v2 parses bank_id and vault_id from request body"
    - "Frontend sends bank_id and vault_id in sessionFilters object"
    - "Backend logs bank/vault context for debugging"
  artifacts:
    - path: "supabase/functions/chat-stream-v2/index.ts"
      provides: "RequestBody type includes bank_id/vault_id, parsed and logged"
    - path: "src/pages/Chat.tsx"
      provides: "sessionFilters sent in transport body (already implemented)"
  key_links:
    - from: "src/pages/Chat.tsx"
      to: "chat-stream-v2"
      via: "HTTP body"
      pattern: "sessionFilters.bank_id, sessionFilters.vault_id"
---

<objective>
Update chat-stream-v2 to receive and parse bank_id/vault_id from the frontend request body.

Purpose: Enable the backend to know which bank/vault context to use for search scoping.
Output: Backend receives bank/vault context and logs it; no search filtering yet (that's plan 02).
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-chat-bank-vault-scoping/10-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update RequestBody type to include bank_id/vault_id</name>
  <files>
    supabase/functions/chat-stream-v2/index.ts
  </files>
  <action>
1. Update the `RequestBody` interface to include:
```typescript
interface RequestBody {
  messages: Array<{...}>;
  model?: string;
  filters?: {...};
  sessionId?: string;
  // NEW: Bank/Vault context for multi-tenant scoping
  sessionFilters?: {
    bank_id?: string;
    vault_id?: string | null;  // null = all vaults in bank
  };
}
```

2. Add type for bank/vault context:
```typescript
interface BankVaultContext {
  bank_id?: string;
  vault_id?: string | null;
}
```
  </action>
  <verify>
- TypeScript compiles without errors
- RequestBody interface includes sessionFilters
  </verify>
  <done>
- RequestBody type updated to include bank/vault context
- BankVaultContext interface added
  </done>
</task>

<task type="auto">
  <name>Task 2: Parse bank_id/vault_id from request body in handler</name>
  <files>
    supabase/functions/chat-stream-v2/index.ts
  </files>
  <action>
1. In the main handler after parsing the request body, extract bank/vault context:
```typescript
const { messages, model: requestedModel, filters: requestFilters, sessionId, sessionFilters: bankVaultContext } = body;

const bankId = bankVaultContext?.bank_id;
const vaultId = bankVaultContext?.vault_id; // null means "all vaults in bank"
```

2. Add logging to confirm receipt:
```typescript
console.log(`[chat-stream-v2] User: ${user.id}, Bank: ${bankId || 'none'}, Vault: ${vaultId || 'all'}, Model: ${selectedModel}`);
```

3. Pass bank/vault context to createTools function signature (for use in plan 02):
```typescript
const allTools = createTools(supabase, user.id, openaiApiKey, hfApiKey, sessionFilters, bankId, vaultId);
```

4. Update createTools function signature to accept bank/vault context:
```typescript
function createTools(
  supabase: SupabaseClient,
  userId: string,
  openaiApiKey: string,
  hfApiKey: string,
  sessionFilters?: SessionFilters,
  bankId?: string,
  vaultId?: string | null,
) {
  // Store context for later use (plan 02 will add filtering)
  console.log(`[chat-stream-v2] Tools context - Bank: ${bankId || 'none'}, Vault: ${vaultId || 'all'}`);
  // ... existing tool definitions
}
```
  </action>
  <verify>
- Handler extracts bankId and vaultId from body
- Console logs show bank/vault context
- createTools receives bank/vault parameters
- Application compiles and runs without errors
  </verify>
  <done>
- Bank/vault context parsed from request body
- Context passed to createTools function
- Logging confirms receipt of bank/vault context
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify frontend is sending bank_id/vault_id correctly</name>
  <files>
    src/pages/Chat.tsx
  </files>
  <action>
1. Verify the existing implementation in Chat.tsx (lines 205-208) is correct:
```typescript
sessionFilters: {
  bank_id: activeBankId,
  vault_id: activeVaultId, // null = all vaults in bank
},
```

2. Confirm activeBankId and activeVaultId come from useBankContext hook

3. NO CHANGES NEEDED if already implemented correctly - just verify and document

4. If any adjustments needed, ensure the body structure matches what chat-stream-v2 expects
  </action>
  <verify>
- Chat.tsx sends sessionFilters with bank_id and vault_id
- useBankContext hook provides activeBankId and activeVaultId
- Network inspector shows bank_id/vault_id in request payload
  </verify>
  <done>
- Frontend confirmed sending bank/vault context
- Transport body includes sessionFilters with bank_id/vault_id
  </done>
</task>

</tasks>

<success_criteria>
1. chat-stream-v2 RequestBody type includes sessionFilters.bank_id and sessionFilters.vault_id
2. Handler extracts and logs bank/vault context
3. createTools function receives bank/vault parameters (ready for plan 02)
4. Frontend sends bank_id and vault_id in request body
5. Console logs confirm bank/vault context is received
</success_criteria>

<verification>
1. Start dev server and send a chat message
2. Check Edge Function logs for bank/vault context logging
3. Confirm no TypeScript errors in chat-stream-v2
4. Verify network request includes sessionFilters in body
</verification>
