---
phase: 09-bank-vault-architecture
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260131000003_create_vaults_tables.sql
autonomous: true

must_haves:
  truths:
    - "vaults table exists with bank_id, name, vault_type, and settings"
    - "vault_memberships table exists with user-vault relationship and role"
    - "RLS policies enforce vault isolation within banks"
  artifacts:
    - path: "supabase/migrations/20260131000003_create_vaults_tables.sql"
      provides: "Vaults and VaultMemberships tables with RLS"
      contains: "CREATE TABLE vaults"
  key_links:
    - from: "vaults"
      to: "banks"
      via: "FK bank_id"
      pattern: "REFERENCES banks\\(id\\)"
    - from: "vault_memberships"
      to: "vaults"
      via: "FK vault_id"
      pattern: "REFERENCES vaults\\(id\\)"
---

<objective>
Create the vaults and vault_memberships tables with proper constraints and RLS policies. Vaults are collaboration containers within banks where sharing and work happens.

Purpose: Vaults enable team/coach/community use cases within the bank boundary. Each vault has its own membership and visibility controls.
Output: Two tables (vaults, vault_memberships) with complete RLS policies.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-bank-vault-architecture/09-CONTEXT.md
@.planning/phases/09-bank-vault-architecture/09-RESEARCH.md
@docs/planning/CallVault-Final-Spaces.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vaults table with vault types</name>
  <files>supabase/migrations/20260131000003_create_vaults_tables.sql</files>
  <action>
Create migration file with the vaults table:

```sql
-- Vaults: Collaboration containers within a bank
-- Types: personal, team, coach, community, client (only personal+team fully implemented in Phase 9)
CREATE TABLE IF NOT EXISTS vaults (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bank_id UUID NOT NULL REFERENCES banks(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  vault_type TEXT NOT NULL CHECK (vault_type IN ('personal', 'team', 'coach', 'community', 'client')),
  default_sharelink_ttl_days INTEGER DEFAULT 7,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes for vaults
CREATE INDEX IF NOT EXISTS idx_vaults_bank_id ON vaults(bank_id);
CREATE INDEX IF NOT EXISTS idx_vaults_vault_type ON vaults(vault_type);

-- Updated_at trigger for vaults
CREATE OR REPLACE FUNCTION update_vaults_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS vaults_updated_at ON vaults;
CREATE TRIGGER vaults_updated_at
  BEFORE UPDATE ON vaults
  FOR EACH ROW
  EXECUTE FUNCTION update_vaults_updated_at();

-- Enable RLS on vaults
ALTER TABLE vaults ENABLE ROW LEVEL SECURITY;
```

Key design decisions:
- vault_type enum includes all types, but only 'personal' and 'team' have special behavior in Phase 9
- default_sharelink_ttl_days = 7 per spec
- Cascade delete: if bank is deleted, all vaults are deleted
  </action>
  <verify>
- Migration file exists
- SQL syntax is valid
  </verify>
  <done>
- vaults table definition complete with vault_type enum
- Indexes and triggers defined
- RLS enabled
  </done>
</task>

<task type="auto">
  <name>Task 2: Create vault_memberships table and RLS policies</name>
  <files>supabase/migrations/20260131000003_create_vaults_tables.sql</files>
  <action>
Append to the same migration file:

```sql
-- VaultMembership: Links users to vaults with roles
-- Role hierarchy: vault_owner > vault_admin > manager > member > guest
CREATE TABLE IF NOT EXISTS vault_memberships (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vault_id UUID NOT NULL REFERENCES vaults(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('vault_owner', 'vault_admin', 'manager', 'member', 'guest')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(vault_id, user_id)
);

-- Indexes for vault_memberships
CREATE INDEX IF NOT EXISTS idx_vault_memberships_vault_id ON vault_memberships(vault_id);
CREATE INDEX IF NOT EXISTS idx_vault_memberships_user_id ON vault_memberships(user_id);
CREATE INDEX IF NOT EXISTS idx_vault_memberships_role ON vault_memberships(role);

-- Enable RLS on vault_memberships
ALTER TABLE vault_memberships ENABLE ROW LEVEL SECURITY;

-- SECURITY DEFINER helper to check vault membership (prevents RLS recursion)
CREATE OR REPLACE FUNCTION is_vault_member(p_vault_id UUID, p_user_id UUID)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM vault_memberships
    WHERE vault_id = p_vault_id AND user_id = p_user_id
  )
$$;

-- SECURITY DEFINER helper to check vault admin/owner
CREATE OR REPLACE FUNCTION is_vault_admin_or_owner(p_vault_id UUID, p_user_id UUID)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM vault_memberships
    WHERE vault_id = p_vault_id 
      AND user_id = p_user_id
      AND role IN ('vault_owner', 'vault_admin')
  )
$$;

-- SECURITY DEFINER helper to get vault's bank_id
CREATE OR REPLACE FUNCTION get_vault_bank_id(p_vault_id UUID)
RETURNS UUID
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT bank_id FROM vaults WHERE id = p_vault_id
$$;

-- RLS Policies for vaults
-- Users can see vaults they're a member of
CREATE POLICY "Users can view vaults they belong to"
  ON vaults FOR SELECT
  USING (is_vault_member(id, auth.uid()));

-- Bank admins/owners can also see all vaults in their banks
CREATE POLICY "Bank admins can view all bank vaults"
  ON vaults FOR SELECT
  USING (is_bank_admin_or_owner(bank_id, auth.uid()));

-- Vault owners/admins can update vault settings
CREATE POLICY "Vault owners/admins can update vaults"
  ON vaults FOR UPDATE
  USING (is_vault_admin_or_owner(id, auth.uid()));

-- Bank members can create vaults in banks they belong to
CREATE POLICY "Bank members can create vaults"
  ON vaults FOR INSERT
  WITH CHECK (is_bank_member(bank_id, auth.uid()));

-- Vault owners can delete vaults
CREATE POLICY "Vault owners can delete vaults"
  ON vaults FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM vault_memberships
      WHERE vault_memberships.vault_id = vaults.id
        AND vault_memberships.user_id = auth.uid()
        AND vault_memberships.role = 'vault_owner'
    )
  );

-- RLS Policies for vault_memberships
-- Users can view memberships in their vaults
CREATE POLICY "Users can view vault memberships"
  ON vault_memberships FOR SELECT
  USING (is_vault_member(vault_id, auth.uid()));

-- Bank admins can see all vault memberships in their banks
CREATE POLICY "Bank admins can view all vault memberships"
  ON vault_memberships FOR SELECT
  USING (
    is_bank_admin_or_owner(get_vault_bank_id(vault_id), auth.uid())
  );

-- Vault admins/owners can manage memberships
CREATE POLICY "Vault admins can insert memberships"
  ON vault_memberships FOR INSERT
  WITH CHECK (is_vault_admin_or_owner(vault_id, auth.uid()));

-- Users can create their own membership when creating vault
CREATE POLICY "Users can create own vault membership"
  ON vault_memberships FOR INSERT
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Vault admins can update memberships"
  ON vault_memberships FOR UPDATE
  USING (is_vault_admin_or_owner(vault_id, auth.uid()));

CREATE POLICY "Vault admins can remove members"
  ON vault_memberships FOR DELETE
  USING (is_vault_admin_or_owner(vault_id, auth.uid()));
```

Key patterns:
- Bank admins can see all vaults/memberships in their banks (oversight)
- Vault admins/owners manage vault contents
- Members can only view, not modify vault settings
- Guest role is most restricted (view only specific shared items)
  </action>
  <verify>
- Run `supabase db push` to apply migration
- Query `SELECT * FROM pg_policies WHERE tablename IN ('vaults', 'vault_memberships')` shows 10+ policies
- Test: Create vault in bank, verify membership created
  </verify>
  <done>
- vault_memberships table complete with role hierarchy
- All indexes created
- SECURITY DEFINER helpers for vault access checks
- All RLS policies applied
- Migration runs without errors
  </done>
</task>

</tasks>

<verification>
1. `supabase db push` succeeds
2. Both tables exist: `SELECT tablename FROM pg_tables WHERE tablename IN ('vaults', 'vault_memberships')`
3. RLS is enabled on both tables
4. Helper functions exist: `is_vault_member`, `is_vault_admin_or_owner`, `get_vault_bank_id`
5. Policies enforce vault isolation within bank boundaries
</verification>

<success_criteria>
- vaults table with vault_type enum and bank relationship
- vault_memberships table with 5-level role hierarchy
- SECURITY DEFINER helpers prevent RLS recursion
- RLS policies enforce vault isolation
- Bank admins can see all vaults in their banks
- Migration applies cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/09-bank-vault-architecture/09-03-SUMMARY.md`
</output>
