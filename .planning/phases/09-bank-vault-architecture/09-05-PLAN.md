---
phase: 09-bank-vault-architecture
plan: 05
type: execute
wave: 2
depends_on: ["09-02", "09-03", "09-04"]
files_modified:
  - supabase/migrations/20260131000005_update_signup_trigger.sql
  - supabase/migrations/20260131000006_drop_old_team_tables.sql
  - supabase/migrations/20260131000007_update_folders_for_vaults.sql
autonomous: true

must_haves:
  truths:
    - "New users automatically get a personal bank on signup"
    - "New users automatically get a personal vault in their bank"
    - "Old team tables are dropped (teams, team_memberships, team_shares, manager_notes)"
    - "Folders table has vault_id column for vault-level organization"
  artifacts:
    - path: "supabase/migrations/20260131000005_update_signup_trigger.sql"
      provides: "Updated handle_new_user() trigger"
      contains: "INSERT INTO banks"
    - path: "supabase/migrations/20260131000006_drop_old_team_tables.sql"
      provides: "Drop legacy team tables"
      contains: "DROP TABLE"
  key_links:
    - from: "handle_new_user()"
      to: "banks"
      via: "INSERT trigger"
      pattern: "INSERT INTO banks.*personal"
    - from: "folders"
      to: "vaults"
      via: "vault_id FK"
      pattern: "REFERENCES vaults\\(id\\)"
---

<objective>
Update the signup trigger to auto-create personal bank and vault for new users. Drop old team tables that are being replaced by the Bank/Vault model. Update folders table for vault-level organization.

Purpose: Complete the transition from teams to Bank/Vault by ensuring new users get proper defaults and cleaning up legacy tables.
Output: Working signup flow with personal bank/vault creation, legacy team tables removed, folders wired to vaults.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-bank-vault-architecture/09-CONTEXT.md
@.planning/phases/09-bank-vault-architecture/09-RESEARCH.md
@docs/planning/CallVault-Final-Spaces.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update signup trigger for personal bank/vault creation</name>
  <files>supabase/migrations/20260131000005_update_signup_trigger.sql</files>
  <action>
Create migration to update the handle_new_user() function:

```sql
-- Update handle_new_user() to create personal bank and vault
-- Per CONTEXT.md: Personal Bank auto-created for every new user at signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_bank_id UUID;
  v_vault_id UUID;
BEGIN
  -- Create user profile (existing logic)
  INSERT INTO public.user_profiles (user_id, email, display_name, onboarding_completed)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'display_name', NEW.email),
    false
  );
  
  -- Assign default FREE role (existing logic)
  INSERT INTO public.user_roles (user_id, role)
  VALUES (NEW.id, 'FREE')
  ON CONFLICT (user_id, role) DO NOTHING;
  
  -- Create personal bank for new user
  INSERT INTO banks (name, type)
  VALUES ('Personal', 'personal')
  RETURNING id INTO v_bank_id;
  
  -- Create bank membership as owner
  INSERT INTO bank_memberships (bank_id, user_id, role)
  VALUES (v_bank_id, NEW.id, 'bank_owner');
  
  -- Create default personal vault (named "My Calls" per CONTEXT.md)
  INSERT INTO vaults (bank_id, name, vault_type)
  VALUES (v_bank_id, 'My Calls', 'personal')
  RETURNING id INTO v_vault_id;
  
  -- Create vault membership as owner
  INSERT INTO vault_memberships (vault_id, user_id, role)
  VALUES (v_vault_id, NEW.id, 'vault_owner');
  
  RETURN NEW;
END;
$$;

-- Note: The trigger on auth.users already exists from consolidated schema
-- This just updates the function definition
```

Key behaviors:
- Personal bank named "Personal" with type='personal'
- User is bank_owner of their personal bank
- Personal vault named "My Calls" with vault_type='personal'
- User is vault_owner of their personal vault
  </action>
  <verify>
- Migration applies without errors
- Test: Create new user via auth, verify bank and vault created
- Query: `SELECT COUNT(*) FROM banks WHERE type = 'personal'` matches user count
  </verify>
  <done>
- handle_new_user() updated with bank/vault creation
- New users get Personal bank + My Calls vault automatically
- User becomes owner of both
  </done>
</task>

<task type="auto">
  <name>Task 2: Drop old team tables and update folders</name>
  <files>
    supabase/migrations/20260131000006_drop_old_team_tables.sql
    supabase/migrations/20260131000007_update_folders_for_vaults.sql
  </files>
  <action>
Create migration to drop old team tables:

```sql
-- 20260131000006_drop_old_team_tables.sql
-- Drop legacy team tables - no production data per CONTEXT.md
-- These are replaced by the Bank/Vault model

-- First drop dependent views/functions if any
DROP FUNCTION IF EXISTS get_team_members CASCADE;
DROP FUNCTION IF EXISTS check_team_membership CASCADE;

-- Drop tables in correct order (foreign key dependencies)
DROP TABLE IF EXISTS manager_notes CASCADE;
DROP TABLE IF EXISTS team_shares CASCADE;
DROP TABLE IF EXISTS team_memberships CASCADE;
DROP TABLE IF EXISTS teams CASCADE;
```

Create migration to update folders table:

```sql
-- 20260131000007_update_folders_for_vaults.sql
-- Add vault_id to folders for vault-level organization
-- Add visibility column for folder access control

-- Add vault_id column (nullable initially for existing data)
ALTER TABLE folders ADD COLUMN IF NOT EXISTS vault_id UUID REFERENCES vaults(id) ON DELETE CASCADE;

-- Add visibility column for folder access control
ALTER TABLE folders ADD COLUMN IF NOT EXISTS visibility TEXT DEFAULT 'all_members' 
  CHECK (visibility IN ('all_members', 'managers_only', 'owner_only'));

-- Create index for vault_id
CREATE INDEX IF NOT EXISTS idx_folders_vault_id ON folders(vault_id);

-- Update RLS policy to include vault membership check
-- Drop existing policies first
DROP POLICY IF EXISTS "Users can view their own folders" ON folders;
DROP POLICY IF EXISTS "Users can create their own folders" ON folders;
DROP POLICY IF EXISTS "Users can update their own folders" ON folders;
DROP POLICY IF EXISTS "Users can delete their own folders" ON folders;

-- New policy: Users can view folders in vaults they belong to OR their own folders
CREATE POLICY "Users can view folders"
  ON folders FOR SELECT
  USING (
    user_id = auth.uid()
    OR (vault_id IS NOT NULL AND is_vault_member(vault_id, auth.uid()))
  );

-- Users can create folders (either personal or in vaults they're manager+ in)
CREATE POLICY "Users can create folders"
  ON folders FOR INSERT
  WITH CHECK (
    user_id = auth.uid()
    AND (
      vault_id IS NULL
      OR EXISTS (
        SELECT 1 FROM vault_memberships
        WHERE vault_memberships.vault_id = folders.vault_id
          AND vault_memberships.user_id = auth.uid()
          AND vault_memberships.role IN ('vault_owner', 'vault_admin', 'manager')
      )
    )
  );

-- Users can update their own folders OR vault folders they have manager+ role
CREATE POLICY "Users can update folders"
  ON folders FOR UPDATE
  USING (
    user_id = auth.uid()
    OR (vault_id IS NOT NULL AND is_vault_admin_or_owner(vault_id, auth.uid()))
  );

-- Users can delete their own folders OR vault folders they have admin+ role
CREATE POLICY "Users can delete folders"
  ON folders FOR DELETE
  USING (
    user_id = auth.uid()
    OR (vault_id IS NOT NULL AND is_vault_admin_or_owner(vault_id, auth.uid()))
  );
```

Key changes:
- Old team tables completely removed
- folders.vault_id enables vault-level folder organization
- folders.visibility controls who can see folder contents
- RLS updated for vault membership checks
  </action>
  <verify>
- Migrations apply without errors
- Query `SELECT tablename FROM pg_tables WHERE tablename LIKE 'team%'` returns empty
- Query `SELECT column_name FROM information_schema.columns WHERE table_name = 'folders' AND column_name IN ('vault_id', 'visibility')` returns 2 rows
  </verify>
  <done>
- teams, team_memberships, team_shares, manager_notes dropped
- folders.vault_id added for vault organization
- folders.visibility added for access control
- RLS policies updated for vault membership
  </done>
</task>

</tasks>

<verification>
1. All migrations apply: `supabase db push`
2. No team tables exist
3. New user signup creates bank + vault
4. folders table has vault_id and visibility columns
5. Folder RLS works with vault membership
</verification>

<success_criteria>
- handle_new_user() creates personal bank and vault
- Old team tables completely removed
- folders.vault_id column exists with FK to vaults
- folders.visibility column exists for access control
- All RLS policies updated for new model
</success_criteria>

<output>
After completion, create `.planning/phases/09-bank-vault-architecture/09-05-SUMMARY.md`
</output>
