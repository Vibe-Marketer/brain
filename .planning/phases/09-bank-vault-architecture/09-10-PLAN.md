---
phase: 09-bank-vault-architecture
plan: 10
type: execute
wave: 3
depends_on: ["09-06", "09-07", "09-08", "09-09"]
files_modified:
  - src/stores/teamContextStore.ts
  - src/components/library/SyncTab.tsx
  - src/components/chat/Chat.tsx
  - src/pages/DashboardPage.tsx
autonomous: true

must_haves:
  truths:
    - "SyncTab queries data filtered by active bank context"
    - "Chat filters recordings by active vault context"
    - "Old teamContextStore references cleaned up"
  artifacts:
    - path: "src/stores/teamContextStore.ts"
      provides: "Deprecated with migration note pointing to bankContextStore"
      contains: "DEPRECATED"
  key_links:
    - from: "SyncTab"
      to: "useBankContext"
      via: "hook import"
      pattern: "useBankContext"
    - from: "Chat"
      to: "useBankContext"
      via: "recording filtering"
      pattern: "activeBankId|activeVaultId"
    - from: "Chat"
      to: "chat-stream API"
      via: "sessionFilters with bank_id/vault_id"
      pattern: "bank_id.*vault_id"
---

<objective>
Wire existing pages to use the new bank/vault context. Update data queries to filter by bank_id and vault_id. Deprecate old teamContextStore.

Purpose: Complete the transition from team-based to bank/vault-based data access. All queries should respect the new context boundaries.
Output: Pages use new context, queries filter correctly, old store deprecated.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-bank-vault-architecture/09-CONTEXT.md
@.planning/phases/09-bank-vault-architecture/09-07-SUMMARY.md
@.planning/phases/09-bank-vault-architecture/09-08-SUMMARY.md
@src/stores/teamContextStore.ts
@src/components/library/SyncTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deprecate teamContextStore and update SyncTab</name>
  <files>
    src/stores/teamContextStore.ts
    src/components/library/SyncTab.tsx
  </files>
  <action>
1. Mark teamContextStore as deprecated:

```typescript
// src/stores/teamContextStore.ts
/**
 * @deprecated Use bankContextStore instead. This store is retained for
 * backward compatibility during Phase 9 migration.
 * 
 * Migration guide:
 * - import { useBankContextStore } from '@/stores/bankContextStore'
 * - activeTeamId → activeBankId (for bank context)
 * - null activeTeamId → personal bank (auto-selected)
 * - Team vaults → use activeVaultId for vault context
 * 
 * TODO: Remove after Phase 9 verification
 */

// Keep existing implementation unchanged to avoid breaking
// pages that haven't been migrated yet
```

2. Update SyncTab to use bank context:

- Replace `useTeamContext` with `useBankContext`
- Filter data by `activeBankId` instead of `activeTeamId`
- Update queries to use new `recordings` table (for migrated data)
- Fall back to `fathom_calls` during migration window

Key changes to SyncTab:

```tsx
// Replace team context
import { useBankContext } from '@/hooks/useBankContext'

// In component:
const { activeBankId, isLoading: contextLoading } = useBankContext()

// Update query to use bank context
// If recordings table has data, use it
// Otherwise fall back to fathom_calls
const { data: calls } = useQuery({
  queryKey: ['calls', activeBankId, userId],
  queryFn: async () => {
    // Check if migration is complete (recordings has data)
    const { count: recordingsCount } = await supabase
      .from('recordings')
      .select('*', { count: 'exact', head: true })
      .eq('bank_id', activeBankId)
    
    if (recordingsCount && recordingsCount > 0) {
      // Use new recordings table
      const { data, error } = await supabase
        .from('recordings')
        .select('*')
        .eq('bank_id', activeBankId)
        .order('created_at', { ascending: false })
      
      if (error) throw error
      return data
    } else {
      // Fall back to fathom_calls during migration
      const { data, error } = await supabase
        .from('fathom_calls')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
      
      if (error) throw error
      return data
    }
  },
  enabled: !!activeBankId && !!userId,
})
```
  </action>
  <verify>
- teamContextStore has deprecation comment
- SyncTab imports useBankContext
- Queries filter by activeBankId
- Fallback to fathom_calls works during migration
  </verify>
  <done>
- teamContextStore marked deprecated
- SyncTab uses bank context
- Data filtering by bank works
- Migration fallback implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Chat and other pages for vault context</name>
  <files>
    src/components/chat/Chat.tsx
    src/pages/DashboardPage.tsx
  </files>
  <action>
1. Update Chat.tsx to use vault context for scoping:

- Import `useBankContext`
- Get `activeVaultId` for vault-scoped searches
- Pass vault context to chat-stream API calls
- When vault is selected, only search recordings in that vault

```tsx
// In Chat.tsx
import { useBankContext } from '@/hooks/useBankContext'

// In component:
const { activeBankId, activeVaultId, activeVault } = useBankContext()

// Pass to API calls
// Note: chat-stream Edge Function already accepts filters param (see supabase/functions/chat-stream)
// This wiring passes the new bank/vault context through existing filter mechanism
const response = await fetch('/api/chat-stream', {
  body: JSON.stringify({
    messages,
    sessionFilters: {
      bank_id: activeBankId,
      vault_id: activeVaultId, // null = all vaults in bank
    },
  }),
})
```

2. Update DashboardPage.tsx:

- Show bank context in dashboard header
- Filter analytics by bank
- Show vault-specific stats if vault is selected

```tsx
// In DashboardPage.tsx
import { useBankContext } from '@/hooks/useBankContext'

const { activeBank, activeVault, isPersonalBank } = useBankContext()

// Show context in header
<div className="flex items-center gap-2">
  {isPersonalBank ? (
    <Users className="h-5 w-5" />
  ) : (
    <Building2 className="h-5 w-5" />
  )}
  <h1>{activeBank?.name || 'Dashboard'}</h1>
  {activeVault && (
    <Badge variant="outline">{activeVault.name}</Badge>
  )}
</div>
```

3. Search for other team context usages:

```bash
grep -r "useTeamContext\|teamContextStore\|activeTeamId" --include="*.tsx" --include="*.ts" src/
```

Update each found file:
- Replace with useBankContext
- Update query filters to use activeBankId/activeVaultId
- Ensure fallback during migration period
  </action>
  <verify>
- Chat uses bank/vault context
- Dashboard shows context
- All team context usages identified and updated
- grep for team context returns only deprecated store
  </verify>
  <done>
- Chat filters by vault context
- Dashboard shows bank/vault header
- All pages use new context system
- Team context deprecated but available for fallback
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Navigate app with bank context - data filters correctly
3. Select vault - chat scopes to vault
4. `grep -r "useTeamContext" src/ | grep -v deprecated` returns empty
5. fathom_calls fallback works when recordings empty
</verification>

<success_criteria>
- teamContextStore has deprecation comment
- SyncTab uses activeBankId for filtering
- Chat respects activeVaultId for scoping
- Dashboard shows context header
- All major pages use new context
- Migration fallback works
- chat-stream receives bank_id/vault_id in sessionFilters (existing filter mechanism)
</success_criteria>

<output>
After completion, create `.planning/phases/09-bank-vault-architecture/09-10-SUMMARY.md`
</output>
