---
phase: 09-bank-vault-architecture
plan: 08
type: execute
wave: 3
depends_on: ["09-07"]
files_modified:
  - src/components/header/BankSwitcher.tsx
  - src/components/layout/AppHeader.tsx
autonomous: true

must_haves:
  truths:
    - "Bank switcher dropdown appears in header"
    - "User can switch between banks"
    - "Current bank/vault context is clearly visible"
  artifacts:
    - path: "src/components/header/BankSwitcher.tsx"
      provides: "Bank/vault switching dropdown"
      contains: "BankSwitcher"
  key_links:
    - from: "BankSwitcher"
      to: "useBankContext"
      via: "hook import"
      pattern: "useBankContext"
    - from: "AppHeader"
      to: "BankSwitcher"
      via: "component render"
      pattern: "<BankSwitcher"
---

<objective>
Create the bank switcher dropdown component for the app header. This replaces the team switcher and allows users to switch between their banks and vaults.

Purpose: Enable users to switch context between personal and business banks, and between vaults within a bank.
Output: BankSwitcher component integrated into the app header.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-bank-vault-architecture/09-CONTEXT.md
@.planning/phases/09-bank-vault-architecture/09-07-SUMMARY.md
@src/components/header/TeamSwitcher.tsx (existing pattern to follow)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BankSwitcher component</name>
  <files>src/components/header/BankSwitcher.tsx</files>
  <action>
Create BankSwitcher following TeamSwitcher pattern:

```tsx
// src/components/header/BankSwitcher.tsx
import { useState } from 'react'
import { Building2, ChevronDown, Users, Briefcase, Check, Plus } from 'lucide-react'
import { cn } from '@/lib/utils'
import { useBankContext } from '@/hooks/useBankContext'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import type { BankWithMembership, VaultWithMembership } from '@/types/bank'

export function BankSwitcher() {
  const {
    activeBank,
    activeVault,
    banks,
    vaults,
    isLoading,
    switchBank,
    switchVault,
    isPersonalBank,
  } = useBankContext()

  if (isLoading) {
    return (
      <div className="h-9 w-40 animate-pulse rounded-md bg-muted" />
    )
  }

  if (!activeBank) {
    return null
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button
          variant="outline"
          size="sm"
          className="h-9 gap-2"
        >
          {isPersonalBank ? (
            <Users className="h-4 w-4 text-muted-foreground" />
          ) : (
            <Building2 className="h-4 w-4 text-muted-foreground" />
          )}
          <span className="max-w-32 truncate font-medium">
            {activeBank.name}
          </span>
          {activeVault && (
            <>
              <span className="text-muted-foreground">/</span>
              <span className="max-w-24 truncate text-muted-foreground">
                {activeVault.name}
              </span>
            </>
          )}
          <ChevronDown className="h-4 w-4 text-muted-foreground" />
        </Button>
      </DropdownMenuTrigger>

      <DropdownMenuContent align="start" className="w-64">
        {/* Banks Section */}
        <DropdownMenuLabel className="text-xs text-muted-foreground">
          Banks
        </DropdownMenuLabel>
        <DropdownMenuGroup>
          {banks.map((bank) => (
            <BankMenuItem
              key={bank.id}
              bank={bank}
              isActive={bank.id === activeBank.id}
              onClick={() => switchBank(bank.id)}
            />
          ))}
        </DropdownMenuGroup>

        {/* Vaults in active bank */}
        {vaults.length > 0 && (
          <>
            <DropdownMenuSeparator />
            <DropdownMenuLabel className="text-xs text-muted-foreground">
              Vaults in {activeBank.name}
            </DropdownMenuLabel>
            <DropdownMenuGroup>
              {/* Show all recordings (no vault filter) */}
              <DropdownMenuItem
                className={cn(
                  'gap-2',
                  !activeVault && 'bg-accent'
                )}
                onClick={() => switchVault(null)}
              >
                <Briefcase className="h-4 w-4" />
                <span>All Recordings</span>
                {!activeVault && <Check className="ml-auto h-4 w-4" />}
              </DropdownMenuItem>

              {vaults.map((vault) => (
                <VaultMenuItem
                  key={vault.id}
                  vault={vault}
                  isActive={vault.id === activeVault?.id}
                  onClick={() => switchVault(vault.id)}
                />
              ))}
            </DropdownMenuGroup>
          </>
        )}

        {/* Create Business Bank (only show for paid users with personal bank active) */}
        {isPersonalBank && (
          <>
            <DropdownMenuSeparator />
            <DropdownMenuItem
              className="gap-2 text-muted-foreground"
              onClick={() => {
                // TODO: Open business bank creation modal
                console.log('Create business bank')
              }}
            >
              <Plus className="h-4 w-4" />
              <span>Create Business Bank</span>
              <Badge variant="outline" className="ml-auto text-xs">
                Pro
              </Badge>
            </DropdownMenuItem>
          </>
        )}
      </DropdownMenuContent>
    </DropdownMenu>
  )
}

function BankMenuItem({
  bank,
  isActive,
  onClick,
}: {
  bank: BankWithMembership
  isActive: boolean
  onClick: () => void
}) {
  const Icon = bank.type === 'personal' ? Users : Building2

  return (
    <DropdownMenuItem
      className={cn('gap-2', isActive && 'bg-accent')}
      onClick={onClick}
    >
      <Icon className="h-4 w-4" />
      <span className="flex-1 truncate">{bank.name}</span>
      <Badge variant="outline" className="text-xs capitalize">
        {bank.membership.role.replace('bank_', '')}
      </Badge>
      {isActive && <Check className="h-4 w-4" />}
    </DropdownMenuItem>
  )
}

function VaultMenuItem({
  vault,
  isActive,
  onClick,
}: {
  vault: VaultWithMembership
  isActive: boolean
  onClick: () => void
}) {
  const vaultTypeIcons: Record<string, typeof Users> = {
    personal: Users,
    team: Building2,
    coach: Users,
    community: Users,
    client: Briefcase,
  }
  const Icon = vaultTypeIcons[vault.vault_type] || Briefcase

  return (
    <DropdownMenuItem
      className={cn('gap-2 pl-6', isActive && 'bg-accent')}
      onClick={onClick}
    >
      <Icon className="h-4 w-4" />
      <span className="flex-1 truncate">{vault.name}</span>
      <span className="text-xs text-muted-foreground capitalize">
        {vault.vault_type}
      </span>
      {isActive && <Check className="ml-2 h-4 w-4" />}
    </DropdownMenuItem>
  )
}
```

Key features:
- Shows current bank + vault in button
- Banks section with role badges
- Vaults section within active bank
- "All Recordings" option for no vault filter
- "Create Business Bank" CTA for upsell
  </action>
  <verify>
- Component compiles without TypeScript errors
- Imports resolve correctly
- Component renders correctly when isolated
  </verify>
  <done>
- BankSwitcher component created
- Shows banks with role badges
- Shows vaults within active bank
- Loading state handled
- CTA for business bank creation
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate BankSwitcher into AppHeader</name>
  <files>src/components/layout/AppHeader.tsx</files>
  <action>
Update AppHeader to use BankSwitcher (replace TeamSwitcher if present):

1. Import BankSwitcher:
```tsx
import { BankSwitcher } from '@/components/header/BankSwitcher'
```

2. Replace TeamSwitcher with BankSwitcher in the header layout

3. Position next to user menu or in left section of header

4. Ensure proper spacing with existing header elements

Look at existing TeamSwitcher usage patterns:
- Where is TeamSwitcher currently rendered?
- What props does it receive?
- Replace with BankSwitcher maintaining same position

If TeamSwitcher doesn't exist yet, add BankSwitcher in the header:
- After logo/nav area
- Before user profile/settings area
- With appropriate margins (gap-2 or gap-4)
  </action>
  <verify>
- AppHeader renders without errors
- BankSwitcher visible in header
- Dropdown opens and shows banks/vaults
- Switching works and updates context
  </verify>
  <done>
- BankSwitcher integrated into AppHeader
- Positioned correctly in header layout
- Works alongside existing header elements
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Navigate to app, see bank switcher in header
3. Click switcher, see banks list
4. Switch bank, verify context updates
5. Switch vault, verify context updates
</verification>

<success_criteria>
- BankSwitcher component renders in header
- Shows current bank name with icon
- Dropdown lists all user's banks
- Dropdown shows vaults in active bank
- Switching bank/vault updates useBankContext
- Loading state shows skeleton
</success_criteria>

<output>
After completion, create `.planning/phases/09-bank-vault-architecture/09-08-SUMMARY.md`
</output>
