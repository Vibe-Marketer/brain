---
phase: 06-code-health-infrastructure
plan: 06
type: execute
wave: 2
depends_on: ["06-05"]
files_modified:
  - supabase/functions/summarize-call/index.ts
  - supabase/functions/extract-action-items/index.ts
  - supabase/functions/automation-engine/actions.ts
autonomous: true

must_haves:
  truths:
    - "summarize-call function exists and returns summarization"
    - "extract-action-items function exists and returns action items"
    - "Automation engine can successfully invoke both functions"
  artifacts:
    - path: "supabase/functions/summarize-call/index.ts"
      provides: "Call summarization endpoint"
      min_lines: 50
    - path: "supabase/functions/extract-action-items/index.ts"
      provides: "Action items extraction endpoint"
      min_lines: 50
  key_links:
    - from: "supabase/functions/automation-engine/actions.ts"
      to: "supabase/functions/summarize-call/index.ts"
      via: "supabase.functions.invoke"
      pattern: "invoke.*summarize-call"
---

<objective>
Implement missing automation functions: summarize-call and extract-action-items

Purpose: Create the Edge Functions referenced in automation-engine/actions.ts but don't exist (IMPL-01)
Output: Two working Edge Functions that provide AI-powered call analysis
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-code-health-infrastructure/06-CONTEXT.md
@supabase/functions/automation-engine/actions.ts
@supabase/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create summarize-call Edge Function</name>
  <files>
    supabase/functions/summarize-call/index.ts
  </files>
  <action>
1. Create `supabase/functions/summarize-call/index.ts` following Supabase Edge Function patterns:
   - CORS preflight handler
   - JWT authentication
   - Input validation with Zod

2. Function logic:
   - Accept POST body: `{ recording_id: number }`
   - Fetch call transcript from fathom_calls table
   - Call OpenRouter API (via existing patterns) with summarization prompt
   - Store summary in appropriate field (check schema for summary column)
   - Return success with summary

3. AI implementation per CONTEXT.md (Claude's discretion):
   - Use Vercel AI SDK if already set up in similar functions
   - Or use direct OpenRouter API call (simpler for single purpose)
   - Check chat-stream-v2 for existing OpenRouter patterns

4. Error handling:
   - 400 for invalid recording_id
   - 404 for recording not found
   - 500 for AI API failures
   - User ownership check (recording belongs to authenticated user)

5. Use existing shared utilities:
   - `_shared/cors.ts` for CORS headers
   - Follow patterns from other Edge Functions
  </action>
  <verify>
    - File exists at supabase/functions/summarize-call/index.ts
    - Has proper CORS, auth, and error handling
    - Follows existing Edge Function patterns
  </verify>
  <done>
    summarize-call Edge Function created with AI-powered summarization
  </done>
</task>

<task type="auto">
  <name>Task 2: Create extract-action-items Edge Function</name>
  <files>
    supabase/functions/extract-action-items/index.ts
  </files>
  <action>
1. Create `supabase/functions/extract-action-items/index.ts`:
   - Same boilerplate as summarize-call (CORS, auth, validation)
   - Accept POST body: `{ recording_id: number }`

2. Function logic:
   - Fetch call transcript from fathom_calls table
   - Call OpenRouter API with action items extraction prompt
   - Parse response into structured action items array
   - Return: `{ action_items: Array<{ task: string, assignee?: string, due_date?: string }> }`

3. Prompt design for action items:
   - Extract actionable tasks mentioned in call
   - Identify who is responsible if mentioned
   - Extract any deadlines or timeframes mentioned
   - Return as JSON array

4. Schema consideration:
   - Check if fathom_calls has an action_items column
   - If yes, optionally store extracted items
   - If no, just return in response (caller stores if needed)

5. Error handling:
   - Same patterns as summarize-call
   - Handle case where no action items found (return empty array)
  </action>
  <verify>
    - File exists at supabase/functions/extract-action-items/index.ts
    - Returns properly formatted action_items array
    - Follows same patterns as summarize-call
  </verify>
  <done>
    extract-action-items Edge Function created with AI-powered extraction
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify automation engine integration</name>
  <files>
    supabase/functions/automation-engine/actions.ts
  </files>
  <action>
1. Review automation-engine/actions.ts to ensure calls match new function signatures:
   - Line 471: `supabase.functions.invoke('summarize-call', { body: { recording_id } })`
   - Line 482: `supabase.functions.invoke('extract-action-items', { body: { recording_id } })`

2. Verify response handling matches what new functions return:
   - summarize-call returns: `{ summary: string }`
   - extract-action-items returns: `{ action_items: [...] }`

3. Update actions.ts if response handling needs adjustment

4. Add proper error handling in actions.ts for new function failures

5. No changes needed if existing code already handles expected response shapes
  </action>
  <verify>
    - actions.ts correctly invokes both new functions
    - Response handling matches function return types
    - `npm run typecheck` passes (if applicable for Edge Functions)
  </verify>
  <done>
    Automation engine successfully integrates with both new functions
  </done>
</task>

</tasks>

<verification>
1. Both function directories exist with index.ts
2. Functions follow Supabase Edge Function patterns
3. AI prompts produce reasonable summaries and action items
4. automation-engine/actions.ts correctly integrates
5. Supabase dashboard shows new functions (after deploy)
</verification>

<success_criteria>
- summarize-call function created and returns call summary
- extract-action-items function created and returns action items array
- Both functions have proper auth, validation, error handling
- automation-engine can invoke both without errors
- Response formats match expected shapes in actions.ts
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-health-infrastructure/06-06-SUMMARY.md`
</output>
