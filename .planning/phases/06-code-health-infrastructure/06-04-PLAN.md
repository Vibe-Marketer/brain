---
phase: 06-code-health-infrastructure
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/_shared/deduplication.ts
  - supabase/functions/_shared/dedup-fingerprint.ts
  - supabase/functions/chat-stream-legacy/index.ts
  - supabase/functions/chat-stream-v2/index.ts
autonomous: true

must_haves:
  truths:
    - "Single deduplication implementation used across codebase"
    - "Single diversity filter implementation imported by chat-stream"
    - "No inline diversityFilter function in chat-stream-legacy"
  artifacts:
    - path: "supabase/functions/_shared/deduplication.ts"
      provides: "Consolidated deduplication logic"
    - path: "supabase/functions/_shared/diversity-filter.ts"
      provides: "Single diversity filter implementation"
  key_links:
    - from: "supabase/functions/chat-stream-legacy/index.ts"
      to: "supabase/functions/_shared/diversity-filter.ts"
      via: "import"
      pattern: "import.*diversityFilter.*_shared"
---

<objective>
Consolidate duplicate deduplication and diversity filter code

Purpose: Remove code duplication per CLEAN-01 and REFACTOR-07 requirements
Output: Single source of truth for deduplication and diversity filtering logic
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/functions/_shared/deduplication.ts
@supabase/functions/_shared/dedup-fingerprint.ts
@supabase/functions/_shared/diversity-filter.ts
@supabase/functions/_shared/search-pipeline.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and consolidate deduplication code</name>
  <files>
    supabase/functions/_shared/deduplication.ts
    supabase/functions/_shared/dedup-fingerprint.ts
  </files>
  <action>
1. Analyze both deduplication files:
   - `deduplication.ts` - contains generateFingerprint, fingerprintToHash
   - `dedup-fingerprint.ts` - contains MeetingFingerprint, checkDuplicateMatch

2. Determine consolidation strategy:
   - If both serve different purposes (one for sync, one for search), document clearly
   - If overlapping, merge into single file with clear exports
   - Preserve all functionality - no behavior changes

3. If consolidating:
   - Keep `deduplication.ts` as the canonical file
   - Move any unique functionality from `dedup-fingerprint.ts` to `deduplication.ts`
   - Update all imports across codebase
   - Delete `dedup-fingerprint.ts` if fully merged

4. If keeping separate (different concerns):
   - Add clear documentation at top of each file explaining scope
   - Ensure no duplicate functions between files
   - Consider renaming for clarity (e.g., `sync-dedup.ts` vs `search-dedup.ts`)

5. Search for all imports and update:
   - `grep -r "dedup" supabase/functions/ --include="*.ts"`
  </action>
  <verify>
    - No duplicate function definitions between dedup files
    - All imports still resolve correctly
    - `npm run typecheck` in supabase functions passes (if available)
  </verify>
  <done>
    Deduplication code consolidated or clearly separated with documentation
  </done>
</task>

<task type="auto">
  <name>Task 2: Consolidate diversity filter implementations</name>
  <files>
    supabase/functions/chat-stream-legacy/index.ts
    supabase/functions/_shared/diversity-filter.ts
    supabase/functions/_shared/search-pipeline.ts
  </files>
  <action>
1. Current state:
   - `_shared/diversity-filter.ts` has full implementation with semantic similarity
   - `_shared/search-pipeline.ts` has simple diversityFilter (max-per-recording only)
   - `chat-stream-legacy/index.ts` has inline diversityFilter (~line 203)

2. Decision per CONTEXT.md: chat-stream uses simple filter (max-per-recording only)

3. Ensure `_shared/search-pipeline.ts` exports the simple diversityFilter:
   - Verify it matches production chat-stream behavior
   - Keep `_shared/diversity-filter.ts` for advanced semantic filtering (different use case)

4. Remove inline diversityFilter from `chat-stream-legacy/index.ts`:
   - Import from `_shared/search-pipeline.ts` instead
   - Verify chat-stream-v2 already imports from shared (confirmed: line 14)

5. Update any other files using inline diversity filters

6. Document which diversity filter to use where:
   - Simple (search-pipeline.ts): chat-stream, general search
   - Advanced (diversity-filter.ts): specialized semantic filtering
  </action>
  <verify>
    - `grep -n "function diversityFilter" supabase/functions/chat-stream-legacy/index.ts` returns no results
    - `grep -n "diversityFilter" supabase/functions/chat-stream-legacy/index.ts` shows import only
    - chat-stream-v2 still works (already uses shared)
  </verify>
  <done>
    Single diversity filter imported from _shared/search-pipeline.ts by both chat-stream functions
  </done>
</task>

</tasks>

<verification>
1. No duplicate diversityFilter function definitions in chat-stream files
2. Clear documentation on deduplication file purposes
3. All imports resolve correctly
4. `supabase functions serve` can start without errors (if testable locally)
</verification>

<success_criteria>
- Inline diversityFilter removed from chat-stream-legacy
- Both chat-stream functions import diversityFilter from shared module
- Deduplication files consolidated or clearly documented
- No behavior changes - same logic, just reorganized
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-health-infrastructure/06-04-SUMMARY.md`
</output>
