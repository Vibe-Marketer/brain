---
phase: 06-code-health-infrastructure
plan: 08
type: execute
wave: 2
depends_on: []
files_modified:
  - supabase/functions/_shared/usage-tracker.ts
  - supabase/functions/chat-stream-v2/index.ts
  - src/components/settings/CostDashboard.tsx
  - src/hooks/useAICosts.ts
autonomous: true

must_haves:
  truths:
    - "Cost tracking covers all OpenRouter models used in production"
    - "Dashboard shows cost breakdown by feature/user"
    - "Per-request logging captures model, tokens, and cost"
  artifacts:
    - path: "supabase/functions/_shared/usage-tracker.ts"
      provides: "Extended model pricing"
      contains: "claude\|gpt-4o\|gemini"
    - path: "src/components/settings/CostDashboard.tsx"
      provides: "Cost visualization UI"
      min_lines: 100
  key_links:
    - from: "supabase/functions/chat-stream-v2/index.ts"
      to: "supabase/functions/_shared/usage-tracker.ts"
      via: "import"
      pattern: "import.*usage-tracker"
---

<objective>
Complete cost tracking for all OpenRouter models with dashboard

Purpose: Full per-request logging and real-time dashboard with alerts (INFRA-01)
Output: Extended model pricing, per-request logging, cost dashboard with breakdown and alerts
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-code-health-infrastructure/06-CONTEXT.md
@supabase/functions/_shared/usage-tracker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend usage-tracker with all OpenRouter models</name>
  <files>
    supabase/functions/_shared/usage-tracker.ts
  </files>
  <action>
1. Research current OpenRouter models used in production:
   - `grep -r "model.*openrouter\|openrouter.*model" supabase/functions/`
   - `grep -r "anthropic/claude\|openai/gpt\|google/gemini" supabase/functions/`
   - Check chat-stream-v2, generate-ai-titles, summarize-call, extract-action-items

2. Extend PRICING object with all models (use OpenRouter pricing):
```typescript
const PRICING = {
  // Embeddings
  'text-embedding-3-small': { input: 0.02, output: 0 },
  'text-embedding-3-large': { input: 0.13, output: 0 },
  
  // OpenAI
  'gpt-4o-mini': { input: 0.15, output: 0.60 },
  'gpt-4o': { input: 5.00, output: 15.00 },
  'gpt-4-turbo': { input: 10.00, output: 30.00 },
  
  // Anthropic (via OpenRouter)
  'anthropic/claude-3-opus': { input: 15.00, output: 75.00 },
  'anthropic/claude-3-sonnet': { input: 3.00, output: 15.00 },
  'anthropic/claude-3-haiku': { input: 0.25, output: 1.25 },
  'anthropic/claude-3.5-sonnet': { input: 3.00, output: 15.00 },
  
  // Google (via OpenRouter)
  'google/gemini-pro': { input: 0.50, output: 1.50 },
  'google/gemini-pro-1.5': { input: 3.50, output: 10.50 },
  
  // Add more as found in codebase
} as const;
```

3. Update calculateCostCents to handle model name normalization:
   - OpenRouter uses "provider/model" format
   - Strip provider prefix if needed for matching
   - Log warning for unknown models (don't fail silently)

4. Add model name helpers:
```typescript
function normalizeModelName(model: string): string {
  // Handle openrouter vs direct model names
  return model.includes('/') ? model : model;
}
```
  </action>
  <verify>
    - PRICING includes all models found in grep
    - Unknown models logged but don't crash
    - Cost calculation correct for sample inputs
  </verify>
  <done>
    usage-tracker covers all production models with proper pricing
  </done>
</task>

<task type="auto">
  <name>Task 2: Add per-request logging to chat-stream-v2</name>
  <files>
    supabase/functions/chat-stream-v2/index.ts
  </files>
  <action>
1. Import logUsage from usage-tracker:
   `import { logUsage } from '../_shared/usage-tracker.ts';`

2. After stream completes, log usage:
   - Capture model used
   - Capture input tokens (from prompt)
   - Capture output tokens (from response)
   - Include session_id if available
   - Include latency_ms

3. Add usage logging:
```typescript
// After stream completes
await logUsage(supabase, {
  userId: user.id,
  operationType: 'chat',
  model: selectedModel,
  inputTokens: estimateTokenCount(fullPrompt),
  outputTokens: estimateTokenCount(responseText),
  sessionId: chatSessionId,
  latencyMs: Date.now() - startTime,
});
```

4. Handle token estimation:
   - Use existing estimateTokenCount helper
   - Or use actual token counts from AI SDK if available

5. Ensure logging is fire-and-forget:
   - Use try-catch, don't await if blocking
   - Logging failure shouldn't fail the request
  </action>
  <verify>
    - chat-stream-v2 imports usage-tracker
    - Usage logged after successful responses
    - Logging doesn't block response streaming
  </verify>
  <done>
    Per-request logging implemented for chat-stream-v2
  </done>
</task>

<task type="auto">
  <name>Task 3: Create cost dashboard component</name>
  <files>
    src/components/settings/CostDashboard.tsx
    src/hooks/useAICosts.ts
  </files>
  <action>
1. Create `src/hooks/useAICosts.ts`:
   - Query embedding_usage_logs table
   - Aggregate by: model, operation_type, date range
   - Calculate totals and breakdowns
   - Support filtering by date range

2. Create `src/components/settings/CostDashboard.tsx`:
   - Show total cost for period (today, this week, this month)
   - Breakdown by model (bar chart or table)
   - Breakdown by operation type (chat, embedding, search)
   - Cost trend over time (line chart)
   - Alert threshold configuration (optional, can defer)

3. Use existing UI patterns:
   - Card layout following brand guidelines
   - Tailwind for styling
   - Remix icons for visuals
   - Skeleton loading states

4. Dashboard sections:
   - Summary cards: Total cost, Total requests, Avg cost/request
   - By Model table: Model, Requests, Input tokens, Output tokens, Cost
   - By Feature: Chat, Embeddings, Search, Other
   - Recent activity: Last 10 requests with cost

5. Wire into Settings page:
   - Add tab or section in admin/settings area
   - Ensure proper access control (admin only?)
  </action>
  <verify>
    - Dashboard renders without errors
    - Shows real data from embedding_usage_logs
    - Breakdown displays correctly
    - Loading states work
  </verify>
  <done>
    Cost dashboard created with breakdown by feature/model and alerts
  </done>
</task>

</tasks>

<verification>
1. All production models have pricing entries
2. chat-stream-v2 logs usage after each request
3. Dashboard shows real cost data
4. Breakdown by model and operation type works
5. No performance impact from logging
</verification>

<success_criteria>
- Extended PRICING covers 10+ models
- Per-request logging in chat-stream-v2
- CostDashboard component with breakdown views
- useAICosts hook for data fetching
- Dashboard integrated into settings
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-health-infrastructure/06-08-SUMMARY.md`
</output>
