---
phase: 06-code-health-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/Chat.tsx
  - src/components/chat/ChatMessageList.tsx
  - src/components/chat/ChatInputArea.tsx
  - src/components/chat/ChatConnectionHandler.tsx
  - src/hooks/useChatStreaming.ts
  - src/hooks/useChatFilters.ts
  - src/types/chat.ts
autonomous: true

must_haves:
  truths:
    - "Chat.tsx is under 500 lines"
    - "Chat streaming logic is testable in isolation"
    - "MessageList, InputArea, and ConnectionHandler are separate components"
  artifacts:
    - path: "src/pages/Chat.tsx"
      provides: "Thin orchestration component"
      max_lines: 500
    - path: "src/components/chat/ChatMessageList.tsx"
      provides: "Message rendering logic"
      min_lines: 50
    - path: "src/components/chat/ChatInputArea.tsx"
      provides: "Input handling and filters UI"
      min_lines: 100
    - path: "src/hooks/useChatStreaming.ts"
      provides: "Streaming state management"
      min_lines: 50
  key_links:
    - from: "src/pages/Chat.tsx"
      to: "src/components/chat/ChatMessageList.tsx"
      via: "import and composition"
      pattern: "import.*ChatMessageList"
    - from: "src/pages/Chat.tsx"
      to: "src/hooks/useChatStreaming.ts"
      via: "hook usage"
      pattern: "useChatStreaming"
---

<objective>
Refactor Chat.tsx (2008 lines) into sub-components and custom hooks

Purpose: Break down the monolithic Chat.tsx into testable, maintainable pieces with clear separation of concerns
Output: Chat.tsx under 500 lines with extracted MessageList, InputArea, ConnectionHandler components and streaming hooks
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-code-health-infrastructure/06-CONTEXT.md
@src/pages/Chat.tsx
@src/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract types and create streaming hook</name>
  <files>
    src/types/chat.ts
    src/hooks/useChatStreaming.ts
    src/hooks/useChatFilters.ts
  </files>
  <action>
1. Create `src/types/chat.ts` with all chat-related types extracted from Chat.tsx:
   - ToolCallState, SourceData, ChatFilter types
   - Message display types
   - Connection state types

2. Create `src/hooks/useChatStreaming.ts`:
   - Extract all streaming-related state (isStreaming, connectionState, reconnectAttempts)
   - Extract throttledErrorLog utility
   - Extract isRateLimitError, isStreamingInterruptionError helpers
   - Create clean interface for Chat.tsx to consume

3. Create `src/hooks/useChatFilters.ts`:
   - Extract filter-related state (activeFilters, dateRange, selectedParticipants, etc.)
   - Extract filter manipulation functions
   - Extract buildFiltersObject logic

Follow existing codebase patterns from src/hooks/ directory. Each hook should be independently testable.
  </action>
  <verify>
    - `grep -r "useChatStreaming" src/hooks/useChatStreaming.ts` returns the export
    - `grep -r "useChatFilters" src/hooks/useChatFilters.ts` returns the export
    - `npm run typecheck` passes
  </verify>
  <done>
    Two new hooks exist with clear interfaces, types extracted to dedicated file
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract UI components</name>
  <files>
    src/components/chat/ChatMessageList.tsx
    src/components/chat/ChatInputArea.tsx
    src/components/chat/ChatConnectionHandler.tsx
  </files>
  <action>
1. Create `src/components/chat/ChatMessageList.tsx`:
   - Extract message rendering logic (UserMessage, AssistantMessage mapping)
   - Extract tool call display logic
   - Extract source citation display
   - Props: messages, onCallClick, isLoading, etc.

2. Create `src/components/chat/ChatInputArea.tsx`:
   - Extract PromptInput composition and configuration
   - Extract filter popovers (date range, participants, folders, tags)
   - Extract context bar and attachment handling
   - Props: onSubmit, filters, mentions, etc.

3. Create `src/components/chat/ChatConnectionHandler.tsx`:
   - Extract connection status display
   - Extract retry button logic
   - Extract error state display
   - Props: connectionState, onRetry, error, etc.

Follow component patterns from src/components/chat/ - use existing primitives. Each component should receive props, not use stores directly where possible.
  </action>
  <verify>
    - All three component files exist
    - `npm run typecheck` passes
    - Each component has proper TypeScript interface for props
  </verify>
  <done>
    MessageList, InputArea, and ConnectionHandler components exist as separate files with clear prop interfaces
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor Chat.tsx to use extracted pieces</name>
  <files>
    src/pages/Chat.tsx
  </files>
  <action>
1. Import all extracted hooks and components

2. Replace inline logic with hook calls:
   - useChatStreaming() for connection/streaming state
   - useChatFilters() for filter state
   - Keep useChat from @ai-sdk/react (existing)
   - Keep useChatSession (existing)
   - Keep useMentions (existing)

3. Replace inline JSX blocks with components:
   - ChatMessageList for message rendering
   - ChatInputArea for input + filters
   - ChatConnectionHandler for connection status

4. Keep Chat.tsx as the orchestration layer:
   - AppShell wrapper
   - Route parameter handling
   - Session management
   - Component composition

5. Target: Chat.tsx under 500 lines, ideally 300-400

6. Run full build to verify no regressions:
   - `npm run build`
   - Test manually if dev server available
  </action>
  <verify>
    - `wc -l src/pages/Chat.tsx` shows under 500 lines
    - `npm run build` succeeds
    - No TypeScript errors
  </verify>
  <done>
    Chat.tsx is a thin orchestration layer under 500 lines, all logic extracted to testable hooks/components
  </done>
</task>

</tasks>

<verification>
1. `wc -l src/pages/Chat.tsx` < 500
2. `npm run build` passes
3. `npm run typecheck` passes
4. New hooks are independently importable
5. New components have documented prop interfaces
</verification>

<success_criteria>
- Chat.tsx refactored from 2008 lines to under 500 lines
- At least 3 new components created (MessageList, InputArea, ConnectionHandler)
- At least 2 new hooks created (useChatStreaming, useChatFilters)
- All types extracted to dedicated file
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-health-infrastructure/06-01-SUMMARY.md`
</output>
