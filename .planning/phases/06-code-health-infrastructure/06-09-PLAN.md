---
phase: 06-code-health-infrastructure
plan: 09
type: execute
wave: 2
depends_on: []
files_modified:
  - supabase/functions/automation-scheduler/index.ts
  - src/components/automation/CronPreview.tsx
  - src/components/automation/AutomationRuleForm.tsx
autonomous: true

must_haves:
  truths:
    - "Cron expression parsing produces correct intervals"
    - "Validation UI shows next 3 scheduled times before saving"
    - "No hardcoded 1-hour fallback for cron expressions"
  artifacts:
    - path: "supabase/functions/automation-scheduler/index.ts"
      provides: "Proper cron expression parsing"
    - path: "src/components/automation/CronPreview.tsx"
      provides: "Next run time preview component"
      min_lines: 30
  key_links:
    - from: "src/components/automation/AutomationRuleForm.tsx"
      to: "src/components/automation/CronPreview.tsx"
      via: "import and usage"
      pattern: "CronPreview"
---

<objective>
Fix cron expression parsing with validation UI

Purpose: Cron expressions should work correctly and show preview before saving (INFRA-02)
Output: Working cron parser and UI showing next run times
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-code-health-infrastructure/06-CONTEXT.md
@supabase/functions/automation-scheduler/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement proper cron parsing in scheduler</name>
  <files>
    supabase/functions/automation-scheduler/index.ts
  </files>
  <action>
1. Current state (lines 137-141):
```typescript
case 'cron': {
  // For cron expressions, we need a more complex parser
  // For now, default to running again in 1 hour if cron is used
  return new Date(fromTime.getTime() + 60 * 60 * 1000);
}
```

2. Add a proper cron parser:
   - Use a lightweight cron parsing library (or implement basic parser)
   - Support standard 5-field cron format: minute hour day-of-month month day-of-week
   - Calculate next run time from cron expression

3. Option A: Use cron-parser library (if available in Deno)
```typescript
import { parseExpression } from 'https://esm.sh/cron-parser@4.9.0';

case 'cron': {
  const expression = config.cron_expression;
  if (!expression) {
    return new Date(fromTime.getTime() + 60 * 60 * 1000); // fallback
  }
  const interval = parseExpression(expression, { currentDate: fromTime });
  return interval.next().toDate();
}
```

4. Option B: Implement basic parser for common patterns
```typescript
function parseCronExpression(expression: string, fromTime: Date): Date {
  const [minute, hour, dayOfMonth, month, dayOfWeek] = expression.split(' ');
  // Parse each field and calculate next occurrence
  // Support: *, specific values, ranges, steps
  // ...implementation...
}
```

5. Handle edge cases:
   - Invalid cron expressions: Log error, use 1-hour fallback
   - Timezone considerations: Use UTC or user timezone if available
   - Expression validation before saving (frontend)
  </action>
  <verify>
    - Cron expression "0 9 * * *" (daily at 9am) calculates correct next run
    - Cron expression "*/15 * * * *" (every 15 min) calculates correct next run
    - Invalid expressions don't crash, use fallback with warning
  </verify>
  <done>
    Cron expression parsing produces correct intervals, not hardcoded 1-hour
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CronPreview component for validation UI</name>
  <files>
    src/components/automation/CronPreview.tsx
  </files>
  <action>
1. Create `src/components/automation/CronPreview.tsx`:
   - Accept cron expression as prop
   - Calculate and display next 3 scheduled times
   - Show human-readable description of schedule

2. Component structure:
```tsx
interface CronPreviewProps {
  expression: string;
  timezone?: string;
}

export function CronPreview({ expression, timezone = 'UTC' }: CronPreviewProps) {
  const nextRuns = useMemo(() => {
    // Calculate next 3 run times
    return calculateNextRuns(expression, 3);
  }, [expression]);

  return (
    <div className="space-y-2 text-sm">
      <p className="text-muted-foreground">This will run at:</p>
      <ul className="space-y-1">
        {nextRuns.map((date, i) => (
          <li key={i} className="flex items-center gap-2">
            <RiTimeLine className="h-4 w-4" />
            {format(date, 'PPpp')}
          </li>
        ))}
      </ul>
    </div>
  );
}
```

3. Add cron calculation utilities:
   - Port cron parsing logic to frontend (or use same library)
   - Create `src/lib/cron-utils.ts` for shared logic

4. Handle invalid expressions:
   - Show validation error message
   - Don't show next runs if expression invalid
   - Use red text for errors

5. Optional: Add human-readable description
   - "Every day at 9:00 AM"
   - "Every 15 minutes"
   - Use cronstrue library or implement basic descriptions
  </action>
  <verify>
    - Component renders next 3 run times
    - Updates when expression changes
    - Shows error for invalid expressions
  </verify>
  <done>
    CronPreview component shows "This will run at: [next 3 times]" preview
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate CronPreview into AutomationRuleForm</name>
  <files>
    src/components/automation/AutomationRuleForm.tsx
  </files>
  <action>
1. Find the automation rule form component:
   - `grep -r "AutomationRule" src/components/`
   - May be in a different location or named differently

2. Import and add CronPreview:
   - Show preview when schedule_type is 'cron'
   - Display below cron expression input
   - Update preview on expression change

3. Add validation before save:
   - Validate cron expression is parseable
   - Show error if invalid
   - Prevent save if expression invalid

4. Wire up to form:
```tsx
{scheduleType === 'cron' && (
  <div className="space-y-4">
    <Input
      value={cronExpression}
      onChange={(e) => setCronExpression(e.target.value)}
      placeholder="0 9 * * *"
    />
    <CronPreview expression={cronExpression} />
  </div>
)}
```

5. Ensure form validation includes cron check
  </action>
  <verify>
    - CronPreview visible when editing cron-type rules
    - Preview updates as user types
    - Invalid expressions show validation error
    - Form prevents save with invalid cron
  </verify>
  <done>
    Validation UI shows next run times before saving rule
  </done>
</task>

</tasks>

<verification>
1. Scheduler correctly calculates next run for various cron expressions
2. CronPreview shows 3 upcoming run times
3. AutomationRuleForm includes CronPreview
4. Invalid expressions prevented from saving
5. Build passes
</verification>

<success_criteria>
- Cron parsing works for standard 5-field expressions
- Preview UI shows next 3 scheduled times
- Invalid expressions show clear error messages
- No more hardcoded 1-hour fallback
- Form validation prevents invalid cron saves
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-health-infrastructure/06-09-SUMMARY.md`
</output>
