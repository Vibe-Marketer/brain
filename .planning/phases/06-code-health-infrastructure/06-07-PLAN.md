---
phase: 06-code-health-infrastructure
plan: 07
type: execute
wave: 2
depends_on: []
files_modified:
  - supabase/functions/automation-engine/actions.ts
  - supabase/migrations/YYYYMMDDHHMMSS_handle_missing_tables.sql
autonomous: true

must_haves:
  truths:
    - "References to tasks/clients/client_health_history tables handled gracefully"
    - "No silent failures when tables don't exist"
    - "Clear error messages or skip logic for missing tables"
  artifacts:
    - path: "supabase/functions/automation-engine/actions.ts"
      provides: "Graceful handling of missing tables"
  key_links:
    - from: "supabase/functions/automation-engine/actions.ts"
      to: "database schema"
      via: "table queries"
      pattern: "from\\('(tasks|clients|client_health_history)'\\)"
---

<objective>
Handle non-existent table references in automation actions

Purpose: Resolve IMPL-02 by researching why tables are referenced and handling gracefully
Output: Either tables created, references removed, or graceful fallback behavior
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-code-health-infrastructure/06-CONTEXT.md
@supabase/functions/automation-engine/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research table references and current state</name>
  <files>
    supabase/functions/automation-engine/actions.ts
  </files>
  <action>
1. Trace all table references in actions.ts:
   - `clients` table: lines 542, 562, 587, 610 (executeUpdateClientHealth)
   - `client_health_history` table: line 622 (executeUpdateClientHealth)
   - `tasks` table: line 775 (executeCreateTask)

2. Check database schema for these tables:
   - `grep -r "create table clients\|CREATE TABLE clients" supabase/migrations/`
   - `grep -r "create table tasks\|CREATE TABLE tasks" supabase/migrations/`
   - `grep -r "client_health_history" supabase/migrations/`

3. Determine current state:
   - Do these tables exist in production?
   - Were they planned but never created?
   - Are they from a feature that was abandoned?

4. Check if these features are in the roadmap:
   - Client health = DIFF-03 (Phase 7 - Differentiators)
   - Tasks = No clear requirement

5. Document findings:
   - What tables exist/don't exist
   - What features they were meant for
   - Recommendation (create, stub, or remove)
  </action>
  <verify>
    - Research documented with findings
    - Clear recommendation for each table
  </verify>
  <done>
    Research complete with clear path forward for each table reference
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement graceful handling</name>
  <files>
    supabase/functions/automation-engine/actions.ts
    supabase/migrations/YYYYMMDDHHMMSS_handle_missing_tables.sql
  </files>
  <action>
Based on research findings, implement one of these strategies:

**Option A: If tables should exist (features are planned)**
1. Create migration to add missing tables:
   - `clients` table with: id, user_id, name, email, health_score, created_at
   - `client_health_history` table with: id, client_id, previous_score, new_score, reason, created_at
   - `tasks` table with: id, user_id, title, description, due_date, status, recording_id, created_at

**Option B: If features are deferred (most likely)**
1. Update executeUpdateClientHealth:
   - Add try-catch around client queries
   - Return success with note: "Client health feature not yet available"
   - Don't throw errors, log and skip gracefully

2. Update executeCreateTask:
   - Add try-catch around task insert
   - Return success with note: "Task creation feature not yet available"
   - Already has note handling at line 795

3. Consider adding feature flags:
   - Check if feature is enabled before attempting table operations
   - Cleanly skip if feature disabled

**Option C: If features are abandoned**
1. Remove action handlers entirely
2. Update action types to remove unsupported actions
3. Document in ADR why removed

Choose based on research. Option B (graceful skip) is most likely appropriate since Client Health is in Phase 7.
  </action>
  <verify>
    - No unhandled exceptions when tables don't exist
    - Automation engine continues to work for other actions
    - Clear feedback when feature is not available
  </verify>
  <done>
    Non-existent table references handled gracefully with clear user feedback
  </done>
</task>

</tasks>

<verification>
1. Automation engine doesn't crash when invoking client health actions
2. Automation engine doesn't crash when invoking task creation
3. Clear messages returned indicating feature availability
4. Other automation actions continue to work normally
</verification>

<success_criteria>
- Research documents why these tables are referenced
- Graceful handling implemented (no silent failures)
- Clear error/info messages for unavailable features
- Automation engine remains stable
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-health-infrastructure/06-07-SUMMARY.md`
</output>
