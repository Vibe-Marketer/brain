---
phase: 19-mcp-audit-workspace-tokens
plan: 05
type: execute
wave: 3
depends_on: ["19-03"]
files_modified:
  - /Users/Naegele/dev/callvault/src/components/workspace/WorkspaceMcpPanel.tsx
  - /Users/Naegele/dev/callvault/src/components/workspace/GenerateMcpTokenDialog.tsx
  - /Users/Naegele/dev/callvault/src/components/workspace/McpTokenRow.tsx
  - /Users/Naegele/dev/callvault/src/hooks/useMcpTokens.ts
  - /Users/Naegele/dev/callvault/src/services/mcp-tokens.service.ts
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/workspaces/$workspaceId.tsx
autonomous: false

must_haves:
  truths:
    - "Workspace owner can navigate to Workspace Settings MCP tab and see token list"
    - "Token creation dialog has name field, scope selector (whole workspace or specific folders), and confirmation step"
    - "After generation, user sees token secret exactly once with copy button and MCP config JSON block"
    - "I've copied it confirmation button dismisses the show-once view"
    - "Token list shows name, scope badge, last-used timestamp, created date, and revoke button"
    - "Revoking a token immediately removes it from the active list"
    - "Stale tokens (last used > 30 days ago) have a visual indicator"
  artifacts:
    - path: "/Users/Naegele/dev/callvault/src/components/workspace/WorkspaceMcpPanel.tsx"
      provides: "MCP tab content with token table and generate button"
      min_lines: 60
    - path: "/Users/Naegele/dev/callvault/src/components/workspace/GenerateMcpTokenDialog.tsx"
      provides: "Token creation dialog with scope selector and show-once display"
      min_lines: 100
    - path: "/Users/Naegele/dev/callvault/src/components/workspace/McpTokenRow.tsx"
      provides: "Dense table row component for token list"
      min_lines: 30
    - path: "/Users/Naegele/dev/callvault/src/hooks/useMcpTokens.ts"
      provides: "TanStack Query hooks for token CRUD"
      contains: "useMcpTokens"
    - path: "/Users/Naegele/dev/callvault/src/services/mcp-tokens.service.ts"
      provides: "Service functions for token operations"
      contains: "generateMcpToken"
  key_links:
    - from: "/Users/Naegele/dev/callvault/src/routes/_authenticated/workspaces/$workspaceId.tsx"
      to: "/Users/Naegele/dev/callvault/src/components/workspace/WorkspaceMcpPanel.tsx"
      via: "Radix Tab import and mount"
      pattern: "WorkspaceMcpPanel"
    - from: "/Users/Naegele/dev/callvault/src/hooks/useMcpTokens.ts"
      to: "/Users/Naegele/dev/callvault/src/services/mcp-tokens.service.ts"
      via: "TanStack Query wrapping service calls"
      pattern: "mcpTokensService"
    - from: "/Users/Naegele/dev/callvault/src/services/mcp-tokens.service.ts"
      to: "https://vltmrnjsubfzrgrtdqey.supabase.co/functions/v1/generate-mcp-token"
      via: "supabase.functions.invoke"
      pattern: "generate-mcp-token"
---

<objective>
Build the React token management UI for MCP tokens in Workspace Settings. Follows Airtable-style per CONTEXT.md: dense table rows, dedicated creation dialog with scope selector, show-once token display with MCP config JSON block, and revoke functionality.

Purpose: MCP-05 (token management UI) and MCP-06 (token list display) require a frontend for workspace owners to create, view, and revoke MCP tokens. This plan builds the UI components and wires them into the workspace detail page.

Output: Working MCP tab in workspace detail page with full token lifecycle (create, view, revoke).
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-mcp-audit-workspace-tokens/19-CONTEXT.md
@.planning/phases/19-mcp-audit-workspace-tokens/19-RESEARCH.md
@.planning/phases/16-workspace-redesign/16-02-SUMMARY.md
@.planning/phases/16-workspace-redesign/16-07-SUMMARY.md
@.planning/phases/19-mcp-audit-workspace-tokens/19-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Service layer, hooks, and MCP panel with token table</name>
  <files>
    /Users/Naegele/dev/callvault/src/services/mcp-tokens.service.ts
    /Users/Naegele/dev/callvault/src/hooks/useMcpTokens.ts
    /Users/Naegele/dev/callvault/src/components/workspace/WorkspaceMcpPanel.tsx
    /Users/Naegele/dev/callvault/src/components/workspace/McpTokenRow.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/workspaces/$workspaceId.tsx
  </files>
  <action>
Read the existing patterns first:
- `src/services/workspaces.service.ts` for service function patterns
- `src/hooks/useWorkspaces.ts` for TanStack Query hook patterns
- `src/components/workspace/WorkspaceMemberPanel.tsx` for existing workspace panel UI patterns
- `src/routes/_authenticated/workspaces/$workspaceId.tsx` for current workspace detail page
- `src/CLAUDE.md` in the callvault repo for frontend conventions

**Step 1: Create mcp-tokens.service.ts**

Follow the `workspaces.service.ts` pattern. Import `supabase` from `@/lib/supabase`.

```typescript
// src/services/mcp-tokens.service.ts

interface McpToken {
  id: string;
  workspace_id: string;
  creator_user_id: string;
  name: string;
  scoped_folder_ids: string[] | null;
  is_revoked: boolean;
  last_used_at: string | null;
  created_at: string;
}

interface GenerateTokenResponse {
  token_secret: string;
  token_id: string;
  name: string;
  workspace_id: string;
  scoped_folder_ids: string[] | null;
  created_at: string;
}

export async function getMcpTokens(workspaceId: string): Promise<McpToken[]> {
  // Query workspace_mcp_tokens (RLS ensures only admin/owner sees them)
  // Filter: is_revoked = false
  // Order: created_at DESC
}

export async function generateMcpToken(
  workspaceId: string,
  name: string,
  scopedFolderIds: string[] | null
): Promise<GenerateTokenResponse> {
  // Call the Edge Function via supabase.functions.invoke('generate-mcp-token', { body: ... })
  // Return the response including the show-once token_secret
}

export async function revokeMcpToken(tokenId: string, userId: string): Promise<void> {
  // Direct Supabase update (RLS UPDATE policy allows workspace admins)
  // UPDATE workspace_mcp_tokens SET is_revoked = true, revoked_at = NOW(), revoked_by = userId WHERE id = tokenId
}
```

**Step 2: Create useMcpTokens.ts**

Follow the `useWorkspaces.ts` TanStack Query pattern with session-gated queries.

```typescript
// src/hooks/useMcpTokens.ts

export function useMcpTokens(workspaceId: string | undefined) {
  // queryKey: ['mcp-tokens', 'list', workspaceId]
  // enabled: !!session && !!workspaceId
  // queryFn: () => getMcpTokens(workspaceId!)
}

export function useGenerateMcpToken() {
  // useMutation wrapping generateMcpToken
  // onSuccess: invalidate ['mcp-tokens', 'list', variables.workspaceId]
}

export function useRevokeMcpToken() {
  // useMutation wrapping revokeMcpToken
  // onSuccess: invalidate ['mcp-tokens', 'list'] (all workspaces)
}
```

**Step 3: Create McpTokenRow.tsx**

Dense table row component (Airtable-style per CONTEXT.md decision).

```tsx
// src/components/workspace/McpTokenRow.tsx

// Props: token: McpToken, folders: Folder[], onRevoke: (tokenId: string) => void

// Render a table row with:
// - Name column: token.name (text-sm font-medium)
// - Scope column: badge showing workspace name or folder names
//   - If scoped_folder_ids is null: badge "Entire Workspace" with a neutral color
//   - If scoped_folder_ids has items: comma-joined folder names (look up from folders prop)
//   - If scoped_folder_ids is empty: badge "No Access" with a warning color
// - Last Used column:
//   - If null: "Never" in muted text
//   - If > 30 days ago: relative time with a warning indicator (amber dot or text color)
//     per CONTEXT.md: "Token list should make it obvious which tokens are active vs stale"
//   - Otherwise: relative time (e.g., "2 hours ago")
// - Created column: formatted date (e.g., "Feb 28, 2026")
// - Revoke column: destructive button "Revoke" with confirm dialog or inline confirm
//   Per CONTEXT.md: immediate revocation, no grace period
```

Use relative time formatting. If the project has a date formatting utility, use it. Otherwise use `Intl.RelativeTimeFormat` or a simple helper.

**Step 4: Create WorkspaceMcpPanel.tsx**

Main MCP tab content. Follow `WorkspaceMemberPanel.tsx` patterns.

```tsx
// src/components/workspace/WorkspaceMcpPanel.tsx

// Props: workspaceId: string, workspaceName: string

// Layout:
// - Header: "MCP Tokens" title + "Generate Token" button (primary style)
// - Table with columns: Name | Scope | Last Used | Created | Actions
//   - Use @/components/ui/table (Table, TableHeader, TableRow, etc.)
//   - Map over tokens, render McpTokenRow for each
// - Empty state: "No MCP tokens yet. Generate a token to connect your AI tools."
//   with a brief description of what MCP tokens do
// - Loading state: spinner or skeleton

// The "Generate Token" button opens the GenerateMcpTokenDialog (Task 2)
```

**Step 5: Wire into workspace detail page**

Read `src/routes/_authenticated/workspaces/$workspaceId.tsx` (already loaded above). Currently it renders `WorkspaceMemberPanel` directly. Add Radix Tabs to switch between Members and MCP tabs:

```tsx
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { WorkspaceMcpPanel } from '@/components/workspace/WorkspaceMcpPanel'

// In the component, replace the direct WorkspaceMemberPanel with:
<Tabs defaultValue="members">
  <TabsList>
    <TabsTrigger value="members">Members</TabsTrigger>
    <TabsTrigger value="mcp">MCP</TabsTrigger>
  </TabsList>
  <TabsContent value="members">
    <WorkspaceMemberPanel ... />
  </TabsContent>
  <TabsContent value="mcp">
    <WorkspaceMcpPanel
      workspaceId={workspaceId}
      workspaceName={workspace.name}
    />
  </TabsContent>
</Tabs>
```

Check if `@/components/ui/tabs` exists. If not, check if Radix Tabs is installed directly. Read `package.json` in `/Users/Naegele/dev/callvault/` to confirm available UI components.

Verify the build passes:
```bash
cd /Users/Naegele/dev/callvault && npm run build
```
  </action>
  <verify>
```bash
cd /Users/Naegele/dev/callvault && npm run build
```
Build passes with zero errors. The MCP tab appears in the workspace detail page.
  </verify>
  <done>Service layer, hooks, McpTokenRow, WorkspaceMcpPanel, and Tabs integration all built. Token list displays with name, scope badge, last-used, created, and revoke button. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Token creation dialog with scope selector and show-once display</name>
  <files>
    /Users/Naegele/dev/callvault/src/components/workspace/GenerateMcpTokenDialog.tsx
    /Users/Naegele/dev/callvault/src/components/workspace/WorkspaceMcpPanel.tsx
  </files>
  <action>
Read existing dialog patterns first:
- `src/components/dialogs/WorkspaceInviteDialog.tsx` for dialog structure
- `src/components/ui/dialog.tsx` for the Dialog component API
- Check if there's a `Select` or `Checkbox` component for folder selection

**Create GenerateMcpTokenDialog.tsx**

This dialog has two states:
1. **Form state** (before generation): name input + scope selector
2. **Show-once state** (after generation): token display + MCP config block + "I've copied it" button

```tsx
// src/components/workspace/GenerateMcpTokenDialog.tsx

// Props:
//   workspaceId: string
//   workspaceName: string
//   open: boolean
//   onOpenChange: (open: boolean) => void

// State:
//   step: 'form' | 'show-once'
//   name: string
//   scopeType: 'workspace' | 'folders'
//   selectedFolderIds: string[]
//   generatedToken: GenerateTokenResponse | null

// === FORM STATE ===

// Name field: required, 1-100 chars
// Label: "Token Name" with helper text "A descriptive name for this token (e.g., 'Claude Desktop - Sales')"

// Scope selector:
// - Radio group or segmented control: "Entire Workspace" | "Specific Folders"
// - If "Specific Folders" selected: show folder checklist
//   - Load folders via useFolders(workspaceId) hook (from Phase 16)
//   - Show checkbox for each folder with folder name
//   - At least one folder must be selected to proceed

// Generate button: calls useGenerateMcpToken mutation
// Loading state: button disabled with spinner during generation

// === SHOW-ONCE STATE ===

// After successful generation, switch to show-once view:

// 1. Success message: "Token created successfully"
// 2. Warning: "This is the only time the token will be shown. Copy it now."
//    with a warning icon and amber/yellow styling

// 3. Token secret display:
//    - Monospace font, full token visible
//    - Copy button next to it (copies token_secret to clipboard)
//    - Visual feedback on copy (checkmark or "Copied!")

// 4. MCP Config JSON Block (per CONTEXT.md: ready-to-paste, zero manual editing):
//    Show TWO config formats with copy buttons for each:
//
//    Format 1: "For Claude Desktop / Claude Code (via mcp-remote):"
//    {
//      "mcpServers": {
//        "callvault": {
//          "command": "npx",
//          "args": ["-y", "mcp-remote", "https://callvault-mcp.naegele412.workers.dev/mcp", "--header", "Authorization: Bearer <ACTUAL_TOKEN>"]
//        }
//      }
//    }
//
//    Format 2: "For clients with HTTP transport support:"
//    {
//      "mcpServers": {
//        "callvault": {
//          "transport": "streamable-http",
//          "url": "https://callvault-mcp.naegele412.workers.dev/mcp",
//          "headers": { "Authorization": "Bearer <ACTUAL_TOKEN>" }
//        }
//      }
//    }
//
//    Replace <ACTUAL_TOKEN> with the actual token_secret from the response.
//    Use a code block with monospace font and a copy button for each format.

// 5. "I've copied it" button:
//    - Primary/prominent styling
//    - Clicking it closes the dialog
//    - Per CONTEXT.md: "I've copied it" confirmation button dismisses the show-once view

// Dialog should NOT be closeable by clicking outside or pressing Escape when in show-once state
// (to prevent accidental dismissal before copying). Set onInteractOutside and onEscapeKeyDown
// to prevent close on the Dialog.Content in show-once state.

// When dialog closes (after "I've copied it"), reset all state for next use.
```

**Wire into WorkspaceMcpPanel:**

Update WorkspaceMcpPanel.tsx to:
1. Add state for dialog open/close
2. Pass the dialog component and wire the "Generate Token" button to open it
3. The dialog's onSuccess (after generation) should invalidate the token list query

**Copy-to-clipboard implementation:**

Use the `useClipboard` hook if it exists in the project (Phase 14 foundation created browser API hooks). Otherwise, use `navigator.clipboard.writeText()` with a try-catch and state for "Copied!" feedback.

Check if `useClipboard` exists:
```bash
ls /Users/Naegele/dev/callvault/src/hooks/useClipboard*
```

If it exists, use it. If not, create a simple inline implementation.

Verify build passes:
```bash
cd /Users/Naegele/dev/callvault && npm run build
```
  </action>
  <verify>
```bash
cd /Users/Naegele/dev/callvault && npm run build
```
Build passes with zero errors. GenerateMcpTokenDialog has both form and show-once states.
  </verify>
  <done>Token creation dialog built with name input, workspace/folder scope selector, show-once token display with copy button, two MCP config JSON blocks (mcp-remote and HTTP transport), and "I've copied it" dismissal button.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of MCP token management UI</name>
  <what-built>
Complete MCP token management UI in the workspace detail page:
- MCP tab alongside Members tab in workspace detail
- Token list table (Airtable-style) with name, scope badge, last-used, created, revoke button
- Generate Token dialog with name + scope selector
- Show-once token display with copy button and MCP config JSON blocks
- "I've copied it" confirmation to dismiss
- Revoke button with immediate effect
- Stale token indicator (> 30 days)
  </what-built>
  <how-to-verify>
1. Start dev server: `cd /Users/Naegele/dev/callvault && npm run dev`
2. Open http://localhost:8080 and log in
3. Navigate to a workspace detail page (click a workspace in the sidebar or go to /workspaces and click one)
4. Verify two tabs appear: "Members" and "MCP"
5. Click "MCP" tab -- should show empty state message
6. Click "Generate Token" button
7. In the dialog:
   a. Enter a name (e.g., "Claude Desktop - Sales")
   b. Select scope: "Entire Workspace" should be default
   c. Click Generate
8. Verify the show-once view appears:
   a. Token secret is visible in monospace
   b. Copy button works (copies to clipboard)
   c. Two MCP config JSON blocks shown (mcp-remote and HTTP transport)
   d. Config blocks contain the actual token (not a placeholder)
   e. "I've copied it" button is visible
9. Click "I've copied it" -- dialog closes
10. Verify the token appears in the list with correct name and scope
11. Click "Revoke" on the token -- confirm it disappears from the list
12. Try generating another token with "Specific Folders" scope:
    a. Select one or more folders
    b. Generate and verify the scope badge shows folder names

Type "approved" if everything works, or describe issues.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Workspace detail page has Members and MCP tabs
- MCP tab shows token list table with all required columns
- Generate Token dialog has name input and scope selector
- Show-once display shows token secret, copy button, and MCP config JSON
- "I've copied it" dismisses dialog
- Revoke removes token from list
- Stale tokens have visual indicator
- Build passes
</verification>

<success_criteria>
MCP-05 satisfied: Airtable-style token management UI with name, scope selector, show-once with "I've copied it", and MCP config block. MCP-06 satisfied: token list shows name, scope, last-used timestamp, and revoke button. User can complete full token lifecycle: generate, copy config, revoke.
</success_criteria>

<output>
After completion, create `.planning/phases/19-mcp-audit-workspace-tokens/19-05-SUMMARY.md`
</output>
