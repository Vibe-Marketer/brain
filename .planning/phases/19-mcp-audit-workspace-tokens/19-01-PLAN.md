---
phase: 19-mcp-audit-workspace-tokens
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/mcp-audit.md
autonomous: true

must_haves:
  truths:
    - "Every MCP tool, resource, and prompt is catalogued with current behavior documented"
    - "Each capability has a test result (pass, fail, or not_tested) from the live Worker"
    - "Gaps and issues are identified with actionable descriptions"
  artifacts:
    - path: ".planning/mcp-audit.md"
      provides: "Structured audit of all MCP capabilities"
      contains: "callvault_discover"
  key_links:
    - from: ".planning/mcp-audit.md"
      to: "https://callvault-mcp.naegele412.workers.dev/mcp"
      via: "curl verification commands"
      pattern: "test_result"
---

<objective>
Audit the deployed callvault-mcp Cloudflare Worker and produce a structured mcp-audit.md document cataloguing every tool, resource, and prompt with test results and gap analysis.

Purpose: MCP-01 requires a documented audit before building new MCP features. Building token infrastructure on top of undocumented or broken foundations creates debt. The audit also informs the naming migration (Plan 02) by identifying exactly what needs renaming.

Output: `.planning/mcp-audit.md` with pass/fail results for all 4 tools, 23 resources, and 6 prompts.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/MCP_ANALYSIS.md
@.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/12-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Read and catalogue all MCP capabilities from source</name>
  <files>.planning/mcp-audit.md</files>
  <action>
Read the deployed MCP Worker source at `/Users/Naegele/Developer/mcp/callvault-mcp/src/`:

1. Read `operations.json` — enumerate all categories and operations (expected: 16 operations across 6 categories: navigation, recordings, transcripts, search, contacts, analysis). For each operation, record: key, description, parameters (required and optional), and the handler function name.

2. Read `worker.ts` — catalogue the 4 registered tools: `callvault_discover`, `callvault_get_schema`, `callvault_execute`, `callvault_continue`. For each tool, record: name, description, parameter schema (Zod), and how it routes to handlers.

3. Read `prompts.ts` — catalogue all prompt templates (expected: 6 prompts based on MCP_ANALYSIS.md, but verify: call_analysis, meeting_prep, weekly_digest, action_items, sales_pipeline, person_summary). For each prompt, record: name, description, argument schema, and the instruction text.

4. Read `worker.ts` resource registrations — catalogue all MCP resources (expected: operations-index + per-category + per-operation = ~23). For each resource, record: URI pattern, name, description.

5. Read `handlers/navigation.ts`, `handlers/recordings.ts`, `handlers/transcripts.ts`, `handlers/search.ts`, `handlers/contacts.ts`, `handlers/analysis.ts` — for each handler, record: which Supabase tables it queries, what RLS patterns it uses, and any known limitations.

6. Read `auth-middleware.ts` — document the current authentication flow (JWT validation via jose/JWKS).

7. Read `utils.ts` — document the sessionsCache pagination pattern and its known limitation (in-memory, lost between Worker isolates).

Create `.planning/mcp-audit.md` with the following structure:

```markdown
# CallVault MCP Server Audit

**Audit Date:** 2026-02-28
**Worker URL:** https://callvault-mcp.naegele412.workers.dev/mcp
**Source:** /Users/Naegele/Developer/mcp/callvault-mcp/

## Summary

[Counts: N tools, N resources, N prompts, N operations]
[Architecture: stateless per-request McpServer factory, Cloudflare Worker, WebStandardStreamableHTTPServerTransport]

## Tools

### callvault_discover
- **Description:** [from source]
- **Parameters:** [from source]
- **Behavior:** [what it does]
- **Test Result:** [pass|fail|not_tested]
- **Notes:** [any issues]

[repeat for all 4 tools]

## Resources

### callvault://operations
[repeat for all resources]

## Prompts

### call_analysis
[repeat for all prompts]

## Operations Catalog

### Category: navigation
#### list_banks
- **Description:** [from source]
- **Parameters:** [from source]
- **Handler:** listBanks in navigation.ts
- **Tables:** bank_memberships, banks
- **Test Result:** [pass|fail|not_tested]
- **Naming Issues:** Uses old Bank/Vault terminology
[repeat for all 16 operations]

## Authentication
[Current auth flow documentation]

## Known Gaps
[List of identified gaps with severity and recommended fix]

## Naming Migration Inventory
[Complete list of strings/keys/descriptions that reference Bank/Vault/Hub and need updating]
```

Do NOT perform curl tests in this task -- just catalogue from source. Task 2 does the testing.
  </action>
  <verify>File `.planning/mcp-audit.md` exists and contains sections for all 4 tools, all resources, all prompts, and all 16 operations</verify>
  <done>Every MCP capability is catalogued from source code with handler details, table queries, and naming issues identified</done>
</task>

<task type="auto">
  <name>Task 2: Test capabilities against live Worker and update audit with results</name>
  <files>.planning/mcp-audit.md</files>
  <action>
Test the live Worker at `https://callvault-mcp.naegele412.workers.dev/mcp` using curl commands. You need a valid Supabase JWT to authenticate.

**Getting a test JWT:**
Read `.env.local` from `/Users/Naegele/dev/brain/` for `CALLVAULTAI_LOGIN` and `CALLVAULTAI_LOGIN_PASSWORD`. Use the Supabase auth API to get a session token:

```bash
curl -s -X POST "https://vltmrnjsubfzrgrtdqey.supabase.co/auth/v1/token?grant_type=password" \
  -H "apikey: $(grep VITE_SUPABASE_ANON_KEY /Users/Naegele/dev/brain/.env.local | cut -d= -f2)" \
  -H "Content-Type: application/json" \
  -d '{"email":"<EMAIL>","password":"<PASSWORD>"}' | python3 -m json.tool
```

Extract the `access_token` from the response.

**Test each tool with MCP JSON-RPC protocol:**

1. **Initialize** (required first):
```bash
curl -s -X POST https://callvault-mcp.naegele412.workers.dev/mcp \
  -H "Authorization: Bearer <TOKEN>" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-03-26","capabilities":{},"clientInfo":{"name":"audit","version":"1.0"}}}'
```

2. **callvault_discover** (list all categories):
```bash
curl -s -X POST https://callvault-mcp.naegele412.workers.dev/mcp \
  -H "Authorization: Bearer <TOKEN>" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -H "Mcp-Session-Id: <SESSION_ID>" \
  -d '{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"callvault_discover","arguments":{}}}'
```

3. **callvault_get_schema** (for at least 3 operations):
   Test with `navigation.list_banks`, `recordings.search`, `transcripts.raw`

4. **callvault_execute** (for at least 5 operations):
   - `navigation.list_banks` (no params)
   - `navigation.list_vaults` (with bank_id from previous result)
   - `recordings.list` (with vault_id)
   - `contacts.list` (no params)
   - `search.semantic` (with a query string)

5. **callvault_continue** — test with a pagination scenario if possible (large result set)

6. **Test resources** — list resources via `resources/list`

7. **Test prompts** — list prompts via `prompts/list`, then get a specific prompt via `prompts/get`

**Important notes:**
- The Worker uses Streamable HTTP, which may return SSE format. Handle `text/event-stream` responses by parsing the SSE data lines.
- If the MCP session requires `initialized` notification before tool calls, send it after the initialize response.
- Record actual response shapes (truncated if large) in the audit document.

**For each capability tested, update `.planning/mcp-audit.md`:**
- Change `test_result` from `not_tested` to `pass` or `fail`
- Add response excerpt or error message
- Note any unexpected behavior

**After all tests, update the Known Gaps section** with:
- Any tools that returned errors
- Any operations that returned unexpected data shapes
- The `callvault_continue` sessionsCache limitation (document as known gap)
- Authentication flow gaps (OAuth auto-discovery not tested end-to-end)
- Missing workspace-level scoping on certain operations
  </action>
  <verify>Run `grep -c "test_result" .planning/mcp-audit.md` to confirm every capability has a test result. Run `grep "pass\|fail" .planning/mcp-audit.md` to see results.</verify>
  <done>All 4 tools, representative operations, resources, and prompts tested against live Worker with pass/fail results documented. Known gaps section is complete with actionable descriptions.</done>
</task>

</tasks>

<verification>
- `.planning/mcp-audit.md` exists with structured sections
- All 4 tools catalogued with test results
- All 6 prompt templates catalogued
- All resources catalogued
- All 16 operations catalogued with handler, table, and naming issue details
- Known gaps section identifies at least: sessionsCache limitation, naming migration inventory, workspace scoping gaps
- Naming migration inventory is complete (every Bank/Vault/Hub string that needs updating)
</verification>

<success_criteria>
MCP-01 is satisfied: a documented audit exists listing every MCP tool, resource, and prompt with test results (pass/fail) and gaps identified. The naming migration inventory is ready for Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/19-mcp-audit-workspace-tokens/19-01-SUMMARY.md`
</output>
