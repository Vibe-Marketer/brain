---
phase: 08-growth-infrastructure
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/youtube-import/index.ts
autonomous: true

must_haves:
  truths:
    - "YouTube URL is validated and video ID extracted"
    - "Video metadata is fetched (title, channel, thumbnail, description)"
    - "Transcript is fetched via external API"
    - "Call record is created in fathom_calls with source_platform='youtube'"
    - "Transcript chunks and embeddings are triggered for processing"
  artifacts:
    - path: "supabase/functions/youtube-import/index.ts"
      provides: "YouTube import orchestration"
      contains: "source_platform.*youtube"
      min_lines: 120
  key_links:
    - from: "supabase/functions/youtube-import/index.ts"
      to: "youtube-api"
      via: "internal function call for video-details and transcript"
      pattern: "youtube-api"
    - from: "supabase/functions/youtube-import/index.ts"
      to: "fathom_calls"
      via: "insert with youtube source"
      pattern: "from\\('fathom_calls'\\)"
---

<objective>
Create YouTube import Edge Function for importing video transcripts as calls.

Purpose: Users can import YouTube videos as searchable call transcripts (GROW-03).
Output: youtube-import Edge Function that orchestrates fetch, store, and embed pipeline.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-growth-infrastructure/08-CONTEXT.md
@.planning/phases/08-growth-infrastructure/08-RESEARCH.md
@supabase/CLAUDE.md
@supabase/functions/youtube-api/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create youtube-import Edge Function</name>
  <files>supabase/functions/youtube-import/index.ts</files>
  <action>
Create orchestration function for YouTube video import.

Accept POST with body: { videoUrl: string }
Require auth (JWT from header).

**Step 1: Extract and validate video ID**
Support URL formats:
- https://www.youtube.com/watch?v=VIDEO_ID
- https://youtu.be/VIDEO_ID
- https://youtube.com/embed/VIDEO_ID
- Direct video ID (11 characters, alphanumeric + _ -)

Return 400 if URL is invalid.

**Step 2: Check for duplicate import**
Query fathom_calls where:
- user_id = user.id
- source_platform = 'youtube'
- metadata->>'youtube_video_id' = videoId

If exists, return { success: false, error: 'Video already imported', recordingId: existing.recording_id }

**Step 3: Fetch video details**
Call youtube-api function with action: 'video-details'
Extract: title, description, channelId, channelTitle, publishedAt, thumbnails, duration

**Step 4: Fetch transcript**
Call youtube-api function with action: 'transcript'
If transcript fetch fails, return { success: false, error: 'Transcript not available for this video' }

**Step 5: Create fathom_calls record**
Generate unique recording_id (use timestamp-based approach or query max + 1)
Insert into fathom_calls:
- user_id: from JWT
- recording_id: generated
- title: video title
- full_transcript: transcript text
- recording_start_time: video publishedAt date
- source_platform: 'youtube' (this is the key differentiator)
- url: original YouTube URL
- metadata (JSONB): {
    youtube_video_id: videoId,
    youtube_channel_id: channelId,
    youtube_channel_title: channelTitle,
    youtube_description: description (truncated to 1000 chars),
    youtube_thumbnail: thumbnails.high.url,
    youtube_duration: duration
  }

**Step 6: Return success**
Return {
  success: true,
  recordingId: recording_id,
  title: title,
  status: 'imported'
}

The existing embedding pipeline will pick up the new record for processing.

Follow supabase/CLAUDE.md conventions: CORS, auth, error handling.
  </action>
  <verify>
`ls supabase/functions/youtube-import/index.ts` exists
File contains: source_platform, youtube, fathom_calls insert
URL validation handles multiple formats
  </verify>
  <done>
youtube-import function validates URL, checks duplicates, fetches metadata and transcript, creates fathom_calls record with youtube source_platform.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add progress tracking support</name>
  <files>supabase/functions/youtube-import/index.ts</files>
  <action>
Enhance the import function to support frontend progress tracking.

Per CONTEXT.md: "Step-by-step progress (Fetching -> Transcribing -> Processing -> Done)"

Option A (Simple - Synchronous with status returns):
The function already runs steps sequentially. Frontend can show progress based on response.
Return different responses for different failure points:
- URL validation failed: { step: 'validating', error: '...' }
- Duplicate found: { step: 'checking', exists: true, recordingId: ... }
- Video fetch failed: { step: 'fetching', error: '...' }
- Transcript failed: { step: 'transcribing', error: '...' }
- Insert failed: { step: 'processing', error: '...' }
- Success: { step: 'done', recordingId: ..., title: ... }

Add step field to all responses so frontend can show appropriate progress indicator.

Option B (Complex - Async with job tracking):
Create import_jobs table to track progress - SKIP for MVP.

Go with Option A for simplicity. The import is fast enough (<10s typically) that polling isn't needed.
  </action>
  <verify>
All response objects include 'step' field
Error responses indicate which step failed
  </verify>
  <done>
All responses include step indicator for frontend progress display.
  </done>
</task>

</tasks>

<verification>
1. youtube-import function handles all URL formats
2. Duplicate detection works (same video can't be imported twice)
3. Video metadata stored in JSONB metadata field
4. source_platform = 'youtube' set correctly
5. Error responses include step for progress tracking
6. Function follows supabase/CLAUDE.md patterns
</verification>

<success_criteria>
- User can import any public YouTube video with available transcript
- Duplicate imports are detected and rejected gracefully
- Video appears in fathom_calls with youtube source_platform
- Frontend can show step-by-step progress based on response
- Video metadata (title, thumbnail, channel) is preserved
</success_criteria>

<output>
After completion, create `.planning/phases/08-growth-infrastructure/08-04-SUMMARY.md`
</output>
