---
phase: 08-growth-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - src/components/billing/PlanCards.tsx
  - src/components/billing/UpgradeButton.tsx
  - src/components/settings/BillingTab.tsx
  - src/hooks/useSubscription.ts
  - src/hooks/usePolarCustomer.ts
autonomous: true

must_haves:
  truths:
    - "User can see side-by-side plan comparison (Solo/Team/Business)"
    - "User can click upgrade button to start checkout flow"
    - "User sees their current subscription status in BillingTab"
    - "Free users see upgrade prompt in header"
  artifacts:
    - path: "src/components/billing/PlanCards.tsx"
      provides: "Side-by-side plan comparison cards"
      min_lines: 80
    - path: "src/components/billing/UpgradeButton.tsx"
      provides: "Upgrade CTA button component"
      min_lines: 30
    - path: "src/hooks/useSubscription.ts"
      provides: "Subscription state hook"
      exports: ["useSubscription"]
    - path: "src/hooks/usePolarCustomer.ts"
      provides: "Polar customer management hook"
      exports: ["usePolarCustomer"]
  key_links:
    - from: "src/components/billing/UpgradeButton.tsx"
      to: "polar-checkout"
      via: "supabase.functions.invoke"
      pattern: "invoke.*polar-checkout"
    - from: "src/hooks/useSubscription.ts"
      to: "user_profiles"
      via: "subscription fields query"
      pattern: "subscription_status|product_id"
---

<objective>
Create Polar billing UI components and hooks for plan management.

Purpose: Users can view plans, upgrade/downgrade, and see current subscription status.
Output: PlanCards component, UpgradeButton, subscription hooks, updated BillingTab.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-growth-infrastructure/08-CONTEXT.md
@.planning/phases/08-growth-infrastructure/08-RESEARCH.md
@.planning/phases/08-growth-infrastructure/08-02-SUMMARY.md
@src/CLAUDE.md
@src/components/settings/BillingTab.tsx
@docs/design/brand-guidelines-v4.2.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subscription and customer hooks</name>
  <files>
src/hooks/useSubscription.ts
src/hooks/usePolarCustomer.ts
  </files>
  <action>
**useSubscription.ts:**
Create hook to fetch and manage subscription state.

Query user_profiles for billing fields:
- subscription_id
- subscription_status  
- product_id
- current_period_end

Export interface SubscriptionState:
```typescript
interface SubscriptionState {
  isLoading: boolean;
  error: Error | null;
  subscriptionId: string | null;
  status: 'active' | 'canceled' | 'trialing' | 'past_due' | 'unpaid' | 'free' | null;
  productId: string | null;
  periodEnd: Date | null;
  tier: 'free' | 'solo' | 'team' | 'business';
  canUpgrade: boolean;
  canDowngrade: boolean;
}
```

Derive `tier` from product_id (solo-monthly -> 'solo', team-annual -> 'team', etc.)
Derive `canUpgrade`/`canDowngrade` based on tier hierarchy.

Use TanStack Query with queryKey: ['subscription', userId]

**usePolarCustomer.ts:**
Create hook for Polar customer management.

Query user_profiles for polar_customer_id.
If null, call polar-create-customer Edge Function on demand.

Export:
- customerId: string | null
- isCreating: boolean
- ensureCustomer: () => Promise<string> - Creates if needed, returns ID
  </action>
  <verify>
Files exist: `ls src/hooks/useSubscription.ts src/hooks/usePolarCustomer.ts`
Both export their main hooks
  </verify>
  <done>
useSubscription provides derived tier and upgrade/downgrade flags. usePolarCustomer handles lazy customer creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PlanCards and UpgradeButton components</name>
  <files>
src/components/billing/PlanCards.tsx
src/components/billing/UpgradeButton.tsx
  </files>
  <action>
**PlanCards.tsx:**
Create side-by-side plan comparison component per CONTEXT.md decisions.

Display 3 tiers: Solo ($29/mo), Team ($99/mo), Business ($249/mo)
Each card shows:
- Plan name and price
- Feature list (bullet points)
- CTA button (current plan badge OR upgrade button)

Highlight current plan with different styling (border, badge).
Use brand guidelines: Inter font, proper spacing, card shadows.

Props:
- currentTier: 'free' | 'solo' | 'team' | 'business'
- onUpgrade: (productId: string) => void
- isLoading: boolean

**UpgradeButton.tsx:**
Standalone upgrade CTA for use in header (free users) and billing page.

Props:
- productId: string - Which plan to upgrade to
- children: ReactNode - Button text
- variant: 'default' | 'outline' - Visual style

On click:
1. Call usePolarCustomer().ensureCustomer() 
2. Call polar-checkout Edge Function with productId
3. Redirect to returned checkoutUrl
4. Handle errors with toast

Use sonner for loading/error toasts.
  </action>
  <verify>
Files exist: `ls src/components/billing/PlanCards.tsx src/components/billing/UpgradeButton.tsx`
PlanCards renders 3 plan cards
UpgradeButton calls polar-checkout on click
  </verify>
  <done>
PlanCards shows side-by-side tier comparison. UpgradeButton handles full checkout flow with error handling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update BillingTab with Polar integration</name>
  <files>src/components/settings/BillingTab.tsx</files>
  <action>
Update existing BillingTab to integrate Polar billing.

Changes:
1. Import and use useSubscription hook for current plan display
2. Replace static plan info with dynamic subscription state
3. Add PlanCards component in "All Plans" section with working upgrade buttons
4. Remove "Coming Soon - Stripe Integration" badge (Polar is now live)
5. Add subscription management section showing:
   - Current plan with active/canceled status
   - Period end date if subscribed
   - Renewal/cancellation info

Keep existing AI Usage section (useEmbeddingCosts) - that stays unchanged.

Add loading states with Skeleton components.
Handle error states gracefully.

Per CONTEXT.md: Users can downgrade immediately, excess features become read-only.
Show downgrade notice if user is on higher tier viewing lower tier card.
  </action>
  <verify>
BillingTab imports useSubscription
PlanCards component is rendered
"Coming Soon" badge is removed
  </verify>
  <done>
BillingTab shows real subscription state, working upgrade buttons, plan comparison with PlanCards component.
  </done>
</task>

</tasks>

<verification>
1. useSubscription returns correct tier derived from product_id
2. usePolarCustomer creates customer on demand
3. PlanCards displays all 3 tiers with correct pricing
4. UpgradeButton initiates checkout flow
5. BillingTab shows current subscription status
6. No TypeScript errors in new components
</verification>

<success_criteria>
- Users can see their current plan in BillingTab
- Users can view all plans side-by-side
- Clicking upgrade initiates Polar checkout
- Free users have upgrade path visible
- Subscription state updates after checkout (via polar-customer-state)
</success_criteria>

<output>
After completion, create `.planning/phases/08-growth-infrastructure/08-03-SUMMARY.md`
</output>
