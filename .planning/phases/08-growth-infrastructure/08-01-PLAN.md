---
phase: 08-growth-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/YYYYMMDDHHMMSS_add_polar_billing_fields.sql
  - supabase/functions/_shared/polar-client.ts
  - src/integrations/supabase/types.ts
autonomous: true
user_setup:
  - service: polar
    why: "Subscription billing provider"
    env_vars:
      - name: POLAR_ACCESS_TOKEN
        source: "Polar Dashboard -> Settings -> Access Tokens"
      - name: POLAR_ORGANIZATION_ID
        source: "Polar Dashboard -> Settings -> Organization ID"
      - name: POLAR_WEBHOOK_SECRET
        source: "Polar Dashboard -> Settings -> Webhooks -> Create webhook"
    dashboard_config:
      - task: "Create 3 products: Solo ($29/mo), Team ($99/mo), Business ($249/mo)"
        location: "Polar Dashboard -> Products"
      - task: "Configure webhook endpoint URL"
        location: "Polar Dashboard -> Settings -> Webhooks"

must_haves:
  truths:
    - "Profiles table has Polar billing fields (polar_customer_id, subscription_id, subscription_status, product_id, current_period_end)"
    - "Polar SDK client can be instantiated in Edge Functions"
    - "TypeScript types reflect new billing schema"
  artifacts:
    - path: "supabase/migrations/*_add_polar_billing_fields.sql"
      provides: "Database schema for Polar integration"
      contains: "polar_customer_id"
    - path: "supabase/functions/_shared/polar-client.ts"
      provides: "Shared Polar SDK initialization"
      exports: ["getPolarClient", "POLAR_ORG_ID"]
  key_links:
    - from: "supabase/functions/_shared/polar-client.ts"
      to: "Deno.env"
      via: "environment variable access"
      pattern: "Deno\\.env\\.get\\('POLAR_"
---

<objective>
Add Polar billing infrastructure: database schema migration and shared SDK client.

Purpose: Foundation for 3-tier billing system (Solo/Team/Business) using Polar as payment provider.
Output: Migration file adding billing fields to user_profiles, shared polar-client.ts module for Edge Functions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-growth-infrastructure/08-CONTEXT.md
@.planning/phases/08-growth-infrastructure/08-RESEARCH.md
@supabase/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for Polar billing fields</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_add_polar_billing_fields.sql</files>
  <action>
Create migration file with timestamp format YYYYMMDDHHMMSS (use current date/time).

Add these columns to user_profiles table:
- polar_customer_id (UUID, nullable) - Polar's internal customer ID for API calls
- polar_external_id (TEXT, nullable) - App's user ID (maps to auth.users.id)
- subscription_id (UUID, nullable) - Active subscription ID (null if free tier)
- subscription_status (TEXT, nullable, CHECK constraint for valid values) - Values: 'active', 'canceled', 'revoked', 'incomplete', 'incomplete_expired', 'trialing', 'past_due', 'unpaid'
- product_id (TEXT, nullable) - Product key identifying tier (e.g., 'solo-monthly', 'team-annual')
- current_period_end (TIMESTAMPTZ, nullable) - Subscription renewal date

Add indexes:
- idx_user_profiles_polar_customer_id ON user_profiles(polar_customer_id) WHERE polar_customer_id IS NOT NULL
- idx_user_profiles_subscription_status ON user_profiles(subscription_status) WHERE subscription_status IS NOT NULL

Follow existing migration conventions from supabase/CLAUDE.md (comments, RLS awareness).
  </action>
  <verify>
Run: `ls supabase/migrations/*polar*.sql` - file should exist
Check file contains: polar_customer_id, subscription_status, CHECK constraint, indexes
  </verify>
  <done>
Migration file exists with all 6 billing columns, appropriate CHECK constraint on subscription_status, and 2 indexes created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared Polar SDK client module</name>
  <files>supabase/functions/_shared/polar-client.ts</files>
  <action>
Create shared module for Polar SDK initialization following Edge Function conventions.

Import Polar SDK using npm: specifier pattern (Deno-compatible):
```typescript
import { Polar } from 'npm:@polar-sh/sdk';
```

Export:
1. getPolarClient() function - Returns configured Polar instance with access token
2. POLAR_ORG_ID constant - Organization ID from environment
3. Type exports for webhook event types (WebhookSubscriptionActivePayload, etc.)

Include JSDoc comments explaining:
- Why this exists (centralized client for all Polar operations)
- Required environment variables (POLAR_ACCESS_TOKEN, POLAR_ORGANIZATION_ID)

Handle missing env vars with clear error messages (throw if not configured).
  </action>
  <verify>
Check file exists: `cat supabase/functions/_shared/polar-client.ts`
Verify npm: import pattern present
Verify getPolarClient export
  </verify>
  <done>
polar-client.ts exports getPolarClient() function and POLAR_ORG_ID constant, uses npm:@polar-sh/sdk import pattern, handles missing env vars.
  </done>
</task>

<task type="auto">
  <name>Task 3: Regenerate Supabase types</name>
  <files>src/integrations/supabase/types.ts</files>
  <action>
After migration is ready, regenerate TypeScript types to include new billing fields.

Run: `npx supabase gen types typescript --local > src/integrations/supabase/types.ts`

If the above fails (local DB not running), manually add the new columns to the user_profiles type definition by examining the migration and adding:
- polar_customer_id: string | null
- polar_external_id: string | null  
- subscription_id: string | null
- subscription_status: string | null (document CHECK constraint values in comment)
- product_id: string | null
- current_period_end: string | null

to Row, Insert, and Update interfaces.
  </action>
  <verify>
Grep for polar_customer_id in types.ts: `grep -c "polar_customer_id" src/integrations/supabase/types.ts` should return > 0
  </verify>
  <done>
user_profiles type in types.ts includes all 6 new billing fields in Row, Insert, and Update interfaces.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists with correct naming convention
2. Migration contains all 6 billing columns with proper types
3. polar-client.ts compiles (no TypeScript errors in isolation)
4. Types file includes new billing fields
</verification>

<success_criteria>
- Database schema ready for Polar billing integration
- Shared Polar client module usable by Edge Functions
- TypeScript types reflect new schema
- All required environment variables documented
</success_criteria>

<output>
After completion, create `.planning/phases/08-growth-infrastructure/08-01-SUMMARY.md`
</output>
