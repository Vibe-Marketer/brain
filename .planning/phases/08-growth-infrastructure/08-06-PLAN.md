---
phase: 08-growth-infrastructure
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/YYYYMMDDHHMMSS_add_admin_cost_function.sql
  - src/hooks/useAdminCosts.ts
  - src/components/settings/AdminCostDashboard.tsx
  - src/components/settings/SettingsLayout.tsx
autonomous: true

must_haves:
  truths:
    - "Admin users can see aggregated cost data across all users"
    - "Dashboard shows breakdown by model, feature, and user"
    - "Time period filtering works (this month, last month, all time)"
    - "Non-admin users cannot access admin cost dashboard"
  artifacts:
    - path: "supabase/migrations/*_add_admin_cost_function.sql"
      provides: "RPC function for admin cost aggregation"
      contains: "get_admin_cost_summary"
    - path: "src/hooks/useAdminCosts.ts"
      provides: "Admin cost data hook"
      exports: ["useAdminCosts"]
    - path: "src/components/settings/AdminCostDashboard.tsx"
      provides: "Admin cost visualization"
      min_lines: 100
  key_links:
    - from: "src/hooks/useAdminCosts.ts"
      to: "get_admin_cost_summary"
      via: "RPC call"
      pattern: "rpc.*get_admin_cost_summary"
    - from: "src/components/settings/AdminCostDashboard.tsx"
      to: "useAdminCosts"
      via: "hook consumption"
      pattern: "useAdminCosts"
---

<objective>
Create admin cost tracking dashboard for complete AI cost visibility (GROW-05).

Purpose: Admins can see AI costs across all users with breakdowns by model, feature, and user.
Output: RPC function for aggregation, useAdminCosts hook, AdminCostDashboard component.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-growth-infrastructure/08-CONTEXT.md
@.planning/phases/08-growth-infrastructure/08-RESEARCH.md
@src/CLAUDE.md
@src/hooks/useAICosts.ts
@src/components/settings/BillingTab.tsx
@supabase/functions/_shared/usage-tracker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin cost aggregation RPC function</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_add_admin_cost_function.sql</files>
  <action>
Create migration with RPC function for admin-level cost aggregation.

Function: get_admin_cost_summary(p_period TEXT DEFAULT 'month')

Parameters:
- p_period: 'month' (current month), 'last_month', 'all' (all time)

Returns TABLE with:
- model_breakdown: JSONB array of { model, cost_cents, requests, tokens }
- feature_breakdown: JSONB array of { operation_type, cost_cents, requests }
- user_breakdown: JSONB array of { user_id, email, cost_cents, requests } - top 20 users by cost
- total_cost_cents: NUMERIC
- total_tokens: BIGINT
- total_requests: BIGINT

Security:
- SECURITY DEFINER to bypass RLS for admin aggregation
- Check calling user has ADMIN role before returning data
- Return empty results for non-admin callers

Implementation:
1. Calculate date range based on p_period
2. Query embedding_usage_logs with date filter
3. Aggregate by model using GROUP BY
4. Aggregate by operation_type using GROUP BY
5. Aggregate by user_id, join with user_profiles for email
6. Calculate totals
7. Return as single row with JSONB columns

Use existing indexes on embedding_usage_logs (created_at, user_id).
  </action>
  <verify>
`ls supabase/migrations/*admin_cost*.sql` exists
File contains: get_admin_cost_summary, SECURITY DEFINER, role check
  </verify>
  <done>
RPC function exists with period filtering, role-based access control, and proper aggregations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useAdminCosts hook</name>
  <files>src/hooks/useAdminCosts.ts</files>
  <action>
Create hook for admin cost data following existing useAICosts pattern.

Export type AdminCostPeriod = 'month' | 'last_month' | 'all'

Export interface AdminCostData:
```typescript
interface AdminCostData {
  byModel: { model: string; costCents: number; requests: number; tokens: number }[];
  byFeature: { feature: string; costCents: number; requests: number }[];
  byUser: { userId: string; email: string; costCents: number; requests: number }[];
  totals: { costCents: number; tokens: number; requests: number };
}
```

Use TanStack Query:
- queryKey: ['admin-costs', period]
- Call supabase.rpc('get_admin_cost_summary', { p_period: period })
- Transform JSONB response to typed arrays
- staleTime: 5 minutes (admin data doesn't need real-time updates)

Add centsToUsd helper function (reuse from useAICosts if possible).

Handle errors gracefully - if RPC returns empty (non-admin), return empty data.
  </action>
  <verify>
`ls src/hooks/useAdminCosts.ts` exists
File exports useAdminCosts hook
Hook calls get_admin_cost_summary RPC
  </verify>
  <done>
useAdminCosts hook fetches admin aggregation data with period filtering.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AdminCostDashboard component and integrate</name>
  <files>
src/components/settings/AdminCostDashboard.tsx
src/components/settings/SettingsLayout.tsx
  </files>
  <action>
**AdminCostDashboard.tsx:**
Create admin cost visualization component per CONTEXT.md: "Settings > Admin tab"

Props: none (uses useAdminCosts internally)

Features:
1. Period selector: This Month | Last Month | All Time (tabs or dropdown)
2. Summary cards: Total Cost (USD), Total Requests, Total Tokens
3. By Model breakdown: Table or bar chart showing cost per model
4. By Feature breakdown: Table showing cost per operation_type (chat, embedding, search, enrichment)
5. By User breakdown: Table showing top users by cost (user email, cost, requests)

Use existing Tremor components (BarChart) for consistency with BillingTab.
Use Skeleton components for loading states.

Format costs with appropriate precision (use formatUsd from BillingTab pattern).
Format tokens with K/M suffixes (use formatTokens pattern).

**SettingsLayout.tsx:**
Find where settings tabs are defined.
Add AdminCostDashboard to Admin tab, visible only to ADMIN role users.

Conditional rendering:
- Use useUserRole hook to check isAdmin
- Only render AdminCostDashboard section if isAdmin === true

Place admin cost dashboard in a new "System Costs" section within Admin tab.
  </action>
  <verify>
`ls src/components/settings/AdminCostDashboard.tsx` exists
Component renders period selector and cost breakdowns
Admin tab includes AdminCostDashboard for admin users
  </verify>
  <done>
AdminCostDashboard shows complete cost breakdown. Admin tab displays it for ADMIN role users only.
  </done>
</task>

</tasks>

<verification>
1. RPC function returns correct aggregations
2. useAdminCosts hook transforms data correctly
3. AdminCostDashboard displays all breakdowns
4. Period selector changes data
5. Non-admin users see nothing (empty state or hidden section)
6. Cost formatting is consistent with existing BillingTab
</verification>

<success_criteria>
- Admin can see total AI costs across all users
- Costs are broken down by model (which models cost most)
- Costs are broken down by feature (chat vs embedding vs search)
- Costs are broken down by user (who is using most)
- Time period filtering works
- Non-admins cannot access this data
</success_criteria>

<output>
After completion, create `.planning/phases/08-growth-infrastructure/08-06-SUMMARY.md`
</output>
