---
phase: 16-workspace-redesign
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - /Users/Naegele/dev/callvault/src/stores/orgContextStore.ts
  - /Users/Naegele/dev/callvault/src/hooks/useOrgContext.ts
  - /Users/Naegele/dev/callvault/src/services/organizations.service.ts
  - /Users/Naegele/dev/callvault/src/services/workspaces.service.ts
  - /Users/Naegele/dev/callvault/src/hooks/useOrganizations.ts
  - /Users/Naegele/dev/callvault/src/hooks/useWorkspaces.ts
autonomous: true

must_haves:
  truths:
    - "User can fetch their organizations and workspaces from Supabase"
    - "Active organization and workspace IDs are tracked in a Zustand store"
    - "Switching organization resets activeWorkspaceId to null (clean slate per locked decision)"
    - "Personal organization is identified by type field (not by name)"
  artifacts:
    - path: "/Users/Naegele/dev/callvault/src/stores/orgContextStore.ts"
      provides: "Zustand store for active org/workspace/folder IDs with cross-tab sync"
      contains: "activeOrgId"
    - path: "/Users/Naegele/dev/callvault/src/services/organizations.service.ts"
      provides: "Service functions for fetching orgs: getOrganizations(), getOrganizationById()"
      exports: ["getOrganizations", "getOrganizationById"]
    - path: "/Users/Naegele/dev/callvault/src/services/workspaces.service.ts"
      provides: "Service functions for workspaces: getWorkspaces(orgId), createWorkspace(), etc."
      exports: ["getWorkspaces", "createWorkspace"]
    - path: "/Users/Naegele/dev/callvault/src/hooks/useOrganizations.ts"
      provides: "TanStack Query hooks for organizations"
      exports: ["useOrganizations", "useCreateOrganization"]
    - path: "/Users/Naegele/dev/callvault/src/hooks/useWorkspaces.ts"
      provides: "TanStack Query hooks for workspaces within active org"
      exports: ["useWorkspaces", "useCreateWorkspace"]
  key_links:
    - from: "/Users/Naegele/dev/callvault/src/stores/orgContextStore.ts"
      to: "/Users/Naegele/dev/callvault/src/hooks/useWorkspaces.ts"
      via: "activeOrgId determines which workspaces to fetch"
      pattern: "activeOrgId"
    - from: "/Users/Naegele/dev/callvault/src/services/organizations.service.ts"
      to: "supabase.from('banks')"
      via: "Queries banks table, returns as Organization type"
      pattern: "from\\('banks'\\)"
    - from: "/Users/Naegele/dev/callvault/src/services/workspaces.service.ts"
      to: "supabase.from('vaults')"
      via: "Queries vaults table filtered by bank_id (orgId), returns as Workspace type"
      pattern: "from\\('vaults'\\)"
---

<objective>
Create the data layer for organizations and workspaces: Zustand context store, Supabase service functions, and TanStack Query hooks.

Purpose: All subsequent plans (navigation, folders, invites, onboarding) depend on being able to fetch org/workspace data and track which org/workspace is active. This is the data backbone of the entire phase.

Output: orgContextStore (Zustand), service layers for orgs and workspaces, TanStack Query hooks for both.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/ROADMAP.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-CONTEXT.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-RESEARCH.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-01-SUMMARY.md
@/Users/Naegele/dev/callvault/src/stores/preferencesStore.ts
@/Users/Naegele/dev/callvault/src/services/recordings.service.ts
@/Users/Naegele/dev/callvault/src/hooks/useRecordings.ts
@/Users/Naegele/dev/callvault/src/hooks/useAuth.tsx
@/Users/Naegele/dev/callvault/src/lib/query-config.ts
@/Users/Naegele/dev/callvault/src/types/workspace.ts
@/Users/Naegele/dev/brain/src/stores/bankContextStore.ts
@/Users/Naegele/dev/brain/src/hooks/useBankContext.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Org context store and organization service/hooks</name>
  <files>
    /Users/Naegele/dev/callvault/src/stores/orgContextStore.ts
    /Users/Naegele/dev/callvault/src/services/organizations.service.ts
    /Users/Naegele/dev/callvault/src/hooks/useOrganizations.ts
    /Users/Naegele/dev/callvault/src/hooks/useOrgContext.ts
  </files>
  <action>
    **src/stores/orgContextStore.ts** — Zustand v5 store tracking active org/workspace/folder context. Model after existing `preferencesStore.ts` (Zustand v5 double-invocation pattern: `create<T>()(...)`) and v1's `bankContextStore.ts` (for the bank/vault state management pattern).

    State shape:
    ```typescript
    interface OrgContextState {
      activeOrgId: string | null
      activeWorkspaceId: string | null
      activeFolderId: string | null
      isInitialized: boolean

      setActiveOrg: (orgId: string) => void        // MUST reset activeWorkspaceId to null (locked decision)
      setActiveWorkspace: (workspaceId: string) => void  // MUST reset activeFolderId to null
      setActiveFolder: (folderId: string | null) => void
      initialize: (orgId: string, workspaceId?: string) => void
      reset: () => void
    }
    ```

    CRITICAL per locked decision: `setActiveOrg` MUST set `activeWorkspaceId = null` and `activeFolderId = null`. "Switching organizations resets the view to that org's workspace list. No position memory across orgs — clean slate each time."

    Persist `activeOrgId` and `activeWorkspaceId` to localStorage for cross-tab sync (same pattern as preferencesStore: write to localStorage on change, listen for storage events). Key: `callvault-org-context`.

    **src/services/organizations.service.ts** — Service layer for organizations. Follow the established pattern from `recordings.service.ts` (plain async functions, Supabase client passed or imported).

    Functions:
    - `getOrganizations(supabase, userId)` — Query `banks` table via `bank_memberships` join for the user. Return as `Organization[]`. Include membership role in response for UI (need to know if user is owner/admin).
    - `getOrganizationById(supabase, orgId)` — Single org fetch from `banks` by id.
    - `createOrganization(supabase, userId, name)` — Insert into `banks`, create `bank_memberships` with role 'bank_owner', return new org.
    - `isPersonalOrg(org: Organization)` — Helper: returns true if org.type === 'personal' (check v1 bank.ts for the actual type field value).

    All queries use `supabase.from('banks')` — never reference 'organizations' as a table name.

    **src/hooks/useOrganizations.ts** — TanStack Query hooks:
    - `useOrganizations()` — Fetches all orgs for current user. Uses `queryKeys.organizations.list()`. Enabled only when session exists (pattern from useRecordings).
    - `useCreateOrganization()` — Mutation that calls createOrganization service, invalidates organizations.all on success.

    **src/hooks/useOrgContext.ts** — Convenience hook combining store + data:
    - Returns `{ activeOrg, organizations, activeWorkspace, workspaces, isPersonalOrg, switchOrg, switchWorkspace, ... }`
    - On first load: if no activeOrgId, auto-select the personal org. If no personal org, select first org.
    - Provides `switchOrg(orgId)` which calls store.setActiveOrg (triggers the reset).
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds
    2. `grep "activeWorkspaceId: null" src/stores/orgContextStore.ts` confirms the reset pattern exists in setActiveOrg
    3. `grep "from('banks')" src/services/organizations.service.ts` confirms queries use banks table
  </verify>
  <done>
    orgContextStore tracks active org/workspace/folder with cross-tab localStorage sync. Organization service queries banks table. useOrganizations hook fetches orgs. useOrgContext provides combined data+state. Org switch resets workspace to null.
  </done>
</task>

<task type="auto">
  <name>Task 2: Workspace service and hooks</name>
  <files>
    /Users/Naegele/dev/callvault/src/services/workspaces.service.ts
    /Users/Naegele/dev/callvault/src/hooks/useWorkspaces.ts
  </files>
  <action>
    **src/services/workspaces.service.ts** — Service layer for workspaces. All queries use `supabase.from('vaults')`.

    Functions:
    - `getWorkspaces(supabase, orgId)` — Query `vaults` where `bank_id = orgId`. Return as `Workspace[]`. Include `is_default` field. Order by: is_default DESC (default workspace first), then name ASC.
    - `getWorkspaceById(supabase, workspaceId)` — Single workspace fetch.
    - `createWorkspace(supabase, orgId, userId, name, isDefault = false)` — Insert into `vaults` with bank_id = orgId. Create vault_membership for the user as vault_owner. If isDefault, set is_default = true.
    - `getWorkspaceMembers(supabase, workspaceId)` — Query `vault_memberships` joined with auth.users for display names. Return members with role, display_name, email, joined_at.
    - `updateMemberRole(supabase, workspaceId, userId, newRole)` — Update vault_memberships role.
    - `removeMember(supabase, workspaceId, userId)` — Delete from vault_memberships.

    **src/hooks/useWorkspaces.ts** — TanStack Query hooks:
    - `useWorkspaces(orgId)` — Fetches workspaces for org. Uses `queryKeys.workspaces.list()`. Enabled only when orgId is not null.
    - `useWorkspace(workspaceId)` — Single workspace detail.
    - `useCreateWorkspace()` — Mutation. On success: invalidate workspaces.all, set new workspace as active in orgContextStore.
    - `useWorkspaceMembers(workspaceId)` — Fetches members list.
    - `useUpdateMemberRole()` — Mutation for role changes.
    - `useRemoveMember()` — Mutation for member removal.

    Ensure hooks follow the established pattern from `useRecordings.ts`: session-gated `enabled` prop, proper error typing.
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds
    2. `grep "from('vaults')" src/services/workspaces.service.ts` confirms queries use vaults table
    3. `grep "useWorkspaces" src/hooks/useWorkspaces.ts` shows the hook exists
  </verify>
  <done>
    Workspace service queries vaults table with org filtering. Hooks provide useWorkspaces(orgId), useCreateWorkspace, useWorkspaceMembers, useUpdateMemberRole, useRemoveMember. All follow established TanStack Query patterns with session gating. Build passes clean.
  </done>
</task>

</tasks>

<verification>
- orgContextStore correctly resets workspace/folder on org switch
- Organization service fetches from banks table (never 'organizations' table)
- Workspace service fetches from vaults table (never 'workspaces' table)
- All hooks follow useRecordings pattern (session-gated enabled)
- localStorage cross-tab sync works for org context
- pnpm build passes clean
</verification>

<success_criteria>
1. Org context store tracks activeOrgId/activeWorkspaceId/activeFolderId with localStorage persistence
2. Org switch resets workspace to null (locked decision honored)
3. Service functions query banks/vaults tables (not renamed tables)
4. TanStack Query hooks are session-gated and use queryKeys factory
5. Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-workspace-redesign/16-02-SUMMARY.md`
</output>
