---
phase: 16-workspace-redesign
plan: 07
type: execute
wave: 5
depends_on: ["16-03", "16-04", "16-05", "16-06"]
files_modified:
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/workspaces/index.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/workspaces/$workspaceId.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/calls/$callId.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/folders/$folderId.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/settings/$category.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/import/index.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/sharing/index.tsx
  - /Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
  - /Users/Naegele/dev/callvault/src/components/layout/WorkspaceSidebarPane.tsx
autonomous: false

must_haves:
  truths:
    - "Zero instances of Bank, Vault, or Hub visible anywhere in the UI"
    - "All route pages use Organization/Workspace/Folder terminology consistently"
    - "Workspace settings page includes WorkspaceMemberPanel"
    - "DnD call-to-folder works on desktop calls list"
    - "Action menu on call rows includes Move to Folder option"
    - "Folder route page shows folder contents with breadcrumbs"
    - "Workspace detail page shows workspace info with member management access"
    - "Sidebar folder list updates in real-time after folder create/rename/archive operations"
    - "Supabase Auth email templates do not contain Bank/Vault/Hub terminology"
  artifacts:
    - path: "/Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx"
      provides: "Home page with DnD-enabled calls list, workspace sidebar, breadcrumbs, action menus"
      contains: "DndCallProvider"
    - path: "/Users/Naegele/dev/callvault/src/routes/_authenticated/workspaces/$workspaceId.tsx"
      provides: "Workspace detail with member panel access"
      contains: "WorkspaceMemberPanel"
    - path: "/Users/Naegele/dev/callvault/src/routes/_authenticated/settings/$category.tsx"
      provides: "Settings with organizations category for org management"
      contains: "Organization"
    - path: "/Users/Naegele/dev/callvault/src/components/layout/WorkspaceSidebarPane.tsx"
      provides: "Sidebar using useFolders hook (not inline query) for proper cache invalidation"
      contains: "useFolders"
  key_links:
    - from: "/Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx"
      to: "/Users/Naegele/dev/callvault/src/components/dnd/DndCallProvider.tsx"
      via: "DndCallProvider wraps calls list for drag-to-folder"
      pattern: "DndCallProvider"
    - from: "/Users/Naegele/dev/callvault/src/routes/_authenticated/workspaces/$workspaceId.tsx"
      to: "/Users/Naegele/dev/callvault/src/components/workspace/WorkspaceMemberPanel.tsx"
      via: "Workspace detail includes member management"
      pattern: "WorkspaceMemberPanel"
    - from: "/Users/Naegele/dev/callvault/src/components/layout/WorkspaceSidebarPane.tsx"
      to: "/Users/Naegele/dev/callvault/src/hooks/useFolders.ts"
      via: "Sidebar uses useFolders hook for cache-coherent folder data"
      pattern: "useFolders\\(activeWorkspaceId\\)"
---

<objective>
Complete the full integration: wire all route pages with new components, terminology sweep, DnD integration, action menus, fix sidebar folder query for cache coherence, audit email templates, and human verification of the complete workspace redesign.

Purpose: This is the final assembly plan. All building blocks exist (navigation, folders, invites, onboarding). This plan wires them into every route page, performs the WKSP-01/02/03 terminology sweep (including Supabase Auth email templates), integrates DnD into the calls list, adds action menus for folder assignment, fixes the sidebar's inline folder query to use the shared useFolders hook for real-time updates, and includes a human verification checkpoint.

Output: All authenticated route pages updated with new terminology and components. Complete Phase 16 UX.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-CONTEXT.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-RESEARCH.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-03-SUMMARY.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-04-SUMMARY.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-05-SUMMARY.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-06-SUMMARY.md
@/Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
@/Users/Naegele/dev/callvault/src/routes/_authenticated/workspaces/$workspaceId.tsx
@/Users/Naegele/dev/callvault/src/routes/_authenticated/settings/$category.tsx
@/Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
@/Users/Naegele/dev/callvault/src/components/layout/WorkspaceSidebarPane.tsx
@/Users/Naegele/dev/callvault/src/hooks/useFolders.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DnD integration, action menus, sidebar folder query fix, and calls list enhancement</name>
  <files>
    /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/calls/$callId.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/folders/$folderId.tsx
    /Users/Naegele/dev/callvault/src/components/layout/WorkspaceSidebarPane.tsx
  </files>
  <action>
    **CRITICAL — Fix WorkspaceSidebarPane folder query (Blocker):**

    Plan 03 created WorkspaceSidebarPane with an inline folder query (e.g., `supabase.from('folders').select(...)` inside the component or a useQuery with a local queryKey). Plan 04 created the `useFolders(workspaceId)` hook with proper cache management via `queryKeys.folders.list(workspaceId)`. Folder mutations in Plan 04 (useCreateFolder, useRenameFolder, useArchiveFolder) invalidate the `queryKeys.folders` cache — but the sidebar's inline query uses a DIFFERENT cache key, so folder operations will not update the sidebar in real-time.

    **Fix:** In `WorkspaceSidebarPane.tsx`, replace the inline folder query with `useFolders(activeWorkspaceId)` from `src/hooks/useFolders.ts`. This ensures the sidebar's folder list uses the same TanStack Query cache that folder mutations invalidate, enabling real-time updates when folders are created, renamed, or archived.

    Before (what Plan 03 likely created):
    ```typescript
    // WRONG — inline query with its own cache key
    const { data: folders } = useQuery({
      queryKey: ['sidebar-folders', workspaceId],
      queryFn: () => supabase.from('folders')...
    })
    ```

    After (what this task must produce):
    ```typescript
    // CORRECT — shared hook with shared cache key
    import { useFolders } from '@/hooks/useFolders'
    const { data: folders } = useFolders(activeWorkspaceId)
    ```

    Also import `useArchivedFolders` if WorkspaceSidebarPane shows the "Archived" section.

    **index.tsx (home / calls list)** — Complete integration of all Phase 16 components.

    1. Wrap calls list in `<DndCallProvider>` from Plan 04 — enables drag-to-folder on desktop
    2. Each call row becomes `<DraggableCallRow>` wrapping the existing Link
    3. Add action menu (3-dot "..." button) on each call row with:
       - "Move to Folder" — opens a folder picker dropdown (list active folders from useFolders)
       - "Open" — navigates to /calls/:id
       - "Share" — placeholder (future Phase 21)
    4. WorkspaceSidebarPane folders wrapped in `<FolderDropZone>` from Plan 04
    5. WorkspaceBreadcrumb at top of main content (from Plan 03)
    6. Recordings query scoped: when activeWorkspaceId is set, filter recordings by workspace. When activeFolderId is set, filter by folder_assignments.
    7. When no workspace selected (fresh org switch), show "Select a workspace" message in main area

    **calls/$callId.tsx (call detail)** — Update:
    1. Add breadcrumb at top: Org > Workspace > Folder (if applicable) > Call Title
    2. Add "Move to Folder" in action area (same folder picker as list action menu)
    3. Ensure all text uses "Call" not "Recording" in user-facing labels (recording is internal DB term)

    **folders/$folderId.tsx** — Wire:
    1. Fetch folder by ID from useFolders or direct query
    2. Show breadcrumb: Org > Workspace > Folder Name
    3. List recordings in this folder (via folder_assignments join)
    4. Actions: Rename folder (inline edit), Archive folder button
    5. Same DnD + action menu pattern as home page for calls within the folder
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds
    2. `grep "DndCallProvider" src/routes/_authenticated/index.tsx` confirms DnD wrapper
    3. `grep "Move to Folder" src/routes/_authenticated/index.tsx` confirms action menu
    4. `grep "WorkspaceBreadcrumb" src/routes/_authenticated/calls/\\$callId.tsx` confirms breadcrumb on detail
    5. `grep "useFolders" src/components/layout/WorkspaceSidebarPane.tsx` confirms shared hook usage (NOT inline query)
    6. `grep -c "from('folders')" src/components/layout/WorkspaceSidebarPane.tsx` returns 0 (no inline folder query remains)
  </verify>
  <done>
    Calls list has DnD enabled with draggable rows and folder drop zones. Action menus provide "Move to Folder" on all devices. Call detail has breadcrumbs and folder assignment. Folder route shows contents with rename and archive actions. WorkspaceSidebarPane uses useFolders hook for cache-coherent folder data — sidebar updates in real-time after folder mutations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Terminology sweep (including email templates) and remaining route updates</name>
  <files>
    /Users/Naegele/dev/callvault/src/routes/_authenticated/workspaces/index.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/workspaces/$workspaceId.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/settings/$category.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/import/index.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/sharing/index.tsx
    /Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
  </files>
  <action>
    **WKSP-01/02/03 Terminology Sweep** — Zero instances of "Bank," "Vault," or "Hub" visible anywhere in the UI. This is a phase success criterion.

    Systematically update ALL user-facing text in the v2 codebase:
    - "Bank" -> "Organization" (all contexts)
    - "Vault" -> "Workspace" (all contexts)
    - "Hub" -> "Folder" (all contexts)

    **Source code sweep:** Run a comprehensive grep to find every instance. Use multiple patterns to catch all forms:
    ```bash
    # String literals (catches "Bank", 'Bank', `Bank`)
    grep -rn "\"Bank\|'Bank\|\`Bank\|\"Vault\|'Vault\|\`Vault\|\"Hub\|'Hub\|\`Hub" src/ --include="*.tsx" --include="*.ts"

    # JSX text nodes (catches >Bank<, >Vault<, >Hub<)
    grep -rn ">Bank<\|>Vault<\|>Hub<\|>Bank \|>Vault \|>Hub " src/ --include="*.tsx"

    # Template literal expressions (catches ${...}Bank, Bank${...})
    grep -rn "Bank}\|{Bank\|Vault}\|{Vault\|Hub}\|{Hub" src/ --include="*.tsx" --include="*.ts"

    # Aria labels and title attributes
    grep -rn "aria-label.*[Bb]ank\|aria-label.*[Vv]ault\|aria-label.*[Hh]ub\|title=.*[Bb]ank\|title=.*[Vv]ault\|title=.*[Hh]ub" src/ --include="*.tsx"
    ```

    Exclude from changes:
    - Import paths referencing v1 code (if any)
    - supabase.ts generated types (auto-generated, not user-facing)
    - Internal variable names that reference DB tables (e.g., `bank_id` in service code is fine — it's internal)
    - Comments explaining the mapping (e.g., "Organization = Bank in DB" is fine)

    ONLY change user-facing strings: headings, labels, toasts, error messages, placeholder text, tooltips, aria-labels.

    **Supabase Auth email templates (WKSP-01 requirement):**

    WKSP-01 explicitly requires "Bank renamed in email templates." Supabase Auth email templates (confirmation, magic link, invite, password reset, etc.) are configured in the Supabase Dashboard, NOT in source code. The executor MUST:

    1. Check current email templates via Supabase Dashboard -> Authentication -> Email Templates (or via Supabase Management API if available)
    2. If any template contains "Bank", "Vault", or "Hub" in user-facing text, document the finding
    3. Create a checkpoint note for the human verification step (Task 3) listing which templates need manual update in the dashboard

    Note: If templates use only generic Supabase defaults (e.g., "Confirm your email for {{.SiteURL}}") and never mention Bank/Vault/Hub, document that no changes are needed. The key is to VERIFY rather than assume.

    **Route-specific updates:**

    **workspaces/index.tsx** — Workspace list page:
    - Heading: "Workspaces" (not "Vaults")
    - Show list of workspaces in active org
    - Each workspace card shows: name, member count, call count, "Default" badge if is_default
    - "Create Workspace" button

    **workspaces/$workspaceId.tsx** — Workspace detail page:
    - Show workspace name, org context in breadcrumb
    - Include WorkspaceMemberPanel from Plan 05 in a settings section or tab
    - "Invite" button opens WorkspaceInviteDialog
    - Folder list within the workspace

    **settings/$category.tsx** — Settings page:
    - Add "Organizations" category to settings nav (alongside Account, etc.)
    - Organizations settings shows list of user's orgs with ability to rename, manage members
    - If current category is "organizations", show org management UI
    - Remove any "Banks" references in settings categories

    **import/index.tsx** — Import hub:
    - Ensure all copy says "Workspace" not "Vault" (e.g., "Import calls to your workspace")
    - Import destination should reference active workspace

    **sharing/index.tsx** — Sharing page:
    - "Shared With Me" — ensure terminology uses "Workspace" not "Vault"

    **SidebarNav.tsx** — Final cleanup:
    - Nav item "Workspaces" should link to /workspaces (add if not present)
    - Ensure no "Vault" or "Hub" text remains
    - "How it works" link from Plan 06 should be present

    Final verification: Run the broadened grep patterns above and verify zero user-facing hits. If any edge cases are found that the grep misses, the human verification checkpoint (Task 3) serves as the definitive safety net.
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds
    2. Run broadened terminology audit covering string literals, JSX text nodes, and template literals:
       ```bash
       grep -rni '"Bank\|"Vault\|"Hub\|Bank"\|Vault"\|Hub"\|>Bank\|>Vault\|>Hub' src/ --include="*.tsx" --include="*.ts" | grep -v supabase.ts | grep -v node_modules | grep -v "// " | grep -v "DB\|table\|from("
       ```
       Returns zero lines (no user-facing old terminology)
    3. `grep "Organization" src/routes/_authenticated/settings/\\$category.tsx` confirms organizations settings
    4. `grep "WorkspaceMemberPanel" src/routes/_authenticated/workspaces/\\$workspaceId.tsx` confirms member management
    5. Email template audit documented (either "no changes needed" or "dashboard updates required for Task 3")
  </verify>
  <done>
    Zero instances of Bank/Vault/Hub in user-facing UI text (WKSP-01/02/03). Workspace list and detail pages use new terminology. Settings includes Organizations category. Import and sharing pages updated. SidebarNav cleaned and has Workspaces link. Full terminology audit passes (string literals, JSX text, template literals, aria-labels). Supabase Auth email templates audited and documented. Full terminology audit passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of complete workspace redesign</name>
  <action>
    Pause for human verification of the complete Phase 16 Workspace Redesign at the production URL.

    The user should verify:
    1. Navigate to https://callvault.vercel.app — verify OrgSwitcherBar shows at top with org name and house icon (personal org)
    2. Click the org dropdown — verify organizations list and "Create Organization" option
    3. Check sidebar — verify workspaces listed as expandable items with folders underneath
    4. Click a workspace — verify it expands showing folders, breadcrumb updates
    5. Check breadcrumbs at top of main content — verify "Org > Workspace" trail is clickable
    6. Try creating a folder inside a workspace — verify it appears in the sidebar IMMEDIATELY (no page refresh needed — tests cache coherence fix)
    7. Try dragging a call onto a folder in the sidebar (desktop) — verify it assigns
    8. Try the action menu ("...") on a call — verify "Move to Folder" option works
    9. Open Workspace settings — verify "Members" and "Pending Invites" tabs exist
    10. Try "Invite" — verify the dialog shows both Org and Workspace name, has role picker
    11. Do a text search (Ctrl+F) for "Bank", "Vault", "Hub" on every visible page — verify zero hits
    12. Check if you see the onboarding explorer (if first time) OR click "How it works" in sidebar
    13. Verify old URL works: navigate to /vaults — verify it redirects to /workspaces
    14. **Supabase Auth email templates:** If Task 2 flagged any templates containing old terminology, update them now in Supabase Dashboard -> Authentication -> Email Templates. If Task 2 confirmed no changes needed, skip this step.
  </action>
  <verify>User confirms all 14 verification steps pass at the production URL.</verify>
  <done>User types "approved" if the workspace redesign looks correct, or describes any issues to fix.</done>
</task>

</tasks>

<verification>
- All route pages use Organization/Workspace/Folder terminology (WKSP-01/02/03)
- Supabase Auth email templates audited for old terminology (WKSP-01)
- WorkspaceSidebarPane uses useFolders hook (not inline query) for cache-coherent updates
- DnD call-to-folder works on desktop
- Action menus available on all devices for folder assignment
- Workspace detail includes member management
- Settings has Organizations category
- Zero "Bank/Vault/Hub" in user-facing text
- All prior plan components (navigation, folders, invites, onboarding) are integrated
- Human verification of complete UX
</verification>

<success_criteria>
1. Zero instances of "Bank," "Vault," or "Hub" visible anywhere in the UI (WKSP-01/02/03)
2. Supabase Auth email templates verified clean of old terminology (WKSP-01)
3. All route pages consistently use Organization/Workspace/Folder
4. DnD and action menu both work for call-to-folder assignment
5. Sidebar folder list updates in real-time after folder create/rename/archive (cache coherence)
6. Workspace settings integrates member management panel
7. Settings includes Organizations management
8. Old URLs redirect properly
9. Human-verified at production URL
</success_criteria>

<output>
After completion, create `.planning/phases/16-workspace-redesign/16-07-SUMMARY.md`
</output>
