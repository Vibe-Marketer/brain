---
phase: 16-workspace-redesign
plan: "08"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/recordings.service.ts
  - src/hooks/useRecordings.ts
  - src/routes/_authenticated/index.tsx
  - src/components/layout/WorkspaceBreadcrumb.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When a workspace is active in the sidebar, the calls list shows only recordings belonging to that workspace (via vault_entries join)"
    - "When no workspace is active, the calls list shows all recordings in the org"
    - "When a folder is active, the calls list shows only recordings assigned to that folder (via folder_assignments join)"
    - "Folder name appears in breadcrumb trail when a folder is active (Org > Workspace > Folder)"
  artifacts:
    - path: "src/services/recordings.service.ts"
      provides: "getRecordingsByWorkspace and getRecordingsByFolder service functions"
      contains: "vault_entries"
    - path: "src/hooks/useRecordings.ts"
      provides: "useWorkspaceRecordings hook for workspace/folder-scoped queries"
    - path: "src/routes/_authenticated/index.tsx"
      provides: "useFilteredRecordings wired to workspace/folder context"
      contains: "useWorkspaceRecordings"
    - path: "src/components/layout/WorkspaceBreadcrumb.tsx"
      provides: "Folder breadcrumb level from useFolders lookup"
      contains: "useFolders"
  key_links:
    - from: "src/routes/_authenticated/index.tsx"
      to: "src/hooks/useRecordings.ts"
      via: "useWorkspaceRecordings(activeWorkspaceId, activeFolderId)"
      pattern: "useWorkspaceRecordings"
    - from: "src/hooks/useRecordings.ts"
      to: "src/services/recordings.service.ts"
      via: "getRecordingsByWorkspace / getRecordingsByFolder queryFn"
      pattern: "getRecordingsByWorkspace|getRecordingsByFolder"
    - from: "src/services/recordings.service.ts"
      to: "vault_entries table"
      via: "supabase.from('vault_entries').select('recording_id').eq('vault_id', workspaceId)"
      pattern: "vault_entries"
    - from: "src/components/layout/WorkspaceBreadcrumb.tsx"
      to: "src/hooks/useFolders.ts"
      via: "useFolders(activeWorkspaceId) lookup by activeFolderId"
      pattern: "useFolders"
---

<objective>
Close the 2 remaining gaps from Phase 16 verification:

**Gap 1 — Workspace/folder filtering of calls list.** The `useFilteredRecordings()` hook is currently a passthrough that returns ALL recordings regardless of which workspace or folder is active. This plan wires it to query `vault_entries` (for workspace filtering) and `folder_assignments` (for folder filtering) so that the calls list scopes correctly.

**Gap 2 — Folder breadcrumb level.** The `useBreadcrumbs()` hook has an empty if-block for `activeFolderId` that never pushes a folder name into the breadcrumb trail. This plan wires `useFolders(activeWorkspaceId)` into the breadcrumb hook to look up the folder name.

Purpose: Complete the navigational promise of Phase 16 — switching workspaces and folders actually changes what the user sees.
Output: Working workspace/folder filtering in calls list + complete Org > Workspace > Folder breadcrumb trail.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files being modified (read these before implementing)
@src/services/recordings.service.ts
@src/hooks/useRecordings.ts
@src/routes/_authenticated/index.tsx
@src/components/layout/WorkspaceBreadcrumb.tsx

# Related files for context
@src/stores/orgContextStore.ts
@src/hooks/useFolders.ts
@src/types/workspace.ts
@src/lib/query-config.ts
@src/services/folders.service.ts

# Prior plan summaries for context
@.planning/phases/16-workspace-redesign/16-03-SUMMARY.md
@.planning/phases/16-workspace-redesign/16-04-SUMMARY.md
@.planning/phases/16-workspace-redesign/16-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace/folder-scoped recording queries and wire into calls list</name>
  <files>
    src/services/recordings.service.ts
    src/hooks/useRecordings.ts
    src/routes/_authenticated/index.tsx
    src/lib/query-config.ts
  </files>
  <action>
    **In `src/services/recordings.service.ts`**, add two new service functions:

    1. `getRecordingsByWorkspace(workspaceId: string): Promise<RecordingListItem[]>` —
       - Query `vault_entries` where `vault_id = workspaceId` to get an array of `recording_id` values.
       - Then query `recordings` with `.in('id', recordingIds)` using the same `.select(...)` and `.order(...)` as `getRecordings()`.
       - If vault_entries returns zero rows, return empty array (not all recordings).
       - Use `(supabase as any)` cast for vault_entries if needed (same pattern as folders.service.ts).

    2. `getRecordingsByFolder(folderId: string): Promise<RecordingListItem[]>` —
       - Query `folder_assignments` where `folder_id = folderId` to get an array of `call_recording_id` values (these are legacy numeric IDs).
       - Then query `recordings` with `.in('legacy_recording_id', legacyIds)` using the same `.select(...)` and `.order(...)` as `getRecordings()`.
       - If folder_assignments returns zero rows, return empty array.

    IMPORTANT: Both functions should do a two-step query (get IDs, then get recordings) rather than a join. Supabase JS client makes joins on non-FK relationships awkward, and vault_entries IS typed in supabase.ts (unlike some Phase 16 tables). The two-step approach is explicit and debuggable.

    **In `src/hooks/useRecordings.ts`**, add a new hook:

    `useWorkspaceRecordings(workspaceId: string | null, folderId: string | null)` —
    - When `folderId` is set: use `getRecordingsByFolder(folderId)` as queryFn, with queryKey `queryKeys.recordings.list({ folderId })`.
    - When only `workspaceId` is set (no folderId): use `getRecordingsByWorkspace(workspaceId)` as queryFn, with queryKey `queryKeys.recordings.list({ workspaceId })`.
    - When neither is set: use `getRecordings()` as queryFn (same as existing `useRecordings`), with queryKey `queryKeys.recordings.list()`.
    - Enabled only when session exists.
    - Import `getRecordingsByWorkspace`, `getRecordingsByFolder` from recordings.service.

    **In `src/routes/_authenticated/index.tsx`**, update `useFilteredRecordings()`:

    - Replace the current passthrough implementation.
    - Import `useWorkspaceRecordings` from `@/hooks/useRecordings`.
    - Call `useWorkspaceRecordings(activeWorkspaceId, activeFolderId)` instead of `useRecordings()`.
    - Remove the comment about "Plan 16-08+" since this IS Plan 16-08.
    - Remove the old `useRecordings` import if no longer used.
    - Keep the same return shape: `{ recordings, isLoading, error, activeWorkspaceId, activeFolderId }`.

    **In `src/lib/query-config.ts`**: No changes needed — `queryKeys.recordings.list(filters)` already accepts an optional filters object, which will differentiate cache keys for workspace-scoped vs folder-scoped vs all-recordings queries.
  </action>
  <verify>
    1. `pnpm build` passes with zero TypeScript errors.
    2. Grep `src/services/recordings.service.ts` for `vault_entries` — confirms workspace query exists.
    3. Grep `src/services/recordings.service.ts` for `folder_assignments` — confirms folder query exists.
    4. Grep `src/routes/_authenticated/index.tsx` for `useWorkspaceRecordings` — confirms new hook is wired.
    5. Grep `src/routes/_authenticated/index.tsx` for `Plan 16-08` — returns zero matches (old TODO comment removed).
  </verify>
  <done>
    Selecting a workspace in the sidebar causes useFilteredRecordings to call getRecordingsByWorkspace(activeWorkspaceId), returning only recordings linked via vault_entries. Selecting a folder further narrows to getRecordingsByFolder(activeFolderId). Deselecting both returns all recordings. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire folder name into breadcrumb trail</name>
  <files>
    src/components/layout/WorkspaceBreadcrumb.tsx
  </files>
  <action>
    **In `src/components/layout/WorkspaceBreadcrumb.tsx`**, update the `useBreadcrumbs()` hook:

    1. Add import: `import { useFolders } from '@/hooks/useFolders'`

    2. Inside `useBreadcrumbs()`, after the `activeWorkspace` section and where `activeFolderId` is read:
       - Call `const { data: folders = [] } = useFolders(activeWorkspaceId)` to get the folder list for the active workspace.
       - Find the active folder: `const activeFolder = folders.find((f) => f.id === activeFolderId)`

    3. Replace the empty if-block at the "Level 3: Folder" section (currently lines 169-172 which just have comments and no push):
       ```typescript
       if (activeFolderId && activeFolder) {
         items.push({
           label: activeFolder.name,
           // Folder level links to home with folder filter active
           href: '/',
         })
       }
       ```

    4. Remove the stale TODO comments referencing "Plan 16-04 wires this fully" — this IS the fix.

    5. Keep the `callTitle` (Level 4) logic unchanged.

    IMPORTANT: The `useFolders` hook is already used elsewhere (WorkspaceSidebarPane, index.tsx) with the same `activeWorkspaceId` param, so TanStack Query will reuse the cached result — no extra network request.
  </action>
  <verify>
    1. `pnpm build` passes with zero TypeScript errors.
    2. Grep `src/components/layout/WorkspaceBreadcrumb.tsx` for `useFolders` — confirms import and usage.
    3. Grep `src/components/layout/WorkspaceBreadcrumb.tsx` for `activeFolder.name` or `activeFolder` — confirms folder name is pushed to items.
    4. Grep `src/components/layout/WorkspaceBreadcrumb.tsx` for `Plan 16-04` — returns zero matches (stale comment removed).
  </verify>
  <done>
    When a folder is active, the breadcrumb trail displays: Org Name / Workspace Name / Folder Name. When no folder is active, breadcrumb shows Org / Workspace as before. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero TypeScript errors — no regressions from wiring.
2. The `useFilteredRecordings` function in index.tsx no longer contains "passthrough" or "Plan 16-08" comments.
3. `recordings.service.ts` contains both `getRecordingsByWorkspace` and `getRecordingsByFolder` functions that query `vault_entries` and `folder_assignments` respectively.
4. `WorkspaceBreadcrumb.tsx` imports `useFolders` and pushes a folder-level breadcrumb item when `activeFolderId` is set.
5. No empty if-blocks remain in `WorkspaceBreadcrumb.tsx` for the folder level.
</verification>

<success_criteria>
- Workspace filtering: When activeWorkspaceId is set, calls list shows only recordings belonging to that workspace (via vault_entries). When cleared, shows all recordings.
- Folder filtering: When activeFolderId is set, calls list shows only recordings assigned to that folder (via folder_assignments). When cleared, shows workspace-level or all recordings.
- Folder breadcrumb: When activeFolderId is set, breadcrumb shows Org > Workspace > Folder Name (not just Org > Workspace).
- Zero TypeScript build errors.
</success_criteria>

<output>
After completion, create `.planning/phases/16-workspace-redesign/16-08-SUMMARY.md`
</output>
