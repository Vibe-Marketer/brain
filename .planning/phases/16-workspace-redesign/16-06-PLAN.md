---
phase: 16-workspace-redesign
plan: 06
type: execute
wave: 4
depends_on: ["16-03"]
files_modified:
  - /Users/Naegele/dev/callvault/src/components/onboarding/ModelExplorer.tsx
  - /Users/Naegele/dev/callvault/src/hooks/useOnboarding.ts
  - /Users/Naegele/dev/callvault/src/routes/_authenticated.tsx
  - /Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
autonomous: true

must_haves:
  truths:
    - "New user sees interactive 4-level model explorer on first login after signup"
    - "User clicks through levels one at a time: Account -> Organization -> Workspace -> Folder -> Call"
    - "Each click reveals the next layer with a brief explanation"
    - "Personal org is explained as personal space with house icon"
    - "Onboarding is accessible later via How it works link in sidebar"
    - "Onboarding-seen state persists in user_preferences table (not localStorage)"
  artifacts:
    - path: "/Users/Naegele/dev/callvault/src/components/onboarding/ModelExplorer.tsx"
      provides: "Interactive step-through explorer for the 4-level hierarchy model"
      contains: "ModelExplorer"
      min_lines: 80
    - path: "/Users/Naegele/dev/callvault/src/hooks/useOnboarding.ts"
      provides: "Hook for checking/setting onboarding completion status in user_preferences"
      exports: ["useOnboarding"]
    - path: "/Users/Naegele/dev/callvault/src/routes/_authenticated.tsx"
      provides: "Auth guard layout that triggers onboarding for new users"
      contains: "ModelExplorer"
  key_links:
    - from: "/Users/Naegele/dev/callvault/src/components/onboarding/ModelExplorer.tsx"
      to: "/Users/Naegele/dev/callvault/src/hooks/useOnboarding.ts"
      via: "onComplete callback calls markOnboardingSeen"
      pattern: "markOnboardingSeen"
    - from: "/Users/Naegele/dev/callvault/src/hooks/useOnboarding.ts"
      to: "supabase user_preferences table"
      via: "Reads/writes onboarding_seen_v2 preference"
      pattern: "user_preferences"
    - from: "/Users/Naegele/dev/callvault/src/routes/_authenticated.tsx"
      to: "/Users/Naegele/dev/callvault/src/components/onboarding/ModelExplorer.tsx"
      via: "Shows ModelExplorer overlay when onboarding not completed"
      pattern: "ModelExplorer"
---

<objective>
Build the interactive 4-level model onboarding explorer and wire it to show on first login.

Purpose: WKSP-09 requires an onboarding screen that shows the 4-level model with a diagram so users understand it in 30 seconds. The locked decision specifies an interactive explorer where users click through levels one at a time, triggered on first login, accessible later via sidebar link.

Output: ModelExplorer component, onboarding persistence hook, integration into auth layout and sidebar.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-CONTEXT.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-RESEARCH.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-03-SUMMARY.md
@/Users/Naegele/dev/callvault/src/routes/_authenticated.tsx
@/Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ModelExplorer component and onboarding hook</name>
  <files>
    /Users/Naegele/dev/callvault/src/components/onboarding/ModelExplorer.tsx
    /Users/Naegele/dev/callvault/src/hooks/useOnboarding.ts
  </files>
  <action>
    **src/hooks/useOnboarding.ts** — Hook for managing onboarding state.

    Per research pitfall 6: Store onboarding_seen in user_preferences table (not localStorage). The user_preferences table already exists in the Supabase schema.

    Implementation:
    - `useOnboarding()` — Returns `{ hasCompletedOnboarding, isLoading, markOnboardingSeen, showOnboarding }`
    - `hasCompletedOnboarding`: Query user_preferences for a `onboarding_seen_v2` key. If the key exists and is true, return true.
    - `markOnboardingSeen()`: Upsert `onboarding_seen_v2: true` into user_preferences.
    - `showOnboarding`: state boolean for manually triggering the explorer (via "How it works" link).
    - `setShowOnboarding(bool)`: setter for manual trigger.
    - Uses TanStack Query with queryKeys.user.preferences() key.
    - Use the key `onboarding_seen_v2` (not `v1`) to distinguish from any future onboarding versions.

    If user_preferences uses a JSONB preferences column, read/write the key within that JSON. If it's a key-value table, insert a row. Check the existing table schema from supabase types.

    **src/components/onboarding/ModelExplorer.tsx** — Interactive step-through explorer.

    Per locked decisions:
    - "Interactive explorer — user clicks through levels one at a time"
    - "Each click reveals the next layer (Account -> Organization -> Workspace -> Folder -> Call) with a brief explanation"
    - "More engaging than static, less passive than auto-animation"
    - Personal org explained: "This is your personal space. Create an Organization to collaborate with others."
    - "My Calls workspace" explained as default import destination.
    - Show on first login after signup. Also accessible via "How it works" link.

    Implementation using motion/react (NOT framer-motion — motion v12 import path):
    ```typescript
    import { AnimatePresence, motion } from 'motion/react'
    ```

    5 steps:
    ```typescript
    const STEPS = [
      {
        id: 'account',
        label: 'Your Account',
        description: 'You sign in once. Everything starts here.',
        icon: RiUserLine,
        color: 'text-blue-400',
      },
      {
        id: 'organization',
        label: 'Organization',
        description: 'Your personal space — or a team you create to collaborate with others.',
        icon: RiHome4Line,  // house icon for personal org emphasis
        color: 'text-brand-400',
        detail: 'A Personal organization is auto-created for you. Create more to collaborate.',
      },
      {
        id: 'workspace',
        label: 'Workspace',
        description: 'Where your calls live. "My Calls" is your default — imports land here.',
        icon: RiBriefcaseLine,
        color: 'text-emerald-400',
        detail: 'Each workspace has its own members, folders, and MCP token.',
      },
      {
        id: 'folder',
        label: 'Folder',
        description: 'Organize calls into groups. Archive folders to hide from search and MCP.',
        icon: RiFolderLine,
        color: 'text-amber-400',
      },
      {
        id: 'call',
        label: 'Call',
        description: 'Your recordings — transcript, summary, tags, and more.',
        icon: RiMicLine,
        color: 'text-rose-400',
      },
    ]
    ```

    Visual structure:
    - Centered modal/overlay (fixed position, backdrop blur)
    - Progress dots at top (filled for completed/current steps)
    - Visual hierarchy diagram building up: each step adds a node to a vertical tree
    - AnimatePresence with mode="wait" for step transitions
    - Step content: large icon, label, description, optional detail text
    - "Next" button advances to next step. Final step shows "Get Started" button.
    - "Skip" text link at bottom for users who want to dismiss
    - Spring animation: `initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }}`

    The visual tree diagram should show the hierarchy building: when at step 2 (Organization), show Account -> Organization. When at step 3, show Account -> Organization -> Workspace. Each new level slides in from below.

    Props: `{ onComplete: () => void }`

    On "Get Started" or "Skip": call `onComplete` which triggers `markOnboardingSeen()`.
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds
    2. `grep "motion/react" src/components/onboarding/ModelExplorer.tsx` confirms correct import (not framer-motion)
    3. `grep "onboarding_seen_v2" src/hooks/useOnboarding.ts` confirms persistent preference key
    4. `grep "RiHome4Line" src/components/onboarding/ModelExplorer.tsx` confirms house icon for org step
    5. `grep "Get Started\|Skip" src/components/onboarding/ModelExplorer.tsx` confirms completion UX
  </verify>
  <done>
    ModelExplorer is an interactive step-through of 5 hierarchy levels with motion/react animations, progress dots, visual tree building, and house icon for personal org. useOnboarding persists completion in user_preferences table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire onboarding into auth layout and sidebar</name>
  <files>
    /Users/Naegele/dev/callvault/src/routes/_authenticated.tsx
    /Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
  </files>
  <action>
    **src/routes/_authenticated.tsx** — Add onboarding trigger.

    This is the auth guard layout route. After successful auth check, conditionally render ModelExplorer.

    Implementation:
    - Import useOnboarding hook
    - After auth guard passes (user is authenticated):
      - If `!hasCompletedOnboarding && !isLoading`, render `<ModelExplorer onComplete={markOnboardingSeen} />` as a fixed overlay on top of the normal page content
      - The overlay should have a semi-transparent backdrop (bg-black/60 backdrop-blur-sm)
      - Normal page content still renders underneath (Outlet from TanStack Router)
      - Once onComplete fires, hasCompletedOnboarding becomes true, overlay disappears
    - Also check showOnboarding state from useOnboarding for manual triggers

    The pattern:
    ```tsx
    function AuthenticatedLayout() {
      const { hasCompletedOnboarding, isLoading, markOnboardingSeen, showOnboarding, setShowOnboarding } = useOnboarding()

      return (
        <>
          <Outlet />
          {(!hasCompletedOnboarding && !isLoading) && (
            <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center">
              <ModelExplorer onComplete={() => { markOnboardingSeen(); setShowOnboarding(false) }} />
            </div>
          )}
          {showOnboarding && hasCompletedOnboarding && (
            <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center">
              <ModelExplorer onComplete={() => setShowOnboarding(false)} />
            </div>
          )}
        </>
      )
    }
    ```

    **src/components/layout/SidebarNav.tsx** — Add "How it works" link.

    Per locked decision: "Also accessible later via a 'How it works' link in the sidebar or help menu."

    Add a small link at the bottom of the sidebar (above the "Toggle panels" button):
    - Icon: RiQuestionLine
    - Text: "How it works" (hidden when collapsed, icon-only)
    - onClick: calls `setShowOnboarding(true)` from useOnboarding context
    - Since useOnboarding is a hook, and SidebarNav needs to trigger it, either:
      (a) Import useOnboarding directly in SidebarNav, OR
      (b) Accept an onShowOnboarding prop from AppShell
    - Prefer (a) for simplicity — import the hook directly.
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds
    2. `grep "ModelExplorer" src/routes/_authenticated.tsx` confirms onboarding wired
    3. `grep "How it works" src/components/layout/SidebarNav.tsx` confirms sidebar link
    4. `grep "hasCompletedOnboarding" src/routes/_authenticated.tsx` confirms conditional rendering
  </verify>
  <done>
    ModelExplorer shows as overlay on first login (when onboarding_seen_v2 is not set). "How it works" link in sidebar allows re-triggering. Completion persists in user_preferences table. Build passes clean.
  </done>
</task>

</tasks>

<verification>
- ModelExplorer shows 5 steps with interactive click-through
- Animation uses motion/react (not framer-motion)
- Onboarding-seen persists in user_preferences (not localStorage)
- New users see onboarding on first authenticated page load
- "How it works" link in sidebar re-opens the explorer
- pnpm build passes clean
</verification>

<success_criteria>
1. ModelExplorer shows Account -> Organization -> Workspace -> Folder -> Call with explanations (WKSP-09)
2. Users click through one level at a time (locked decision)
3. Personal org explained with house icon
4. Triggered on first login after signup
5. Accessible later via "How it works" sidebar link
6. Completion state persists in user_preferences table
7. Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-workspace-redesign/16-06-SUMMARY.md`
</output>
