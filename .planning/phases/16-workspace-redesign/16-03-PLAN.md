---
phase: 16-workspace-redesign
plan: 03
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - /Users/Naegele/dev/callvault/src/components/layout/OrgSwitcherBar.tsx
  - /Users/Naegele/dev/callvault/src/components/layout/WorkspaceSidebarPane.tsx
  - /Users/Naegele/dev/callvault/src/components/layout/WorkspaceBreadcrumb.tsx
  - /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx
  - /Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a thin header bar above the sidebar showing current org name with dropdown to switch"
    - "User sees workspaces as expandable items in the sidebar with folders nested underneath"
    - "User sees full breadcrumb trail (Org > Workspace > Folder) at top of main content area"
    - "Switching orgs resets to workspace list (clean slate per locked decision)"
    - "Personal org shows house icon (locked decision)"
    - "Current workspace is highlighted in sidebar"
  artifacts:
    - path: "/Users/Naegele/dev/callvault/src/components/layout/OrgSwitcherBar.tsx"
      provides: "Thin header bar with org dropdown, house icon for personal org, Create Organization option"
      contains: "OrgSwitcherBar"
      min_lines: 40
    - path: "/Users/Naegele/dev/callvault/src/components/layout/WorkspaceSidebarPane.tsx"
      provides: "Expandable workspace list with nested folders using @radix-ui/react-collapsible"
      contains: "WorkspaceSidebarPane"
      min_lines: 60
    - path: "/Users/Naegele/dev/callvault/src/components/layout/WorkspaceBreadcrumb.tsx"
      provides: "Breadcrumb component showing Org > Workspace > Folder > Call trail"
      contains: "WorkspaceBreadcrumb"
      min_lines: 20
    - path: "/Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx"
      provides: "Updated to include OrgSwitcherBar above pane container"
      contains: "OrgSwitcherBar"
  key_links:
    - from: "/Users/Naegele/dev/callvault/src/components/layout/OrgSwitcherBar.tsx"
      to: "/Users/Naegele/dev/callvault/src/hooks/useOrgContext.ts"
      via: "Reads orgs, activeOrg, switchOrg from useOrgContext"
      pattern: "useOrgContext"
    - from: "/Users/Naegele/dev/callvault/src/components/layout/WorkspaceSidebarPane.tsx"
      to: "/Users/Naegele/dev/callvault/src/hooks/useWorkspaces.ts"
      via: "useWorkspaces(activeOrgId) fetches workspaces for sidebar"
      pattern: "useWorkspaces"
    - from: "/Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx"
      to: "/Users/Naegele/dev/callvault/src/components/layout/OrgSwitcherBar.tsx"
      via: "OrgSwitcherBar rendered above pane container in desktop layout"
      pattern: "OrgSwitcherBar"
---

<objective>
Build the complete navigation redesign: OrgSwitcherBar header, WorkspaceSidebarPane with folder nesting, breadcrumbs, and integrate into AppShell.

Purpose: This is the core UX of Phase 16 — the three navigation components that make the Organization > Workspace > Folder hierarchy tangible. Addresses WKSP-05, WKSP-06, WKSP-07, WKSP-08, and the breadcrumb locked decision.

Output: Three new layout components (OrgSwitcherBar, WorkspaceSidebarPane, WorkspaceBreadcrumb) integrated into the existing AppShell and authenticated routes.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-CONTEXT.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-RESEARCH.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-02-SUMMARY.md
@/Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx
@/Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
@/Users/Naegele/dev/callvault/src/stores/orgContextStore.ts
@/Users/Naegele/dev/callvault/src/hooks/useOrgContext.ts
@/Users/Naegele/dev/callvault/src/hooks/useWorkspaces.ts
@/Users/Naegele/dev/callvault/src/types/workspace.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: OrgSwitcherBar and WorkspaceSidebarPane components</name>
  <files>
    /Users/Naegele/dev/callvault/src/components/layout/OrgSwitcherBar.tsx
    /Users/Naegele/dev/callvault/src/components/layout/WorkspaceSidebarPane.tsx
  </files>
  <action>
    **OrgSwitcherBar.tsx** — Dedicated thin header bar above the sidebar (locked decision). Uses shadcn DropdownMenu (already available via shadcn init in Phase 14).

    Requirements per locked decisions:
    - Thin header bar above the sidebar showing current org name
    - One click to switch orgs via dropdown
    - House icon (RiHome4Line from @remixicon/react) for personal org, RiBuilding2Line for business orgs
    - "Create Organization" option at bottom of dropdown with separator
    - When org switches, view resets (handled by store, but dropdown should close and UI should reflect)

    Implementation:
    - Import `useOrgContext` for orgs, activeOrg, switchOrg, isPersonalOrg
    - Height: `h-10` (40px) — thin but tappable
    - Background: `bg-card/80 backdrop-blur-sm` to blend with sidebar
    - Border bottom: `border-b border-border/40`
    - Org name truncated at `max-w-[160px]`
    - Dropdown arrow indicator (RiArrowDownSLine)
    - Active org has checkmark in dropdown list
    - Loading state: skeleton placeholder while orgs load

    For "Create Organization" — use a simple dialog trigger. Create a minimal `CreateOrganizationDialog` inline (or as a separate small component) that takes a name input and calls `useCreateOrganization()` mutation. Dialog can be triggered from the dropdown.

    **WorkspaceSidebarPane.tsx** — Replaces the stub FolderSidebar in index.tsx. Uses @radix-ui/react-collapsible (already installed v1.1.12).

    Requirements per locked decisions:
    - Workspaces listed as expandable items
    - Click workspace name to switch (sets activeWorkspaceId)
    - Current workspace highlighted
    - Folders nest underneath each workspace
    - Matches v1 vault sidebar pattern (expandable accordion)

    Implementation:
    - Import `useOrgContext` for activeOrgId, activeWorkspaceId, switchWorkspace
    - Import `useWorkspaces(activeOrgId)` for workspace list
    - Import folder data (will need a `useFolders(workspaceId)` hook — create a minimal version here or reference Plan 05's folder hook; for now can create inline query)
    - Each workspace is a `Collapsible.Root` from @radix-ui/react-collapsible
    - Active workspace auto-expanded, has highlighted background
    - Folders indented under expanded workspace
    - "My Calls" workspace (is_default = true) shows a subtle badge or star icon
    - "Create Workspace" button at bottom of list
    - "Create Folder" button visible when workspace is expanded (under folders)
    - Archived folders shown in collapsed "Archived" section at bottom of folder list (if any exist)

    For folder data fetching: Create an inline query using `supabase.from('folders').select('*').eq('vault_id', workspaceId).eq('is_archived', false).order('position')` or use the folders queryKey from query-config. Full useFolders hook will be built in Plan 05 — here just wire the basic query.

    Folder click: calls `setActiveFolder(folderId)` from orgContextStore to filter the calls list.
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds
    2. `grep "RiHome4Line" src/components/layout/OrgSwitcherBar.tsx` confirms house icon for personal org
    3. `grep "Collapsible" src/components/layout/WorkspaceSidebarPane.tsx` confirms @radix-ui/react-collapsible usage
    4. `grep "switchOrg\|setActiveOrg" src/components/layout/OrgSwitcherBar.tsx` confirms org switching wired
  </verify>
  <done>
    OrgSwitcherBar shows current org with dropdown, house icon for personal org, Create Organization option. WorkspaceSidebarPane shows expandable workspaces with nested folders, active workspace highlighted, folder click filters calls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Breadcrumbs and AppShell/route integration</name>
  <files>
    /Users/Naegele/dev/callvault/src/components/layout/WorkspaceBreadcrumb.tsx
    /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx
    /Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
  </files>
  <action>
    **WorkspaceBreadcrumb.tsx** — Full breadcrumb trail per locked decision: "Org > Workspace > Folder > Call always visible at the top of the main content area. Each level clickable for navigation."

    Implementation:
    - Accept `items: BreadcrumbItem[]` prop (from workspace.ts types)
    - Separator: `/` character (light muted color)
    - Each item either clickable (has href) or current (no href, bold)
    - Truncate per item at `max-w-[120px]` with `truncate` class
    - Mobile: show only last 2 levels (Claude's discretion per CONTEXT.md)
    - Use TanStack Router `<Link>` for clickable items (not anchor tags)
    - aria-label="Breadcrumb" on nav wrapper
    - Styling: `text-xs text-muted-foreground` for crumbs, `text-foreground font-medium` for current

    Create a helper hook `useBreadcrumbs()` that reads from orgContextStore (activeOrg, activeWorkspace, activeFolder) and constructs the breadcrumb items array. This hook should also accept an optional `callTitle` prop for when viewing a specific call.

    **AppShell.tsx** — Modify to add OrgSwitcherBar above the pane container.

    Per the research pattern (Pattern: AppShell layout modification):
    ```tsx
    // Wrap the current flex container in flex-col to stack org bar above panes:
    return (
      <div className="flex flex-col h-full">
        {/* Org switcher bar — always visible, desktop/tablet only */}
        {!isMobile && <OrgSwitcherBar />}

        {/* Existing pane container (unchanged structure) */}
        <div className="flex-1 flex gap-3 overflow-hidden p-1">
          {/* ... existing 4 panes unchanged ... */}
        </div>
      </div>
    )
    ```

    The OrgSwitcherBar sits above ALL panes (spanning full width). The existing pane layout below is unchanged.

    **SidebarNav.tsx** — Remove the placeholder SwitcherRow components for "Organization" and "Workspace". Those are replaced by OrgSwitcherBar (org) and WorkspaceSidebarPane (workspace). The sidebar should only contain: nav items (All Calls, Import, Settings) and bottom panel toggle. Add a "How it works" link at the bottom (for accessing onboarding diagram later — Plan 07 will wire it).

    **index.tsx** (authenticated home) — Replace the stub `<FolderSidebar />` with `<WorkspaceSidebarPane />` as the secondaryPane. Add `<WorkspaceBreadcrumb />` at the top of the main content area (above "All Calls" heading).

    Update the recordings list to filter by activeWorkspaceId and activeFolderId from orgContextStore. When a workspace is active, the calls list should show only recordings from that workspace (via vault_entries or recordings.bank_id filtering). When a folder is active, further filter to folder_assignments.
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds
    2. `grep "OrgSwitcherBar" src/components/layout/AppShell.tsx` confirms integration
    3. `grep "WorkspaceSidebarPane" src/routes/_authenticated/index.tsx` confirms sidebar replacement
    4. `grep "WorkspaceBreadcrumb" src/routes/_authenticated/index.tsx` confirms breadcrumb added
    5. `grep -c "SwitcherRow" src/components/layout/SidebarNav.tsx` returns 0 (removed placeholder)
  </verify>
  <done>
    Breadcrumb component shows Org > Workspace > Folder trail with clickable levels. AppShell integrates OrgSwitcherBar above panes. SidebarNav cleaned of placeholder switchers. Home page uses WorkspaceSidebarPane and WorkspaceBreadcrumb. Calls list filters by active workspace/folder.
  </done>
</task>

</tasks>

<verification>
- OrgSwitcherBar renders above all panes in AppShell (desktop/tablet only)
- Org dropdown shows all user's orgs with personal org having house icon
- Workspace sidebar shows expandable workspaces with folders nested
- Breadcrumbs at top of main content area, each level clickable
- Org switch resets view (workspace sidebar shows new org's workspaces)
- pnpm build passes clean
</verification>

<success_criteria>
1. OrgSwitcherBar shows current org name, dropdown, house icon for personal, Create Organization option
2. WorkspaceSidebarPane shows workspaces as expandable items with folders nested underneath
3. Breadcrumbs show full path (Org > Workspace > Folder) at top of main content
4. AppShell has OrgSwitcherBar above pane container on desktop/tablet
5. SidebarNav no longer has placeholder org/workspace switcher rows
6. Calls list filters by active workspace and folder
7. Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-workspace-redesign/16-03-SUMMARY.md`
</output>
