---
phase: 16-workspace-redesign
plan: 05
type: execute
wave: 4
depends_on: ["16-03"]
files_modified:
  - /Users/Naegele/dev/callvault/src/services/invitations.service.ts
  - /Users/Naegele/dev/callvault/src/hooks/useInvitations.ts
  - /Users/Naegele/dev/callvault/src/components/dialogs/WorkspaceInviteDialog.tsx
  - /Users/Naegele/dev/callvault/src/components/workspace/WorkspaceMemberPanel.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/join/workspace.$token.tsx
autonomous: true

must_haves:
  truths:
    - "User can invite someone to a workspace via email AND shareable link"
    - "Invite dialog shows both Org name and Workspace name (WKSP-10)"
    - "User can assign Viewer/Member/Admin roles when inviting (WKSP-11)"
    - "Workspace settings has Members tab and Pending Invites tab (WKSP-13)"
    - "User can resend and revoke pending invites"
    - "User can change member roles and remove members"
    - "Invite acceptance page shows who invited, org name, workspace name, and role before accepting"
    - "Invite links can be revoked"
  artifacts:
    - path: "/Users/Naegele/dev/callvault/src/services/invitations.service.ts"
      provides: "Service for creating, revoking, accepting workspace invitations"
      exports: ["createInvitation", "revokeInvitation", "getInviteDetails", "acceptInvite"]
    - path: "/Users/Naegele/dev/callvault/src/hooks/useInvitations.ts"
      provides: "TanStack Query hooks for invitation management"
      exports: ["useInvitations", "useCreateInvitation", "useRevokeInvitation"]
    - path: "/Users/Naegele/dev/callvault/src/components/dialogs/WorkspaceInviteDialog.tsx"
      provides: "Dialog with email invite and shareable link tabs, role picker"
      contains: "WorkspaceInviteDialog"
      min_lines: 80
    - path: "/Users/Naegele/dev/callvault/src/components/workspace/WorkspaceMemberPanel.tsx"
      provides: "Members + Pending Invites tabs in workspace settings"
      contains: "WorkspaceMemberPanel"
      min_lines: 100
    - path: "/Users/Naegele/dev/callvault/src/routes/_authenticated/join/workspace.$token.tsx"
      provides: "Invite acceptance page showing full context (WKSP-10)"
      contains: "get_workspace_invite_details"
  key_links:
    - from: "/Users/Naegele/dev/callvault/src/components/dialogs/WorkspaceInviteDialog.tsx"
      to: "/Users/Naegele/dev/callvault/src/hooks/useInvitations.ts"
      via: "useCreateInvitation mutation called on form submit"
      pattern: "useCreateInvitation"
    - from: "/Users/Naegele/dev/callvault/src/components/workspace/WorkspaceMemberPanel.tsx"
      to: "/Users/Naegele/dev/callvault/src/hooks/useWorkspaces.ts"
      via: "useWorkspaceMembers for active members, useInvitations for pending"
      pattern: "useWorkspaceMembers|useInvitations"
    - from: "/Users/Naegele/dev/callvault/src/routes/_authenticated/join/workspace.$token.tsx"
      to: "supabase.rpc('get_workspace_invite_details')"
      via: "Fetches invite context for acceptance page"
      pattern: "get_workspace_invite_details"
---

<objective>
Build the complete invite and membership management system: invite dialog with email + link modes, workspace member panel with Members and Pending Invites tabs, and the invite acceptance page.

Purpose: Addresses WKSP-10 (invite shows both Org + Workspace name), WKSP-11 (invite with Viewer/Member/Admin roles), and WKSP-13 (manage membership from workspace settings). The locked decisions specify email invite AND shareable link, separate tabs for Members and Pending Invites, and invitees must see full context before accepting.

Output: Invitation service, hooks, invite dialog, member panel, and join page.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-CONTEXT.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-RESEARCH.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-03-SUMMARY.md
@/Users/Naegele/dev/callvault/src/types/workspace.ts
@/Users/Naegele/dev/callvault/src/stores/orgContextStore.ts
@/Users/Naegele/dev/callvault/src/hooks/useWorkspaces.ts
@/Users/Naegele/dev/callvault/src/hooks/useAuth.tsx
@/Users/Naegele/dev/callvault/src/lib/query-config.ts
@/Users/Naegele/dev/brain/src/components/dialogs/VaultInviteDialog.tsx
@/Users/Naegele/dev/brain/src/pages/VaultJoin.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Invitation service, hooks, and invite dialog</name>
  <files>
    /Users/Naegele/dev/callvault/src/services/invitations.service.ts
    /Users/Naegele/dev/callvault/src/hooks/useInvitations.ts
    /Users/Naegele/dev/callvault/src/components/dialogs/WorkspaceInviteDialog.tsx
  </files>
  <action>
    **src/services/invitations.service.ts** — Service layer for workspace invitations.

    Functions:
    - `getInvitations(supabase, workspaceId)` — Query workspace_invitations where workspace_id = workspaceId AND status = 'pending'. Return as WorkspaceInvitation[].
    - `createInvitation(supabase, workspaceId, invitedBy, email, role)` — Insert into workspace_invitations. Token auto-generated by DB default. Return the created invitation.
    - `revokeInvitation(supabase, invitationId)` — Update status to 'revoked'.
    - `resendInvitation(supabase, invitationId)` — Update expires_at to NOW() + 7 days (refreshes the expiry). Email re-send is a future concern — for now, just refresh the expiry.
    - `getInviteDetails(supabase, token)` — Call the `get_workspace_invite_details` RPC. Returns WorkspaceInviteDetails.
    - `acceptInvite(supabase, token, userId)` — Call the `accept_workspace_invite` RPC. Returns success/failure.
    - `getShareableLink(workspaceId, token)` — Construct URL: `${window.location.origin}/join/workspace/${token}`. Pure function, no DB call.

    **NOTE on email delivery:** Per research open question, the project has no email sending infrastructure (no Resend, no Mailgun). For this plan: create the invitation record in DB and provide the shareable link. Email delivery can be added later (Phase 17+ or via Supabase webhooks). The invite dialog should show both modes but "Email Invite" creates the DB record + shows the link to manually share. Flag this as a known limitation.

    **src/hooks/useInvitations.ts** — TanStack Query hooks:
    - `useInvitations(workspaceId)` — Pending invitations for workspace. Uses queryKeys.invitations.byWorkspace.
    - `useCreateInvitation()` — Mutation. On success: invalidate invitations list, show toast "Invitation created", copy link to clipboard.
    - `useRevokeInvitation()` — Mutation. On success: invalidate, toast "Invitation revoked".
    - `useResendInvitation()` — Mutation. On success: invalidate, toast "Invitation refreshed".
    - `useInviteDetails(token)` — Query invite details by token. Uses queryKeys.invitations.details(token).
    - `useAcceptInvite()` — Mutation. On success: invalidate organizations + workspaces (new workspace now visible).

    **src/components/dialogs/WorkspaceInviteDialog.tsx** — Dialog with two modes.

    Per locked decisions:
    - Email invite AND shareable invite link (like Slack/Discord)
    - Role picker: Claude's discretion — pick what fits the dialog context
    - Invite dialog shows both Org + Workspace name (WKSP-10)

    Implementation:
    - Dialog header: "Invite to {workspaceName}" with subtext "in {orgName}" — satisfies WKSP-10
    - Two tabs or sections: "Invite by Email" and "Share Link"
    - **Email tab:** Email input field + role dropdown + "Send Invite" button. Creates invitation record. Shows the generated link with copy button. Note: "Email notification coming soon" disclaimer since no email infra exists yet.
    - **Link tab:** Shows the workspace's shareable invite link with a copy button. Link format: `/join/workspace/{token}`. "Revoke Link" button to invalidate.
    - **Role picker:** Dropdown with three options per WKSP-11: Viewer (guest), Member (member), Admin (vault_admin). Use ROLE_DISPLAY_NAMES from workspace.ts. Default to "Member".
    - Use shadcn Dialog, Input, Select, Button components
    - Confirmation: "Anyone with this link can join as {role}" warning text
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds
    2. `grep "get_workspace_invite_details" src/services/invitations.service.ts` confirms RPC usage
    3. `grep "WKSP-10\|orgName\|organization" src/components/dialogs/WorkspaceInviteDialog.tsx` confirms org name displayed
    4. `grep "Viewer\|Member\|Admin" src/components/dialogs/WorkspaceInviteDialog.tsx` confirms role picker
  </verify>
  <done>
    Invitation service handles CRUD for workspace_invitations table. Hooks provide mutations with toast feedback. Invite dialog shows both email and link modes with role picker and org+workspace context (WKSP-10). Email delivery flagged as future enhancement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Workspace member panel and invite acceptance page</name>
  <files>
    /Users/Naegele/dev/callvault/src/components/workspace/WorkspaceMemberPanel.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/join/workspace.$token.tsx
  </files>
  <action>
    **src/components/workspace/WorkspaceMemberPanel.tsx** — Members + Pending Invites tabs per locked decision.

    Requirements:
    - Separate tabs for "Members" and "Pending Invites" (locked decision)
    - Pending invites tab shows resend/revoke options (locked decision)

    Implementation:
    - Use shadcn Tabs component
    - **Members tab:**
      - List of current members from useWorkspaceMembers(workspaceId)
      - Each row: avatar (initials fallback), display name, email, role badge, actions dropdown
      - Actions: Change Role (opens inline select or ChangeRoleDialog), Remove Member
      - Owner cannot be removed or have role changed
      - Role change calls useUpdateMemberRole() mutation — immediate effect (WKSP success criteria 5: "role changes take effect immediately, no page refresh")
      - Member removal calls useRemoveMember() mutation with confirmation dialog
    - **Pending Invites tab:**
      - List of pending invitations from useInvitations(workspaceId)
      - Each row: email, role, invited date, expires_at, actions
      - Actions: Resend (refreshes expiry), Revoke (marks as revoked)
      - Show "No pending invites" empty state
    - "Invite Member" button in header opens WorkspaceInviteDialog
    - This panel will be used inside workspace settings page. For now, export it as a standalone component.

    **src/routes/_authenticated/join/workspace.$token.tsx** — Invite acceptance page (satisfies WKSP-10).

    The acceptance page MUST show (per locked decision / WKSP-10):
    - Who invited them (inviter display name)
    - Organization name
    - Workspace name
    - Assigned role
    - What they'll have access to (brief description based on role)

    Implementation:
    - Route: `/join/workspace/$token` (TanStack Router file-based route)
    - On load: call `useInviteDetails(token)` which calls `get_workspace_invite_details` RPC
    - Display: Centered card showing invite details. "You've been invited to join **{workspaceName}** in **{orgName}**" with inviter name and role.
    - Role explanation: brief text like "As a Member, you can view and organize calls in this workspace."
    - "Accept Invite" button → calls useAcceptInvite mutation → redirects to workspace page on success
    - "Decline" link → just navigates away (no DB action needed)
    - Handle edge cases: expired invite (show "This invite has expired"), already accepted, revoked, invalid token
    - If user is not authenticated: show the invite details but redirect to login first, then back to this page
    - Use the _authenticated layout (requires login to accept — this is the correct flow for workspace membership)
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds
    2. `grep "Members\|Pending Invites" src/components/workspace/WorkspaceMemberPanel.tsx` confirms two tabs
    3. `grep "inviter_display_name\|organization_name" src/routes/_authenticated/join/workspace.\$token.tsx` confirms WKSP-10 context
    4. `grep "Accept\|Decline" src/routes/_authenticated/join/workspace.\$token.tsx` confirms acceptance flow
  </verify>
  <done>
    WorkspaceMemberPanel has Members tab (role change, remove) and Pending Invites tab (resend, revoke). Role changes take effect immediately without page refresh. Invite acceptance page shows full context: inviter, org name, workspace name, role, access scope (WKSP-10 satisfied). Edge cases handled: expired, revoked, invalid tokens.
  </done>
</task>

</tasks>

<verification>
- Invite dialog shows both Org + Workspace name (WKSP-10)
- Three roles available: Viewer, Member, Admin (WKSP-11)
- Both email and link invite modes available
- Members tab shows role change and remove actions
- Pending Invites tab shows resend and revoke actions
- Join page shows full invite context before acceptance
- Role changes take effect immediately (no page refresh)
- pnpm build passes clean
</verification>

<success_criteria>
1. WorkspaceInviteDialog shows org+workspace context with email and link modes (WKSP-10)
2. Role picker offers Viewer/Member/Admin (WKSP-11)
3. WorkspaceMemberPanel has separate Members and Pending Invites tabs (WKSP-13)
4. Join page shows inviter name, org name, workspace name, role before acceptance (WKSP-10)
5. Role changes and member removal take effect immediately
6. Invite links can be revoked
7. Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-workspace-redesign/16-05-SUMMARY.md`
</output>
