---
phase: 16-workspace-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/Naegele/dev/callvault/vercel.json
  - /Users/Naegele/dev/brain/supabase/migrations/20260228000001_workspace_redesign_schema.sql
  - /Users/Naegele/dev/callvault/src/types/workspace.ts
  - /Users/Naegele/dev/callvault/src/lib/query-config.ts
autonomous: true

must_haves:
  truths:
    - "Requests to old /bank/, /vault/, /hub/ URLs get 301-redirected to new paths before any UI rename ships"
    - "A new user who signs up gets a personal vault with is_default = TRUE that cannot be deleted"
    - "All existing personal vaults (vault_type='personal') already have is_default = TRUE after migration"
    - "TypeScript type aliases (Organization, Workspace, Folder) exist mapping to DB table row types"
  artifacts:
    - path: "/Users/Naegele/dev/callvault/vercel.json"
      provides: "Server-level 301 redirects for old Bank/Vault/Hub URLs"
      contains: "redirects"
    - path: "/Users/Naegele/dev/brain/supabase/migrations/20260228000001_workspace_redesign_schema.sql"
      provides: "Additive migration: workspace_invitations, folders.vault_id, folders.is_archived, vaults.is_default with backfill, updated handle_new_user()"
      contains: "workspace_invitations"
    - path: "/Users/Naegele/dev/callvault/src/types/workspace.ts"
      provides: "Organization, Workspace, Folder type aliases and workspace-related TypeScript interfaces"
      contains: "Organization"
    - path: "/Users/Naegele/dev/callvault/src/lib/query-config.ts"
      provides: "Updated queryKeys factory with invitations domain"
      contains: "invitations"
  key_links:
    - from: "/Users/Naegele/dev/callvault/vercel.json"
      to: "Vercel deployment"
      via: "Vercel reads vercel.json for server-level redirects"
      pattern: "redirects.*permanent.*true"
    - from: "/Users/Naegele/dev/callvault/src/types/workspace.ts"
      to: "supabase/migrations schema"
      via: "Types mirror DB schema structure"
      pattern: "Organization|Workspace|WorkspaceInvitation"
    - from: "/Users/Naegele/dev/brain/supabase/migrations/20260228000001_workspace_redesign_schema.sql"
      to: "handle_new_user() trigger"
      via: "Updated trigger sets is_default = TRUE on personal vault creation"
      pattern: "is_default.*TRUE"
---

<objective>
Set up URL redirects and database schema foundation for the entire Workspace Redesign phase.

Purpose: WKSP-04 requires URL redirects to ship BEFORE any UI rename. The additive DB migrations add workspace_invitations, folder scoping (vault_id), archive support (is_archived), and default workspace protection (is_default). The is_default column is backfilled for existing personal vaults AND the handle_new_user() trigger is updated so new signups also get is_default = TRUE. TypeScript type aliases provide the mapping layer from old table names (banks/vaults) to new concept names (organizations/workspaces). This plan unblocks all subsequent plans.

Output: vercel.json with 301 redirects, SQL migration file, TypeScript type aliases, updated query-config.ts.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/ROADMAP.md
@/Users/Naegele/dev/brain/.planning/STATE.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-CONTEXT.md
@/Users/Naegele/dev/brain/.planning/phases/16-workspace-redesign/16-RESEARCH.md
@/Users/Naegele/dev/callvault/src/types/supabase.ts
@/Users/Naegele/dev/callvault/src/lib/query-config.ts
@/Users/Naegele/dev/brain/supabase/migrations/20260131210000_update_signup_trigger.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: URL redirects and additive DB migration</name>
  <files>
    /Users/Naegele/dev/callvault/vercel.json
    /Users/Naegele/dev/brain/supabase/migrations/20260228000001_workspace_redesign_schema.sql
  </files>
  <action>
    **vercel.json** — Create (or update if exists) with 301 redirects for ALL old Bank/Vault/Hub paths. These MUST be server-level redirects (not client-side) for external bookmarks. Per WKSP-04 requirement: 90-day lifespan.

    Redirect rules:
    - `/vaults` -> `/workspaces` (permanent: true)
    - `/vaults/:vaultId` -> `/workspaces/:vaultId` (permanent: true)
    - `/join/vault/:token` -> `/join/workspace/:token` (permanent: true)
    - `/settings/banks` -> `/settings/organizations` (permanent: true)
    - `/bank/:path*` -> `/organization/:path*` (permanent: true)
    - `/vault/:path*` -> `/workspace/:path*` (permanent: true)
    - `/hub/:path*` -> `/folder/:path*` (permanent: true)

    The v2 app already has client-side blockers at /bank, /vault, /hub routes (created in Phase 14 Plan 04). The vercel.json redirects will catch requests BEFORE they hit the SPA, handling external bookmarks and crawlers.

    **SQL Migration** — Create additive migration at `supabase/migrations/20260228000001_workspace_redesign_schema.sql`:

    1. **workspace_invitations table** — For email invite tracking (WKSP-10/11):
       ```sql
       CREATE TABLE IF NOT EXISTS public.workspace_invitations (
         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
         workspace_id UUID NOT NULL REFERENCES public.vaults(id) ON DELETE CASCADE,
         invited_by UUID NOT NULL REFERENCES auth.users(id),
         email TEXT NOT NULL,
         role TEXT NOT NULL CHECK (role IN ('vault_admin', 'manager', 'member', 'guest')),
         token VARCHAR(64) NOT NULL UNIQUE DEFAULT encode(gen_random_bytes(24), 'hex'),
         status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'revoked', 'expired')),
         expires_at TIMESTAMPTZ NOT NULL DEFAULT NOW() + INTERVAL '7 days',
         created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
         accepted_at TIMESTAMPTZ,
         UNIQUE(workspace_id, email, status)
       );
       ```
       Add RLS: Enable RLS. Policy for workspace admins to SELECT/INSERT/UPDATE. Policy for invited user to SELECT their own invitations by email.

    2. **folders.vault_id** — Critical schema gap identified in research. Add nullable UUID FK to vaults:
       ```sql
       ALTER TABLE public.folders ADD COLUMN IF NOT EXISTS vault_id UUID REFERENCES public.vaults(id) ON DELETE SET NULL;
       ```
       Backfill: For each folder, set vault_id to the first vault in the same bank (ordered by created_at). Use an UPDATE...FROM pattern.

    3. **folders.is_archived + folders.archived_at** — For WKSP-12 archive:
       ```sql
       ALTER TABLE public.folders ADD COLUMN IF NOT EXISTS is_archived BOOLEAN NOT NULL DEFAULT FALSE;
       ALTER TABLE public.folders ADD COLUMN IF NOT EXISTS archived_at TIMESTAMPTZ;
       ```

    4. **vaults.is_default** — For "My Calls" undeletable protection (WKSP-07):
       ```sql
       ALTER TABLE public.vaults ADD COLUMN IF NOT EXISTS is_default BOOLEAN NOT NULL DEFAULT FALSE;
       ```

       **CRITICAL — Backfill existing personal vaults:**
       ```sql
       UPDATE public.vaults SET is_default = TRUE WHERE vault_type = 'personal';
       ```
       Without this backfill, the protect_default_workspace trigger (step 7) can never fire because no vault would have is_default = TRUE. Every existing personal vault must be marked as default.

    5. **Update handle_new_user() trigger** — The existing trigger (from migration 20260131210000) creates a personal vault on signup but does NOT set is_default = TRUE. Update it to include `is_default = TRUE` in the vault INSERT:
       ```sql
       CREATE OR REPLACE FUNCTION public.handle_new_user()
       RETURNS TRIGGER
       LANGUAGE plpgsql
       SECURITY DEFINER
       SET search_path = public
       AS $$
       DECLARE
         v_bank_id UUID;
         v_vault_id UUID;
       BEGIN
         -- Insert profile for new user
         INSERT INTO public.user_profiles (user_id, email, display_name, onboarding_completed)
         VALUES (
           NEW.id,
           NEW.email,
           COALESCE(NEW.raw_user_meta_data->>'display_name', NEW.email),
           false
         );

         -- Assign default FREE role
         INSERT INTO public.user_roles (user_id, role)
         VALUES (NEW.id, 'FREE')
         ON CONFLICT (user_id, role) DO NOTHING;

         -- Create personal bank for new user
         INSERT INTO banks (name, type)
         VALUES ('Personal', 'personal')
         RETURNING id INTO v_bank_id;

         -- Create bank membership as owner
         INSERT INTO bank_memberships (bank_id, user_id, role)
         VALUES (v_bank_id, NEW.id, 'bank_owner');

         -- Create default personal vault with is_default = TRUE
         INSERT INTO vaults (bank_id, name, vault_type, is_default)
         VALUES (v_bank_id, 'My Calls', 'personal', TRUE)
         RETURNING id INTO v_vault_id;

         -- Create vault membership as owner
         INSERT INTO vault_memberships (vault_id, user_id, role)
         VALUES (v_vault_id, NEW.id, 'vault_owner');

         RETURN NEW;
       END;
       $$;

       COMMENT ON FUNCTION public.handle_new_user() IS
         'Automatically create user profile, FREE role, personal bank, and personal vault (is_default=TRUE) on signup';
       ```

    6. **get_workspace_invite_details RPC** — SECURITY DEFINER function for the join page (allows unauthenticated users to see invite context before accepting):
       ```sql
       CREATE OR REPLACE FUNCTION public.get_workspace_invite_details(p_token TEXT)
       RETURNS TABLE (
         invitation_id UUID,
         workspace_name TEXT,
         organization_name TEXT,
         inviter_display_name TEXT,
         role TEXT,
         expires_at TIMESTAMPTZ
       )
       LANGUAGE plpgsql
       SECURITY DEFINER
       SET search_path = public
       AS $$
       BEGIN
         RETURN QUERY
         SELECT
           wi.id,
           v.name,
           b.name,
           (u.raw_user_meta_data->>'full_name')::TEXT,
           wi.role,
           wi.expires_at
         FROM workspace_invitations wi
         JOIN vaults v ON v.id = wi.workspace_id
         JOIN banks b ON b.id = v.bank_id
         JOIN auth.users u ON u.id = wi.invited_by
         WHERE wi.token = p_token
           AND wi.status = 'pending'
           AND wi.expires_at > NOW();
       END;
       $$;
       ```

    7. **accept_workspace_invite RPC** — SECURITY DEFINER function for accepting invites:
       Accepts token + user_id, verifies token is valid + pending, creates vault_memberships row, updates invitation status to 'accepted', sets accepted_at.

    8. **protect_default_workspace trigger** — Prevent deletion of vaults where is_default = true:
       ```sql
       CREATE OR REPLACE FUNCTION prevent_default_workspace_delete()
       RETURNS TRIGGER AS $$
       BEGIN
         IF OLD.is_default = TRUE THEN
           RAISE EXCEPTION 'Cannot delete the default workspace';
         END IF;
         RETURN OLD;
       END;
       $$ LANGUAGE plpgsql;

       CREATE TRIGGER protect_default_workspace
       BEFORE DELETE ON public.vaults
       FOR EACH ROW EXECUTE FUNCTION prevent_default_workspace_delete();
       ```

    Run the migration against production using the existing pattern:
    ```
    PGHOST=aws-1-us-east-1.pooler.supabase.com PGPORT=5432 PGUSER=postgres.vltmrnjsubfzrgrtdqey PGPASSWORD=x2n2KlCAA8suZjqa PGDATABASE=postgres psql -f supabase/migrations/20260228000001_workspace_redesign_schema.sql
    ```
  </action>
  <verify>
    1. `cat /Users/Naegele/dev/callvault/vercel.json` shows redirect rules with `"permanent": true`
    2. Run SQL verification queries against production:
       - `SELECT column_name FROM information_schema.columns WHERE table_name = 'workspace_invitations';` returns expected columns
       - `SELECT column_name FROM information_schema.columns WHERE table_name = 'folders' AND column_name IN ('vault_id', 'is_archived', 'archived_at');` returns 3 rows
       - `SELECT column_name FROM information_schema.columns WHERE table_name = 'vaults' AND column_name = 'is_default';` returns 1 row
       - `SELECT COUNT(*) FROM folders WHERE vault_id IS NULL;` returns 0 (all backfilled)
       - `SELECT COUNT(*) FROM vaults WHERE vault_type = 'personal' AND is_default = FALSE;` returns 0 (all personal vaults backfilled)
       - `SELECT COUNT(*) FROM vaults WHERE is_default = TRUE;` returns at least 1 (confirms backfill worked)
       - `SELECT routine_name FROM information_schema.routines WHERE routine_name IN ('get_workspace_invite_details', 'accept_workspace_invite');` returns 2 rows
       - Verify handle_new_user includes is_default: `SELECT prosrc FROM pg_proc WHERE proname = 'handle_new_user';` output contains 'is_default'
  </verify>
  <done>
    vercel.json has 301 redirects for all old paths. workspace_invitations table exists with RLS. folders have vault_id (backfilled), is_archived, archived_at. vaults have is_default — backfilled to TRUE for all existing personal vaults. handle_new_user() trigger updated to set is_default = TRUE for new signups. RPCs for invite details and acceptance exist. Default workspace delete protection trigger active and functional (personal vaults are protected).
  </done>
</task>

<task type="auto">
  <name>Task 2: TypeScript type aliases and query key updates</name>
  <files>
    /Users/Naegele/dev/callvault/src/types/workspace.ts
    /Users/Naegele/dev/callvault/src/lib/query-config.ts
  </files>
  <action>
    **src/types/workspace.ts** — Create new file with TypeScript type aliases that map from DB table names (banks/vaults/folders) to new concept names (Organization/Workspace/Folder). Per research recommendation: use TypeScript type aliases over DB views. All Supabase queries continue using original table names (banks, vaults, folders). Only display strings use new names.

    Define these types:
    ```typescript
    import type { Database } from './supabase'

    // --- Type Aliases: New concept names mapping to existing DB tables ---
    // Queries still use supabase.from('banks'), supabase.from('vaults'), etc.
    // These aliases are for TypeScript type safety with new naming.

    type BankRow = Database['public']['Tables']['banks']['Row']
    type VaultRow = Database['public']['Tables']['vaults']['Row']
    type FolderRow = Database['public']['Tables']['folders']['Row']

    /** Organization = Bank in the DB. Display as "Organization" in UI. */
    export type Organization = BankRow

    /** Workspace = Vault in the DB. Display as "Workspace" in UI. */
    export type Workspace = VaultRow & {
      is_default?: boolean  // Added in Phase 16 migration, may not be in generated types yet
    }

    /** Workspace invitation for email-based invites */
    export interface WorkspaceInvitation {
      id: string
      workspace_id: string
      invited_by: string
      email: string
      role: 'vault_admin' | 'manager' | 'member' | 'guest'
      token: string
      status: 'pending' | 'accepted' | 'revoked' | 'expired'
      expires_at: string
      created_at: string
      accepted_at: string | null
    }

    /** Invite details returned by get_workspace_invite_details RPC */
    export interface WorkspaceInviteDetails {
      invitation_id: string
      workspace_name: string
      organization_name: string
      inviter_display_name: string
      role: string
      expires_at: string
    }

    /** Folder with Phase 16 additions (vault_id, is_archived) */
    export interface Folder {
      id: string
      name: string
      user_id: string
      bank_id: string
      vault_id: string | null
      parent_folder_id: string | null
      position: number
      is_archived: boolean
      archived_at: string | null
      created_at: string
      updated_at: string
    }

    /** Workspace member role hierarchy */
    export type WorkspaceRole = 'vault_owner' | 'vault_admin' | 'manager' | 'member' | 'guest'

    /** Role display names for UI */
    export const ROLE_DISPLAY_NAMES: Record<WorkspaceRole, string> = {
      vault_owner: 'Owner',
      vault_admin: 'Admin',
      manager: 'Manager',
      member: 'Member',
      guest: 'Viewer',  // "guest" in DB but "Viewer" per WKSP-11 requirement
    }

    /** Breadcrumb item for navigation */
    export interface BreadcrumbItem {
      label: string
      href?: string
    }
    ```

    **src/lib/query-config.ts** — Add `invitations` domain to the queryKeys factory:
    ```typescript
    invitations: {
      all: ['invitations'] as const,
      byWorkspace: (workspaceId: string) => ['invitations', 'workspace', workspaceId] as const,
      details: (token: string) => ['invitations', 'details', token] as const,
    },
    ```

    Also add `members` sub-key to workspaces if not already present (for workspace member queries).
  </action>
  <verify>
    1. `cd /Users/Naegele/dev/callvault && pnpm build` succeeds with zero errors
    2. `grep -r "Organization" src/types/workspace.ts` shows the type alias
    3. `grep -r "invitations" src/lib/query-config.ts` shows the new domain
  </verify>
  <done>
    TypeScript type aliases exist for Organization, Workspace, Folder, WorkspaceInvitation, WorkspaceInviteDetails. ROLE_DISPLAY_NAMES maps DB roles to user-friendly names. queryKeys factory includes invitations domain. Build passes clean.
  </done>
</task>

</tasks>

<verification>
- vercel.json exists with 301 redirects for /bank/, /vault/, /hub/, /vaults, /settings/banks paths
- Migration file exists and has been applied to production
- workspace_invitations table has RLS enabled
- folders.vault_id is backfilled (no NULL values for existing folders)
- vaults.is_default backfilled to TRUE for all existing personal vaults (vault_type='personal')
- handle_new_user() trigger sets is_default = TRUE when creating personal vault for new signups
- protect_default_workspace trigger can actually fire (vaults with is_default = TRUE exist)
- TypeScript types compile without errors
- pnpm build passes in callvault repo
</verification>

<success_criteria>
1. Old URL paths return 301 redirects at the server level (vercel.json)
2. All additive DB schema changes are applied: workspace_invitations, folders.vault_id, folders.is_archived, vaults.is_default
3. All existing personal vaults have is_default = TRUE (backfill verified)
4. New user signups create a personal vault with is_default = TRUE (handle_new_user updated)
5. RPCs exist: get_workspace_invite_details, accept_workspace_invite
6. Default workspace delete protection trigger is active and functional
7. TypeScript type system maps Organization/Workspace/Folder to DB types
8. pnpm build passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/16-workspace-redesign/16-01-SUMMARY.md`
</output>
