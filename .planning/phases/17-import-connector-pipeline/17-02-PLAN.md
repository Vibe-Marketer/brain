---
phase: 17-import-connector-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - supabase/functions/youtube-import/index.ts
  - supabase/functions/zoom-sync-meetings/index.ts
  - supabase/functions/sync-meetings/index.ts
  - supabase/functions/fetch-meetings/index.ts
autonomous: true

must_haves:
  truths:
    - "YouTube import writes to recordings table via pipeline — no fathom_calls writes"
    - "Zoom sync writes to recordings table via pipeline — no fathom_calls writes"
    - "Fathom sync writes to recordings table via pipeline — no fathom_calls writes"
    - "Deduplication works for all 3 connectors using source_metadata->>'external_id'"
    - "Existing sync_jobs progress tracking still works after rewire"
  artifacts:
    - path: "supabase/functions/youtube-import/index.ts"
      provides: "YouTube import using shared pipeline"
      contains: "connector-pipeline"
    - path: "supabase/functions/zoom-sync-meetings/index.ts"
      provides: "Zoom sync using shared pipeline"
      contains: "connector-pipeline"
  key_links:
    - from: "supabase/functions/youtube-import/index.ts"
      to: "supabase/functions/_shared/connector-pipeline.ts"
      via: "import { runPipeline }"
      pattern: "import.*connector-pipeline"
    - from: "supabase/functions/zoom-sync-meetings/index.ts"
      to: "supabase/functions/_shared/connector-pipeline.ts"
      via: "import { runPipeline }"
      pattern: "import.*connector-pipeline"
---

<objective>
Rewire all three existing import connectors (YouTube, Zoom, Fathom/sync-meetings) to use the shared connector pipeline for their database writes.

Purpose: This fixes a production bug — existing connectors write to `fathom_calls` which is now a read-only VIEW (Phase 15 archived the table). After rewire, all connectors write to `recordings` via the pipeline. This also normalizes the codebase: one insert path instead of three ad-hoc implementations.

Output: YouTube, Zoom, and Fathom sync edge functions all import from `connector-pipeline.ts` for stages 3-5 (dedup, transform, insert). Stages 1-2 (credentials, fetch) remain connector-specific.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-import-connector-pipeline/17-RESEARCH.md
@.planning/phases/17-import-connector-pipeline/17-01-SUMMARY.md
@supabase/functions/youtube-import/index.ts
@supabase/functions/zoom-sync-meetings/index.ts
@supabase/functions/sync-meetings/index.ts
@supabase/functions/fetch-meetings/index.ts
@supabase/functions/_shared/connector-pipeline.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire YouTube import to use shared pipeline</name>
  <files>supabase/functions/youtube-import/index.ts</files>
  <action>
Read `supabase/functions/youtube-import/index.ts` completely. Identify where it:
1. Checks for duplicates (currently queries `fathom_calls_archive` or `recordings` — look for `.filter('metadata->>youtube_video_id'` or similar)
2. Inserts into `fathom_calls` (now the VIEW — this is the broken write)
3. Inserts into `recordings` (may have dual write)
4. Inserts into `vault_entries`

Replace all of the above with the shared pipeline:

1. Add import: `import { checkDuplicate, insertRecording } from '../_shared/connector-pipeline.ts';`
2. Replace the duplicate check with: `checkDuplicate(supabase, userId, 'youtube', videoId)` where `videoId` is the YouTube video ID
3. Replace the `fathom_calls` insert entirely — DELETE the code that writes to `fathom_calls`. This write path is broken (inserts into a read-only VIEW fail).
4. Replace the `recordings` insert with: `insertRecording(supabase, userId, { external_id: videoId, source_app: 'youtube', title, full_transcript: transcript, recording_start_time: publishedAt, duration, source_metadata: { youtube_video_id: videoId, channel_title: channelTitle, ... } })`
5. Keep the existing vault_entry creation if it works, OR let the pipeline handle it (pipeline's insertRecording creates vault_entry automatically).

**CRITICAL:** Remove the numeric `recording_id` generation hack (the `9000000000000 + timestamp` pattern). The pipeline uses UUID ids via the `recordings` table. The `legacy_recording_id` column is for backward compat only and should NOT be populated for new imports.

Keep all YouTube API fetching code (stages 1-2) unchanged. Only change the DB write path (stages 3-5).

After changes, the youtube-import function should NOT reference `fathom_calls` anywhere.
  </action>
  <verify>
- `grep -c "fathom_calls" supabase/functions/youtube-import/index.ts` returns 0
- `grep -c "connector-pipeline" supabase/functions/youtube-import/index.ts` returns at least 1
- No `9000000000000` numeric ID generation
- `checkDuplicate` or `runPipeline` used for dedup
- `insertRecording` used for DB writes
  </verify>
  <done>
YouTube import uses shared pipeline for dedup + insert, zero references to fathom_calls, no legacy numeric ID hack
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewire Zoom and Fathom sync to use shared pipeline</name>
  <files>
    supabase/functions/zoom-sync-meetings/index.ts
    supabase/functions/sync-meetings/index.ts
    supabase/functions/fetch-meetings/index.ts
  </files>
  <action>
**Zoom sync (`zoom-sync-meetings/index.ts`):**

Read the file completely. Identify where it:
1. Checks for duplicates (look for dedup queries against `fathom_calls` or `recordings`)
2. Inserts into `fathom_calls` (now the VIEW — broken)
3. Inserts into `recordings`
4. Creates `vault_entries`

Replace DB write path with pipeline imports:
1. Add import: `import { checkDuplicate, insertRecording } from '../_shared/connector-pipeline.ts';`
2. Replace dedup with: `checkDuplicate(supabase, userId, 'zoom', zoomMeetingId)` where `zoomMeetingId` is the Zoom meeting UUID
3. Remove ALL `fathom_calls` inserts
4. Replace `recordings` insert with: `insertRecording(supabase, userId, { external_id: zoomMeetingId, source_app: 'zoom', title, full_transcript, recording_start_time, duration, source_metadata: { zoom_meeting_id: zoomMeetingId, ... } })`

Keep: `sync_jobs` progress tracking (progress_current, progress_total, synced_ids, failed_ids), `EdgeRuntime.waitUntil()` pattern, Zoom API fetching, OAuth token refresh. Only change the DB write path.

**Fathom sync (`sync-meetings/index.ts` and `fetch-meetings/index.ts`):**

Read both files. These handle Fathom sync. Identify:
1. Where meetings are fetched from Fathom API
2. Where they are inserted into `fathom_calls` (now broken)
3. Any dedup logic

Replace DB writes with pipeline:
1. Add pipeline imports
2. Use `checkDuplicate(supabase, userId, 'fathom', fathomCallId)` for dedup
3. Use `insertRecording(supabase, userId, { external_id: fathomCallId, source_app: 'fathom', title, full_transcript, recording_start_time, duration, source_metadata: { fathom_call_id: fathomCallId, ... } })`
4. Remove ALL `fathom_calls` insert references

After changes, NONE of these files should reference `fathom_calls` for writes (reads are acceptable during transition but writes MUST go through pipeline).

**Important:** Preserve all existing error handling, retry logic, and progress tracking. The `_shared/fathom-client.ts` and `_shared/zoom-client.ts` files should NOT be modified — they handle API communication, not DB writes.
  </action>
  <verify>
- `grep -c "\.from('fathom_calls')" supabase/functions/zoom-sync-meetings/index.ts` returns 0 (no fathom_calls writes)
- `grep -c "connector-pipeline" supabase/functions/zoom-sync-meetings/index.ts` returns at least 1
- `grep -c "\.from('fathom_calls').insert" supabase/functions/sync-meetings/index.ts` returns 0
- `grep -c "\.from('fathom_calls').insert" supabase/functions/fetch-meetings/index.ts` returns 0
- `sync_jobs` progress tracking code still present in zoom-sync-meetings
- `EdgeRuntime.waitUntil` still present in zoom-sync-meetings
  </verify>
  <done>
All 3 existing connectors (YouTube, Zoom, Fathom) write to recordings via shared pipeline. Zero fathom_calls insert references remain. Sync progress tracking preserved.
  </done>
</task>

</tasks>

<verification>
- `grep -r "\.from('fathom_calls').insert" supabase/functions/youtube-import/ supabase/functions/zoom-sync-meetings/ supabase/functions/sync-meetings/ supabase/functions/fetch-meetings/` returns no matches
- All 3 connectors import from `_shared/connector-pipeline.ts`
- Existing sync_jobs polling pattern is preserved (zoom-sync-meetings progress_current/progress_total still updated)
- No new npm dependencies introduced
</verification>

<success_criteria>
1. All 3 existing connectors use the shared pipeline for DB writes (IMP-01 satisfied)
2. The broken fathom_calls VIEW insert is fixed — connectors write to recordings directly
3. Dedup uses source_metadata->>'external_id' consistently across all connectors
4. No regression in sync progress tracking (sync_jobs table still updated correctly)
</success_criteria>

<output>
After completion, create `.planning/phases/17-import-connector-pipeline/17-02-SUMMARY.md`
</output>
