---
phase: 17-import-connector-pipeline
plan: 03
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - supabase/functions/file-upload-transcribe/index.ts
autonomous: true

must_haves:
  truths:
    - "A file uploaded via multipart POST is transcribed by Whisper and saved as a recording"
    - "File upload connector edge function is ≤230 lines total"
    - "Files >25MB are rejected with a clear error message"
    - "Duplicate file uploads (same filename + size) are detected and skipped"
    - "The connector uses checkDuplicate and insertRecording from the shared pipeline"
    - "File uploads exceeding 10/month free tier limit are rejected with 429 status"
  artifacts:
    - path: "supabase/functions/file-upload-transcribe/index.ts"
      provides: "File upload connector with Whisper transcription"
      min_lines: 40
  key_links:
    - from: "supabase/functions/file-upload-transcribe/index.ts"
      to: "supabase/functions/_shared/connector-pipeline.ts"
      via: "import { checkDuplicate, insertRecording }"
      pattern: "import.*connector-pipeline"
    - from: "supabase/functions/file-upload-transcribe/index.ts"
      to: "https://api.openai.com/v1/audio/transcriptions"
      via: "fetch POST to Whisper API"
      pattern: "api\\.openai\\.com/v1/audio/transcriptions"
---

<objective>
Build the file upload connector edge function — the first new connector that validates the ≤230 line pipeline promise (IMP-02).

Purpose: This proves the shared pipeline works. A new connector should require only: (1) an edge function adapter handling auth + request parsing + Whisper API call, (2) pipeline calls for dedup + insert. The entire edge function should be well under 230 lines.

Output: `supabase/functions/file-upload-transcribe/index.ts` — a working Whisper transcription connector.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-import-connector-pipeline/17-RESEARCH.md
@.planning/phases/17-import-connector-pipeline/17-01-SUMMARY.md
@supabase/functions/_shared/connector-pipeline.ts
@supabase/functions/_shared/cors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file-upload-transcribe edge function</name>
  <files>supabase/functions/file-upload-transcribe/index.ts</files>
  <action>
Create `supabase/functions/file-upload-transcribe/index.ts`:

**Imports:**
- `createClient` from supabase-js (Deno ESM import)
- `getCorsHeaders` from `../_shared/cors.ts`
- `checkDuplicate`, `insertRecording` from `../_shared/connector-pipeline.ts`

**Constants:**
- `WHISPER_URL = 'https://api.openai.com/v1/audio/transcriptions'`
- `MAX_FILE_SIZE = 25 * 1024 * 1024` (25MB — Whisper limit)
- `ACCEPTED_TYPES` — Set of MIME types: `audio/mpeg` (MP3), `audio/wav`, `audio/x-wav`, `audio/mp4` (M4A), `audio/x-m4a`, `video/mp4`, `video/quicktime` (MOV), `video/webm`

**Handler flow (Deno.serve):**

1. CORS preflight: if OPTIONS, return 204 with cors headers
2. Auth: extract Bearer token, create supabase client with `SUPABASE_URL` + `SUPABASE_SERVICE_ROLE_KEY`, call `supabase.auth.getUser(token)`, return 401 if no user
3. Parse multipart form data: `const formData = await req.formData()`, get file as `formData.get('file')`
4. Validate file exists, validate `file.size <= MAX_FILE_SIZE` (return 400 with `"File exceeds 25MB limit. For video files, consider extracting the audio track first."` if too large)
5. Optional: validate MIME type against ACCEPTED_TYPES (return 400 with clear message listing accepted formats if wrong type)
6. **Import quota check (locked decision: 10 imports/month free tier):** Before dedup, query import count for the current billing month: `SELECT COUNT(*) FROM recordings WHERE owner_user_id = userId AND created_at >= date_trunc('month', now())`. If count >= 10, return 429 with `{ error: 'Monthly import limit reached (10/month on free tier). Upgrade for unlimited imports.' }`. This ensures file uploads count toward the same 10/month limit as all other sources.
7. Stage 3 — Dedup: `const externalId = \`\${file.name}-\${file.size}\``; call `checkDuplicate(supabase, user.id, 'file-upload', externalId)`. Return `{ error: 'File already imported', exists: true }` if duplicate.
8. Stage 4 — Whisper transcription:
   - Build FormData: append file, model `'whisper-1'`, response_format `'text'`
   - POST to WHISPER_URL with Authorization header using `Deno.env.get('OPENAI_API_KEY')`
   - Do NOT set Content-Type header (fetch sets multipart boundary automatically)
   - If Whisper returns non-OK, return 502 with `"Transcription failed"` and include status code in error
   - Parse transcript as text: `const transcript = await whisperRes.text()`
9. Stage 5 — Insert via pipeline:
   ```
   const recording = await insertRecording(supabase, user.id, {
     external_id: externalId,
     source_app: 'file-upload',
     title: file.name.replace(/\.[^.]+$/, ''),  // strip extension
     full_transcript: transcript,
     recording_start_time: new Date().toISOString(),
     source_metadata: { original_filename: file.name, file_size: file.size, mime_type: file.type },
   });
   ```
10. Return 200 with `{ success: true, recordingId: recording.id }`
11. Wrap the whole handler in try/catch — return 500 with error message on unexpected errors

**Target: ~70-90 lines.** The IMP-02 budget is ≤230 lines for the ENTIRE connector (adapter + component + registry line). This edge function is the adapter portion.

**Note:** This is a synchronous flow — the request waits for Whisper to finish. For MVP this is acceptable (most audio files take 10-60 seconds). If timeouts become an issue, the Plan 02 pattern (EdgeRuntime.waitUntil + sync_jobs polling) can be added later. Per research, Supabase Edge Functions have a 150-second wall-clock limit which is sufficient for files under 25MB.
  </action>
  <verify>
- File exists at `supabase/functions/file-upload-transcribe/index.ts`
- `wc -l supabase/functions/file-upload-transcribe/index.ts` returns ≤120 lines
- Imports `checkDuplicate` and `insertRecording` from connector-pipeline
- Imports `getCorsHeaders` from cors.ts
- Uses `Deno.env.get('OPENAI_API_KEY')` for Whisper auth
- Uses `Deno.env.get('SUPABASE_URL')` and `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')` for supabase client
- Validates file size against 25MB limit
- Checks monthly import quota (10/month) before processing, returns 429 if exceeded
- POST to `api.openai.com/v1/audio/transcriptions` with model `whisper-1`
- Returns 200 with recordingId on success
  </verify>
  <done>
File upload connector exists at ≤120 lines, uses shared pipeline for dedup + insert, transcribes via Whisper API, validates file size, handles errors gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify ≤230 line budget and deploy</name>
  <files>supabase/functions/file-upload-transcribe/index.ts</files>
  <action>
Count total lines for the file upload connector:
```bash
wc -l supabase/functions/file-upload-transcribe/index.ts
```

The IMP-02 requirement is ≤230 lines for "1 adapter file + 1 edge function + 1 connector component + 1 registry line." For the backend portion (this plan), the edge function IS the adapter file AND edge function combined. The connector component (frontend SourceCard + FileUploadDropzone) will be counted in Plan 04. The registry line is adding the source to the source registry.

Document the line count in the summary. The backend portion should be well under 100 lines.

Deploy the edge function:
```bash
cd /Users/Naegele/dev/brain && npx supabase functions deploy file-upload-transcribe --project-ref vltmrnjsubfzrgrtdqey
```

If the deploy command requires auth, note it for the user. The function should use `verify_jwt = true` in config (user must be authenticated to upload files).

Add to `supabase/config.toml` if needed:
```toml
[functions.file-upload-transcribe]
verify_jwt = true
```

Test with curl (requires a valid JWT — can test locally or note for human verification):
```bash
curl -X POST https://vltmrnjsubfzrgrtdqey.supabase.co/functions/v1/file-upload-transcribe \
  -H "Authorization: Bearer $JWT" \
  -F "file=@test-audio.mp3"
```
  </action>
  <verify>
- `wc -l supabase/functions/file-upload-transcribe/index.ts` ≤ 120 (backend adapter portion of the 230-line budget)
- Edge function deploys without errors (or deployment steps documented)
- config.toml entry exists for file-upload-transcribe with verify_jwt = true
  </verify>
  <done>
File upload connector backend is under 120 lines, deployed (or deployment documented), config.toml updated. IMP-02 line budget tracking documented.
  </done>
</task>

</tasks>

<verification>
- File upload edge function exists and is under 120 lines
- Uses shared pipeline (imports from connector-pipeline.ts)
- Validates 25MB file size limit
- Whisper API integration verified via code review (endpoint, model, auth)
- IMP-02 line count tracking started (backend portion documented)
</verification>

<success_criteria>
1. A new connector (file-upload-transcribe) exists that uses the shared pipeline for stages 3-5
2. The edge function is well under the 230-line budget (targeting ~70-90 lines for the adapter)
3. The connector handles auth, file validation, Whisper transcription, dedup, and recording insert — the full pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/17-import-connector-pipeline/17-03-SUMMARY.md`
</output>
