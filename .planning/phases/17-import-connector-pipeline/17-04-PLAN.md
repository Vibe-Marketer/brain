---
phase: 17-import-connector-pipeline
plan: 04
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/routes/_authenticated/import/index.tsx
  - src/components/import/SourceCard.tsx
  - src/components/import/FileUploadDropzone.tsx
  - src/components/import/ImportSourceGrid.tsx
  - src/components/import/FailedImportsSection.tsx
  - src/services/import-sources.service.ts
  - src/hooks/useImportSources.ts
  - src/lib/query-config.ts
autonomous: true

must_haves:
  truths:
    - "User can see all connected import sources as cards with logo, name, status badge, last sync time, call count, and active/inactive toggle"
    - "User can toggle a source active/inactive and the change persists across page refresh"
    - "User can drag-and-drop audio/video files onto the upload dropzone to start transcription"
    - "File upload validates 25MB size limit and accepted formats before sending to edge function"
    - "Source cards show connection status (active/paused/error/disconnected)"
    - "An 'Add Source' card is visible at the end of the grid for future connector discovery"
    - "Failed imports are shown with per-call retry buttons"
    - "After first-time OAuth, sync triggers automatically without user prompt"
    - "User can disconnect a source via a confirm dialog; imported calls are kept"
    - "Sync completion toast includes count of skipped duplicates when applicable"
  artifacts:
    - path: "src/routes/_authenticated/import/index.tsx"
      provides: "Import Hub page with source grid and file upload"
    - path: "src/components/import/SourceCard.tsx"
      provides: "Per-source card component with status, toggle, sync button"
    - path: "src/components/import/FileUploadDropzone.tsx"
      provides: "Drag-and-drop file upload area"
    - path: "src/components/import/ImportSourceGrid.tsx"
      provides: "Card grid container"
    - path: "src/services/import-sources.service.ts"
      provides: "Import sources CRUD service"
    - path: "src/hooks/useImportSources.ts"
      provides: "React hooks for import source data"
    - path: "src/components/import/FailedImportsSection.tsx"
      provides: "Failed imports list with per-call retry buttons"
  key_links:
    - from: "src/hooks/useImportSources.ts"
      to: "src/services/import-sources.service.ts"
      via: "useQuery wrapping service functions"
      pattern: "useQuery.*getImportSources"
    - from: "src/services/import-sources.service.ts"
      to: "import_sources table"
      via: "supabase.from('import_sources')"
      pattern: "from\\('import_sources'\\)"
    - from: "src/components/import/FileUploadDropzone.tsx"
      to: "file-upload-transcribe edge function"
      via: "supabase.functions.invoke('file-upload-transcribe')"
      pattern: "file-upload-transcribe"
---

<objective>
Build the Import Hub UI — a card grid showing all connected import sources with status, toggles, and a file upload dropzone.

Purpose: This satisfies IMP-03 (import source management UI). Users connect new sources and manage existing ones from a single page. Each source is a card showing logo, name, status, last sync, call count, and an active/inactive toggle. The file upload dropzone allows drag-and-drop audio/video upload for Whisper transcription.

Output: A fully functional Import Hub page replacing the placeholder at /import.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-import-connector-pipeline/17-RESEARCH.md
@.planning/phases/17-import-connector-pipeline/17-01-SUMMARY.md
@.planning/phases/14-foundation/14-04-SUMMARY.md
@src/routes/_authenticated/import/index.tsx
@src/lib/query-config.ts
@src/hooks/useRecordings.ts
@src/services/recordings.service.ts
@src/components/layout/AppShell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create import sources service and hooks</name>
  <files>
    src/services/import-sources.service.ts
    src/hooks/useImportSources.ts
    src/lib/query-config.ts
  </files>
  <action>
**Service layer** (`src/services/import-sources.service.ts`):

Follow the established service pattern from `recordings.service.ts`:

```typescript
import { supabase } from '@/lib/supabase';

export interface ImportSource {
  id: string;
  user_id: string;
  source_app: string;
  is_active: boolean;
  account_email: string | null;
  last_sync_at: string | null;
  error_message: string | null;
  created_at: string;
  updated_at: string;
}

export interface ImportSourceWithCount extends ImportSource {
  call_count: number;
}
```

Functions:
- `getImportSources()` — query `import_sources` table, ORDER BY `source_app`. Returns `ImportSource[]`.
- `getImportCounts()` — call `supabase.rpc('get_import_counts', { p_user_id: userId })`. Requires user ID. Returns `Record<string, number>` mapping source_app to count.
- `toggleSourceActive(sourceId: string, isActive: boolean)` — UPDATE `import_sources` SET `is_active`, `updated_at = new Date().toISOString()`. Returns updated row.
- `upsertImportSource(source: { source_app: string, account_email?: string })` — UPSERT into `import_sources` using `onConflict: 'user_id,source_app'`. Used when connecting a new source.
- `uploadFile(file: File)` — POST to file-upload-transcribe edge function via `supabase.functions.invoke('file-upload-transcribe', { body: formData })` where formData has the file. Returns `{ recordingId: string }` on success.
- `disconnectImportSource(sourceId: string)` — DELETE from `import_sources` WHERE `id = sourceId`. Per locked decision: disconnecting keeps all imported calls, only stops future syncs.
- `retryFailedImport(sourceApp: string, failedExternalId: string)` — dispatch to the appropriate source's sync function based on `sourceApp`: for `'fathom'` invoke `'sync-meetings'` with `{ singleCallId: failedExternalId }`, for `'zoom'` invoke `'zoom-sync-meetings'` with `{ singleCallId: failedExternalId }`, for `'youtube'` invoke `'youtube-import'` with `{ singleCallId: failedExternalId }`, for `'file-upload'` return an error directing user to re-upload the file. Returns success/failure.
- `getFailedImports()` — query `sync_jobs` table where `failed_ids` is not null and array length > 0, JOIN with `import_sources` for source name. Returns failed import rows with source_app, failed_ids, error details.

**Hooks layer** (`src/hooks/useImportSources.ts`):

Follow the established hook pattern from `useRecordings.ts`:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { queryKeys } from '@/lib/query-config';
```

- `useImportSources()` — `useQuery` wrapping `getImportSources()` with key `queryKeys.imports.sources()`
- `useImportCounts()` — `useQuery` wrapping `getImportCounts()` with key `queryKeys.imports.counts()`, staleTime 5 minutes
- `useToggleSource()` — `useMutation` wrapping `toggleSourceActive()`, invalidates `queryKeys.imports.sources()` on success
- `useFileUpload()` — `useMutation` wrapping `uploadFile()`, invalidates `queryKeys.recordings.all` and `queryKeys.imports.sources()` on success. Track upload progress state if possible.
- `useDisconnectSource()` — `useMutation` wrapping `disconnectImportSource()`. On success: invalidates `queryKeys.imports.sources()`. Shows Sonner toast "Source disconnected".
- `useFailedImports()` — `useQuery` wrapping `getFailedImports()` with key `queryKeys.imports.failed()`, refetchInterval 30s while any sync is active.
- `useRetryFailedImport()` — `useMutation` wrapping `retryFailedImport()`. On success: invalidates `queryKeys.imports.failed()` and `queryKeys.imports.sources()`.

**Query config update** (`src/lib/query-config.ts`):

Add `counts` to the existing `imports` domain:
```typescript
imports: {
  all: ['imports'] as const,
  sources: () => ['imports', 'sources'] as const,
  counts: () => ['imports', 'counts'] as const,
  history: () => ['imports', 'history'] as const,
  failed: () => ['imports', 'failed'] as const,
},
```
  </action>
  <verify>
- `src/services/import-sources.service.ts` exists with `getImportSources`, `getImportCounts`, `toggleSourceActive`, `upsertImportSource`, `uploadFile` exports
- `src/hooks/useImportSources.ts` exists with `useImportSources`, `useImportCounts`, `useToggleSource`, `useFileUpload` exports
- `src/lib/query-config.ts` has `counts` in the `imports` domain
- Service uses `supabase.from('import_sources')` for CRUD
- Service uses `supabase.rpc('get_import_counts')` for counts
- Hooks use `queryKeys.imports.*` for cache keys
  </verify>
  <done>
Service and hook layers exist following established patterns, query keys updated, all 4 CRUD operations and file upload covered
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Import Hub UI with source cards and file upload dropzone</name>
  <files>
    src/routes/_authenticated/import/index.tsx
    src/components/import/SourceCard.tsx
    src/components/import/FileUploadDropzone.tsx
    src/components/import/ImportSourceGrid.tsx
  </files>
  <action>
**SourceCard component** (`src/components/import/SourceCard.tsx`):

Per locked decision: card with logo, source name, connected account email, status badge (active/paused/error), last sync time, call count imported, active/inactive toggle.

Props interface:
```typescript
interface SourceCardProps {
  name: string;           // 'Fathom', 'Zoom', 'YouTube', 'File Upload'
  sourceApp: string;      // 'fathom', 'zoom', 'youtube', 'file-upload'
  icon: React.ReactNode;  // Remix Icon component
  status: 'active' | 'paused' | 'error' | 'disconnected';
  accountEmail?: string;
  lastSyncAt?: string;
  callCount: number;
  isActive: boolean;
  onToggle: (active: boolean) => void;
  onSync?: () => void;      // "Sync Now" button for OAuth sources
  onConnect?: () => void;    // "Connect" button for disconnected sources
  onDisconnect?: () => void;
  syncProgress?: { current: number; total: number };
  errorMessage?: string;
}
```

Use shadcn/ui: `Card`, `CardContent`, `Badge`, `Switch`, `Button`, `Progress`.
Use Remix Icon: `RiCloudLine` (Fathom), `RiVideoLine` (Zoom), `RiYoutubeLine` (YouTube), `RiUploadCloud2Line` (File Upload).

Status badge colors:
- active: green background (`bg-emerald-500/10 text-emerald-500`)
- paused: amber (`bg-amber-500/10 text-amber-500`)
- error: red (`bg-red-500/10 text-red-500`)
- disconnected: muted (`bg-muted text-muted-foreground`)

Show last sync as relative time (e.g., "2 hours ago") — use a simple `formatRelativeTime` helper.
Show "Sync Now" button only for OAuth sources (Fathom, Zoom) when status is active.
Show active/inactive Switch with label.
Show call count as "X calls imported".
Show "Disconnect" option (small text link or menu item) for connected sources. Per locked decision: clicking Disconnect opens a simple confirm dialog — "Disconnect [Source]? Future syncs will stop. Your imported calls will be kept." Confirm button calls `onDisconnect`. Uses shadcn `AlertDialog` component.

**FileUploadDropzone** (`src/components/import/FileUploadDropzone.tsx`):

Per locked decision: multi-file drag-and-drop, accepted formats (MP3, WAV, M4A, MP4, MOV, WebM), 25MB max.

Use HTML5 drag-and-drop events (`onDragOver`, `onDragLeave`, `onDrop`). No external library needed.

Accept attribute: `accept="audio/mpeg,audio/wav,audio/x-wav,audio/mp4,audio/x-m4a,video/mp4,video/quicktime,video/webm"`

Validate before upload:
- File size ≤ 25MB (show inline error: "File exceeds 25MB limit")
- MIME type in accepted list (show inline error: "Unsupported format. Accepted: MP3, WAV, M4A, MP4, MOV, WebM")

On valid drop: call `useFileUpload().mutate(file)` for each file. Show per-file progress (uploading/transcribing/done/error). Use Sonner toast for completion: "Transcription complete — [filename]".

Visual: dashed border card, upload icon, "Drag audio or video files here" text, "or click to browse" link that triggers hidden file input. Highlight border on dragover (brand orange or primary color).

**ImportSourceGrid** (`src/components/import/ImportSourceGrid.tsx`):

Container for SourceCard components. Responsive grid: 1 col on mobile, 2 cols on sm, 3-4 cols on lg.

```tsx
<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
  {sources.map(source => <SourceCard key={source.sourceApp} {...source} />)}
</div>
```

**ImportHubPage rewrite** (`src/routes/_authenticated/import/index.tsx`):

Replace the current placeholder with the full Import Hub:

1. Use `useImportSources()` and `useImportCounts()` for data
2. Define source registry (static config for the 4 sources: Fathom, Zoom, YouTube, File Upload) mapping sourceApp to display name, icon, and connection type (oauth vs direct)
3. Merge import_sources data with source registry to build card props
4. Determine status from import_sources row: no row = disconnected, row with is_active = true and no error = active, is_active = false = paused, error_message present = error
5. Render within AppShell (no secondaryPane — full-width main):
   - Page heading: "Import Hub"
   - ImportSourceGrid with SourceCards for all 4 sources
   - FileUploadDropzone below the grid (or as the File Upload card's expanded state)
   - Per locked decision: include an "Add Source" card at the end of the grid. This card has a "+" icon and "Add Source" label. Clicking it opens a panel/dialog showing "Coming soon" connectors (Grain, Fireflies) with disabled state. The per-card "Connect" buttons on disconnected sources serve as the inline add/connect action for currently supported sources. The "Add Source" card is the entry point for future connectors.
   - FailedImportsSection: below the source grid (above or below the dropzone), query `sync_jobs` table for jobs with `failed_ids` array length > 0. Render a collapsible section "Failed Imports" showing per-call rows with: source name, call title or external_id, error message, and a "Retry" button. The retry button calls `retryFailedImport(sourceApp, failedExternalId)` which dispatches to the appropriate connector's edge function (sync-meetings for Fathom, zoom-sync-meetings for Zoom, youtube-import for YouTube) with `{ singleCallId }` param for that single call. File uploads show "Re-upload file" instead of retry. If no failed imports exist, hide the section entirely.

For OAuth sources (Fathom, Zoom), the "Connect" button should redirect to the existing OAuth flow URLs. Use same-window redirect pattern (per v1 OAuth pattern). The OAuth callback will return the user to the Import page.

**Auto-sync after first-time OAuth (locked decision):** On Import Hub mount, check URL query params for `?source=fathom&connected=true` or `?source=zoom&connected=true` (set by OAuth callback). If present: (1) call `upsertImportSource({ source_app: sourceParam, account_email: emailFromCallback })` to register the connection, (2) immediately invoke the sync edge function for that source (`supabase.functions.invoke('sync-meetings')` for Fathom, `supabase.functions.invoke('zoom-sync-meetings')` for Zoom), (3) show a toast "Connected! Syncing your calls...", (4) clean up the query params from the URL using `window.history.replaceState`. This ensures the user sees calls appearing within seconds after OAuth, no extra prompt needed.

For YouTube, show as always "connected" (uses API key, no per-user OAuth). The "Sync" action should open a dialog or inline form for YouTube URL input (reuse the existing YouTube import form concept).

For File Upload, the card expands to show the FileUploadDropzone or the dropzone is always visible below the grid.

Use Sonner toast for sync completion notifications per locked decision. Per locked decision on dedup: the toast message should include skipped duplicate count when applicable — e.g., "Fathom sync complete — 8 new calls imported. Skipped 3 duplicates." Read `skipped_count` from the sync_jobs row (added in Plan 02) and include it in the toast if > 0.
  </action>
  <verify>
- `src/components/import/SourceCard.tsx` exists with status badge, toggle, sync button, call count, disconnect option with confirm dialog
- `src/components/import/FileUploadDropzone.tsx` exists with drag-and-drop, file validation, progress display
- `src/components/import/ImportSourceGrid.tsx` exists with responsive grid
- `src/components/import/FailedImportsSection.tsx` exists with per-call retry buttons
- `src/routes/_authenticated/import/index.tsx` renders all 4 source cards, an "Add Source" card, the file upload dropzone, and FailedImportsSection
- Import page uses AppShell
- Source cards show: name, icon, status badge, account email, last sync, call count, active/inactive toggle
- "Add Source" card visible at end of grid with "+" icon
- File upload validates 25MB and accepted MIME types before sending
- OAuth callback query params (`?source=...&connected=true`) trigger auto-sync on mount
- Disconnect confirm dialog renders with correct copy per locked decision
- `pnpm build` passes (in callvault/ repo)
  </verify>
  <done>
Import Hub page renders 4 source cards plus "Add Source" card, active/inactive toggle, sync buttons for OAuth sources, disconnect confirm dialog, FailedImportsSection with retry, auto-sync on OAuth return, file upload dropzone with drag-and-drop validation, and dedup-aware sync toasts. Page replaces placeholder. Build passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` in /Users/Naegele/dev/callvault/ passes with zero errors
- Import page at /import renders 4 source cards (Fathom, Zoom, YouTube, File Upload) plus "Add Source" card — not "Coming soon" placeholders
- Each card shows source name, icon, and connection status
- File upload dropzone is visible and accepts file drops
- Source toggle updates import_sources table via mutation
- "Add Source" card opens a panel showing future connectors
- FailedImportsSection renders when failed imports exist, hidden when none
- Disconnect confirm dialog appears on disconnect click with correct copy
- OAuth callback params trigger immediate sync
- Sync completion toasts include skipped duplicate count
</verification>

<success_criteria>
1. All 4 import sources are visible as cards on the Import Hub page plus "Add Source" card (IMP-03 satisfied, locked decision honored)
2. Each card shows logo, name, status badge, call count, active/inactive toggle, and disconnect option per locked decisions
3. File upload dropzone validates file size and format before sending to the edge function
4. Failed imports are surfaced with per-call retry buttons (partial failure handling)
5. Auto-sync triggers after first-time OAuth connection (no extra prompt)
6. The page follows established patterns (AppShell, service+hook separation, queryKeys factory, Sonner toasts)
</success_criteria>

<output>
After completion, create `.planning/phases/17-import-connector-pipeline/17-04-SUMMARY.md`
</output>
