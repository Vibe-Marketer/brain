---
phase: 02-chat-foundation
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/Chat.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Streaming errors show toast notification to user"
    - "Error logging is throttled to prevent console spam"
    - "Network disconnection shows clear user feedback"
  artifacts:
    - path: "src/pages/Chat.tsx"
      provides: "Error toast notifications and throttled logging"
      contains: "toast.error"
  key_links:
    - from: "error useEffect"
      to: "toast.error"
      via: "streaming errors trigger user notification"
      pattern: "toast\\.error.*Connection|Network"
---

<objective>
Fix Gaps 2 & 3: Error Toast Notifications and Console Spam

UAT found two related issues:
1. Gap 2: Network errors don't show toast notifications - user sees nothing when operations fail
2. Gap 3: Console shows 500+ error messages per second during network issues (runaway loop)

The streaming error handling in 02-08 added retry UX, but the toast notifications weren't consistently firing and console logging wasn't throttled.

Purpose: Users must see clear feedback when errors occur; console must not spam.
Output: Reliable toast.error calls on streaming failures + throttled error logging.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-chat-foundation/02-08-SUMMARY.md
@src/pages/Chat.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add throttled error logging and ensure toast fires</name>
  <files>src/pages/Chat.tsx</files>
  <action>
Update the error handling in Chat.tsx to fix two issues:

**1. Add throttled error logging to prevent console spam:**

Add a throttle mechanism near the top of the component (after the imports, before the component function):

```tsx
// Throttle error logging to prevent console spam during network issues
const ERROR_LOG_INTERVAL_MS = 5000; // Log at most once per 5 seconds per error type
const lastErrorLogTime = { current: new Map<string, number>() };

function throttledErrorLog(errorType: string, message: string, ...args: unknown[]) {
  const now = Date.now();
  const lastLog = lastErrorLogTime.current.get(errorType) || 0;

  if (now - lastLog >= ERROR_LOG_INTERVAL_MS) {
    lastErrorLogTime.current.set(errorType, now);
    logger.error(message, ...args);
  }
}
```

**2. Update the error useEffect to use throttled logging:**

In the `useEffect` that handles `error` (around line 510-655), replace direct `logger.error` calls with `throttledErrorLog`:

```tsx
// Change from:
logger.error('[Chat] Fetch error:', error);
// To:
throttledErrorLog('fetch', '[Chat] Fetch error:', error);

// Change from:
logger.error('[Chat] Session refresh failed, redirecting to login');
// To:
throttledErrorLog('session', '[Chat] Session refresh failed, redirecting to login');
```

**3. Ensure toast.error ALWAYS fires for connection errors:**

In the streaming interruption error handler (around line 549-608), the toast only fires after max reconnect attempts. Add an immediate toast for the first error:

Find this section:
```tsx
if (isStreamingInterruptionError(error) && lastUserMessageRef.current) {
  // Mark the last assistant message as incomplete
  ...
  if (currentAttempts <= MAX_RECONNECT_ATTEMPTS) {
    // Reconnection logic with toast.loading
```

Add toast.error for when we start reconnecting (user needs feedback immediately):
```tsx
if (currentAttempts === 1) {
  // First interruption - show brief error toast before reconnect toast
  toast.error('Connection interrupted. Attempting to reconnect...', {
    id: 'connection-error-toast',
    duration: 2000,
  });
}
```

**4. Add explicit toast for network errors that aren't streaming interruptions:**

After the streaming interruption check (around line 608), add a catch-all for network-type errors:

```tsx
// For non-streaming network errors, also show toast
if (error instanceof Error &&
    (error.message.toLowerCase().includes('network') ||
     error.message.toLowerCase().includes('failed to fetch'))) {
  toast.error('Network error. Please check your connection.', {
    id: 'network-error-toast',
    duration: 5000,
  });
}
```
  </action>
  <verify>
1. `grep -n "throttledErrorLog" src/pages/Chat.tsx` shows the throttle function
2. `grep -n "ERROR_LOG_INTERVAL_MS" src/pages/Chat.tsx` shows the constant
3. `grep -n "Connection interrupted" src/pages/Chat.tsx` shows the new toast message
4. `npm run build` passes without TypeScript errors
  </verify>
  <done>Error logging is throttled to 1 log per 5 seconds per error type; toast.error fires immediately on connection issues</done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Navigate to /chat and send a message to start streaming
3. Open DevTools Network tab and set to "Offline" mode mid-stream
4. Verify: Toast notification appears saying "Connection interrupted..." (NOT just console log)
5. Verify: Console does NOT show 500+ error messages (throttled to ~1 per 5 seconds)
6. Re-enable network and verify reconnection behavior
7. Check console - error spam should be controlled
</verification>

<success_criteria>
- Streaming errors immediately show toast notification to user
- Console error logging is throttled (no more 500+ messages per second)
- Network disconnection shows clear "Connection interrupted" toast
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-foundation/02-12-SUMMARY.md`
</output>
