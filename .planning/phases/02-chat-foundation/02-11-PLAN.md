---
phase: 02-chat-foundation
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/chat-stream-v2/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Model uses actual recording_ids from search results, not fabricated numbers"
    - "getCallDetails tool receives real recording_ids from prior tool calls"
    - "System prompt explicitly instructs model to use recording_ids from search results"
  artifacts:
    - path: "supabase/functions/chat-stream-v2/index.ts"
      provides: "Updated system prompt with recording_id usage instructions"
      contains: "NEVER invent or guess recording_id"
  key_links:
    - from: "system prompt"
      to: "getCallDetails tool"
      via: "explicit instruction to use recording_ids from tool results"
      pattern: "recording_id.*from.*search.*results"
---

<objective>
Fix Model Hallucination Bug: Use Real Recording IDs

UAT discovered the model calls getCallDetails with fabricated recording_ids (1, 2) instead of actual IDs from search results. The root cause is the system prompt doesn't explicitly instruct the model to extract and use recording_ids from prior tool results.

Purpose: Ensure getCallDetails receives valid recording_ids so call detail lookups succeed.
Output: Updated system prompt with explicit instructions about recording_id usage.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@supabase/functions/chat-stream-v2/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update system prompt with recording_id usage instructions</name>
  <files>supabase/functions/chat-stream-v2/index.ts</files>
  <action>
Update the buildSystemPrompt() function in chat-stream-v2/index.ts to add explicit instructions about recording_id usage. Add a new section after the tool descriptions:

Find the system prompt around line 91 and add the following section after "QUERY EXPANSION GUIDANCE" and before "TEMPORAL REFERENCE":

```
RECORDING ID RULES (CRITICAL):
- Every search result includes a recording_id field — this is the unique identifier for that call
- When you need call details, you MUST use the recording_id from your search results
- NEVER invent, guess, or use placeholder recording_ids like 1, 2, 3
- If you want details about a call mentioned in search results, extract its recording_id from those results
- Example flow:
  1. User asks "Tell me about my call with John"
  2. You call searchBySpeaker(query='meeting discussion', speaker='John')
  3. Results include: { recording_id: 847291, call_title: "Sales Call with John" }
  4. To get full details, call getCallDetails(recording_id='847291') — NOT getCallDetails(recording_id='1')
- If no search results exist yet, search first before trying to get call details
```

Also update the getCallDetails tool description (around line 109) to reinforce this:

Change from:
```
10. getCallDetails — Get complete details about a specific call by recording_id. Returns title, date, duration, speakers, summary, URL.
```

To:
```
10. getCallDetails — Get complete details about a specific call. IMPORTANT: You must use an actual recording_id from your search results, never a made-up number. Returns title, date, duration, speakers, summary, URL.
```
  </action>
  <verify>
1. `grep -A5 "RECORDING ID RULES" supabase/functions/chat-stream-v2/index.ts` shows the new section
2. `grep "NEVER invent" supabase/functions/chat-stream-v2/index.ts` shows the warning
3. `grep "actual recording_id" supabase/functions/chat-stream-v2/index.ts` shows updated tool description
  </verify>
  <done>System prompt includes explicit recording_id usage rules and warnings against fabrication</done>
</task>

</tasks>

<verification>
1. Deploy function: `supabase functions deploy chat-stream-v2`
2. Navigate to /chat
3. Ask: "What did we discuss recently? Then give me details about one of those calls."
4. Observe tool calls in the response
5. Verify: getCallDetails is called with an actual recording_id from search results (6+ digit number), not 1 or 2
6. Verify: Call details are returned successfully (not "Invalid recording_id" error)
</verification>

<success_criteria>
- System prompt contains RECORDING ID RULES section
- getCallDetails tool description mentions "actual recording_id from search results"
- Model uses real recording_ids from prior search results when calling getCallDetails
- No more "recording_id: 1" or "recording_id: 2" in tool calls
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-foundation/02-11-SUMMARY.md`
</output>
