---
phase: 02-chat-foundation
plan: 06
type: execute
wave: 3
depends_on: ["02-01"]
files_modified:
  - src/pages/Chat.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "/chat2 route exists and uses chat-stream-v2 endpoint"
    - "/chat continues to use legacy chat-stream endpoint (untouched)"
    - "User can test new backend via /chat2 while /chat remains stable"
  artifacts:
    - path: "src/pages/Chat.tsx"
      provides: "Transport URL conditionally uses v2 for /chat2 path"
      contains: "chat-stream-v2"
    - path: "src/App.tsx"
      provides: "/chat2 route definition"
      contains: "chat2"
  key_links:
    - from: "src/pages/Chat.tsx"
      to: "supabase/functions/chat-stream-v2"
      via: "DefaultChatTransport URL"
      pattern: "chat-stream-v2"
    - from: "src/App.tsx"
      to: "src/pages/Chat.tsx"
      via: "Route component"
      pattern: "chat2.*Chat"
---

<objective>
Create a /chat2 test path that uses the new chat-stream-v2 backend while keeping /chat on the legacy backend. This enables parallel testing â€” the new implementation can be validated without risking the existing chat.

Purpose: This is the locked decision from CONTEXT.md: "Build as a NEW Edge Function accessible via a /chat2 test path. The existing chat-stream continues serving /chat untouched."
Output: /chat2 route serving Chat.tsx connected to chat-stream-v2, /chat unchanged.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chat-foundation/02-CONTEXT.md

# Files to modify
@src/pages/Chat.tsx
@src/App.tsx

# PoC confirmed working
@.planning/phases/02-chat-foundation/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add /chat2 route and conditional transport URL</name>
  <files>src/App.tsx, src/pages/Chat.tsx</files>
  <action>
**Step 1: Add /chat2 route to App.tsx**

Read `src/App.tsx` and find where the `/chat` route is defined. Add a `/chat2` route pointing to the same Chat component:

```typescript
// Existing route stays:
<Route path="/chat" element={<Chat />} />
// Add new test route:
<Route path="/chat2" element={<Chat />} />
```

The Chat component itself will detect which path it's on and choose the appropriate backend.

**Step 2: Make Chat.tsx transport URL conditional**

Read `src/pages/Chat.tsx` and find the `DefaultChatTransport` construction (look for the transport URL pattern: `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/chat-stream`).

Add path detection to choose the endpoint:

```typescript
import { useLocation } from 'react-router-dom';

// Inside the component:
const location = useLocation();
const isV2 = location.pathname.startsWith('/chat2');
const chatEndpoint = isV2 ? 'chat-stream-v2' : 'chat-stream';

// In the transport construction:
const transport = new DefaultChatTransport({
  api: `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/${chatEndpoint}`,
  // ... rest stays the same
});
```

**Also add a visual indicator** when on /chat2 so testers know they're using the new backend:
- Add a small badge/pill at the top of the chat: "v2 backend" with a colored border (e.g., blue/purple)
- Only show when `isV2 === true`
- Use existing UI patterns (Tailwind + shadcn)

**Do NOT:**
- Change any Chat.tsx logic beyond the transport URL and v2 indicator
- Remove or modify the /chat route
- Change session management, message persistence, or any other behavior
- Import useLocation if it's already imported (check first)
  </action>
  <verify>
1. `grep "chat2" src/App.tsx` shows the route definition
2. `grep "chat-stream-v2" src/pages/Chat.tsx` shows conditional endpoint
3. `grep "isV2\|chat2" src/pages/Chat.tsx` shows path detection logic
4. `tsc --noEmit` passes
5. `/chat` route still loads normally (unchanged behavior)
6. `/chat2` route loads and connects to chat-stream-v2
  </verify>
  <done>
- /chat2 route defined in App.tsx
- Chat.tsx detects path and uses appropriate backend endpoint
- Visual "v2 backend" indicator visible on /chat2
- /chat completely unchanged (still uses chat-stream)
- Both routes share the same Chat component (no code duplication)
  </done>
</task>

</tasks>

<verification>
- /chat works as before (legacy backend)
- /chat2 works with new backend (chat-stream-v2)
- Visual v2 indicator visible on /chat2 only
- `tsc --noEmit` passes
- No regressions in session management or message persistence
</verification>

<success_criteria>
- Parallel testing path established: /chat (legacy) and /chat2 (v2)
- Zero changes to existing /chat behavior
- Clear visual indicator for v2 testing
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-foundation/02-06-SUMMARY.md`
</output>
