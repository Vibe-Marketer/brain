---
phase: 02-chat-foundation
plan: 08
type: execute
wave: 4
depends_on: ["02-06"]
files_modified:
  - src/pages/Chat.tsx
autonomous: true

must_haves:
  truths:
    - "Streaming failures show toast notification with 'Connection lost' message"
    - "Partial response is preserved on streaming failure (not wiped)"
    - "Retry button appears after streaming failure to resend the message"
    - "Chat stays stable for 10+ consecutive messages"
    - "Tool failures don't crash the stream — model continues with partial data"
  artifacts:
    - path: "src/pages/Chat.tsx"
      provides: "Error handling, retry logic, connection stability"
      contains: "retry"
  key_links:
    - from: "src/pages/Chat.tsx"
      to: "sonner toast"
      via: "toast.error on stream failure"
      pattern: "toast\\.error.*connection"
    - from: "src/pages/Chat.tsx"
      to: "useChat error handling"
      via: "error state and onError callback"
      pattern: "error|onError|retry"
---

<objective>
Implement streaming error handling and recovery UX: toast notifications on failure, partial response preservation, retry button, and connection stability improvements for the v2 backend path.

Purpose: CHAT-03 (streaming doesn't error out mid-response) and success criterion #5 (stable for 10+ messages). The current implementation has reconnection logic with exponential backoff, but error recovery UX is incomplete — failures should be graceful with clear recovery options.
Output: Robust error handling in Chat.tsx for streaming failures, tool failures, and connection drops.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chat-foundation/02-CONTEXT.md

# File to modify
@src/pages/Chat.tsx

# Frontend test path established
@.planning/phases/02-chat-foundation/02-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement streaming error handling and retry UX</name>
  <files>src/pages/Chat.tsx</files>
  <action>
Read `src/pages/Chat.tsx` (1900+ lines) and enhance the error handling for the chat streaming flow. Focus on the useChat error handling, the existing reconnection logic, and adding retry UX.

**1. Toast notification on streaming failure:**

Find where `useChat` errors are handled (the `error` state from `useChat` hook, and any existing error handlers). Add:

```typescript
import { toast } from 'sonner';

// When error is detected from useChat:
useEffect(() => {
  if (error) {
    toast.error('Connection lost. Your partial response has been saved.', {
      action: {
        label: 'Retry',
        onClick: () => handleRetry(),
      },
      duration: 10000, // Keep visible for 10 seconds
    });
  }
}, [error]);
```

**2. Partial response preservation:**

When a streaming error occurs:
- Do NOT clear the messages array
- Do NOT remove the partially-streamed assistant message
- The partial text should remain visible in the chat
- Add a visual indicator on the partial message: a subtle "Incomplete response" label or a different styling (e.g., slightly dimmed, with a warning icon)

Check the existing code for any `setMessages([])` or similar clearing on error — remove or guard those.

**3. Retry button:**

Add a `handleRetry()` function that:
- Takes the last user message
- Resends it to the chat endpoint
- Removes the incomplete assistant message first (so the new response replaces it)
- Uses the same session context (sessionId, filters, model)

Also add an inline retry button below the partial message (in addition to the toast action):

```tsx
{message.isIncomplete && (
  <button onClick={handleRetry} className="text-sm text-blue-500 hover:text-blue-700 mt-1">
    ↻ Retry
  </button>
)}
```

**4. Connection stability:**

Review the existing reconnection logic (exponential backoff, 3 attempts). Ensure:
- Backoff attempts don't produce duplicate messages
- Connection status is tracked (if there's an existing indicator, update it; if not, Claude's discretion on adding one)
- After max retries exhausted, show a clear "Connection failed" state with manual retry option
- Rate limit errors (429) are distinguished from connection errors — show different messages

**5. Tool failure handling:**

The v2 backend handles tool failures by returning `{ error: true, message: "..." }` in the tool result. The stream continues and the model should acknowledge the gap. On the frontend:
- Do NOT abort the stream on tool failure
- The model's text will reference the gap (system prompt instructs this)
- Tool call UI already handles error state (plan 04)

**Do NOT:**
- Refactor Chat.tsx structure (that's Phase 7 REFACTOR-01)
- Change the transport or endpoint logic (that's plan 06)
- Add a persistent connection indicator unless it fits naturally into existing UI
  </action>
  <verify>
1. `grep "toast.error\|Connection lost\|Retry" src/pages/Chat.tsx` shows error handling
2. `grep "handleRetry\|retry" src/pages/Chat.tsx` shows retry logic
3. `tsc --noEmit` passes
4. No `setMessages([])` called on error (partial preservation)
  </verify>
  <done>
- Streaming failures show toast with retry action
- Partial responses preserved (not wiped on error)
- Inline retry button below incomplete messages
- Connection stability reviewed and improved
- Tool failures don't crash the stream
- Rate limit errors distinguished from connection errors
- CHAT-03 and success criterion #5 addressed
  </done>
</task>

</tasks>

<verification>
- Toast appears on streaming error with retry action
- Partial response remains visible after error
- Retry resends the last user message
- No message duplication on retry
- Rate limit vs connection errors show different messages
- `tsc --noEmit` passes
</verification>

<success_criteria>
- Streaming failures are graceful with clear recovery path (CHAT-03)
- Partial responses preserved
- Retry works without duplication
- Chat stable for extended conversations (#5)
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-foundation/02-08-SUMMARY.md`
</output>
