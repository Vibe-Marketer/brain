---
phase: 02-chat-foundation
plan: 09
type: execute
wave: 5
depends_on: ["02-04", "02-05", "02-06", "02-07", "02-08"]
files_modified:
  - src/pages/Chat.tsx
  - src/App.tsx
  - supabase/functions/chat-stream/index.ts
autonomous: true

must_haves:
  truths:
    - "/chat serves responses from chat-stream-v2 (the new AI SDK backend)"
    - "Legacy chat-stream renamed to chat-stream-legacy as fallback"
    - "/chat2 test route removed (no longer needed)"
    - "All 6 Phase 2 success criteria pass end-to-end"
  artifacts:
    - path: "src/pages/Chat.tsx"
      provides: "Chat component always uses chat-stream-v2"
      contains: "chat-stream-v2"
    - path: "supabase/functions/chat-stream-legacy/index.ts"
      provides: "Renamed legacy function as fallback"
  key_links:
    - from: "src/pages/Chat.tsx"
      to: "supabase/functions/chat-stream-v2"
      via: "DefaultChatTransport URL"
      pattern: "chat-stream-v2"
---

<objective>
Switch /chat from the legacy backend to the new AI SDK-powered chat-stream-v2. Rename the old chat-stream to chat-stream-legacy as a fallback. Remove the /chat2 test route. Run final end-to-end verification of all 6 Phase 2 success criteria.

Purpose: This is the switchover — all previous plans have built and validated the new backend. Now it becomes the primary endpoint.
Output: /chat using v2 backend, legacy renamed as fallback, all success criteria verified.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chat-foundation/02-CONTEXT.md

# All prior plan summaries needed for switchover verification
@.planning/phases/02-chat-foundation/02-01-SUMMARY.md
@.planning/phases/02-chat-foundation/02-05-SUMMARY.md
@.planning/phases/02-chat-foundation/02-06-SUMMARY.md
@.planning/phases/02-chat-foundation/02-07-SUMMARY.md
@.planning/phases/02-chat-foundation/02-08-SUMMARY.md

# Files to modify
@src/pages/Chat.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename legacy chat-stream and switch /chat to v2</name>
  <files>src/pages/Chat.tsx, src/App.tsx, supabase/functions/chat-stream/index.ts</files>
  <action>
**Step 1: Rename legacy function**

Rename the `supabase/functions/chat-stream/` directory to `supabase/functions/chat-stream-legacy/`:
```bash
mv supabase/functions/chat-stream supabase/functions/chat-stream-legacy
```

This preserves the legacy function as a deployable fallback.

**Step 2: Update Chat.tsx to always use v2**

Remove the conditional transport URL logic added in plan 06. Replace with:

```typescript
// Direct to v2 (always)
const chatEndpoint = 'chat-stream-v2';

const transport = new DefaultChatTransport({
  api: `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/${chatEndpoint}`,
  // ... rest stays the same
});
```

Remove:
- The `useLocation()` import (if only used for /chat2 detection)
- The `isV2` path detection
- The "v2 backend" visual indicator badge
- Any /chat2-specific code

**Step 3: Remove /chat2 route from App.tsx**

Remove the `/chat2` route definition added in plan 06. Only `/chat` remains.

**Step 4: Verify no references to old `chat-stream` path remain**

Search for `chat-stream` (without `-v2` or `-legacy`) in:
- `src/pages/Chat.tsx` — should only reference `chat-stream-v2`
- Any other frontend files that might reference the endpoint

**Do NOT:**
- Delete the legacy function (keep as `chat-stream-legacy`)
- Change the v2 function itself
- Modify session management, persistence, or any other behavior
  </action>
  <verify>
1. `ls supabase/functions/chat-stream-legacy/index.ts` — legacy exists
2. `grep "chat-stream-v2" src/pages/Chat.tsx` — v2 is the default
3. `grep "chat2" src/App.tsx` — no /chat2 route
4. `grep "isV2\|chat2" src/pages/Chat.tsx` — no conditional code
5. `tsc --noEmit` passes
  </verify>
  <done>
- /chat now serves from chat-stream-v2 backend
- Legacy function renamed to chat-stream-legacy (fallback)
- /chat2 test route removed
- No references to old chat-stream path in frontend
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end verification of all Phase 2 success criteria</name>
  <files></files>
  <action>
Run automated verification of all 6 Phase 2 success criteria using Playwright or curl-based testing. Since this is yolo mode (no manual checkpoints), use automated browser testing.

**Success Criterion 1: "User can send chat message and receive complete streamed response without errors"**
- Use Playwright to navigate to /chat
- Send a message: "What topics were discussed in my recent calls?"
- Verify: Response streams in without console errors
- Check: useChat status transitions to 'ready' after completion

**Success Criterion 2: "All 14 RAG tools fire when relevant to query"**
- Send a broad query: "Give me a comprehensive analysis of all my calls — search by topic, speaker, date, sentiment, and entities"
- Verify: Multiple tool calls appear in the response (check for tool-call UI elements)
- Note: Not all 14 will fire on one query, but multiple should fire

**Success Criterion 3: "Tool calls that find data return that data to the UI"**
- Verify: Tool calls with results show green indicator + result count (not empty checkmarks)
- Check: Tool calls with no results show amber indicator

**Success Criterion 4: "Citations appear inline in chat responses"**
- Verify: Response text contains [N] citation markers
- Verify: Bottom source list is present
- Check: Citations survive page reload (navigate away and back)

**Success Criterion 5: "Chat connection stays stable for 10+ consecutive messages"**
- Send 3-5 test messages in sequence (automated)
- Verify: No connection errors, no reconnection attempts
- Check: All responses complete successfully

**Success Criterion 6: "Store errors surface to user with actionable error messages"**
- This was verified in plan 02 (STORE-01)
- Quick re-check: `grep -rc "toast.error" src/stores/` confirms 16 toast.error calls

**Create a test results summary** in the SUMMARY.md output documenting each criterion's pass/fail status.

**If any criterion FAILS:** Document what failed, what the expected behavior was, and what the actual behavior was. Do NOT block the plan — document for gap closure.
  </action>
  <verify>
1. Playwright or automated test confirms streaming works on /chat
2. Tool calls render with correct three-state indicators
3. Citations render inline and in bottom list
4. No console errors during chat interactions
5. Store toast.error calls confirmed present (16 total)
6. `tsc --noEmit` passes
  </verify>
  <done>
- All 6 Phase 2 success criteria verified
- /chat serves from v2 backend with all features
- Legacy fallback available at chat-stream-legacy
- Test results documented in SUMMARY
- Phase 2 complete (or gaps documented for closure)
  </done>
</task>

</tasks>

<verification>
- /chat uses chat-stream-v2 backend
- Legacy function available as fallback
- All 6 success criteria pass (or gaps documented)
- `tsc --noEmit` passes
- No regressions in chat functionality
</verification>

<success_criteria>
- Switchover complete: /chat → v2
- Legacy preserved: chat-stream-legacy
- All Phase 2 success criteria verified or gaps documented
- Zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-foundation/02-09-SUMMARY.md`
</output>
