---
phase: 02-chat-foundation
plan: 07
type: execute
wave: 4
depends_on: ["02-05", "02-06"]
files_modified:
  - src/components/chat/message.tsx
  - src/components/chat/source.tsx
autonomous: true

must_haves:
  truths:
    - "Inline numbered citation markers [1], [2] appear in chat response text"
    - "Hovering a citation marker shows call title + speaker + date tooltip"
    - "Clicking a citation opens CallDetailDialog"
    - "Bottom source list shows all cited sources"
    - "Citations persist across page reload"
  artifacts:
    - path: "src/components/chat/message.tsx"
      provides: "Citation marker parsing and inline rendering"
      contains: "parseCitations"
    - path: "src/components/chat/source.tsx"
      provides: "Citation tooltip, bottom source list, click handler"
      contains: "CitationMarker"
  key_links:
    - from: "src/components/chat/message.tsx"
      to: "src/components/chat/source.tsx"
      via: "import CitationMarker, SourceList"
      pattern: "CitationMarker|SourceList"
    - from: "src/components/chat/source.tsx"
      to: "CallDetailDialog"
      via: "onClick opens dialog"
      pattern: "CallDetailDialog|recording_id"
---

<objective>
Implement inline citations ([1], [2]) in chat responses with hover preview and click-to-open, plus a bottom source list. Citations link to specific calls via recording_id from tool results and must persist across page reload.

Purpose: CHAT-04 — Citations work consistently. The system prompt (plan 05) instructs the model to cite sources with recording_id markers. This plan renders those citations as interactive inline markers with a collated source list.
Output: Inline [N] markers with tooltip + click, bottom source list, both surviving reload.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chat-foundation/02-CONTEXT.md
@.planning/phases/02-chat-foundation/02-RESEARCH.md

# Files to modify
@src/components/chat/message.tsx
@src/components/chat/source.tsx

# Reference: How tool results are stored in message parts (recording_id in results)
@src/hooks/useChatSession.ts

# Reference: CallDetailDialog for click behavior
@src/pages/Chat.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement citation parsing and inline markers in message.tsx</name>
  <files>src/components/chat/message.tsx</files>
  <action>
Read `src/components/chat/message.tsx` (~200 lines) and add citation parsing to the text rendering pipeline.

**Citation data flow:**
1. Model response contains text with markers like `[recording_id_123]` or `[1]` referencing tool results
2. Tool results in `message.parts` contain `recording_id`, `call_title`, `call_date`, `speaker` per result
3. Parse the text to find citation markers and map them to source data

**Add `parseCitations()` function:**

```typescript
interface CitationSource {
  index: number;          // Display number [1], [2]
  recording_id: string;
  call_title: string;
  call_date: string;
  speaker?: string;
  text_snippet?: string;  // Brief excerpt from the cited chunk
}

function extractSourcesFromParts(parts: UIMessagePart[]): Map<string, CitationSource> {
  // Iterate over tool-result parts
  // Collect unique recording_ids with their metadata
  // Assign sequential [1], [2], [3] indices
  // Return Map<recording_id, CitationSource>
}

function renderTextWithCitations(
  text: string,
  sources: Map<string, CitationSource>
): ReactNode {
  // Parse text for patterns: [recording_id_xxx] or [N] where N maps to a source
  // Replace each marker with a <CitationMarker> component
  // Return array of text spans + citation components
}
```

**Integration:** In the text rendering section of message.tsx, wrap the assistant message text through `renderTextWithCitations()` before rendering. Pass the extracted sources from tool result parts.

**Handle both citation formats:**
- `[recording_id]` — model cites by recording_id directly (map to source via recording_id)
- `[N]` — model cites by number (map to Nth unique source found in tool results)

**Do NOT:**
- Change the overall message layout structure
- Modify how tool parts are rendered (that's tool-call.tsx)
- Break existing message rendering for messages without citations
  </action>
  <verify>
1. `grep "parseCitations\|renderTextWithCitations\|CitationMarker" src/components/chat/message.tsx`
2. `tsc --noEmit` passes
3. Messages without citations render normally (no regressions)
  </verify>
  <done>
- Citation markers parsed from assistant message text
- Inline [N] markers rendered as interactive components
- Source data extracted from tool result parts
- Messages without citations unaffected
  </done>
</task>

<task type="auto">
  <name>Task 2: Build CitationMarker component and bottom SourceList</name>
  <files>src/components/chat/source.tsx</files>
  <action>
Read `src/components/chat/source.tsx` (281 lines) and extend with citation marker and source list components.

**CitationMarker component:**
```typescript
interface CitationMarkerProps {
  source: CitationSource;
  onSourceClick: (recording_id: string) => void;
}
```
- Renders as a small superscript `[N]` with subtle styling (e.g., `text-xs text-blue-500 cursor-pointer hover:text-blue-700 font-medium`)
- **Hover:** Show a tooltip/popover with:
  - Call title (bold)
  - Speaker name
  - Date formatted nicely
  - Brief text snippet (first 100 chars of the cited chunk)
- **Click:** Calls `onSourceClick(recording_id)` which opens CallDetailDialog
- Use existing tooltip/popover components from shadcn if available, or simple CSS tooltip

**SourceList component (bottom of message):**
```typescript
interface SourceListProps {
  sources: CitationSource[];
  onSourceClick: (recording_id: string) => void;
}
```
- Renders at the bottom of assistant messages that have citations
- Shows "Sources" header with a list:
  - `[1] Call Title — Speaker — Date`
  - `[2] Another Call — Speaker — Date`
- Each source is clickable (opens CallDetailDialog)
- Compact layout, subtle background (e.g., `bg-surface-secondary rounded-lg p-3 mt-3`)
- Only shown when sources exist (don't render empty section)

**Wire to CallDetailDialog:**
- Read how CallDetailDialog is opened in Chat.tsx (find the state/callback pattern)
- The `onSourceClick` callback should trigger the same dialog opening mechanism
- If Chat.tsx uses a state like `selectedCallId` + `setSelectedCallId`, pass those down or use a context/callback pattern

**Citation persistence across reload:**
- Citations are derived from `message.parts` (tool results stored in JSONB)
- Verify that tool result data including `recording_id`, `call_title`, etc. survives the `JSON.parse(JSON.stringify(parts))` round-trip in useChatSession
- If any data is stripped during sanitization, add it to the allowed fields
- Test: After saving a message with citations and reloading, citations should still render

**Do NOT:**
- Remove existing source-related functionality in source.tsx
- Change the CallDetailDialog component itself
- Modify message persistence in useChatSession (unless citation data is being stripped)
  </action>
  <verify>
1. `grep "CitationMarker\|SourceList" src/components/chat/source.tsx`
2. `tsc --noEmit` passes
3. `grep "recording_id" src/components/chat/source.tsx` shows citation linking
4. Tooltip and click behavior implemented
  </verify>
  <done>
- CitationMarker component renders inline [N] with hover tooltip
- SourceList component renders bottom source list
- Click opens CallDetailDialog for the cited call
- Citation data persists across page reload (JSONB round-trip verified)
- CHAT-04 requirement fully satisfied
  </done>
</task>

</tasks>

<verification>
- Inline citations render in assistant messages with tool results
- Hover shows source details tooltip
- Click opens CallDetailDialog
- Bottom source list shows all cited sources
- Citations survive page reload
- Messages without citations render normally
- `tsc --noEmit` passes
</verification>

<success_criteria>
- Citations appear inline [1], [2] with hover preview (CHAT-04)
- Both inline markers and bottom source list present
- Click opens CallDetailDialog
- Citations persist across reload
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-foundation/02-07-SUMMARY.md`
</output>
