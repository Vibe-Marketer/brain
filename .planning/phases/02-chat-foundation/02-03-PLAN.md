---
phase: 02-chat-foundation
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - supabase/functions/_shared/search-pipeline.ts
  - supabase/functions/_shared/embeddings.ts
autonomous: true

must_haves:
  truths:
    - "Hybrid search pipeline is extracted to a reusable shared module"
    - "Embedding generation is extracted to a reusable shared module"
    - "Both chat-stream (legacy) and chat-stream-v2 can import the same search logic"
  artifacts:
    - path: "supabase/functions/_shared/search-pipeline.ts"
      provides: "Hybrid search, re-ranking, diversity filtering"
      exports: ["executeHybridSearch", "rerankResults", "diversityFilter"]
    - path: "supabase/functions/_shared/embeddings.ts"
      provides: "OpenAI embedding generation"
      exports: ["generateQueryEmbedding"]
  key_links:
    - from: "supabase/functions/_shared/search-pipeline.ts"
      to: "supabase/functions/_shared/embeddings.ts"
      via: "import generateQueryEmbedding"
      pattern: "generateQueryEmbedding"
    - from: "supabase/functions/_shared/search-pipeline.ts"
      to: "hybrid_search_transcripts RPC"
      via: "supabase.rpc()"
      pattern: "hybrid_search_transcripts"
---

<objective>
Extract the shared search pipeline (embedding generation → hybrid search RPC → re-ranking → diversity filtering) from the current `chat-stream/index.ts` monolith into reusable `_shared/` modules. This is a zero-risk refactor that creates the foundation for all 14 tool definitions in the next plan.

Purpose: The 14 RAG tools all share the same search pipeline. Extracting it prevents 800+ lines of duplication and lets both the legacy `chat-stream` and new `chat-stream-v2` use the same battle-tested logic.
Output: Two new shared modules in `supabase/functions/_shared/` with typed exports.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chat-foundation/02-RESEARCH.md

# Source: Current search pipeline implementation to extract
@supabase/functions/chat-stream/index.ts

# Reference: Existing shared modules pattern
@supabase/functions/_shared/cors.ts

# PoC output (need to know if streamText worked)
@.planning/phases/02-chat-foundation/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract embedding generation to _shared/embeddings.ts</name>
  <files>supabase/functions/_shared/embeddings.ts</files>
  <action>
Extract the `generateQueryEmbedding()` function from `chat-stream/index.ts` (approximately lines 56-75) into a new shared module.

**Create `supabase/functions/_shared/embeddings.ts`:**

```typescript
/**
 * Shared embedding generation for RAG tools.
 * Uses OpenAI text-embedding-3-small via direct API call.
 * (OpenRouter doesn't support embeddings, so we call OpenAI directly.)
 */
```

1. Read the existing `generateQueryEmbedding` function from `chat-stream/index.ts`
2. Extract it with full type annotations:
   - Input: `(query: string, openaiApiKey: string)` 
   - Output: `Promise<number[]>` (embedding vector)
3. Add proper error handling: throw a typed error if the OpenAI API call fails
4. Export the function as a named export
5. Include the OpenAI API URL and model (`text-embedding-3-small`) as constants at the top

**Do NOT:**
- Change the embedding model or API call logic
- Add any new dependencies
- Modify `chat-stream/index.ts` (that's a separate concern — the legacy function keeps working as-is)
  </action>
  <verify>
1. File exists: `ls supabase/functions/_shared/embeddings.ts`
2. Exports `generateQueryEmbedding`: `grep "export.*generateQueryEmbedding" supabase/functions/_shared/embeddings.ts`
3. Uses `text-embedding-3-small`: `grep "text-embedding-3-small" supabase/functions/_shared/embeddings.ts`
  </verify>
  <done>
- `_shared/embeddings.ts` exists with exported `generateQueryEmbedding()` function
- Logic matches current `chat-stream/index.ts` embedding generation exactly
- Properly typed inputs and outputs
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract search pipeline to _shared/search-pipeline.ts</name>
  <files>supabase/functions/_shared/search-pipeline.ts</files>
  <action>
Extract the hybrid search pipeline from `chat-stream/index.ts` into a reusable module. This includes re-ranking, diversity filtering, and the main hybrid search orchestrator.

**Create `supabase/functions/_shared/search-pipeline.ts`:**

Read the following sections from `chat-stream/index.ts` and extract:

1. **`rerankResults()`** (approximately lines 80-201) — HuggingFace cross-encoder re-ranking with batch processing and timeout. Extract with:
   - Input: `(query: string, results: SearchResult[], hfApiKey: string)` 
   - Output: `Promise<SearchResult[]>` (re-ranked)
   - Include the HuggingFace API URL, batch size, and timeout constants

2. **`diversityFilter()`** (approximately lines 203-222) — Max N chunks per recording. Extract with:
   - Input: `(results: SearchResult[], maxPerRecording?: number)`
   - Output: `SearchResult[]` (filtered)
   - Default maxPerRecording to 2

3. **`executeHybridSearch()`** — NEW orchestrator function that combines the full pipeline:
   - Input: `(params: { query: string, limit?: number, supabase: SupabaseClient, userId: string, openaiApiKey: string, hfApiKey: string, filters?: SearchFilters })`
   - Steps: 
     a. Call `generateQueryEmbedding(query, openaiApiKey)` from `./embeddings.ts`
     b. Call `supabase.rpc('hybrid_search_transcripts', { ... })` with embedding + filters
     c. Call `rerankResults(query, results, hfApiKey)`
     d. Call `diversityFilter(results)`
     e. Return formatted results with recording_id, call_title, call_date, speaker, text, relevance_score
   - Output: `Promise<SearchResult[]>`

4. **Type definitions** — Define and export:
   - `SearchResult` — the shape returned by hybrid_search_transcripts RPC
   - `SearchFilters` — optional filters (date_from, date_to, speaker, category, etc.)
   - `FormattedSearchResult` — the final shape returned to tools

**Import from embeddings:**
```typescript
import { generateQueryEmbedding } from './embeddings.ts';
```

**Do NOT:**
- Modify `chat-stream/index.ts` (legacy keeps its own copy for now)
- Change any algorithm logic — exact port from existing code
- Add new search features (query expansion is a system prompt concern, not pipeline)

**Supabase client type:** Use `import { createClient, SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2.49.1';` for the type import only, or use a generic type. Check what the existing Edge Functions use.
  </action>
  <verify>
1. File exists: `ls supabase/functions/_shared/search-pipeline.ts`
2. Exports all three functions: `grep "export" supabase/functions/_shared/search-pipeline.ts`
3. Imports from embeddings: `grep "embeddings" supabase/functions/_shared/search-pipeline.ts`
4. Contains hybrid_search_transcripts RPC call: `grep "hybrid_search_transcripts" supabase/functions/_shared/search-pipeline.ts`
5. Contains HuggingFace re-ranking: `grep -i "huggingface\|cross-encoder" supabase/functions/_shared/search-pipeline.ts`
  </verify>
  <done>
- `_shared/search-pipeline.ts` exists with exported `executeHybridSearch()`, `rerankResults()`, `diversityFilter()` functions
- `_shared/embeddings.ts` imported and used for embedding generation
- Type definitions exported: SearchResult, SearchFilters, FormattedSearchResult
- All logic matches current chat-stream/index.ts implementation exactly
- Ready for 14 tool definitions to import and use
  </done>
</task>

</tasks>

<verification>
- Both `_shared/embeddings.ts` and `_shared/search-pipeline.ts` exist
- Exports match: generateQueryEmbedding, executeHybridSearch, rerankResults, diversityFilter
- Type exports: SearchResult, SearchFilters, FormattedSearchResult
- No modifications to existing `chat-stream/index.ts`
- Imports resolve correctly between modules
</verification>

<success_criteria>
- Search pipeline fully extracted to shared modules
- Both legacy and v2 can import the same search logic
- All algorithms preserved exactly (no behavior changes)
- Type definitions exported for tool implementations
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-foundation/02-03-SUMMARY.md`
</output>
