---
phase: 02-chat-foundation
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - src/components/chat/tool-call.tsx
autonomous: true

must_haves:
  truths:
    - "Successful tool calls with results show green indicator + result count"
    - "Successful tool calls with zero results show amber indicator + '0 results'"
    - "Failed tool calls show red indicator + 'Failed' label"
    - "Tool status line always visible, details collapsed by default"
    - "Streaming query visible while tool is running"
  artifacts:
    - path: "src/components/chat/tool-call.tsx"
      provides: "Three-state tool call display component"
      contains: "getToolStatus"
  key_links:
    - from: "src/components/chat/tool-call.tsx"
      to: "UIMessage parts"
      via: "toolPart.state and toolPart.result"
      pattern: "output-available|output-error|input-streaming"
---

<objective>
Implement three-state tool call transparency UI: success (green + count), empty (amber + 0 results), and error (red + Failed). Replace the current single-state green checkmark that shows for all outcomes including empty results and errors.

Purpose: This is the core fix for CHAT-02 — users see green checkmarks on empty/failed tool calls, creating false confidence. The three-state system (success/empty/failed) with visible counts is the most important UX improvement in this phase.
Output: Updated tool-call.tsx with three visual states, result counts, streaming query visibility, and collapsible details.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chat-foundation/02-CONTEXT.md
@.planning/phases/02-chat-foundation/02-RESEARCH.md

# File to modify
@src/components/chat/tool-call.tsx

# Reference: How tool parts are structured in messages
@src/pages/Chat.tsx
@src/components/chat/message.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement three-state tool call status logic</name>
  <files>src/components/chat/tool-call.tsx</files>
  <action>
Read `src/components/chat/tool-call.tsx` (144 lines) and refactor to support three tool states.

**Add a `getToolStatus()` function** that determines the visual state from tool part data:

```typescript
type ToolStatus = 'pending' | 'running' | 'success' | 'empty' | 'error';

function getToolStatus(toolPart: ToolInvocationPart): ToolStatus {
  // Error state: explicit error or output-error state
  if (toolPart.toolInvocation.state === 'error' || toolPart.toolInvocation.state === 'output-error') return 'error';
  
  // Still running: input-streaming or input-available (waiting for output)
  if (toolPart.toolInvocation.state === 'input-streaming') return 'running';
  if (toolPart.toolInvocation.state === 'input-available') return 'pending';
  
  // Has output — check content
  if (toolPart.toolInvocation.state === 'output-available') {
    const result = toolPart.toolInvocation.output;
    if (!result) return 'empty';
    if (result.error) return 'error';
    if (result.message?.toLowerCase().includes('could not find')) return 'empty';
    if (result.message?.toLowerCase().includes('no results')) return 'empty';
    if (Array.isArray(result.results) && result.results.length === 0) return 'empty';
    if (result.count === 0) return 'empty';
    return 'success';
  }
  
  return 'pending';
}
```

**Add a `getResultCount()` function** to extract result counts:

```typescript
function getResultCount(toolPart: ToolInvocationPart): number | null {
  const result = toolPart.toolInvocation.output;
  if (!result) return null;
  if (Array.isArray(result.results)) return result.results.length;
  if (typeof result.count === 'number') return result.count;
  if (Array.isArray(result)) return result.length;
  return null;
}
```

**Update the visual rendering** with status-specific icons and colors:

| Status | Icon | Color | Label Example |
|--------|------|-------|---------------|
| `pending` | Loader/spinner (dim) | `text-ink-muted` | "Searched Transcripts" |
| `running` | Loader/spinner (animated) | `text-blue-500` | "Searching Transcripts: 'quarterly sales calls'..." |
| `success` | Check circle | `text-green-500` | "Searched Transcripts (7 results)" |
| `empty` | Alert/info circle | `text-amber-500` | "Searched By Speaker (0 results)" |
| `error` | Error/warning | `text-red-500` | "Search By Date Range — Failed" |

Use icons from `@remixicon/react` (the project's icon library): `RiCheckLine`, `RiLoader4Line`, `RiAlertLine`, `RiErrorWarningLine` (or similar available icons).

**Streaming query visibility:** When status is `running`, show the tool's input being constructed in real-time. Extract the query/search term from `toolPart.toolInvocation.args` and display it: "Searching Transcripts: 'quarterly sales calls'..."

**Layout:** Each tool gets its own line as a flat list. Status line always visible. Add a chevron toggle to expand/collapse tool result details. Default collapsed.

**Format tool names for display:** Convert camelCase tool names to human-readable: `searchTranscriptsByQuery` → "Searched Transcripts", `searchBySpeaker` → "Searched By Speaker", `getCallDetails` → "Got Call Details", etc. Create a `formatToolName()` helper or a lookup map.

**Do NOT:**
- Change how tool parts are extracted from messages (that's in message.tsx)
- Modify the tool result data structure
- Add new props to the component that would break existing usage
  </action>
  <verify>
1. `tsc --noEmit` passes
2. The component renders without errors (check no import errors)
3. `grep "getToolStatus" src/components/chat/tool-call.tsx` returns matches
4. `grep "toast\|amber\|green\|red" src/components/chat/tool-call.tsx` shows color coding
5. The three states are visually distinct: success (green), empty (amber), error (red)
  </verify>
  <done>
- Tool call component shows three distinct visual states
- Result counts visible for success state ("7 results")
- Empty results clearly distinguished from success ("0 results" with amber)
- Failed tools show red error state
- Streaming query visible during execution
- Tool names formatted human-readably
- Collapsible details (collapsed by default)
- CHAT-02 visual requirement met
  </done>
</task>

</tasks>

<verification>
- Three-state tool display renders correctly for all states
- Existing tool call rendering not broken
- `tsc --noEmit` passes clean
- Icons from @remixicon/react resolve correctly
</verification>

<success_criteria>
- Tool calls show success/empty/error with distinct colors and counts
- No more green checkmarks on empty results (CHAT-02 core fix)
- Streaming query visible while tool runs
- Details collapsible (default collapsed)
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-foundation/02-04-SUMMARY.md`
</output>
