---
phase: 15-data-migration
plan: 03
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - supabase/migrations/20260227000002_archive_fathom_calls.sql
autonomous: false

must_haves:
  truths:
    - "fathom_calls has been renamed to fathom_calls_archive"
    - "fathom_calls_archive has a COMMENT explaining it is archived, dormant, and scheduled for Phase 22 drop"
    - "User has personally verified 5-10 calls match between old and new frontend"
    - "No RLS policies are added to fathom_calls_archive — it sits dormant"
  artifacts:
    - path: "supabase/migrations/20260227000002_archive_fathom_calls.sql"
      provides: "ALTER TABLE RENAME migration for archiving fathom_calls"
      contains: "RENAME TO fathom_calls_archive"
  key_links:
    - from: "fathom_calls"
      to: "fathom_calls_archive"
      via: "ALTER TABLE RENAME"
      pattern: "RENAME TO fathom_calls_archive"
---

<objective>
Archive fathom_calls by renaming it to fathom_calls_archive, and have the user manually verify 5-10 calls match between old and new frontends.

Purpose: DATA-04 requires archiving fathom_calls (renamed, NOT dropped). Per CONTEXT locked decision, the archive is just a safety net — not queryable, no RLS needed, dropped in Phase 22. The manual spot-check (CONTEXT: "Manual spot-check second: user personally compares 5-10 calls") is the human verification gate before the phase is declared complete.

Output: fathom_calls_archive table exists. User has verified call data matches. Phase 15 is complete.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-data-migration/15-CONTEXT.md
@.planning/phases/15-data-migration/15-RESEARCH.md
@.planning/phases/15-data-migration/15-01-SUMMARY.md
@.planning/phases/15-data-migration/15-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename fathom_calls to fathom_calls_archive</name>
  <files>supabase/migrations/20260227000002_archive_fathom_calls.sql</files>
  <action>
Step 1 — Create `supabase/migrations/20260227000002_archive_fathom_calls.sql` with the archive rename:

```sql
-- Archive fathom_calls after successful migration to recordings table.
-- Per Phase 15 CONTEXT: rename, NOT drop. No RLS needed — table is dormant.
-- 30-day clock starts when v2 goes live to real users (not from migration completion).
-- Scheduled for DROP in Phase 22 (Backend Cleanup).

SET lock_timeout = '5s';
ALTER TABLE fathom_calls RENAME TO fathom_calls_archive;

COMMENT ON TABLE fathom_calls_archive IS
  'Archived by Phase 15 data migration. Original fathom_calls data. Do NOT query directly.
   30-day hold from v2 go-live. Scheduled for DROP in Phase 22 (Backend Cleanup).
   Migration date: 2026-02-27.';
```

The `SET lock_timeout = '5s'` prevents indefinite waits if any long-running transaction is touching the table (see RESEARCH Pitfall 5).

Step 2 — Deploy the migration. Run via `npx supabase db push` or execute directly in the Supabase SQL Editor against production.

IMPORTANT: Per RESEARCH, PostgreSQL automatically renames all indexes and triggers associated with the table when you rename it. No manual index work needed.

Step 3 — Verify the archive:

```sql
-- Confirm table exists with new name
SELECT tablename FROM pg_tables WHERE tablename = 'fathom_calls_archive';

-- Confirm old name no longer exists
SELECT tablename FROM pg_tables WHERE tablename = 'fathom_calls';

-- Confirm comment is set
SELECT obj_description('fathom_calls_archive'::regclass, 'pg_class');

-- Confirm data is intact (same row count as before)
SELECT COUNT(*) FROM fathom_calls_archive;
```

Note: After this rename, the sync edge functions (sync-meetings, zoom-sync-meetings, youtube-import) that write to fathom_calls will fail on their next invocation. This is EXPECTED and ACCEPTABLE per RESEARCH: "Phase 17 will migrate those connectors to recordings directly." New imports will temporarily fail until Phase 17 rewires them. If this is a concern, the edge functions can be disabled in the Supabase Dashboard before the rename — but per RESEARCH Pattern 8 recommendation, the sync functions writing to fathom_calls is Phase 17's problem.
  </action>
  <verify>
1. Migration SQL file exists at supabase/migrations/20260227000002_archive_fathom_calls.sql
2. `SELECT tablename FROM pg_tables WHERE tablename = 'fathom_calls_archive'` returns 1 row
3. `SELECT tablename FROM pg_tables WHERE tablename = 'fathom_calls'` returns 0 rows
4. `SELECT COUNT(*) FROM fathom_calls_archive` matches the original fathom_calls count from Plan 01 profiling
  </verify>
  <done>fathom_calls has been renamed to fathom_calls_archive. The archive table is dormant with a comment documenting its Phase 22 drop schedule. DATA-04 is satisfied.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Manual spot-check — compare 5-10 calls in old vs new frontend</name>
  <files></files>
  <action>
Present the user with the verification checklist below. This is a human verification gate — Claude has completed all automated work. The user must personally compare calls between the old and new frontends to confirm data integrity before Phase 15 is declared complete.

Display the how-to-verify steps and wait for the user's response.

What was built:
- All fathom_calls rows migrated to recordings table with COALESCE defaults and external_id
- v2 frontend at / shows real call history from recordings table
- v2 frontend at /calls/:id shows call detail with transcript
- RLS verified: User A cannot see User B's recordings
- fathom_calls renamed to fathom_calls_archive

How to verify:
1. Open the OLD frontend (brain v1 at https://callvault.vercel.app or localhost) and pick 5-10 calls. Note their title, date, duration, and first few lines of transcript.
2. Open the NEW frontend (callvault v2 at localhost:3000) and find those same calls. Verify title matches (or shows "Untitled Call" if original was blank), date matches, duration matches (or shows 0:00 if original had no duration), and transcript content matches.
3. Try navigating to /calls/:id for at least 2 different calls and verify the detail page loads with the correct transcript.
4. (Optional) If you have access to a second user account, log in as that user and verify they see ONLY their own calls.

Issues to look for: Missing calls, wrong data, broken navigation, any "Coming soon" placeholders still visible.

Resume signal: Type "approved" if 5-10 calls match correctly, or describe any issues found.
  </action>
  <verify>User types "approved" confirming 5-10 calls match between old and new frontends</verify>
  <done>User has personally verified data integrity across old and new frontends. Phase 15 is complete: all DATA requirements (DATA-01 through DATA-05) satisfied.</done>
</task>

</tasks>

<verification>
- fathom_calls table no longer exists (renamed to fathom_calls_archive)
- fathom_calls_archive has COMMENT documenting archive status
- User has personally verified 5-10 calls match between old and new frontends
- All 5 DATA requirements (DATA-01 through DATA-05) are satisfied
</verification>

<success_criteria>
1. fathom_calls_archive exists; fathom_calls does not
2. User confirms 5-10 calls match correctly (title, date, duration, transcript)
3. No "Coming soon" placeholders remain on / or /calls/:id
4. Phase 15 can be marked complete in STATE.md
</success_criteria>

<output>
After completion, create `.planning/phases/15-data-migration/15-03-SUMMARY.md`
</output>
