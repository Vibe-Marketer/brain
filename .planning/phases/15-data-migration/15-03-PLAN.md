---
phase: 15-data-migration
plan: 03
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - supabase/migrations/20260227000002_archive_fathom_calls.sql
autonomous: false

must_haves:
  truths:
    - "fathom_calls has been renamed to fathom_calls_archive"
    - "fathom_calls_archive has a COMMENT explaining it is archived, dormant, and scheduled for Phase 22 drop"
    - "Sync edge functions (sync-meetings, zoom-sync-meetings, youtube-import) are re-enabled after archive rename"
    - "User has personally verified 5-10 calls match between old and new frontend"
    - "No RLS policies are added to fathom_calls_archive — it sits dormant"
  artifacts:
    - path: "supabase/migrations/20260227000002_archive_fathom_calls.sql"
      provides: "ALTER TABLE RENAME migration for archiving fathom_calls"
      contains: "RENAME TO fathom_calls_archive"
  key_links:
    - from: "fathom_calls"
      to: "fathom_calls_archive"
      via: "ALTER TABLE RENAME"
      pattern: "RENAME TO fathom_calls_archive"
---

<objective>
Archive fathom_calls by renaming it to fathom_calls_archive, re-enable sync edge functions, and have the user manually verify 5-10 calls match between old and new frontends.

Purpose: DATA-04 requires archiving fathom_calls (renamed, NOT dropped). Per CONTEXT locked decision, the archive is just a safety net — not queryable, no RLS needed, dropped in Phase 22. After the archive rename, sync edge functions are re-enabled per CONTEXT locked decision ("re-enable after completion"). The manual spot-check (CONTEXT: "Manual spot-check second: user personally compares 5-10 calls") is the human verification gate before the phase is declared complete.

Output: fathom_calls_archive table exists. Sync edge functions re-enabled. User has verified call data matches. Phase 15 is complete.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-data-migration/15-CONTEXT.md
@.planning/phases/15-data-migration/15-RESEARCH.md
@.planning/phases/15-data-migration/15-01-SUMMARY.md
@.planning/phases/15-data-migration/15-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename fathom_calls to fathom_calls_archive</name>
  <files>supabase/migrations/20260227000002_archive_fathom_calls.sql</files>
  <action>
Step 1 — Create `supabase/migrations/20260227000002_archive_fathom_calls.sql` with the archive rename:

```sql
-- Archive fathom_calls after successful migration to recordings table.
-- Per Phase 15 CONTEXT: rename, NOT drop. No RLS needed — table is dormant.
-- 30-day clock starts when v2 goes live to real users (not from migration completion).
-- Scheduled for DROP in Phase 22 (Backend Cleanup).

SET lock_timeout = '5s';
ALTER TABLE fathom_calls RENAME TO fathom_calls_archive;

COMMENT ON TABLE fathom_calls_archive IS
  'Archived by Phase 15 data migration. Original fathom_calls data. Do NOT query directly.
   30-day hold from v2 go-live. Scheduled for DROP in Phase 22 (Backend Cleanup).
   Migration date: 2026-02-27.';
```

The `SET lock_timeout = '5s'` prevents indefinite waits if any long-running transaction is touching the table (see RESEARCH Pitfall 5).

Step 2 — Deploy the migration. Run via `npx supabase db push` or execute directly in the Supabase SQL Editor against production.

IMPORTANT: Per RESEARCH, PostgreSQL automatically renames all indexes and triggers associated with the table when you rename it. No manual index work needed.

Step 3 — Verify the archive:

```sql
-- Confirm table exists with new name
SELECT tablename FROM pg_tables WHERE tablename = 'fathom_calls_archive';

-- Confirm old name no longer exists
SELECT tablename FROM pg_tables WHERE tablename = 'fathom_calls';

-- Confirm comment is set
SELECT obj_description('fathom_calls_archive'::regclass, 'pg_class');

-- Confirm data is intact (same row count as before)
SELECT COUNT(*) FROM fathom_calls_archive;
```
  </action>
  <verify>
1. Migration SQL file exists at supabase/migrations/20260227000002_archive_fathom_calls.sql
2. `SELECT tablename FROM pg_tables WHERE tablename = 'fathom_calls_archive'` returns 1 row
3. `SELECT tablename FROM pg_tables WHERE tablename = 'fathom_calls'` returns 0 rows
4. `SELECT COUNT(*) FROM fathom_calls_archive` matches the original fathom_calls count from Plan 01 profiling
  </verify>
  <done>fathom_calls has been renamed to fathom_calls_archive. The archive table is dormant with a comment documenting its Phase 22 drop schedule. DATA-04 is satisfied.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Re-enable sync edge functions after migration</name>
  <action>
Per CONTEXT locked decision: "Pause all imports (Fathom sync, Zoom sync, YouTube) during migration window — disable sync edge functions, re-enable after completion."

The migration is now complete and fathom_calls has been archived. Re-enable the sync edge functions that were disabled in Plan 01 Task 2.

IMPORTANT: These functions currently write to fathom_calls, which no longer exists (renamed to fathom_calls_archive). Re-enabling them will cause them to fail on their next invocation until Phase 17 rewires them to write to the recordings table. This is expected — the functions need to be re-enabled so they are ready for Phase 17 to update, rather than being left in a disabled state that could be forgotten.

If any of the three functions were already inactive before Plan 01 disabled them (as noted in Plan 01 Task 2), do NOT re-enable those — only re-enable functions that were previously active.

Re-enable in the Supabase Dashboard:

1. Go to https://supabase.com/dashboard/project/vltmrnjsubfzrgrtdqey/functions
2. Re-enable the functions that were active before migration:
   - **sync-meetings** (Fathom sync)
   - **zoom-sync-meetings** (Zoom sync)
   - **youtube-import** (YouTube import)

Note: If you prefer to leave them disabled until Phase 17 rewires them, that is also acceptable — just document the decision so Phase 17 knows to re-enable them.
  </action>
  <verify>User confirms sync edge functions have been re-enabled (or deliberately left disabled with documentation for Phase 17).</verify>
  <done>Sync edge functions are re-enabled per CONTEXT locked decision, completing the migration window. Functions are back online and ready for Phase 17 connector pipeline rewiring.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Manual spot-check — compare 5-10 calls in old vs new frontend</name>
  <action>
Present the user with the verification checklist below. This is a human verification gate — Claude has completed all automated work. The user must personally compare calls between the old and new frontends to confirm data integrity before Phase 15 is declared complete.

Display the how-to-verify steps and wait for the user's response.

What was built:
- All fathom_calls rows migrated to recordings table with COALESCE defaults and external_id
- v2 frontend at / shows real call history from recordings table
- v2 frontend at /calls/:id shows call detail with transcript
- RLS verified: User A cannot see User B's recordings
- fathom_calls renamed to fathom_calls_archive
- Sync edge functions re-enabled (migration window closed)

How to verify:
1. Open the OLD frontend (brain v1 at https://callvault.vercel.app or localhost) and pick 5-10 calls. Note their title, date, duration, and first few lines of transcript.
2. Open the NEW frontend (callvault v2 at localhost:3000) and find those same calls. Verify title matches (or shows "Untitled Call" if original was blank), date matches, duration matches (or shows 0:00 if original had no duration), and transcript content matches.
3. Try navigating to /calls/:id for at least 2 different calls and verify the detail page loads with the correct transcript.
4. (Optional) If you have access to a second user account, log in as that user and verify they see ONLY their own calls.

Issues to look for: Missing calls, wrong data, broken navigation, any "Coming soon" placeholders still visible.

Resume signal: Type "approved" if 5-10 calls match correctly, or describe any issues found.
  </action>
  <verify>User types "approved" confirming 5-10 calls match between old and new frontends</verify>
  <done>User has personally verified data integrity across old and new frontends. Phase 15 is complete: all DATA requirements (DATA-01 through DATA-05) satisfied.</done>
</task>

</tasks>

<verification>
- fathom_calls table no longer exists (renamed to fathom_calls_archive)
- fathom_calls_archive has COMMENT documenting archive status
- Sync edge functions re-enabled (or documented as intentionally left disabled for Phase 17)
- User has personally verified 5-10 calls match between old and new frontends
- All 5 DATA requirements (DATA-01 through DATA-05) are satisfied
</verification>

<success_criteria>
1. fathom_calls_archive exists; fathom_calls does not
2. Sync edge functions re-enabled per CONTEXT locked decision
3. User confirms 5-10 calls match correctly (title, date, duration, transcript)
4. No "Coming soon" placeholders remain on / or /calls/:id
5. Phase 15 can be marked complete in STATE.md
</success_criteria>

<output>
After completion, create `.planning/phases/15-data-migration/15-03-SUMMARY.md`
</output>
