---
phase: 15-data-migration
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - /Users/Naegele/dev/callvault/src/services/recordings.service.ts
  - /Users/Naegele/dev/callvault/src/hooks/useRecordings.ts
  - /Users/Naegele/dev/callvault/src/lib/query-config.ts
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/calls/$callId.tsx
autonomous: true

must_haves:
  truths:
    - "User opens v2 frontend at / and sees their complete call history — titles, dates, durations, source app"
    - "User clicks a call and navigates to /calls/:id to see the call detail with transcript"
    - "No fathom_calls references exist anywhere in the callvault/ codebase"
    - "Recordings data is fetched via TanStack Query using the established queryKeys factory pattern"
  artifacts:
    - path: "/Users/Naegele/dev/callvault/src/services/recordings.service.ts"
      provides: "Supabase queries for recordings list and detail"
      contains: "from('recordings')"
    - path: "/Users/Naegele/dev/callvault/src/hooks/useRecordings.ts"
      provides: "TanStack Query hooks for recordings data fetching"
      contains: "useQuery"
    - path: "/Users/Naegele/dev/callvault/src/lib/query-config.ts"
      provides: "recordings domain added to queryKeys factory"
      contains: "recordings"
    - path: "/Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx"
      provides: "Calls list page rendering real recordings data"
      contains: "useRecordings"
    - path: "/Users/Naegele/dev/callvault/src/routes/_authenticated/calls/$callId.tsx"
      provides: "Call detail page rendering recording transcript"
      contains: "useRecording"
  key_links:
    - from: "/Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx"
      to: "/Users/Naegele/dev/callvault/src/hooks/useRecordings.ts"
      via: "useRecordings() hook call"
      pattern: "useRecordings"
    - from: "/Users/Naegele/dev/callvault/src/hooks/useRecordings.ts"
      to: "/Users/Naegele/dev/callvault/src/services/recordings.service.ts"
      via: "queryFn calling getRecordings()"
      pattern: "getRecordings"
    - from: "/Users/Naegele/dev/callvault/src/services/recordings.service.ts"
      to: "supabase.from('recordings')"
      via: "Supabase JS client query"
      pattern: "from\\('recordings'\\)"
---

<objective>
Wire the v2 frontend calls list and call detail pages to the recordings table, replacing "Coming soon" placeholders with real data.

Purpose: After Plan 01 migrates all data, this plan makes it visible in the v2 frontend. The v2 frontend reads ONLY from the recordings table (per CONTEXT locked decision: "No dual-read transition"). This is the clean cut — fathom_calls never appears in the callvault/ codebase.

Output: Working calls list at /, working call detail at /calls/:id, recordings service layer, TanStack Query hooks.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-data-migration/15-RESEARCH.md
@.planning/phases/14-foundation/14-02-SUMMARY.md
@.planning/phases/14-foundation/14-04-SUMMARY.md

# v2 frontend files to modify
@/Users/Naegele/dev/callvault/src/lib/query-config.ts
@/Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
@/Users/Naegele/dev/callvault/src/routes/_authenticated/calls/$callId.tsx
@/Users/Naegele/dev/callvault/src/lib/supabase.ts
@/Users/Naegele/dev/callvault/src/hooks/useAuth.tsx
@/Users/Naegele/dev/callvault/src/types/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create recordings service and TanStack Query hooks</name>
  <files>
    /Users/Naegele/dev/callvault/src/services/recordings.service.ts
    /Users/Naegele/dev/callvault/src/hooks/useRecordings.ts
    /Users/Naegele/dev/callvault/src/lib/query-config.ts
  </files>
  <action>
Step 1 — Add `recordings` domain to the queryKeys factory in `/Users/Naegele/dev/callvault/src/lib/query-config.ts`. Add alongside the existing domains (calls, workspaces, etc.):

```typescript
recordings: {
  all: ['recordings'] as const,
  list: (filters?: Record<string, unknown>) =>
    ['recordings', 'list', filters] as const,
  detail: (id: string) => ['recordings', 'detail', id] as const,
},
```

Note: The existing `calls` domain stays. `recordings` is the Supabase table name; `calls` is the UI concept. They may converge later but for Phase 15 we add `recordings` because the service layer queries the `recordings` table.

Step 2 — Create `/Users/Naegele/dev/callvault/src/services/recordings.service.ts`. This is the data access layer for the recordings table. Use the established Supabase client pattern from Phase 14 (`import { supabase } from '@/lib/supabase'`).

Export two functions:

`getRecordings()` — Fetches the user's recordings list. RLS handles tenant isolation automatically (no need to pass user_id). Select columns: `id, title, recording_start_time, duration, source_app, summary, global_tags, source_metadata`. Order by `recording_start_time` descending, nulls last.

`getRecordingById(id: string)` — Fetches a single recording with full transcript. Select all columns from getRecordings PLUS `full_transcript, audio_url, video_url, owner_user_id, created_at`. Use `.eq('id', id).maybeSingle()`.

Type the return values using the generated Supabase types from `src/types/supabase.ts`. The `recordings` table is in the generated types as `Database['public']['Tables']['recordings']['Row']`. Create a narrower `RecordingListItem` type for the list view and use the full `Row` type for detail.

Do NOT import from or reference `fathom_calls` anywhere. The v2 codebase has a hard boundary: recordings table only.

Step 3 — Create `/Users/Naegele/dev/callvault/src/hooks/useRecordings.ts`. Two hooks:

`useRecordings()` — Uses `useQuery` with `queryKeys.recordings.list()`, calls `getRecordings()`, enabled when session exists (from `useAuth`).

`useRecording(id: string)` — Uses `useQuery` with `queryKeys.recordings.detail(id)`, calls `getRecordingById(id)`, enabled when session exists and id is truthy.

Follow the exact TanStack Query patterns from Phase 14 (see query-config.ts FOUND-06 boundary). Import `queryKeys` from `@/lib/query-config`. Import `useAuth` from `@/hooks/useAuth`.
  </action>
  <verify>
1. `src/services/recordings.service.ts` exists and exports `getRecordings` and `getRecordingById`
2. `src/hooks/useRecordings.ts` exists and exports `useRecordings` and `useRecording`
3. `src/lib/query-config.ts` contains `recordings` domain
4. TypeScript compiles: run `cd /Users/Naegele/dev/callvault && npx tsc --noEmit` (zero errors)
5. Grep for `fathom_calls` in callvault/src/ returns zero matches
  </verify>
  <done>Recordings service layer and TanStack Query hooks exist, typed against the recordings table. queryKeys factory includes recordings domain. Zero fathom_calls references in the v2 codebase.</done>
</task>

<task type="auto">
  <name>Task 2: Wire calls list and call detail pages to recordings data</name>
  <files>
    /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/calls/$callId.tsx
  </files>
  <action>
Step 1 — Update `/Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx` to replace the "Coming soon" placeholder with a real calls list:

1. Import `useRecordings` from `@/hooks/useRecordings`
2. Import `Link` from `@tanstack/react-router` for navigation to call detail
3. In the `AuthenticatedHomePage` component, call `useRecordings()` to get `{ data: recordings, isLoading, error }`
4. Render three states:
   - **Loading:** Skeleton/spinner in the main content area (keep it simple — a pulsing div or "Loading calls..." text)
   - **Error:** Error message with the error description
   - **Data:** A list/table of recordings showing:
     - Title (linked to `/calls/${recording.id}`)
     - Date (formatted from `recording_start_time` — use `new Date().toLocaleDateString()`)
     - Duration (formatted as MM:SS from seconds)
     - Source app badge (e.g., "fathom", "zoom", "youtube")
   - **Empty state:** "No calls found" message if recordings array is empty

Keep the existing AppShell composition (secondaryPane={FolderSidebar}, showDetailPane={true}). Only replace the inner "Coming soon" div with the real recordings list.

Style the list with existing Tailwind utility classes. Keep it functional, not over-designed — this is data verification, not final UI. A simple list with rows is fine. Each row should be a Link to `/calls/${recording.id}`.

Step 2 — Update `/Users/Naegele/dev/callvault/src/routes/_authenticated/calls/$callId.tsx` to replace the "Coming soon" placeholder with a real call detail:

1. Import `useRecording` from `@/hooks/useRecordings`
2. Get `callId` from `Route.useParams()` (already there)
3. Call `useRecording(callId)` to get `{ data: recording, isLoading, error }`
4. Render three states:
   - **Loading:** Skeleton/spinner
   - **Error / Not found:** Error message or "Call not found"
   - **Data:** Show:
     - Title as the page heading (replace the generic "Call: {callId}")
     - Date, duration, source app as metadata
     - Summary (if available)
     - Tags (if available, from global_tags)
     - Full transcript in a scrollable pre/div (preserve newlines, use `whitespace-pre-wrap`)

Keep the existing AppShell composition (showDetailPane={true}). Only replace the inner "Coming soon" div.

Step 3 — Build check. Run `cd /Users/Naegele/dev/callvault && pnpm build` to verify zero TypeScript and build errors. This is the CI-equivalent check per Phase 14 convention (pnpm build, not tsc --noEmit).
  </action>
  <verify>
1. `pnpm build` passes with zero errors in `/Users/Naegele/dev/callvault/`
2. index.tsx imports and uses `useRecordings()` — no "Coming soon" text in the main content area
3. calls/$callId.tsx imports and uses `useRecording(callId)` — no "Coming soon" text for the transcript
4. Both pages handle loading, error, and empty states
5. Grep `fathom_calls` in callvault/src/ returns zero matches
  </verify>
  <done>The v2 frontend calls list at / shows real recordings data from the recordings table. The call detail at /calls/:id shows the full recording with transcript. Both pages handle loading/error/empty states. Build passes. Zero fathom_calls references.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes in /Users/Naegele/dev/callvault/
- `/` route renders a list of recordings fetched from the recordings table
- `/calls/:id` route renders recording detail with transcript
- `grep -r 'fathom_calls' /Users/Naegele/dev/callvault/src/` returns nothing
- queryKeys.recordings exists in query-config.ts
</verification>

<success_criteria>
1. An authenticated user navigating to / in the v2 frontend sees their complete call history — every migrated recording appears with title, date, duration
2. Clicking a call navigates to /calls/:id and shows the recording detail with full transcript
3. The v2 codebase contains zero references to fathom_calls — only recordings table queries
4. `pnpm build` passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-data-migration/15-02-SUMMARY.md`
</output>
