---
phase: 10.2-vaults-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
  - src/components/ui/sidebar-nav.tsx
  - src/pages/VaultsPage.tsx
  - src/components/panes/VaultListPane.tsx
  - src/hooks/useVaults.ts
  - src/lib/query-config.ts
  - src/stores/panelStore.ts
  - src/types/panel.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to /vaults route"
    - "Sidebar shows 'Vaults' instead of 'Collaboration'"
    - "Vault list pane displays all user's vaults grouped by bank"
    - "Clicking a vault selects it and shows detail view"
    - "URL updates to /vaults/:vaultId for deep linking"
  artifacts:
    - path: "src/pages/VaultsPage.tsx"
      provides: "Main vaults page using AppShell"
      exports: ["default"]
    - path: "src/components/panes/VaultListPane.tsx"
      provides: "Secondary pane showing vault list"
      exports: ["VaultListPane"]
    - path: "src/hooks/useVaults.ts"
      provides: "Tanstack Query hooks for vault data"
      exports: ["useVaults", "useVaultDetail"]
  key_links:
    - from: "src/App.tsx"
      to: "src/pages/VaultsPage.tsx"
      via: "Route path='/vaults'"
    - from: "src/components/ui/sidebar-nav.tsx"
      to: "/vaults"
      via: "navItems array update"
    - from: "VaultListPane"
      to: "useVaults hook"
      via: "query for vault list"
---

<objective>
Create the foundational Vaults page infrastructure: new route, sidebar navigation update, and vault list secondary pane. This establishes the 3-pane layout foundation that subsequent waves will build upon.

Purpose: Replace the legacy "Collaboration" page with a first-class "Vaults" management interface that serves as the primary workspace for bank/vault operations.
Output: Working /vaults route with vault list sidebar and URL-based vault selection.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/pages/SortingTagging.tsx
@/Users/admin/repos/brain/src/components/layout/AppShell.tsx
@/Users/admin/repos/brain/src/components/ui/sidebar-nav.tsx
@/Users/admin/repos/brain/src/App.tsx
@/Users/admin/repos/brain/src/hooks/useBankContext.ts
@/Users/admin/repos/brain/src/lib/query-config.ts
@/Users/admin/repos/brain/src/types/bank.ts
</context>

<tasks>

<task type="auto">
  <name>Update Query Keys and Types</name>
  <files>src/lib/query-config.ts, src/types/panel.ts</files>
  <action>
Add vault-related query keys to query-config.ts:
- Add `vaults` object with `list()`, `detail(id)`, `members(vaultId)`, `recordings(vaultId)` methods
- Follow existing pattern from folders/categories

Add vault-detail to PanelType in types/panel.ts:
- Add 'vault-detail' to PanelType union
- Add { type: 'vault-detail'; vaultId: string } to PanelData discriminated union
  </action>
  <verify>grep -n "vaults" src/lib/query-config.ts && grep -n "vault-detail" src/types/panel.ts</verify>
  <done>Query keys for vaults exist in query-config.ts and vault-detail panel type is defined</done>
</task>

<task type="auto">
  <name>Create useVaults Hook</name>
  <files>src/hooks/useVaults.ts</files>
  <action>
Create comprehensive vault data hooks:

1. `useVaults()` - Returns all vaults for current user, grouped by bank
   - Uses useBankContext to get user's banks
   - For each bank, fetch vaults with membership info
   - Return structure: { personalBank: BankWithVaults, businessBanks: BankWithVaults[] }
   - Use queryKeys.vaults.list()

2. `useVaultDetail(vaultId: string | null)` - Returns detailed vault info
   - Fetch vault with full membership list
   - Include member count, user roles
   - Use queryKeys.vaults.detail(vaultId)
   - Enabled only when vaultId provided

3. `useVaultRecordings(vaultId: string | null)` - Returns recordings in vault
   - Join vault_entries with recordings
   - Include vault-specific metadata (local_tags, scores, notes)
   - Use queryKeys.vaults.recordings(vaultId)
   - Pagination support (limit/offset)

Use existing patterns from useBankContext and useFolders. All queries must have staleTime of 5 minutes.
  </action>
  <verify>npm run typecheck passes for new hook file</verify>
  <done>useVaults.ts exports three hooks with proper TypeScript types and query keys</done>
</task>

<task type="auto">
  <name>Create VaultListPane Component</name>
  <files>src/components/panes/VaultListPane.tsx</files>
  <action>
Create the secondary pane component for vault list:

**Structure:**
- Header: "VAULTS" title (Montserrat uppercase) + Create Vault button
- Sections: Personal Bank vaults (if any), Business Banks with expandable vault lists
- Items: Vault name, type badge, member count

**Features:**
- Selected vault highlighting (vibe orange left border per brand guidelines)
- Group vaults by bank (personal first, then business banks)
- Show vault type badges (personal, team, coach, etc.)
- Member count indicator
- Create Vault button (opens dialog - stub for now)
- Loading skeleton state

**Props:**
```tsx
interface VaultListPaneProps {
  selectedVaultId: string | null;
  onVaultSelect: (vaultId: string) => void;
  className?: string;
}
```

**Styling:**
- Use AppShell secondary pane width (280px)
- Follow SortingCategoryPane patterns
- 500ms transitions for selection changes
- Remix icons only (RiSafeLine for vault icon)
  </action>
  <verify>Component renders without errors, uses correct query hooks</verify>
  <done>VaultListPane component displays vaults grouped by bank with selection support</done>
</task>

<task type="auto">
  <name>Create VaultsPage Foundation</name>
  <files>src/pages/VaultsPage.tsx</files>
  <action>
Create the main Vaults page following SortingTagging.tsx patterns:

**Route Handling:**
- Support /vaults and /vaults/:vaultId routes
- On mount: if no vaultId in URL, auto-select first vault and navigate
- If invalid vaultId, redirect to /vaults (base)

**State:**
- selectedVaultId from URL param
- Mobile overlay states (following SortingTagging pattern)

**Layout:**
- Use AppShell with:
  - secondaryPane: <VaultListPane />
  - showDetailPane: true (for member/settings panel)

**Main Content (placeholder for Wave 2):**
- Empty state when no vault selected
- "Select a vault to view recordings and members"

**Mobile:**
- Full mobile layout with overlays (copy from SortingTagging)
- Vault list becomes overlay on mobile

**Keyboard:**
- Escape closes detail panel

Do NOT implement vault detail content yet - that's Wave 2.
  </action>
  <verify>Page renders at /vaults, URL updates on vault selection, mobile layout works</verify>
  <done>VaultsPage component with AppShell integration and URL-based vault selection</done>
</task>

<task type="auto">
  <name>Update Routing and Navigation</name>
  <files>src/App.tsx, src/components/ui/sidebar-nav.tsx, src/components/Layout.tsx</files>
  <action>
1. **App.tsx:**
   - Add import for VaultsPage
   - Replace `/team` route with `/vaults` route
   - Keep `/team` redirect to `/vaults` for backwards compatibility
   - Add `/vaults/:vaultId` route

2. **sidebar-nav.tsx:**
   - Change "collaboration" nav item to "vaults"
   - Name: "Vaults" (was "Collaboration")
   - Path: "/vaults" (was "/team")
   - Icon: RiSafeLine (was RiTeamLine) - import from @remixicon/react
   - Keep RiTeamFill for active state

3. **Layout.tsx:**
   - Update getPageLabel to return 'VAULTS' for /vaults paths
   - Remove '/team' special case

**Migration Path:**
- Keep /team working but redirect to /vaults
- Users with bookmarks will be redirected
  </action>
  <verify>
curl http://localhost:8080/vaults (should serve app)
Navigation shows "Vaults" not "Collaboration"
  </verify>
  <done>Route /vaults works, sidebar shows Vaults, /team redirects to /vaults</done>
</task>

</tasks>

<verification>
- [ ] /vaults route loads VaultsPage
- [ ] /vaults/:vaultId deep linking works
- [ ] Sidebar displays "Vaults" with safe/vault icon
- [ ] Vault list pane shows all user vaults grouped by bank
- [ ] Selecting vault updates URL
- [ ] Mobile layout has vault list overlay
- [ ] TypeScript compilation passes
</verification>

<success_criteria>
User can navigate to /vaults, see vault list in secondary pane, select vaults with URL updates, and view empty state in main content area.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-01-SUMMARY.md`
</output>
