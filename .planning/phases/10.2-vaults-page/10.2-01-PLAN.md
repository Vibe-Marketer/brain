---
phase: 10.2-vaults-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
  - src/components/ui/sidebar-nav.tsx
  - src/components/Layout.tsx
  - src/pages/VaultsPage.tsx
  - src/components/panes/VaultListPane.tsx
  - src/hooks/useVaults.ts
  - src/lib/query-config.ts
  - src/stores/panelStore.ts
  - src/types/panel.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to /vaults route"
    - "Sidebar shows 'Vaults' instead of 'Collaboration'"
    - "Vault list pane displays vaults for the active bank only"
    - "Bank context is visible on the Vaults page itself (not just header)"
    - "Clicking a vault selects it and URL updates to /vaults/:vaultId"
  artifacts:
    - path: "src/pages/VaultsPage.tsx"
      provides: "Main vaults page using AppShell"
      exports: ["default"]
    - path: "src/components/panes/VaultListPane.tsx"
      provides: "Secondary pane showing vault list"
      exports: ["VaultListPane"]
    - path: "src/hooks/useVaults.ts"
      provides: "Tanstack Query hooks for vault data"
      exports: ["useVaults", "useVaultDetail", "useVaultRecordings"]
  key_links:
    - from: "src/App.tsx"
      to: "src/pages/VaultsPage.tsx"
      via: "Route path='/vaults'"
    - from: "src/components/ui/sidebar-nav.tsx"
      to: "/vaults"
      via: "navItems array update"
    - from: "VaultListPane"
      to: "useVaults hook"
      via: "query for vault list"
    - from: "VaultListPane"
      to: "useBankContext"
      via: "activeBankId filters visible vaults"
---

<objective>
Create the foundational Vaults page infrastructure: new route, sidebar navigation update, query hooks, vault list secondary pane, and page shell. This establishes the 3-pane layout foundation that subsequent waves build upon.

Purpose: Replace the legacy "Collaboration" page with a first-class "Vaults" management interface. The bank switcher in the header controls which bank's vaults are visible — vault list shows ONLY the active bank's vaults.
Output: Working /vaults route with vault list sidebar, URL-based vault selection, and bank context visible on page.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/pages/SortingTagging.tsx
@/Users/admin/repos/brain/src/components/layout/AppShell.tsx
@/Users/admin/repos/brain/src/components/ui/sidebar-nav.tsx
@/Users/admin/repos/brain/src/App.tsx
@/Users/admin/repos/brain/src/components/Layout.tsx
@/Users/admin/repos/brain/src/hooks/useBankContext.ts
@/Users/admin/repos/brain/src/lib/query-config.ts
@/Users/admin/repos/brain/src/stores/panelStore.ts
@/Users/admin/repos/brain/src/types/bank.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Query Keys, Panel Types, and useVaults Hook</name>
  <files>src/lib/query-config.ts, src/types/panel.ts, src/stores/panelStore.ts, src/hooks/useVaults.ts</files>
  <action>
**query-config.ts:**
Add `vaults` object to queryKeys following existing pattern (e.g., folders):
- `all: ['vaults'] as const`
- `list: () => ['vaults', 'list'] as const`
- `detail: (id: string) => ['vaults', 'detail', id] as const`
- `members: (vaultId: string) => ['vaults', 'members', vaultId] as const`
- `recordings: (vaultId: string) => ['vaults', 'recordings', vaultId] as const`

**panel types (src/types/panel.ts or wherever PanelType is defined):**
Add to PanelType union: `'vault-member'`
Add to PanelData discriminated union: `{ type: 'vault-member'; vaultId: string }`

**panelStore.ts:**
Update DetailPaneOutlet render switch to handle 'vault-member' type (placeholder for now — just renders null or empty div with "Members panel coming in Plan 02").

**useVaults.ts:**
Create comprehensive vault data hooks:

1. `useVaults(bankId: string | null)` — Returns vaults for specific bank
   - Query from `vaults` table filtered by `bank_id`
   - Join `vault_memberships` to only include vaults user is a member of
   - Include member count via count aggregation
   - Use queryKeys.vaults.list()
   - Return: `{ vaults: Vault[], isLoading, error }`

2. `useVaultDetail(vaultId: string | null)` — Returns detailed vault info
   - Fetch vault with full membership list
   - Include member count, user's role in this vault
   - Use queryKeys.vaults.detail(vaultId)
   - Enabled only when vaultId provided

3. `useVaultRecordings(vaultId: string | null)` — Returns recordings in vault
   - Join vault_entries with recordings table
   - Include vault-specific metadata (local_tags, scores, notes)
   - Use queryKeys.vaults.recordings(vaultId)
   - Pagination support (limit/offset)

Use existing patterns from useBankContext and useFolders. All queries must have staleTime of 5 minutes. Import types from `@/types/bank`.
  </action>
  <verify>npm run typecheck — no errors on new files. grep for queryKeys.vaults in query-config.ts to confirm.</verify>
  <done>Query keys for vaults in query-config.ts, vault-member panel type defined, useVaults.ts exports three hooks with proper TypeScript types</done>
</task>

<task type="auto">
  <name>Task 2: Create VaultListPane Component</name>
  <files>src/components/panes/VaultListPane.tsx</files>
  <action>
Create the secondary pane component for vault list:

**Structure:**
- Header: Active bank name displayed prominently (from useBankContext) — this satisfies "bank context visible on page itself"
- Subheader: "VAULTS" title (Montserrat uppercase) + Create Vault button (stub onClick for now)
- Items: Vault cards showing name, type badge, member count

**Key behavior — bank filtering (LOCKED DECISION):**
- Uses `useBankContext()` to get `activeBankId`
- Passes `activeBankId` to `useVaults(activeBankId)` — shows ONLY active bank's vaults
- When bank changes in header BankSwitcher, vault list updates automatically (reactive query)

**Features:**
- Selected vault highlighting (vibe orange left border per brand guidelines)
- Show vault type badges (personal, team, coach, etc.)
- Member count indicator
- Create Vault button header (stub for Plan 03)
- Loading skeleton state (3-4 skeleton items)
- Empty state: "No vaults in this bank" with Create Vault CTA

**Props:**
```tsx
interface VaultListPaneProps {
  selectedVaultId: string | null;
  onVaultSelect: (vaultId: string) => void;
  className?: string;
}
```

**Styling:**
- Use AppShell secondary pane width (280px)
- Follow SortingCategoryPane patterns from SortingTagging.tsx
- 500ms transitions for selection changes
- Remix icons only (RiSafeLine for vault icon)
  </action>
  <verify>Component renders without errors, uses correct query hooks, shows active bank name</verify>
  <done>VaultListPane component displays vaults for active bank with selection support and bank context visible</done>
</task>

<task type="auto">
  <name>Task 3: Create VaultsPage and Wire Routing</name>
  <files>src/pages/VaultsPage.tsx, src/App.tsx, src/components/ui/sidebar-nav.tsx, src/components/Layout.tsx</files>
  <action>
**VaultsPage.tsx** — following SortingTagging.tsx patterns:

Route Handling:
- Support /vaults and /vaults/:vaultId routes
- On mount: if no vaultId in URL, auto-select first vault and navigate
- If invalid vaultId, redirect to /vaults (base)

State:
- selectedVaultId from URL param
- Mobile overlay states (following SortingTagging pattern)

Layout using AppShell:
- secondaryPane: `<VaultListPane />`
- showDetailPane: true (for member panel — 4th pane)
- Main content: placeholder empty state for now — "Select a vault to view recordings and members"

Mobile:
- Full mobile layout with overlays (copy from SortingTagging)
- Vault list becomes overlay on mobile

Keyboard:
- Escape closes detail panel

Do NOT implement vault detail content yet — that's Wave 2 (Plan 02).

**App.tsx:**
- Import VaultsPage
- Replace `/team` route with `/vaults` route
- Keep `/team` redirect to `/vaults` for backwards compatibility
- Add `/vaults/:vaultId` route

**sidebar-nav.tsx:**
- Change "collaboration" nav item to "vaults"
- Name: "Vaults" (was "Collaboration")
- Path: "/vaults" (was "/team")
- Icon: RiSafeLine (import from @remixicon/react)

**Layout.tsx:**
- Update getPageLabel to return 'VAULTS' for /vaults paths
- Remove '/team' special case
- Add '/vaults' to usesCustomLayout check (since it uses AppShell)
  </action>
  <verify>
Navigate to http://localhost:8080/vaults — page renders with AppShell layout.
Sidebar shows "Vaults" not "Collaboration".
URL updates when selecting a vault.
/team redirects to /vaults.
  </verify>
  <done>Route /vaults works, sidebar shows Vaults, /team redirects, VaultsPage renders with AppShell and VaultListPane</done>
</task>

</tasks>

<verification>
- [ ] /vaults route loads VaultsPage
- [ ] /vaults/:vaultId deep linking works
- [ ] Sidebar displays "Vaults" with safe/vault icon
- [ ] Vault list pane shows vaults for ACTIVE BANK ONLY
- [ ] Active bank name visible on the Vaults page itself
- [ ] Selecting vault updates URL
- [ ] Mobile layout has vault list overlay
- [ ] TypeScript compilation passes
- [ ] /team redirects to /vaults
</verification>

<success_criteria>
User can navigate to /vaults, see vault list for their active bank in secondary pane, select vaults with URL updates, and see the active bank context on the page. Switching banks in header BankSwitcher updates the vault list.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-01-SUMMARY.md`
</output>
