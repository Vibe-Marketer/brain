---
phase: 10.2-vaults-page
plan: 02
subsystem: ui
tags: [react, tanstack-query, transcript-table, vault, adapter, panel, members]

# Dependency graph
requires:
  - phase: 10.2-vaults-page
    plan: 01
    provides: VaultListPane, useVaults hooks, /vaults route, vault-member panel type
  - phase: 09-bank-vault-architecture
    provides: Recording and VaultEntry types, vault_memberships table
provides:
  - VaultDetailPane with always-visible recordings via TranscriptTable
  - VaultMemberPanel slide-in 4th pane with role-sorted members
  - useVaultMembers hook for fetching members with profiles
  - mapRecordingToMeeting adapter bridging Recording → Meeting types
  - AddToVaultMenu UUID recording support
  - Vault recordings query invalidation on add/remove
affects: [10.2-03, 10.2-04, 10.2-05]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Recording → Meeting adapter for reusing TranscriptTable"
    - "Role hierarchy sorting with ROLE_ORDER constant"
    - "vault recordings query invalidation on vault entry mutations"

# File tracking
key-files:
  created:
    - src/components/panes/VaultDetailPane.tsx
    - src/components/panels/VaultMemberPanel.tsx
  modified:
    - src/hooks/useVaults.ts
    - src/hooks/useVaultAssignment.ts
    - src/components/layout/DetailPaneOutlet.tsx
    - src/components/transcript-library/TranscriptTableRow.tsx
    - src/pages/VaultsPage.tsx

# Decisions
decisions:
  - id: recording-meeting-adapter
    decision: "mapRecordingToMeeting adapter function bridges vault Recording type to Meeting type for TranscriptTable"
    rationale: "Reuses existing TranscriptTable without modification — adapter maps all Meeting fields with sensible defaults"
  - id: uuid-recording-id-pass-through
    decision: "TranscriptTableRow passes UUID string recording IDs to AddToVaultMenu's recordingId prop"
    rationale: "Vault recordings have UUID IDs from recordings table, not just legacy numeric IDs from fathom_calls"
  - id: vault-recordings-invalidation
    decision: "useVaultAssignment invalidates queryKeys.vaults.recordings(vaultId) on add/remove"
    rationale: "VaultDetailPane uses a different query key than vaultEntries.byRecording — both need invalidation for consistency"
  - id: role-hierarchy-sorting
    decision: "VaultMember list sorted by ROLE_ORDER: vault_owner(0) → vault_admin(1) → manager(2) → member(3) → guest(4)"
    rationale: "Owners and admins should appear first for easy identification"
  - id: orange-owner-badge
    decision: "vault_owner role badge uses orange (bg-orange-100), vault_admin uses blue, manager green, member/guest gray"
    rationale: "Differentiates roles visually; orange for owner follows vibe-orange-adjacent pattern without breaking brand rules"

# Metrics
metrics:
  duration: "~5 minutes"
  completed: "2026-02-09"
---

# Phase 10.2 Plan 02: Vault Detail View with Recordings Table Summary

**One-liner:** VaultDetailPane renders vault recordings via TranscriptTable adapter with slide-in member panel.

## What Was Built

### Task 1: useVaultMembers Hook + mapRecordingToMeeting Adapter
- **useVaultMembers(vaultId)** — fetches vault_memberships joined with user_profiles, returns VaultMember[] sorted by role hierarchy
- **mapRecordingToMeeting(recording)** — bridges VaultRecording → Meeting type for TranscriptTable consumption, mapping all fields with sensible defaults
- Added VaultMember interface (id, user_id, role, email, display_name, avatar_url)
- Added ROLE_ORDER constant for consistent sorting

### Task 2: VaultDetailPane + VaultMemberPanel Components
- **VaultDetailPane** — main content area with:
  - Montserrat uppercase vault name header
  - Vault type badge (color-coded by type)
  - Recording count with icon
  - Members button that opens 4th pane panel
  - TranscriptTable fed by mapRecordingToMeeting adapter
  - Empty state: "No recordings in this vault yet" + Go to Library CTA
  - Loading skeleton state
  - Mobile back button support
- **VaultMemberPanel** — slide-in 4th pane with:
  - Role-sorted member list with avatars
  - Color-coded role badges (owner=orange, admin=blue, manager=green, member/guest=gray)
  - Email + display name + join date
  - "Invite Members" stub button (disabled, "Soon" badge) for Plan 04
  - Empty state with invite prompt
- **DetailPaneOutlet** updated to render real VaultMemberPanel (replaced placeholder)

### Task 3: AddToVaultMenu Integration
- TranscriptTableRow now passes UUID string `recordingId` to AddToVaultMenu (in addition to numeric `legacyRecordingId`)
- useVaultAssignment now invalidates `queryKeys.vaults.recordings(vaultId)` on both add and remove mutations
- Ensures VaultDetailPane recording list auto-refreshes when recordings are moved between vaults

### Task 4: VaultsPage Integration
- Desktop: VaultDetailPane renders in main content area when vault selected
- Desktop empty state: "Select a Vault" with left-arrow indicator
- Mobile: VaultDetailPane with back button navigates to vault list overlay
- Mobile: VaultMemberPanel renders in bottom sheet (replaces placeholder)
- All Plan 02 placeholder text removed

## Task Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | 89b037b | Add useVaultMembers hook and mapRecordingToMeeting adapter |
| 2 | f7927f3 | Create VaultDetailPane and VaultMemberPanel components |
| 3 | 9e79da5 | Integrate AddToVaultMenu with UUID recording support |
| 4 | 9c6bb58 | Integrate VaultDetailPane into VaultsPage |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] UUID recording ID not passed to AddToVaultMenu**
- **Found during:** Task 3
- **Issue:** TranscriptTableRow only passed numeric `legacyRecordingId` to AddToVaultMenu. Vault recordings with UUID IDs (from recordings table) wouldn't be findable.
- **Fix:** Added `recordingId={typeof call.recording_id === 'string' ? call.recording_id : null}` prop to AddToVaultMenu in TranscriptTableRow
- **Files modified:** src/components/transcript-library/TranscriptTableRow.tsx

**2. [Rule 2 - Missing Critical] Vault recordings query not invalidated on vault entry mutations**
- **Found during:** Task 3
- **Issue:** useVaultAssignment only invalidated `vaultEntries.byRecording()` but VaultDetailPane uses `vaults.recordings()` — a different query key. Recordings list wouldn't refresh after add/remove.
- **Fix:** Added `queryKeys.vaults.recordings(vaultId)` invalidation to both addToVault and removeFromVault onSettled callbacks
- **Files modified:** src/hooks/useVaultAssignment.ts

## Verification

- [x] Vault detail pane shows recordings table (always visible, NO tabs)
- [x] TranscriptTable receives data via mapRecordingToMeeting adapter
- [x] Recording count displays in header
- [x] "Members" button opens VaultMemberPanel as slide-in 4th pane
- [x] Member roles display correctly with color coding
- [x] Empty state for vault with no recordings
- [x] AddToVaultMenu available on recording rows (via TranscriptTableRow)
- [x] Move/assign recording between vaults updates the recording list
- [x] Mobile layout functional
- [x] TypeScript compilation passes (tsc --noEmit clean)

## Next Phase Readiness

Plan 02 complete. Ready for Plan 03 (Vault Creation & Edit Dialogs).

Key state for next plan:
- VaultDetailPane is live with recordings
- VaultMemberPanel renders with role-sorted members
- "Invite Members" button is stubbed (disabled) — Plan 04 will activate it
- AddToVaultMenu works with both legacy numeric IDs and UUID recording IDs

## Self-Check: PASSED
