---
phase: 10.2-vaults-page
plan: 09
type: execute
wave: 3
depends_on: ["10.2-02"]
files_modified:
  - src/components/vault/VaultSelector.tsx
  - src/hooks/useUserPreferences.ts
  - src/components/import/YouTubeImportForm.tsx
  - src/components/transcripts/SyncTab.tsx
  - supabase/functions/youtube-import/index.ts
  - supabase/functions/zoom-sync-meetings/index.ts
  - supabase/functions/google-poll-sync/index.ts
autonomous: true

must_haves:
  truths:
    - "User can select which vault to import recordings into during YouTube import"
    - "Vault selector shows in YouTube import form"
    - "Zoom/Google sync flow gets vault selection in SyncTab confirmation step"
    - "Default vault preference remembered per integration"
    - "Import edge functions accept and use vault_id parameter"
  artifacts:
    - path: "src/components/vault/VaultSelector.tsx"
      provides: "Vault selection dropdown component"
      exports: ["VaultSelector"]
    - path: "src/hooks/useUserPreferences.ts"
      provides: "User preferences including default vault per integration"
      exports: ["useUserPreferences"]
  key_links:
    - from: "YouTubeImportForm"
      to: "VaultSelector"
      via: "Vault selection before import"
    - from: "SyncTab"
      to: "VaultSelector"
      via: "Vault selection before sync"
    - from: "youtube-import edge function"
      to: "vault_entries table"
      via: "create entry in specified vault"
    - from: "zoom-sync-meetings edge function"
      to: "vault_entries table"
      via: "create entries for synced meetings in specified vault"
    - from: "google-poll-sync edge function"
      to: "vault_entries table"
      via: "create entries for synced meetings in specified vault"
---

<objective>
Allow users to choose which vault recordings go into during import. YouTube import form gets a VaultSelector. Zoom/Google sync flow in SyncTab gets vault selection in the confirmation step. Edge functions are updated to accept vault_id and create vault entries.

CRITICAL: ZoomImportDialog and GoogleImportDialog DO NOT EXIST. Zoom/Google sync uses the `useIntegrationSync` hook and SyncTab component with `useMeetingsSync`. The VaultSelector must integrate into the ACTUAL sync flow, not imaginary dialog components.

Purpose: Give users control over where imported recordings land.
Output: Vault selection in all import flows with preference persistence and edge function support.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/components/import/YouTubeImportForm.tsx
@/Users/admin/repos/brain/src/components/transcripts/SyncTab.tsx
@/Users/admin/repos/brain/src/hooks/useIntegrationSync.ts
@/Users/admin/repos/brain/src/hooks/useMeetingsSync.ts
@/Users/admin/repos/brain/src/hooks/useBankContext.ts
@/Users/admin/repos/brain/src/types/bank.ts
@/Users/admin/repos/brain/supabase/functions/youtube-import/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VaultSelector Component and useUserPreferences Hook</name>
  <files>src/components/vault/VaultSelector.tsx, src/hooks/useUserPreferences.ts</files>
  <action>
**useUserPreferences Hook:**
```tsx
interface UserPreferences {
  defaultImportVaultId: string | null;
  lastUsedVaultPerIntegration: Record<string, string>; // 'youtube' | 'zoom' | 'google_meet' → vaultId
}
```
- Persist to localStorage: `callvault:preferences:defaultImportVault`, `callvault:preferences:lastVault:{integration}`
- getSuggestedVault(integration, personalVaultId): returns last used → default → personal fallback
- setLastUsedVault(integration, vaultId): updates localStorage
- Simple, lightweight — no database sync needed for MVP

**VaultSelector Component:**
```tsx
interface VaultSelectorProps {
  selectedVaultId: string;
  onVaultSelect: (vaultId: string) => void;
  label?: string; // Default: "Import to vault"
  disabled?: boolean;
  className?: string;
}
```
- Dropdown trigger shows selected vault name + icon
- Uses useBankContext to get available vaults across all user's banks
- Grouped by: Personal Bank vaults, then Business Bank vaults
- Each item: vault icon (personal vs team style), vault name, bank name (if multiple banks)
- Selected: checkmark icon, highlighted
- Personal vault: RiUserLine icon, muted
- Team vault: RiSafeLine icon, standard
- Compact design suitable for embedding in forms
  </action>
  <verify>VaultSelector renders with correct grouping. useUserPreferences persists to localStorage.</verify>
  <done>VaultSelector component and useUserPreferences hook created</done>
</task>

<task type="auto">
  <name>Task 2: Integrate VaultSelector into YouTubeImportForm and SyncTab</name>
  <files>src/components/import/YouTubeImportForm.tsx, src/components/transcripts/SyncTab.tsx</files>
  <action>
**YouTubeImportForm:**
- Add VaultSelector between URL input and import button
- Initialize with getSuggestedVault('youtube', personalVaultId)
- On import success: setLastUsedVault('youtube', selectedVaultId)
- Pass selectedVaultId to the import edge function call
- Label: "Import to vault"

**SyncTab (Zoom/Google sync flow):**
CRITICAL: There are NO ZoomImportDialog or GoogleImportDialog components. Zoom and Google sync happens through SyncTab using useMeetingsSync hook. The sync flow is:
1. User selects meetings from the unsynced list
2. User clicks "Sync Selected" button
3. Meetings are synced via edge functions

Integration approach:
- Add VaultSelector near the "Sync Selected" button (in the sync confirmation area)
- When syncing: pass vault_id to the sync edge function
- Initialize with getSuggestedVault('zoom' or 'google_meet', personalVaultId)
- On sync success: setLastUsedVault for the appropriate integration
- Read the actual SyncTab code to find the exact location to add VaultSelector — look for the sync button and the function that triggers sync

The VaultSelector should appear ABOVE the sync action button, with label "Sync to vault:" — making it clear where recordings will land.

If SyncTab has separate sync paths for Zoom vs Google, add VaultSelector to each path. If unified, add once.
  </action>
  <verify>YouTube import form shows vault selector. SyncTab sync flow includes vault selection. Preferences persist.</verify>
  <done>VaultSelector integrated into YouTube import and SyncTab sync flow with preference persistence</done>
</task>

<task type="auto">
  <name>Task 3: Update ALL Import Edge Functions for vault_id (YouTube, Zoom, Google)</name>
  <files>supabase/functions/youtube-import/index.ts, supabase/functions/zoom-sync-meetings/index.ts, supabase/functions/google-poll-sync/index.ts</files>
  <action>
LOCKED DECISION: Import vault selection covers ALL 3 import flows — YouTube, Zoom, and Google.

**youtube-import edge function:**
Request body change:
```typescript
interface YouTubeImportRequest {
  videoUrl: string;
  vault_id?: string; // NEW - optional for backwards compatibility
}
```

After creating the recording in the recordings table, if vault_id provided:
1. Validate vault membership — query vault_memberships for user + vault
2. If no membership: return 403 "Access denied to vault"
3. Create vault_entry: insert into vault_entries with vault_id, recording_id
4. If vault_entry creation fails: log error but don't fail the whole import

**zoom-sync-meetings edge function:**
Read the actual function code to understand how it processes meetings. Apply same pattern:
1. Accept vault_id in the request body (optional for backwards compat)
2. After inserting/syncing each recording, if vault_id provided: validate membership + create vault_entry
3. For batch sync (multiple meetings): use the same vault_id for all recordings in the batch
4. If vault_entry creation fails for one recording: log error, continue with remaining

**google-poll-sync edge function:**
Read the actual function code. Apply same pattern as zoom:
1. Accept vault_id in the request body (optional for backwards compat)
2. After syncing each meeting recording, if vault_id provided: validate membership + create vault_entry
3. For batch operations: use same vault_id for all recordings
4. If vault_entry creation fails: log error, continue

Backwards compatibility for ALL functions: If vault_id not provided, recording still goes to personal vault (existing behavior via trigger or default).
  </action>
  <verify>All 3 edge functions accept vault_id. YouTube import creates vault_entry. Zoom sync creates vault_entries for synced meetings. Google sync creates vault_entries. Without vault_id all 3 functions still work (backwards compat).</verify>
  <done>All 3 import edge functions (youtube-import, zoom-sync-meetings, google-poll-sync) accept vault_id, validate membership, and create vault entries</done>
</task>

</tasks>

<verification>
- [ ] VaultSelector renders in YouTube import form
- [ ] VaultSelector renders in SyncTab sync flow
- [ ] Default vault remembered per integration
- [ ] YouTube import edge function creates vault_entry when vault_id provided
- [ ] Zoom sync edge function creates vault_entries when vault_id provided
- [ ] Google sync edge function creates vault_entries when vault_id provided
- [ ] Vault membership validated before creating entry (all 3 functions)
- [ ] Backwards compatibility (no vault_id) works for all 3 functions
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
Users can select which vault to import recordings into across YouTube import and Zoom/Google sync. The system remembers preferences per integration. Edge functions validate access and create vault entries.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-09-SUMMARY.md`
</output>
