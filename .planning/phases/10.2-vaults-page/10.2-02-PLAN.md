---
phase: 10.2-vaults-page
plan: 02
type: execute
wave: 2
depends_on: ["10.2-01"]
files_modified:
  - src/pages/VaultsPage.tsx
  - src/components/panes/VaultDetailPane.tsx
  - src/components/panels/VaultMemberPanel.tsx
  - src/hooks/useVaults.ts
autonomous: true

must_haves:
  truths:
    - "User sees vault recordings in main content area"
    - "Recordings show vault-specific metadata (local tags, notes)"
    - "Tabs for Recordings and Members visible"
    - "Recording count displayed"
    - "Empty state when vault has no recordings"
  artifacts:
    - path: "src/components/panes/VaultDetailPane.tsx"
      provides: "Main content showing vault recordings"
      exports: ["VaultDetailPane"]
    - path: "src/components/panels/VaultMemberPanel.tsx"
      provides: "Detail panel showing vault members"
      exports: ["VaultMemberPanel"]
  key_links:
    - from: "VaultDetailPane"
      to: "useVaultRecordings hook"
      via: "Tanstack Query fetch"
    - from: "VaultDetailPane"
      to: "panelStore"
      via: "openPanel('vault-member', ...)"
---

<objective>
Build the vault detail view - the main content area showing recordings in the selected vault with tabs for Recordings and Members. This is the primary interaction surface where users spend most of their time.

Purpose: Provide the core vault experience - viewing and managing recordings within a collaboration space.
Output: Complete vault detail pane with recordings list, metadata display, and member management entry point.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/components/panes/SortingDetailPane.tsx
@/Users/admin/repos/brain/src/components/transcript-library/TranscriptTable.tsx
@/Users/admin/repos/brain/src/hooks/useVaultAssignment.ts
@/Users/admin/repos/brain/src/stores/panelStore.ts
</context>

<tasks>

<task type="auto">
  <name>Extend useVaults with Member Query</name>
  <files>src/hooks/useVaults.ts</files>
  <action>
Add to existing useVaults.ts:

4. `useVaultMembers(vaultId: string | null)` - Returns members with profiles
   - Fetch from vault_memberships joined with user_profiles
   - Include role, joined date, user name/email/avatar
   - Use queryKeys.vaults.members(vaultId)
   - Sort by role (owner first, then admin, then manager, then member)

5. `useVaultStats(vaultId: string | null)` - Returns aggregated stats
   - Recording count
   - Member count
   - Last activity date
   - Use single query with count aggregates

Update query-config.ts to add these query keys if not already done in Wave 1.
  </action>
  <verify>Hooks return correct data shapes, loading states work</verify>
  <done>useVaultMembers and useVaultStats hooks implemented and tested</done>
</task>

<task type="auto">
  <name>Create VaultDetailPane Component</name>
  <files>src/components/panes/VaultDetailPane.tsx</files>
  <action>
Create the main vault detail content pane:

**Header Section:**
- Vault name (large, Montserrat)
- Vault type badge
- Member count icon + number
- Recording count
- Settings button (cog icon) - opens settings panel
- Close/Back button (for mobile)

**Tabs (vibe orange underline style per brand):**
- "Recordings" (default) - shows recordings table
- "Members" - shows member list inline

**Recordings Tab:**
- Table with columns:
  - Title (with recording indicator if audio available)
  - Duration
  - Date
  - Owner
  - Local Tags (vault-specific tags)
  - Notes indicator (if notes exist)
- Empty state: "No recordings in this vault yet"
- Use existing TranscriptTable patterns but simplified
- Virtual scrolling for large vaults (react-window)

**Members Tab (inline preview):**
- Show first 5 members with avatars
- Role badges
- "View All" button opens member panel

**Props:**
```tsx
interface VaultDetailPaneProps {
  vaultId: string;
  onClose?: () => void;
  onBack?: () => void;
  showBackButton?: boolean;
  className?: string;
}
```

**Interactions:**
- Click recording → navigate to call detail
- Click member → open user detail panel
- Click "Manage Members" → open vault-member panel
  </action>
  <verify>Component displays recordings, tabs switch, stats load</verify>
  <done>VaultDetailPane with recordings table and members tab</done>
</task>

<task type="auto">
  <name>Create VaultMemberPanel Component</name>
  <files>src/components/panels/VaultMemberPanel.tsx</files>
  <action>
Create the detail panel for vault member management:

**Header:**
- Title: "Vault Members"
- Member count badge
- Close button
- Pin button (to keep panel open)

**Member List:**
- Avatar + Name + Email
- Role badge (color-coded: owner=orange, admin=blue, manager=green, member=gray)
- Joined date
- Actions menu (if user has permission):
  - Change role (for admins/owners)
  - Remove from vault (for admins/owners)

**Invite Section:**
- "Invite Members" button
- Opens invite dialog (stub for Wave 4)

**Empty State:**
- "No members yet"
- Show invite button

**Props:**
```tsx
interface VaultMemberPanelProps {
  vaultId: string;
}
```

**Data:**
- Use useVaultMembers hook
- Check current user's role to determine permissions
- Only vault_owner/vault_admin can manage members

**Styling:**
- Follow DetailPaneOutlet width (360px desktop, 320px tablet)
- Use panelStore for open/close/pin state
  </action>
  <verify>Panel shows members, roles display correctly, permissions respected</verify>
  <done>VaultMemberPanel component for detail pane</done>
</task>

<task type="auto">
  <name>Integrate VaultDetailPane into VaultsPage</name>
  <files>src/pages/VaultsPage.tsx</files>
  <action>
Update VaultsPage to render VaultDetailPane in main content area:

**Changes:**
1. Replace placeholder empty state with actual VaultDetailPane
2. Pass vaultId from URL param
3. Handle onClose to clear selection and navigate to /vaults
4. Wire up detail panel outlet for vault-member panel

**Panel Integration:**
- Add panel type 'vault-member' to panelStore render
- When user clicks "Manage Members", open vault-member panel
- Panel renders VaultMemberPanel component

**Mobile:**
- Detail pane becomes full-screen on mobile
- Back button returns to vault list

**URL Sync:**
- Ensure vaultId in URL stays in sync with selection
- Back/forward browser buttons work correctly
  </action>
  <verify>Vault detail renders, tabs work, panel opens</verify>
  <done>VaultsPage fully integrated with VaultDetailPane and member panel</done>
</task>

<task type="auto">
  <name>Add Vault Recording Row Context Menu</name>
  <files>src/components/panes/VaultDetailPane.tsx, src/components/vault/AddToVaultMenu.tsx</files>
  <action>
Add context menu to recording rows in vault detail:

**Menu Items:**
- "View Details" - navigate to call detail
- "Add to Folder" - submenu with vault folders
- "Edit Local Tags" - inline tag editing
- "Add Note" - quick note addition
- "Remove from Vault" - if user has permission

**Permissions:**
- Members can edit their own recordings' local tags/notes
- Vault admins can edit any recording
- Recording owner can remove from vault (unless personal vault)

**Implementation:**
- Use existing DropdownMenu component
- Reuse AddToVaultMenu for folder assignment
- Inline tag editing with TagInput component
  </action>
  <verify>Right-click on recording shows menu, actions work</verify>
  <done>Context menu on recording rows with vault-specific actions</done>
</task>

</tasks>

<verification>
- [ ] Vault detail pane shows recordings table
- [ ] Tabs (Recordings/Members) switch correctly
- [ ] Recording count displays
- [ ] Member panel opens from "Manage Members"
- [ ] Member roles display correctly
- [ ] Context menu works on recordings
- [ ] Empty state for vault with no recordings
- [ ] Mobile layout functional
</verification>

<success_criteria>
User can select a vault and see its recordings in a table with metadata, switch between Recordings and Members tabs, open the member panel, and interact with recording context menus.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-02-SUMMARY.md`
</output>
