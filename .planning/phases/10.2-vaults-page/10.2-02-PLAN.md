---
phase: 10.2-vaults-page
plan: 02
type: execute
wave: 2
depends_on: ["10.2-01"]
files_modified:
  - src/pages/VaultsPage.tsx
  - src/components/panes/VaultDetailPane.tsx
  - src/components/panels/VaultMemberPanel.tsx
  - src/hooks/useVaults.ts
  - src/components/vault/AddToVaultMenu.tsx
autonomous: true

must_haves:
  truths:
    - "User sees vault recordings in main content area (always visible, NO tabs)"
    - "Recordings display uses existing TranscriptTable with adapter for Recording → Meeting shape"
    - "Clicking 'Members' button opens slide-in detail panel (4th pane pattern)"
    - "Recording count displayed in vault header"
    - "Empty state when vault has no recordings"
    - "User can move/assign recordings between vaults via context menu on recording rows"
  artifacts:
    - path: "src/components/panes/VaultDetailPane.tsx"
      provides: "Main content showing vault recordings (always visible)"
      exports: ["VaultDetailPane"]
    - path: "src/components/panels/VaultMemberPanel.tsx"
      provides: "Slide-in detail panel showing vault members (4th pane)"
      exports: ["VaultMemberPanel"]
  key_links:
    - from: "VaultDetailPane"
      to: "useVaultRecordings hook"
      via: "Tanstack Query fetch"
    - from: "VaultDetailPane"
      to: "TranscriptTable"
      via: "Adapter: mapRecordingToMeeting() converts Recording+VaultEntry → Meeting-compatible shape"
    - from: "VaultDetailPane"
      to: "panelStore"
      via: "openPanel('vault-member', { vaultId })"
    - from: "VaultMemberPanel"
      to: "useVaultMembers hook"
      via: "Tanstack Query fetch"
    - from: "VaultDetailPane recording rows"
      to: "AddToVaultMenu"
      via: "Context menu on recording rows for move/assign to vault"
---

<objective>
Build the vault detail view — the main content area showing recordings in the selected vault. Recordings are ALWAYS visible (no tabs — per locked decision). Members open as a slide-in detail panel (4th pane pattern). This reuses existing TranscriptTable with an adapter function to bridge Recording → Meeting type shape.

Purpose: Provide the core vault experience — viewing recordings within a collaboration space with quick member access.
Output: Complete vault detail pane with recordings table, member panel, and Recording→Meeting adapter.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/components/panes/SortingDetailPane.tsx
@/Users/admin/repos/brain/src/components/transcript-library/TranscriptTable.tsx
@/Users/admin/repos/brain/src/hooks/useVaultAssignment.ts
@/Users/admin/repos/brain/src/stores/panelStore.ts
@/Users/admin/repos/brain/src/types/bank.ts
@.planning/phases/10.2-vaults-page/10.2-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useVaults with Member Query + Create Recording→Meeting Adapter</name>
  <files>src/hooks/useVaults.ts</files>
  <action>
Add to existing useVaults.ts (created in Plan 01):

**useVaultMembers(vaultId: string | null):**
- Fetch from vault_memberships joined with user_profiles (or auth.users metadata)
- Include: role, joined date (created_at), user name/email/avatar
- Use queryKeys.vaults.members(vaultId)
- Sort by role hierarchy: vault_owner first, then vault_admin, manager, member, guest
- Enabled only when vaultId is non-null

**mapRecordingToMeeting() adapter function:**
CRITICAL: TranscriptTable uses `Meeting` type. Vault recordings use `Recording` + `VaultEntry` from `@/types/bank`. Per locked decision, we REUSE existing TranscriptTable — so we need an adapter.

```tsx
export function mapRecordingToMeeting(
  recording: Recording,
  vaultEntry: VaultEntry
): Meeting {
  return {
    recording_id: recording.legacy_recording_id ?? 0,
    title: recording.title,
    full_transcript: recording.full_transcript,
    duration_seconds: recording.duration_seconds,
    created_at: recording.created_at,
    // Map remaining Meeting fields from Recording fields
    // Fields that don't exist on Recording: set sensible defaults
    // e.g., calendar_invitees: [], sentiment_cache: null, etc.
    // Include vault-specific data as extra properties if needed
  };
}
```

Read the actual Meeting type (from useMeetingsSync or types) and Recording type (from @/types/bank) to build a complete mapping. Every Meeting field must be populated or defaulted. This is the critical bridge between vault data and the existing table component.
  </action>
  <verify>npm run typecheck — adapter function compiles with no type errors. useVaultMembers returns correct shape.</verify>
  <done>useVaultMembers hook and mapRecordingToMeeting adapter function implemented with full type safety</done>
</task>

<task type="auto">
  <name>Task 2: Create VaultDetailPane and VaultMemberPanel</name>
  <files>src/components/panes/VaultDetailPane.tsx, src/components/panels/VaultMemberPanel.tsx</files>
  <action>
**VaultDetailPane — main content area (NO tabs, per locked decision):**

Header Section:
- Vault name (large, Montserrat uppercase)
- Vault type badge
- Member count icon + number (clickable — opens member panel)
- Recording count
- "Members" button — opens VaultMemberPanel via panelStore.openPanel('vault-member', { vaultId })
- Close/Back button (for mobile)

Recordings (ALWAYS visible — no tabs):
- Use existing TranscriptTable component
- Feed it data from useVaultRecordings, transformed via mapRecordingToMeeting()
- Show vault-specific columns if TranscriptTable supports custom columns, otherwise show standard columns
- Empty state: "No recordings in this vault yet" with CTA to go to Library

Props:
```tsx
interface VaultDetailPaneProps {
  vaultId: string;
  onClose?: () => void;
  onBack?: () => void;
  showBackButton?: boolean;
  className?: string;
}
```

Interactions:
- Click recording → navigate to call detail page
- Click "Members" button → open vault-member panel (slide-in 4th pane)

**VaultMemberPanel — slide-in detail panel (4th pane pattern):**

Header:
- Title: "Vault Members"
- Member count badge
- Close button

Member List:
- Avatar + Name + Email
- Role badge (color-coded: vault_owner=vibe orange bg, vault_admin=blue, manager=green, member=gray, guest=gray/lighter)
- Joined date
- Actions menu placeholder (stub for Plan 04 — "Change Role" and "Remove" will be added there)

Invite Section:
- "Invite Members" button (stub for Plan 04)

Empty State:
- "No members yet" + invite button

Styling:
- Follow DetailPaneOutlet width (360px desktop, 320px tablet)
- Use panelStore for open/close/pin state
- Register in panelStore render switch for 'vault-member' type
  </action>
  <verify>VaultDetailPane shows recordings via TranscriptTable. Member panel opens via "Members" button. No tab UI exists.</verify>
  <done>VaultDetailPane displays recordings always-visible with member panel as slide-in 4th pane. NO tabs anywhere.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate AddToVaultMenu into VaultDetailPane Recording Rows</name>
  <files>src/components/panes/VaultDetailPane.tsx, src/components/vault/AddToVaultMenu.tsx</files>
  <action>
VAULT-UI-07: Users must be able to move/assign recordings between vaults from the vault detail view.

The AddToVaultMenu component already exists from Phase 9 (`src/components/vault/AddToVaultMenu.tsx`). It provides a context menu for assigning a recording to vaults. Integrate it into VaultDetailPane's TranscriptTable rows:

1. Read AddToVaultMenu.tsx to understand its props (likely needs recordingId and current vaultId)
2. Add AddToVaultMenu as a context menu option on each recording row in the vault's TranscriptTable
3. Integration approaches (choose based on how TranscriptTable handles row actions):
   - If TranscriptTable supports a `rowActions` or `contextMenu` prop: pass AddToVaultMenu as a row action
   - If TranscriptTable uses a separate actions column: add AddToVaultMenu trigger there
   - If neither: wrap TranscriptTable rows with a right-click context menu that includes AddToVaultMenu
4. After a recording is moved/removed from the current vault, invalidate useVaultRecordings query so the list updates
5. Show toast on success: "Recording moved to {vaultName}" or "Recording added to {vaultName}"

Do NOT create a new component — reuse the existing AddToVaultMenu from Phase 9.
  </action>
  <verify>Right-click or action menu on a recording row in VaultDetailPane shows vault assignment options. Assigning to another vault updates the recording list.</verify>
  <done>AddToVaultMenu integrated into VaultDetailPane recording rows, enabling move/assign recordings between vaults</done>
</task>

<task type="auto">
  <name>Task 4: Integrate VaultDetailPane into VaultsPage</name>
  <files>src/pages/VaultsPage.tsx</files>
  <action>
Update VaultsPage (from Plan 01 placeholder) to render VaultDetailPane in main content area:

Changes:
1. Replace placeholder empty state with actual VaultDetailPane when vaultId is selected
2. Pass vaultId from URL param
3. Handle onClose to clear selection and navigate to /vaults
4. Wire up detail panel outlet for vault-member panel type

Panel Integration:
- When panelStore has type 'vault-member', render VaultMemberPanel in detail pane outlet
- Panel opens when user clicks "Members" in VaultDetailPane header

No vault selected state:
- Show empty state: "Select a vault to view recordings and members"
- Arrow/icon pointing to vault list pane

Mobile:
- Detail pane becomes full-screen on mobile
- Back button returns to vault list

URL Sync:
- Ensure vaultId in URL stays in sync with selection
- Back/forward browser buttons work correctly
  </action>
  <verify>Vault detail renders when vault selected. Member panel slides in when "Members" clicked. Mobile back button works.</verify>
  <done>VaultsPage fully integrated with VaultDetailPane and member panel. Recordings always visible, members as slide-in.</done>
</task>

</tasks>

<verification>
- [ ] Vault detail pane shows recordings table (always visible, NO tabs)
- [ ] TranscriptTable receives data via mapRecordingToMeeting adapter
- [ ] Recording count displays in header
- [ ] "Members" button opens VaultMemberPanel as slide-in 4th pane
- [ ] Member roles display correctly with color coding
- [ ] Empty state for vault with no recordings
- [ ] AddToVaultMenu available on recording rows (context menu or actions column)
- [ ] Move/assign recording between vaults updates the recording list
- [ ] Mobile layout functional
- [ ] TypeScript compilation passes (adapter function is type-safe)
</verification>

<success_criteria>
User can select a vault and see its recordings in TranscriptTable (always visible, no tab switching). Clicking "Members" opens a slide-in panel showing member list with roles. The adapter function cleanly bridges Recording → Meeting types.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-02-SUMMARY.md`
</output>
