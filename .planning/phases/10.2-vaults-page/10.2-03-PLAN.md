---
phase: 10.2-vaults-page
plan: 03
type: execute
wave: 2
depends_on: ["10.2-01"]
files_modified:
  - src/components/dialogs/CreateVaultDialog.tsx
  - src/components/dialogs/EditVaultDialog.tsx
  - src/components/dialogs/DeleteVaultDialog.tsx
  - src/components/panes/VaultListPane.tsx
  - src/hooks/useVaultMutations.ts
autonomous: true

must_haves:
  truths:
    - "User can create new vaults from the vault list pane"
    - "User can rename vaults and change settings"
    - "User can delete vaults they own"
    - "Dialog confirmations prevent accidental deletion"
    - "Create vault supports all vault types (team, coach, community, client)"
  artifacts:
    - path: "src/components/dialogs/CreateVaultDialog.tsx"
      provides: "Dialog for creating new vaults"
      exports: ["CreateVaultDialog"]
    - path: "src/components/dialogs/EditVaultDialog.tsx"
      provides: "Dialog for editing vault settings"
      exports: ["EditVaultDialog"]
    - path: "src/components/dialogs/DeleteVaultDialog.tsx"
      provides: "Confirmation dialog for vault deletion"
      exports: ["DeleteVaultDialog"]
    - path: "src/hooks/useVaultMutations.ts"
      provides: "Mutations for vault CRUD operations"
      exports: ["useCreateVault", "useUpdateVault", "useDeleteVault"]
  key_links:
    - from: "CreateVaultDialog"
      to: "useCreateVault mutation"
      via: "mutationFn call"
    - from: "VaultListPane"
      to: "CreateVaultDialog"
      via: "Dialog trigger from Create Vault button"
---

<objective>
Implement vault CRUD operations â€” create, edit, and delete vaults with mutation hooks and dialog components. The Create Vault button in VaultListPane header is wired up.

Purpose: Enable self-service vault management without requiring settings page navigation.
Output: Complete CRUD dialogs with proper permissions, validation, and optimistic updates.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/components/settings/VaultManagement.tsx
@/Users/admin/repos/brain/src/hooks/useVaultAssignment.ts
@/Users/admin/repos/brain/src/types/bank.ts
@/Users/admin/repos/brain/src/components/ui/dialog.tsx
@.planning/phases/10.2-vaults-page/10.2-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useVaultMutations Hook</name>
  <files>src/hooks/useVaultMutations.ts</files>
  <action>
Create mutation hooks for vault CRUD operations. Reference existing VaultManagement.tsx in settings for create vault pattern.

**useCreateVault:**
```tsx
interface CreateVaultInput {
  bankId: string;
  name: string;
  vaultType: VaultType;
  defaultShareLinkTtlDays?: number;
}
```
- Creates vault record in `vaults` table
- Creates vault_membership for creator as vault_owner
- For team vaults: optionally create default folders (Hall of Fame, Manager Reviews)
- Invalidate vault list query on success
- Optimistic update: add vault to list immediately
- Toast: "Vault 'Name' created"

**useUpdateVault:**
```tsx
interface UpdateVaultInput {
  vaultId: string;
  name?: string;
  defaultShareLinkTtlDays?: number;
}
```
- Update vault settings
- Invalidate vault detail query
- Optimistic update
- Toast: "Vault updated"
- Note: vault_type cannot be changed after creation

**useDeleteVault:**
```tsx
interface DeleteVaultInput {
  vaultId: string;
  transferRecordingsToVaultId?: string;
}
```
- Hard delete with confirmation (checked via dialog, not in mutation)
- If transferRecordingsToVaultId provided: move vault_entries to target vault first
- Invalidate all vault queries
- RLS policies enforce that only vault_owner can delete
- Toast: "Vault deleted"

All mutations: Error handling with toast.error(), loading states, RLS enforcement.
  </action>
  <verify>Mutations compile with npm run typecheck. Create/update/delete operations work against Supabase.</verify>
  <done>useVaultMutations hook with create, update, delete operations and optimistic updates</done>
</task>

<task type="auto">
  <name>Task 2: Create CRUD Dialog Components</name>
  <files>src/components/dialogs/CreateVaultDialog.tsx, src/components/dialogs/EditVaultDialog.tsx, src/components/dialogs/DeleteVaultDialog.tsx</files>
  <action>
**CreateVaultDialog:**
- Trigger: "Create Vault" button in VaultListPane header
- Form: Vault Name (3-50 chars), Vault Type select (Team default, Coach/Community/Client disabled with "Coming Soon" badge), Default Share Link Expiration (optional, default 7 days), Bank Selection (if multiple business banks, defaults to active bank)
- Actions: Cancel (hollow) + Create Vault (primary, disabled until valid)
- Success: Close dialog, select new vault, toast

**EditVaultDialog:**
- Trigger: Settings icon in vault detail header, or vault context menu
- Form: Vault Name (current value), Default Share Link Expiration (current), Vault Type (read-only display with note "cannot be changed")
- Permissions: Only vault_owner and vault_admin can edit
- Actions: Cancel + Save Changes (disabled if no changes) + Delete Vault button at bottom (destructive)
- Delete opens DeleteVaultDialog

**DeleteVaultDialog:**
- Trigger: Delete button in EditVaultDialog
- Content: Warning icon, "Delete '[name]'?", recording count if any
- If vault has recordings: option to "Transfer recordings to another vault" (select) or confirm deletion
- Confirmation: Type vault name to confirm
- Actions: Cancel + Delete Vault (destructive, disabled until name typed)
- Success: Close all dialogs, navigate to /vaults, toast

All dialogs use existing dialog.tsx primitive. Follow brand guidelines for button variants.
  </action>
  <verify>All three dialogs render, form validation works, create/edit/delete flow completes</verify>
  <done>CreateVaultDialog, EditVaultDialog, DeleteVaultDialog with full form validation and permission checks</done>
</task>

<task type="auto">
  <name>Task 3: Wire CRUD into VaultListPane and VaultDetailPane</name>
  <files>src/components/panes/VaultListPane.tsx, src/components/panes/VaultDetailPane.tsx</files>
  <action>
**VaultListPane:**
- Wire Create Vault button in header (was stub from Plan 01) to open CreateVaultDialog
- After creation: auto-select new vault and navigate to /vaults/:newVaultId
- Only show create button if user is bank_admin or bank_owner of the active bank

**VaultDetailPane (if it exists from Plan 02, otherwise update in same wave):**
- Add settings icon to header
- Click opens EditVaultDialog
- Context menu on vault name with "Edit Vault" and "Delete Vault" options
- Only show edit/delete if user is vault_admin or vault_owner

**Optimistic Updates:**
- New vault appears in list immediately
- Name changes reflect immediately
- Deleted vault removed from list immediately with navigation to /vaults

**Permissions:**
- Check user role before showing action buttons
- Use useBankContext for bank-level role, useVaultDetail for vault-level role
  </action>
  <verify>Create button opens dialog, new vault auto-selects, edit/delete work from detail pane header</verify>
  <done>CRUD dialogs integrated into vault UI with proper permission checks</done>
</task>

</tasks>

<verification>
- [ ] Create Vault button opens dialog from VaultListPane
- [ ] Can create team vault with name and settings
- [ ] New vault appears in list and auto-selects
- [ ] Edit dialog opens with current values from detail header
- [ ] Can rename vault
- [ ] Delete requires typing vault name to confirm
- [ ] Delete handles recordings (transfer option)
- [ ] Permissions hide/show actions correctly
- [ ] Toast notifications on all operations
</verification>

<success_criteria>
User can create new vaults with custom settings, edit existing vault names and settings, and delete vaults with proper confirmation and recording handling.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-03-SUMMARY.md`
</output>
