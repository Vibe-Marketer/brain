---
phase: 10.2-vaults-page
plan: 03
type: execute
wave: 3
depends_on: ["10.2-02"]
files_modified:
  - src/components/dialogs/CreateVaultDialog.tsx
  - src/components/dialogs/EditVaultDialog.tsx
  - src/components/dialogs/DeleteVaultDialog.tsx
  - src/components/panes/VaultListPane.tsx
  - src/hooks/useVaultMutations.ts
  - src/lib/query-config.ts
autonomous: true

must_haves:
  truths:
    - "User can create new vaults from the vault list pane"
    - "User can rename vaults and change settings"
    - "User can delete vaults they own"
    - "Dialog confirmations prevent accidental deletion"
    - "Create vault supports all vault types (team, coach, community, client)"
  artifacts:
    - path: "src/components/dialogs/CreateVaultDialog.tsx"
      provides: "Dialog for creating new vaults"
      exports: ["CreateVaultDialog"]
    - path: "src/components/dialogs/EditVaultDialog.tsx"
      provides: "Dialog for editing vault settings"
      exports: ["EditVaultDialog"]
    - path: "src/components/dialogs/DeleteVaultDialog.tsx"
      provides: "Confirmation dialog for vault deletion"
      exports: ["DeleteVaultDialog"]
    - path: "src/hooks/useVaultMutations.ts"
      provides: "Mutations for vault CRUD operations"
      exports: ["useCreateVault", "useUpdateVault", "useDeleteVault"]
  key_links:
    - from: "CreateVaultDialog"
      to: "useCreateVault mutation"
      via: "mutationFn call"
    - from: "VaultListPane"
      to: "CreateVaultDialog"
      via: "Dialog trigger"
---

<objective>
Implement vault CRUD operations - create, edit, and delete vaults. This gives users full control over their collaboration spaces within business banks.

Purpose: Enable self-service vault management without requiring admin intervention.
Output: Complete CRUD dialogs with proper permissions, validation, and optimistic updates.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/components/settings/VaultManagement.tsx
@/Users/admin/repos/brain/src/hooks/useVaultAssignment.ts
@/Users/admin/repos/brain/src/types/bank.ts
@/Users/admin/repos/brain/src/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Create useVaultMutations Hook</name>
  <files>src/hooks/useVaultMutations.ts</files>
  <action>
Create mutation hooks for vault CRUD operations:

**useCreateVault:**
```tsx
interface CreateVaultInput {
  bankId: string;
  name: string;
  vaultType: VaultType;
  defaultShareLinkTtlDays?: number;
}
```
- Creates vault record
- Creates vault_membership for creator as vault_owner
- For team vaults: create default folders (Hall of Fame, Manager Reviews)
- Invalidate vault list query on success
- Optimistic update: add vault to list immediately

**useUpdateVault:**
```tsx
interface UpdateVaultInput {
  vaultId: string;
  name?: string;
  defaultShareLinkTtlDays?: number;
  // Note: vault_type cannot be changed after creation
}
```
- Update vault settings
- Invalidate vault detail query
- Optimistic update

**useDeleteVault:**
```tsx
interface DeleteVaultInput {
  vaultId: string;
  transferRecordingsToVaultId?: string; // Optional: move recordings before delete
}
```
- Check: only vault_owner can delete
- Check: vault must be empty OR recordings transferred
- Soft delete? No - hard delete with confirmation
- Invalidate all vault queries

**All mutations:**
- Error handling with toast notifications
- Loading states
- RLS policies will enforce permissions
  </action>
  <verify>Mutations work via React Query DevTools or test component</verify>
  <done>useVaultMutations hook with create, update, delete operations</done>
</task>

<task type="auto">
  <name>Create CreateVaultDialog Component</name>
  <files>src/components/dialogs/CreateVaultDialog.tsx</files>
  <action>
Create dialog for creating new vaults:

**Trigger:**
- "Create Vault" button in VaultListPane header
- Plus icon button (mobile)

**Form Fields:**
1. **Vault Name** (required)
   - Text input
   - Validation: 3-50 characters
   - Error: "Vault name must be between 3 and 50 characters"

2. **Vault Type** (required)
   - Select dropdown
   - Options: Team, Coach, Community, Client
   - Default: Team
   - Descriptions below select:
     - Team: "Internal team collaboration space"
     - Coach: "For coaching relationships (coming soon)"
     - Community: "Open sharing space (coming soon)"
     - Client: "Client-specific vault (coming soon)"
   - Disable Coach/Community/Client with "Coming Soon" badge

3. **Default Share Link Expiration** (optional)
   - Number input (days)
   - Default: 7 days
   - Help text: "Share links will expire after this many days"

4. **Bank Selection** (if user has multiple business banks)
   - Select which bank to create vault in
   - Default to current active bank
   - Hide if only one bank

**Actions:**
- Cancel (hollow button)
- Create Vault (primary button, disabled until valid)

**Success:**
- Close dialog
- Select new vault
- Toast: "Vault 'Name' created"
  </action>
  <verify>Dialog opens, form validates, creates vault successfully</verify>
  <done>CreateVaultDialog with full form and validation</done>
</task>

<task type="auto">
  <name>Create EditVaultDialog Component</name>
  <files>src/components/dialogs/EditVaultDialog.tsx</files>
  <action>
Create dialog for editing vault settings:

**Trigger:**
- Settings icon in vault detail header
- "Edit Vault" option in vault context menu

**Form Fields:**
1. **Vault Name** (required)
   - Text input with current name
   - Same validation as create

2. **Default Share Link Expiration**
   - Number input (days)
   - Current value pre-filled
   - Help text about existing links not being affected

3. **Vault Type** (read-only display)
   - Show current type
   - Note: "Vault type cannot be changed"

**Permissions Check:**
- Only vault_owner and vault_admin can edit
- If user lacks permission, show "You don't have permission" message

**Actions:**
- Cancel
- Save Changes (disabled if no changes)
- Delete Vault (destructive button at bottom)

**Delete Flow:**
- Clicking Delete opens DeleteVaultDialog instead of immediate action
  </action>
  <verify>Edit form loads current values, saves changes, respects permissions</verify>
  <done>EditVaultDialog with settings form</done>
</task>

<task type="auto">
  <name>Create DeleteVaultDialog Component</name>
  <files>src/components/dialogs/DeleteVaultDialog.tsx</files>
  <action>
Create confirmation dialog for vault deletion:

**Trigger:**
- Delete button in EditVaultDialog
- "Delete Vault" option in vault context menu (if owner)

**Content:**
- Warning icon (destructive color)
- Title: "Delete Vault?"
- Message: "This will permanently delete '[vault name]' and all its data."

**Recording Handling:**
- If vault has recordings:
  - Show recording count
  - "This vault contains X recordings"
  - Option: "Transfer recordings to another vault" (select dropdown)
  - Option: "Delete all recordings" (checkbox with confirmation)
- If vault is empty:
  - "This vault is empty"

**Confirmation:**
- Type vault name to confirm: "Type '[vault name]' to confirm"
- Input must match exactly
- Delete button disabled until confirmed

**Actions:**
- Cancel (hollow)
- Delete Vault (destructive, disabled until confirmed)

**Success:**
- Close all dialogs
- Navigate to /vaults (clear selection)
- Toast: "Vault deleted"
  </action>
  <verify>Delete requires confirmation, handles recordings, shows toast</verify>
  <done>DeleteVaultDialog with confirmation and recording handling</done>
</task>

<task type="auto">
  <name>Integrate CRUD into VaultListPane and VaultDetailPane</name>
  <files>src/components/panes/VaultListPane.tsx, src/components/panes/VaultDetailPane.tsx</files>
  <action>
Wire up CRUD dialogs to the UI:

**VaultListPane:**
- Add Create Vault button to header
- Open CreateVaultDialog on click
- After creation, auto-select new vault

**VaultDetailPane:**
- Add settings icon to header
- Click opens EditVaultDialog
- Add context menu to vault name (right-click or overflow menu)
  - Edit Vault
  - Delete Vault

**Permissions:**
- Only show create button if user is bank_admin or bank_owner
- Only show edit/delete if user is vault_admin or vault_owner
- Check permissions before opening dialogs

**Optimistic Updates:**
- New vault appears in list immediately
- Name changes reflect immediately
- Deleted vault removed from list immediately
  </action>
  <verify>All CRUD operations work from UI, permissions respected</verify>
  <done>CRUD dialogs integrated into vault UI</done>
</task>

</tasks>

<verification>
- [ ] Create Vault button opens dialog
- [ ] Can create team vault with name and settings
- [ ] New vault appears in list and auto-selects
- [ ] Edit dialog opens with current values
- [ ] Can rename vault
- [ ] Delete requires typing vault name
- [ ] Delete handles recordings (transfer or delete)
- [ ] Permissions hide/show actions correctly
- [ ] Toast notifications on all operations
</verification>

<success_criteria>
User can create new vaults with custom settings, edit existing vault names and settings, and delete vaults with proper confirmation and recording handling.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-03-SUMMARY.md`
</output>
