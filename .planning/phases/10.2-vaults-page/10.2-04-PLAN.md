---
phase: 10.2-vaults-page
plan: 04
type: execute
wave: 4
depends_on: ["10.2-03"]
files_modified:
  - src/components/dialogs/InviteMemberDialog.tsx
  - src/components/dialogs/ChangeRoleDialog.tsx
  - src/components/panels/VaultMemberPanel.tsx
  - src/hooks/useVaultMemberMutations.ts
  - src/lib/query-config.ts
autonomous: true

must_haves:
  truths:
    - "Vault owners/admins can invite new members by email"
    - "Invited users receive email with join link"
    - "Member roles can be changed (member → manager → admin)"
    - "Members can be removed from vault"
    - "User sees their own role and permissions"
  artifacts:
    - path: "src/components/dialogs/InviteMemberDialog.tsx"
      provides: "Dialog for inviting members to vault"
      exports: ["InviteMemberDialog"]
    - path: "src/components/dialogs/ChangeRoleDialog.tsx"
      provides: "Dialog for changing member roles"
      exports: ["ChangeRoleDialog"]
    - path: "src/hooks/useVaultMemberMutations.ts"
      provides: "Mutations for member management"
      exports: ["useInviteMember", "useChangeRole", "useRemoveMember"]
  key_links:
    - from: "InviteMemberDialog"
      to: "useInviteMember mutation"
      via: "mutationFn"
    - from: "VaultMemberPanel"
      to: "ChangeRoleDialog"
      via: "role change action"
---

<objective>
Implement comprehensive member management for vaults - inviting users, changing roles, and removing members. This enables team collaboration workflows.

Purpose: Complete the collaboration experience by allowing vault owners to manage their teams.
Output: Full member management UI with invitations, role changes, and removal capabilities.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/components/sharing/TeamInviteDialog.tsx
@/Users/admin/repos/brain/src/types/bank.ts
@/Users/admin/repos/brain/src/components/panels/VaultMemberPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Create useVaultMemberMutations Hook</name>
  <files>src/hooks/useVaultMemberMutations.ts</files>
  <action>
Create mutation hooks for member management:

**useInviteMember:**
```tsx
interface InviteMemberInput {
  vaultId: string;
  email: string;
  role: VaultRole; // 'member' | 'manager' | 'vault_admin'
  message?: string; // Optional personal message
}
```
- Check: inviter must be vault_owner or vault_admin
- Check: target role cannot exceed inviter's role (admin can't invite owner)
- Flow:
  1. Look up user by email (may not exist yet)
  2. Create invitation record in vault_invitations table
  3. Trigger edge function to send email
  4. If user exists, also create vault_membership with 'invited' status
- Return: invitation token for URL generation
- Optimistic: add to member list as "pending"

**useChangeRole:**
```tsx
interface ChangeRoleInput {
  vaultId: string;
  userId: string;
  newRole: VaultRole;
}
```
- Check: changer must be vault_owner or vault_admin
- Check: cannot change role of vault_owner (only owner can transfer ownership)
- Check: new role cannot exceed changer's role
- Update vault_memberships table
- Invalidate member list

**useRemoveMember:**
```tsx
interface RemoveMemberInput {
  vaultId: string;
  userId: string;
}
```
- Check: remover must be vault_owner or vault_admin
- Check: cannot remove vault_owner
- Check: members can remove themselves
- Delete from vault_memberships
- Remove their recordings from vault? No - recordings stay
- Invalidate member list

**useTransferOwnership:** (separate, more complex)
- Only vault_owner can transfer
- Must specify new owner
- Updates both memberships atomically

**Edge Cases:**
- Inviting existing member → error "User is already a member"
- Re-inviting pending user → resend email, reset expiration
- Removing self → allowed, navigate away from vault
  </action>
  <verify>Mutations execute correctly, RLS policies enforce permissions</verify>
  <done>Member mutation hooks with full permission checks</done>
</task>

<task type="auto">
  <name>Create InviteMemberDialog Component</name>
  <files>src/components/dialogs/InviteMemberDialog.tsx</files>
  <action>
Create dialog for inviting members to vault:

**Trigger:**
- "Invite Members" button in VaultMemberPanel
- "+" button next to Members tab header

**Form Fields:**
1. **Email Address** (required)
   - Email input with validation
   - Support multiple emails (comma-separated)? MVP: single only
   - Check if user exists: show "User found" or "Will send invite email"

2. **Role** (required)
   - Select dropdown
   - Options depend on current user's role:
     - If owner: Member, Manager, Admin
     - If admin: Member, Manager
   - Default: Member
   - Role descriptions:
     - Member: "Can view and add recordings"
     - Manager: "Can also edit any recording"
     - Admin: "Can manage members and settings"

3. **Personal Message** (optional)
   - Textarea
   - Included in invite email
   - Max 500 characters

**Validation:**
- Valid email format
- User not already member
- Role allowed for inviter

**Actions:**
- Cancel
- Send Invite (primary, disabled if invalid)

**Success:**
- Close dialog
- Show member as "pending" in list
- Toast: "Invitation sent to [email]"
- Copy invite link option: "Copy invite link to share"
  </action>
  <verify>Can invite by email, validation works, success feedback shown</verify>
  <done>InviteMemberDialog with email, role selection, and messaging</done>
</task>

<task type="auto">
  <name>Create ChangeRoleDialog Component</name>
  <files>src/components/dialogs/ChangeRoleDialog.tsx</files>
  <action>
Create dialog for changing member roles:

**Trigger:**
- "Change Role" option in member actions menu

**Content:**
- Title: "Change Role for [User Name]"
- Current role displayed
- New role selector:
  - Radio buttons or select
  - Options limited by current user's max role
  - Cannot select role higher than self

**Role Info:**
- Show description of selected role
- Warn if upgrading to admin: "Admins can manage all vault settings and members"

**Special Case - Transfer Ownership:**
- If changing from owner to another role:
  - "You are transferring vault ownership"
  - Must select new owner from other admins
  - Additional confirmation required

**Actions:**
- Cancel
- Save Changes

**Validation:**
- New role must be different from current
- User must have permission to assign new role
- Cannot demote last admin (must have at least one)
  </action>
  <verify>Role changes save correctly, transfer ownership works</verify>
  <done>ChangeRoleDialog with role selection and validation</done>
</task>

<task type="auto">
  <name>Enhance VaultMemberPanel with Management Actions</name>
  <files>src/components/panels/VaultMemberPanel.tsx</files>
  <action>
Update VaultMemberPanel with full management capabilities:

**Member List Items:**
- Each member row has actions menu (if user has permission):
  - Change Role (if user can assign that role)
  - Remove from Vault (if not owner)
  - View Profile (opens user detail panel)

**Role Badges:**
- Color coding per brand guidelines:
  - vault_owner: Vibe orange background
  - vault_admin: Blue background
  - manager: Green background
  - member: Gray/neutral background

**Pending Invitations Section:**
- Separate list for pending invites
- Shows: email, invited date, role, resend/cancel actions
- Resend button: re-triggers invitation email
- Cancel button: removes invitation

**Current User Indicator:**
- "You" badge on current user's row
- Cannot remove yourself without confirmation

**Empty States:**
- No members: "No members yet. Invite your team to collaborate."
- No pending: Hide pending section entirely

**Search/Filter:**
- Search members by name or email
- Filter by role
- Sort by: Joined date (newest first), Name (A-Z), Role (hierarchy)
  </action>
  <verify>All member actions work, permissions respected, UI updates correctly</verify>
  <done>VaultMemberPanel with complete member management</done>
</task>

<task type="auto">
  <name>Create Database Migration for Invitations</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_vault_invitations.sql</files>
  <action>
Create database table for vault invitations:

```sql
-- Vault Invitations Table
CREATE TABLE vault_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vault_id UUID NOT NULL REFERENCES vaults(id) ON DELETE CASCADE,
  invited_by_user_id UUID NOT NULL REFERENCES auth.users(id),
  email TEXT NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('member', 'manager', 'vault_admin')),
  token TEXT NOT NULL UNIQUE, -- For join URL
  message TEXT,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'expired', 'cancelled')),
  expires_at TIMESTAMPTZ NOT NULL DEFAULT NOW() + INTERVAL '7 days',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  accepted_at TIMESTAMPTZ,
  accepted_by_user_id UUID REFERENCES auth.users(id)
);

-- Indexes
CREATE INDEX idx_vault_invitations_vault_id ON vault_invitations(vault_id);
CREATE INDEX idx_vault_invitations_email ON vault_invitations(email);
CREATE INDEX idx_vault_invitations_token ON vault_invitations(token);
CREATE INDEX idx_vault_invitations_status ON vault_invitations(status);

-- Enable RLS
ALTER TABLE vault_invitations ENABLE ROW LEVEL SECURITY;

-- RLS Policies
-- Vault members can view invitations
CREATE POLICY "Vault members can view invitations"
  ON vault_invitations FOR SELECT
  USING (is_vault_member(vault_id, auth.uid()));

-- Vault admins can create invitations
CREATE POLICY "Vault admins can create invitations"
  ON vault_invitations FOR INSERT
  WITH CHECK (is_vault_admin_or_owner(vault_id, auth.uid()));

-- Inviter or admin can cancel
CREATE POLICY "Inviter or admin can cancel invitations"
  ON vault_invitations FOR UPDATE
  USING (
    invited_by_user_id = auth.uid() 
    OR is_vault_admin_or_owner(vault_id, auth.uid())
  );
```

Also create edge function for sending invite emails (or use Supabase Auth email templates).
  </action>
  <verify>Migration runs successfully, RLS policies tested</verify>
  <done>Vault invitations table with RLS policies</done>
</task>

</tasks>

<verification>
- [ ] Can invite member by email
- [ ] Pending invitation appears in list
- [ ] Can change member role
- [ ] Can remove member from vault
- [ ] Permissions prevent unauthorized actions
- [ ] Role badges show correctly
- [ ] Current user highlighted
- [ ] Empty states display appropriately
</verification>

<success_criteria>
Vault owners and admins can invite members by email, change member roles with proper hierarchy enforcement, and remove members. Members see their role and can view other vault members.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-04-SUMMARY.md`
</output>
