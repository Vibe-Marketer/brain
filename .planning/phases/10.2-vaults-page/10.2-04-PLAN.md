---
phase: 10.2-vaults-page
plan: 04
type: execute
wave: 3
depends_on: ["10.2-02", "10.2-03"]
files_modified:
  - supabase/migrations/YYYYMMDDHHMMSS_vault_invite_columns.sql
  - src/pages/VaultJoin.tsx
  - src/App.tsx
  - src/components/dialogs/VaultInviteDialog.tsx
  - src/components/dialogs/ChangeRoleDialog.tsx
  - src/components/panels/VaultMemberPanel.tsx
  - src/hooks/useVaultMemberMutations.ts
autonomous: true

must_haves:
  truths:
    - "Vault owners/admins can generate shareable invite link (NOT email-based)"
    - "Invite link follows /join/vault/:token pattern (like /join/team/:token)"
    - "Default join role via link is always 'member'"
    - "Member roles can be changed (member → manager → admin) by owners/admins"
    - "Members can be removed from vault; members can leave vault"
    - "NO vault_invitations table — invite_token lives on vaults table"
  artifacts:
    - path: "src/pages/VaultJoin.tsx"
      provides: "Join vault page at /join/vault/:token"
      exports: ["default"]
    - path: "src/components/dialogs/VaultInviteDialog.tsx"
      provides: "Dialog for generating/copying invite link"
      exports: ["VaultInviteDialog"]
    - path: "src/components/dialogs/ChangeRoleDialog.tsx"
      provides: "Dialog for changing member roles"
      exports: ["ChangeRoleDialog"]
    - path: "src/hooks/useVaultMemberMutations.ts"
      provides: "Mutations for member management"
      exports: ["useGenerateVaultInvite", "useChangeRole", "useRemoveMember", "useLeaveVault"]
  key_links:
    - from: "VaultInviteDialog"
      to: "useGenerateVaultInvite mutation"
      via: "generates token, copies link to clipboard"
    - from: "/join/vault/:token"
      to: "vaults.invite_token"
      via: "Supabase lookup by token"
    - from: "VaultMemberPanel"
      to: "ChangeRoleDialog"
      via: "role change action in member row menu"
---

<objective>
Implement member management for vaults using shareable invite links (following the TeamJoin pattern from Phase 4). NO vault_invitations table, NO email sending — invite_token and invite_expires_at columns are added directly to the vaults table. Default join role is always 'member'. Full 5-level role hierarchy exposed in UI.

Purpose: Complete the collaboration experience by allowing vault owners to share access and manage their teams.
Output: Invite link generation, VaultJoin page, role management, member removal and self-leave.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/pages/TeamJoin.tsx
@/Users/admin/repos/brain/src/components/sharing/TeamInviteDialog.tsx
@/Users/admin/repos/brain/src/hooks/useTeamHierarchy.ts
@/Users/admin/repos/brain/src/types/bank.ts
@/Users/admin/repos/brain/supabase/migrations/20260129000005_add_team_invite_columns.sql
@/Users/admin/repos/brain/supabase/migrations/20260131000006_create_vaults_tables.sql
@.planning/phases/10.2-vaults-page/10.2-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database Migration + useVaultMemberMutations Hook</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_vault_invite_columns.sql, src/hooks/useVaultMemberMutations.ts</files>
  <action>
**Database Migration — add invite columns to vaults table (NOT a new table):**
Follow exact pattern from `20260129000005_add_team_invite_columns.sql`:
```sql
-- Add invite_token and invite_expires_at to vaults table
ALTER TABLE vaults
ADD COLUMN IF NOT EXISTS invite_token VARCHAR(32),
ADD COLUMN IF NOT EXISTS invite_expires_at TIMESTAMPTZ;

CREATE INDEX IF NOT EXISTS idx_vaults_invite_token
ON vaults(invite_token) WHERE invite_token IS NOT NULL;
```

**useVaultMemberMutations.ts:**

`useGenerateVaultInvite(vaultId: string)`:
- Follow useTeamHierarchy.generateTeamInvite pattern exactly
- Check if existing invite_token is still valid (not expired)
- If valid: return existing URL
- If expired/missing: generate new 32-char token, set 7-day expiry, update vaults table
- Return: `{ invite_token: string, invite_url: string }` where URL = `${origin}/join/vault/${token}`
- Permission check: only vault_owner or vault_admin

`useChangeRole(vaultId, userId, newRole)`:
- Permission: changer must be vault_owner or vault_admin
- Cannot change vault_owner role (only owner can transfer ownership)
- New role cannot exceed changer's role (admin can't make someone owner)
- Update vault_memberships table
- Invalidate member list query
- Toast: "Role changed to {newRole}"

`useRemoveMember(vaultId, userId)`:
- Permission: remover must be vault_owner or vault_admin
- Cannot remove vault_owner
- Delete from vault_memberships
- Recordings stay in vault (NOT removed)
- Invalidate member list query
- Toast: "Member removed"

`useLeaveVault(vaultId)`:
- Current user removes themselves
- Cannot leave if you're vault_owner (must transfer first)
- Navigate to /vaults after leaving
- Toast: "You left the vault"
  </action>
  <verify>Migration runs. Mutations compile. Generate invite returns valid token URL.</verify>
  <done>Vault invite columns added to vaults table. Member mutation hooks with generate invite, change role, remove, and leave.</done>
</task>

<task type="auto">
  <name>Task 2: Create VaultJoin Page + VaultInviteDialog</name>
  <files>src/pages/VaultJoin.tsx, src/App.tsx, src/components/dialogs/VaultInviteDialog.tsx</files>
  <action>
**VaultJoin.tsx — follow TeamJoin.tsx pattern exactly:**
- Route: /join/vault/:token
- On load: look up vault by invite_token from URL param
- Check token validity:
  - Token exists? → show vault info + join button
  - Token expired? → show "This invite link has expired"
  - Already a member? → show "You're already a member" + link to vault
- On join: Create vault_membership with role='member' (LOCKED: default join role is always member)
- After join: Navigate to /vaults/:vaultId
- Toast: "Joined vault '{name}'"

Read TeamJoin.tsx closely and replicate the same UX pattern: show vault name, member count, join button with loading state, error states.

**App.tsx:**
- Add Route: `<Route path="/join/vault/:token" element={<VaultJoin />} />`
- Place near the existing /join/team/:token route

**VaultInviteDialog:**
- Follow TeamInviteDialog pattern
- Trigger: "Invite Members" button in VaultMemberPanel
- Content:
  - Generate invite link (or show existing valid link)
  - Copy to clipboard button with "Copied!" feedback
  - Show expiry date ("Expires in 7 days")
  - "Regenerate Link" button if they want a fresh one
  - Note: "Anyone with this link can join as a member. You can change their role after they join."
- Permission: Only vault_owner or vault_admin can generate/see invite link
  </action>
  <verify>Navigate to /join/vault/test-token — page renders. VaultInviteDialog generates and copies link.</verify>
  <done>VaultJoin page at /join/vault/:token following TeamJoin pattern. VaultInviteDialog generates shareable links.</done>
</task>

<task type="auto">
  <name>Task 3: Wire Member Management into VaultMemberPanel</name>
  <files>src/components/panels/VaultMemberPanel.tsx, src/components/dialogs/ChangeRoleDialog.tsx</files>
  <action>
**ChangeRoleDialog:**
- Trigger: "Change Role" in member actions menu
- Title: "Change Role for [User Name]"
- Current role displayed
- New role selector: radio buttons for available roles
  - Show all 5 levels: vault_owner, vault_admin, manager, member, guest
  - Disable roles higher than current user's role
  - Cannot demote last admin/owner
- Actions: Cancel + Save Changes
- Calls useChangeRole mutation

**VaultMemberPanel updates (enhance from Plan 02 stub):**
Each member row gets actions menu (3-dot overflow) if user has permission:
- "Change Role" → opens ChangeRoleDialog
- "Remove from Vault" → confirmation, then useRemoveMember
- "View Profile" → placeholder for now

Current user indicator:
- "You" badge on current user's row
- Show "Leave Vault" instead of "Remove" for own row
- Leave vault: confirmation → useLeaveVault → navigate to /vaults

Role Badges (color-coded per brand):
- vault_owner: vibe orange background
- vault_admin: blue background
- manager: green background
- member: gray/neutral background
- guest: lighter gray

Invite Section (replace stub):
- "Invite Members" button opens VaultInviteDialog
- Only visible to vault_owner/vault_admin

Search/filter members by name (if >10 members).
  </action>
  <verify>Can generate invite link, change roles, remove members, leave vault. All actions show correct toasts.</verify>
  <done>Full member management in VaultMemberPanel: invite links, role changes, removal, self-leave. 5-level hierarchy exposed.</done>
</task>

</tasks>

<verification>
- [ ] Invite link generated at /join/vault/:token format
- [ ] Joining via link creates membership with role='member'
- [ ] Can change member role (full 5-level hierarchy)
- [ ] Can remove member from vault
- [ ] Can leave vault (self-removal)
- [ ] Vault owner cannot be removed
- [ ] Cannot leave if only owner (must transfer)
- [ ] Permission checks on all actions
- [ ] NO vault_invitations table created
- [ ] invite_token and invite_expires_at columns on vaults table
</verification>

<success_criteria>
Vault owners/admins can generate shareable invite links. Anyone with the link can join as a member. Owners/admins can change roles across the full 5-level hierarchy and remove members. Members can leave vaults.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-04-SUMMARY.md`
</output>
