---
phase: 10.2-vaults-page
plan: 05
type: execute
wave: 5
depends_on: ["10.2-04"]
files_modified:
  - src/components/dialogs/CreateBusinessBankDialog.tsx
  - src/components/panes/VaultListPane.tsx
  - src/hooks/useBankMutations.ts
  - src/components/header/BankSwitcher.tsx
autonomous: true

must_haves:
  truths:
    - "User can create business banks from the Vaults page"
    - "Business bank requires name and optional logo"
    - "Creator becomes bank_owner automatically"
    - "New bank appears in bank switcher immediately"
    - "No billing gate for MVP (free for all users)"
  artifacts:
    - path: "src/components/dialogs/CreateBusinessBankDialog.tsx"
      provides: "Dialog for creating business banks"
      exports: ["CreateBusinessBankDialog"]
    - path: "src/hooks/useBankMutations.ts"
      provides: "Mutations for bank operations"
      exports: ["useCreateBusinessBank"]
  key_links:
    - from: "VaultListPane"
      to: "CreateBusinessBankDialog"
      via: "Create Business Bank button"
    - from: "useCreateBusinessBank"
      to: "useBankContext"
      via: "Invalidates bank list query"
---

<objective>
Implement business bank creation flow. This allows users to create organization-level banks for team collaboration, expanding beyond their personal bank.

Purpose: Enable multi-tenant collaboration by allowing users to create and manage business banks.
Output: Complete business bank creation with immediate availability in bank switcher.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/components/header/BankSwitcher.tsx
@/Users/admin/repos/brain/src/hooks/useBankContext.ts
@/Users/admin/repos/brain/src/types/bank.ts
@/Users/admin/repos/brain/supabase/migrations/20260131000005_create_banks_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Create useBankMutations Hook</name>
  <files>src/hooks/useBankMutations.ts</files>
  <action>
Create mutation hooks for bank operations:

**useCreateBusinessBank:**
```tsx
interface CreateBusinessBankInput {
  name: string;
  crossBankDefault?: 'copy_only' | 'copy_and_remove';
  logoUrl?: string;
}
```
- Creates bank record with type='business'
- Creates bank_membership for creator as 'bank_owner'
- Creates default personal vault in the bank
- Creates vault_membership for creator as 'vault_owner'
- Edge function: notify about new bank (analytics/logging)
- Invalidate bank context queries
- Optimistic update: add to bank list
- Return: new bank object

**useUpdateBank:** (for future use)
- Update bank name, logo, cross-bank default
- Only bank_owner and bank_admin

**useDeleteBank:** (for future use)
- Delete business bank and all associated data
- Cascade: vaults, memberships, recordings stay in personal
- Only bank_owner with confirmation

**useLeaveBank:**
- Remove self from business bank
- Cannot leave if you're the only owner (transfer first)
- What happens to recordings? They stay in bank

**Cross-Bank Default:**
- 'copy_only': When moving recordings between banks, copy and keep original
- 'copy_and_remove': When moving recordings between banks, copy and delete from source
- Set at bank creation, can be changed later
  </action>
  <verify>Can create bank, appears in context, RLS policies work</verify>
  <done>useBankMutations hook with create business bank</done>
</task>

<task type="auto">
  <name>Create CreateBusinessBankDialog Component</name>
  <files>src/components/dialogs/CreateBusinessBankDialog.tsx</files>
  <action>
Create dialog for creating business banks:

**Trigger:**
- "Create Business Bank" button at bottom of VaultListPane
- Bank switcher dropdown ("+ New Business Bank")

**Form Fields:**

1. **Organization Name** (required)
   - Text input
   - Validation: 3-50 characters
   - Placeholder: "Acme Inc."
   - Help: "This will be visible to all team members"

2. **Logo** (optional)
   - Image upload
   - Accept: PNG, JPG, SVG
   - Max size: 2MB
   - Preview uploaded image
   - Use existing ImageUpload component pattern

3. **Cross-Bank Recording Default** (advanced, collapsed by default)
   - Select: "Copy only" vs "Copy and remove from source"
   - Default: "Copy only"
   - Help text explaining the difference
   - This affects how recordings behave when moved between banks

**Validation:**
- Name unique per user? No - multiple banks can have same name
- Name required
- Logo size/type validation

**Actions:**
- Cancel
- Create Business Bank (primary, disabled until valid)

**Success Flow:**
1. Create bank
2. Create default vault
3. Close dialog
4. Switch to new bank
5. Select default vault
6. Toast: "Business bank '[name]' created"

**Post-Creation:**
- User sees new bank in VaultListPane
- Bank switcher shows new bank
- Ready to invite members and create vaults
  </action>
  <verify>Dialog validates, creates bank, switches to it, shows in UI</verify>
  <done>CreateBusinessBankDialog with form and validation</done>
</task>

<task type="auto">
  <name>Integrate Business Bank Creation into UI</name>
  <files>src/components/panes/VaultListPane.tsx, src/components/header/BankSwitcher.tsx</files>
  <action>
Add business bank creation entry points:

**VaultListPane:**
- Add section at bottom: "Business Banks"
- If no business banks: show "Create your first business bank to collaborate with your team"
- Create Business Bank button (hollow style, plus icon)
- Button opens CreateBusinessBankDialog

**BankSwitcher (Header):**
- Add "Create Business Bank" option in dropdown
- Shows at bottom of bank list with separator
- Plus icon (RiAddLine)
- Click opens dialog

**Success Handling:**
- After creation, dialog closes
- useBankContext automatically refreshes
- New bank appears in list
- User stays in new bank context

**Edge Cases:**
- Multiple banks: scrollable list
- Long names: truncate with ellipsis
- Error: show error message in dialog
  </action>
  <verify>Button appears in both locations, creates bank successfully</verify>
  <done>Business bank creation integrated into vault UI and header</done>
</task>

<task type="auto">
  <name>Create Bank Settings Panel (Basic)</name>
  <files>src/components/panels/BankSettingsPanel.tsx</files>
  <action>
Create basic bank settings panel:

**Trigger:**
- "Bank Settings" option in bank switcher dropdown
- Settings gear icon in VaultListPane header (next to bank name)

**Content:**

1. **General Section:**
   - Bank name (editable if admin/owner)
   - Logo (upload/change)
   - Bank type (read-only: Business)
   - Created date (read-only)

2. **Cross-Bank Settings:**
   - Default recording transfer behavior
   - Select: copy_only / copy_and_remove
   - Help: "When moving recordings between banks..."

3. **Members Section (Preview):**
   - Show count of bank members
   - "Manage Members" link (future feature)
   - Note: "Bank members have access to all vaults"

4. **Danger Zone:**
   - Leave Bank (if not owner)
   - Transfer Ownership (if owner)
   - Delete Bank (if owner, with confirmation)

**Permissions:**
- Read: any bank member
- Edit: bank_admin, bank_owner
- Delete: bank_owner only

**Props:**
```tsx
interface BankSettingsPanelProps {
  bankId: string;
}
```

**Integration:**
- Open via panelStore: openPanel('bank-settings', { bankId })
- Add to DetailPaneOutlet render switch
  </action>
  <verify>Panel opens, shows settings, permissions work</verify>
  <done>BankSettingsPanel with general settings and danger zone</done>
</task>

<task type="auto">
  <name>Update BankSwitcher with Creation Flow</name>
  <files>src/components/header/BankSwitcher.tsx</files>
  <action>
Enhance BankSwitcher to support business bank creation:

**Dropdown Changes:**
1. **Personal Bank Section:**
   - Show personal bank first
   - Clear label: "Personal"

2. **Business Banks Section:**
   - Separator + "Business Banks" label
   - List of business banks with member count
   - Current bank highlighted

3. **Actions Section:**
   - Separator
   - "Create Business Bank" button with plus icon
   - "Bank Settings" (opens settings for current bank)

**Empty State:**
- If no business banks yet:
  - "No business banks"
  - "Create one to collaborate with your team"

**Active State:**
- Show active bank name in header button
- Bank icon (RiBuilding4Line for business, RiUserLine for personal)

**Quick Actions:**
- Keyboard shortcut? (Cmd/Ctrl+Shift+B to open switcher)
  </action>
  <verify>Switcher shows banks, creation works, navigation smooth</verify>
  <done>BankSwitcher enhanced with business bank creation</done>
</task>

</tasks>

<verification>
- [ ] Create Business Bank button in VaultListPane
- [ ] Create Business Bank option in BankSwitcher
- [ ] Dialog validates name
- [ ] Logo upload works
- [ ] Bank created and appears in list
- [ ] Auto-switches to new bank
- [ ] Default vault created
- [ ] Can create multiple business banks
</verification>

<success_criteria>
User can create business banks with names and logos, new banks appear immediately in the UI with default vaults, and the bank switcher provides quick access to all banks.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-05-SUMMARY.md`
</output>
