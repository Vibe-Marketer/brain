---
phase: 10.2-vaults-page
plan: 05
type: execute
wave: 4
depends_on: ["10.2-01", "10.2-03"]
files_modified:
  - src/components/dialogs/CreateBusinessBankDialog.tsx
  - src/components/panes/VaultListPane.tsx
  - src/components/header/BankSwitcher.tsx
  - src/hooks/useBankMutations.ts
autonomous: true

must_haves:
  truths:
    - "User can create business banks from the Vaults page CTA"
    - "User can create business banks from the header BankSwitcher dropdown"
    - "Business bank collects name + logo + settings (cross-bank behavior, default vault)"
    - "Creator becomes bank_owner automatically"
    - "After creation: auto-switch to new bank + prompt to create first vault"
    - "No billing gate for MVP"
    - "Bank settings (rename, logo, delete) lives in Settings page ONLY — NOT on Vaults page"
  artifacts:
    - path: "src/components/dialogs/CreateBusinessBankDialog.tsx"
      provides: "Dialog for creating business banks with full configuration"
      exports: ["CreateBusinessBankDialog"]
    - path: "src/hooks/useBankMutations.ts"
      provides: "Mutations for bank operations"
      exports: ["useCreateBusinessBank"]
  key_links:
    - from: "VaultListPane"
      to: "CreateBusinessBankDialog"
      via: "Create Business Bank CTA button"
    - from: "BankSwitcher"
      to: "CreateBusinessBankDialog"
      via: "'+ New Business Bank' option in dropdown"
    - from: "useCreateBusinessBank"
      to: "useBankContext"
      via: "Invalidates bank list query, auto-switches active bank"
---

<objective>
Implement business bank creation flow with entry points from both the Vaults page CTA and the header BankSwitcher dropdown. Full configuration upfront: name, logo, cross-bank recording behavior, default vault. After creation, auto-switch to new bank and immediately prompt to create first vault. Bank settings (rename, logo, danger zone/delete) lives in Settings page ONLY — NOT on the Vaults page.

Purpose: Enable multi-tenant collaboration by allowing users to create organization-level banks.
Output: Complete business bank creation with immediate availability, auto-switch, and vault creation prompt.
</objective>

<execution_context>
@/Users/admin/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@/Users/admin/repos/brain/src/CLAUDE.md
@/Users/admin/repos/brain/src/components/header/BankSwitcher.tsx
@/Users/admin/repos/brain/src/hooks/useBankContext.ts
@/Users/admin/repos/brain/src/types/bank.ts
@/Users/admin/repos/brain/supabase/migrations/20260131000005_create_banks_tables.sql
@.planning/phases/10.2-vaults-page/10.2-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useBankMutations Hook + CreateBusinessBankDialog</name>
  <files>src/hooks/useBankMutations.ts, src/components/dialogs/CreateBusinessBankDialog.tsx</files>
  <action>
**useBankMutations.ts:**

`useCreateBusinessBank`:
```tsx
interface CreateBusinessBankInput {
  name: string;
  crossBankDefault?: 'copy_only' | 'copy_and_remove';
  logoUrl?: string;
  defaultVaultName?: string; // For the auto-created vault
}
```
- Creates bank record with type='business'
- Creates bank_membership for creator as 'bank_owner'
- Creates default vault in the bank (using defaultVaultName or "{bankName}'s Vault")
- Creates vault_membership for creator as 'vault_owner' on default vault
- Invalidate bank context queries
- Return: new bank object with default vault ID
- Toast: "Business bank '{name}' created"

**CreateBusinessBankDialog — full configuration upfront (LOCKED DECISION):**

Form Fields:
1. **Organization Name** (required) — Text input, 3-50 chars, placeholder "Acme Inc."
2. **Logo** (optional) — Image upload (PNG, JPG, SVG), max 2MB, preview. Use existing upload pattern if one exists, or simple file input.
3. **Cross-Bank Recording Default** (collapsed "Advanced" section) — Select: "Copy only" (default) vs "Copy and remove from source". Help text explaining difference.
4. **Default Vault Name** (optional) — Text input, defaults to "{Bank Name}'s Vault". Help: "Your first vault in this bank"

Actions: Cancel (hollow) + Create Business Bank (primary, disabled until valid)

**Post-Creation Flow (LOCKED DECISION: auto-switch + prompt first vault):**
1. Create bank (with default vault)
2. Close dialog
3. Auto-switch to new bank via useBankContext.setActiveBankId()
4. Navigate to /vaults — the default vault will be the only vault, auto-selected
5. Optionally: show CreateVaultDialog immediately if user wants to create additional vaults
6. Toast: "Business bank '{name}' created — you're now viewing it"
  </action>
  <verify>Dialog creates bank, auto-switches, navigates to /vaults showing new bank's default vault</verify>
  <done>useBankMutations with createBusinessBank. CreateBusinessBankDialog with full config and post-creation flow.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Business Bank Creation into VaultListPane and BankSwitcher</name>
  <files>src/components/panes/VaultListPane.tsx, src/components/header/BankSwitcher.tsx</files>
  <action>
**VaultListPane — two entry points (LOCKED DECISION: both CTA and BankSwitcher):**
- Add CTA at bottom of vault list: "Create Business Bank" button
- If no business banks exist: show prominent CTA "Create your first business bank to collaborate with your team"
- If business banks exist: show smaller "Create Business Bank" button below vault list
- Button opens CreateBusinessBankDialog

**BankSwitcher (Header) — second entry point:**
- Add "Create Business Bank" option in dropdown
- Position: bottom of bank list with separator
- Plus icon (RiAddLine from @remixicon/react)
- Click opens CreateBusinessBankDialog

Additional BankSwitcher enhancements:
- Personal Bank section: show personal bank first with "Personal" label
- Business Banks section: separator + "Business Banks" label + list with member count
- Current bank highlighted
- Empty state for no business banks: "No business banks" + "Create one to collaborate"

**IMPORTANT: NO bank settings on Vaults page (LOCKED DECISION).**
Do NOT add bank settings gear/panel to VaultListPane or VaultsPage. Bank settings (rename, logo, danger zone/delete) lives in Settings page ONLY. If user needs bank settings, they go to Settings > Banks.
  </action>
  <verify>Create Business Bank button appears in both VaultListPane and BankSwitcher. Dialog opens from both. No bank settings on Vaults page.</verify>
  <done>Business bank creation integrated into VaultListPane CTA and BankSwitcher dropdown. No bank settings on Vaults page.</done>
</task>

</tasks>

<verification>
- [ ] Create Business Bank button in VaultListPane CTA
- [ ] Create Business Bank option in BankSwitcher dropdown
- [ ] Dialog collects name, logo, cross-bank settings, default vault name
- [ ] Bank created with bank_owner membership
- [ ] Default vault auto-created in new bank
- [ ] Auto-switches to new bank after creation
- [ ] Navigates to /vaults showing new bank context
- [ ] Can create multiple business banks
- [ ] NO bank settings panel/gear on Vaults page
- [ ] No billing gate
</verification>

<success_criteria>
User can create business banks from both the Vaults page CTA and header BankSwitcher. Full configuration collected upfront (name, logo, cross-bank settings). After creation, auto-switches to new bank with default vault ready. Bank settings managed exclusively in Settings page.
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-vaults-page/10.2-05-SUMMARY.md`
</output>
