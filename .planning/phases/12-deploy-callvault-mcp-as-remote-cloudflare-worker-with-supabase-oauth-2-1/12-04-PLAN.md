---
phase: 12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - /Users/Naegele/dev/brain/src/pages/OAuthConsentPage.tsx
  - /Users/Naegele/dev/brain/src/App.tsx
autonomous: false
user_setup:
  - service: supabase
    why: "Supabase OAuth 2.1 Server must be enabled before the consent page can function"
    env_vars: []
    dashboard_config:
      - task: "Enable OAuth 2.1 Server"
        location: "Supabase Dashboard > Authentication > OAuth Server > Toggle ON"
      - task: "Set Authorization Path to /oauth/consent"
        location: "Supabase Dashboard > Authentication > OAuth Server > Authorization Path"
      - task: "Enable Dynamic Client Registration"
        location: "Supabase Dashboard > Authentication > OAuth Server > Dynamic Client Registration toggle"
      - task: "Switch JWT signing to RS256"
        location: "Supabase Dashboard > Authentication > Signing Keys > Generate new asymmetric key > Activate"

must_haves:
  truths:
    - "Consent page renders at /oauth/consent and shows the requesting application name and scopes"
    - "Clicking Approve redirects the browser to the OAuth callback URL with an authorization code"
    - "Clicking Deny redirects the browser to the OAuth callback URL with an error"
    - "If user is not logged in, they are redirected to login with authorization_id preserved"
    - "The consent page uses the CallVault brand styling (not a bare HTML form)"
  artifacts:
    - path: "/Users/Naegele/dev/brain/src/pages/OAuthConsentPage.tsx"
      provides: "OAuth consent page component"
      min_lines: 80
    - path: "/Users/Naegele/dev/brain/src/App.tsx"
      provides: "Updated router with /oauth/consent route"
      contains: "OAuthConsentPage"
  key_links:
    - from: "/Users/Naegele/dev/brain/src/pages/OAuthConsentPage.tsx"
      to: "supabase.auth.oauth.getAuthorizationDetails"
      via: "Fetches authorization details on mount"
      pattern: "getAuthorizationDetails"
    - from: "/Users/Naegele/dev/brain/src/pages/OAuthConsentPage.tsx"
      to: "supabase.auth.oauth.approveAuthorization"
      via: "Approves authorization on user click"
      pattern: "approveAuthorization"
    - from: "/Users/Naegele/dev/brain/src/pages/OAuthConsentPage.tsx"
      to: "supabase.auth.oauth.denyAuthorization"
      via: "Denies authorization on user click"
      pattern: "denyAuthorization"
---

<objective>
Build the OAuth consent page in the CallVault frontend that Supabase redirects users to during the MCP OAuth flow. This page shows the requesting application's name and scopes, and lets the user approve or deny access.

Purpose: Without this consent page, the OAuth 2.1 flow cannot complete -- Supabase redirects to this path after the user authenticates, and the page must call supabase-js methods to approve/deny the authorization request. This is a required piece of the MCP-REMOTE-02 and MCP-REMOTE-07 requirements.

Output: A new React page component at /oauth/consent in the CallVault frontend, wired into the router.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/12-RESEARCH.md
@/Users/Naegele/dev/brain/.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/RESEARCH-supabase-oauth.md

@/Users/Naegele/dev/brain/src/App.tsx
@/Users/Naegele/dev/brain/src/CLAUDE.md
@/Users/Naegele/dev/brain/docs/design/brand-guidelines-v4.2.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OAuthConsentPage component</name>
  <files>
    /Users/Naegele/dev/brain/src/pages/OAuthConsentPage.tsx
  </files>
  <action>
    Create a new page component `OAuthConsentPage.tsx` in the CallVault frontend.

    **Behavior:**

    1. On mount, read `authorization_id` from URL search params (`?authorization_id=<id>`)
    2. Check if user is authenticated via `supabase.auth.getUser()`
       - If NOT authenticated: redirect to `/login` with `?next=/oauth/consent?authorization_id=<id>` to preserve the authorization_id through the login flow
       - If authenticated: proceed to fetch authorization details
    3. Call `supabase.auth.oauth.getAuthorizationDetails(authorizationId)` to get:
       - `client.name` -- the requesting application's display name (e.g., "Claude", "ChatGPT")
       - `scope` -- space-separated string of requested scopes
       - `redirect_uri` -- where the user will be sent after
    4. Display a consent card showing:
       - CallVault logo/branding
       - "**[App Name]** wants to access your CallVault account"
       - List of requested permissions based on scopes (map `openid` -> "Verify your identity", `email` -> "View your email address")
       - "This will allow [App Name] to read your call recordings, transcripts, and contacts on your behalf."
       - Two buttons: "Allow" (primary) and "Deny" (secondary/outline)
    5. On "Allow" click:
       - Call `supabase.auth.oauth.approveAuthorization(authorizationId)`
       - Get `data.redirect_to` from response
       - `window.location.href = data.redirect_to` to redirect browser
    6. On "Deny" click:
       - Call `supabase.auth.oauth.denyAuthorization(authorizationId)`
       - Get `data.redirect_to` from response
       - `window.location.href = data.redirect_to`

    **Error handling:**
    - If `authorization_id` is missing from URL: show error message "Invalid authorization request. Please try connecting again from your MCP client."
    - If `getAuthorizationDetails` fails: show error with retry option
    - If `approveAuthorization`/`denyAuthorization` fails: show error with retry
    - If authorization_id has expired (10-min lifetime): show "This authorization request has expired. Please try connecting again from your MCP client."

    **Styling:**
    - Use existing CallVault component patterns and brand styling
    - Check `/Users/Naegele/dev/brain/src/CLAUDE.md` for React patterns and component conventions
    - Check `/Users/Naegele/dev/brain/docs/design/brand-guidelines-v4.2.md` for color palette and typography
    - Use a centered card layout (similar to login page pattern)
    - Shield/lock icon to convey security
    - Subtle branding: CallVault logo at top, app name prominently displayed
    - Keep it clean and minimal -- users need to make a quick trust decision

    **Loading state:**
    - Show a loading spinner while fetching authorization details
    - Disable buttons during approve/deny API call

    **Use the existing Supabase client from the app's context** (the CallVault frontend already has supabase-js initialized). Import from wherever the app initializes its Supabase client.
  </action>
  <verify>
    1. File exists at `/Users/Naegele/dev/brain/src/pages/OAuthConsentPage.tsx`
    2. `grep "getAuthorizationDetails\|approveAuthorization\|denyAuthorization" /Users/Naegele/dev/brain/src/pages/OAuthConsentPage.tsx` shows all three methods
    3. `grep "authorization_id" /Users/Naegele/dev/brain/src/pages/OAuthConsentPage.tsx` shows URL param handling
    4. Component handles missing auth (redirect to login)
    5. Component handles missing/expired authorization_id (error state)
  </verify>
  <done>
    OAuthConsentPage component created with full authorize/deny flow, login redirect with authorization_id preservation, error handling, and CallVault brand styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire consent page route into App.tsx router</name>
  <files>
    /Users/Naegele/dev/brain/src/App.tsx
  </files>
  <action>
    Add the `/oauth/consent` route to the CallVault frontend router in `App.tsx`.

    1. Read the current `App.tsx` to understand the routing pattern (React Router, custom router, etc.)
    2. Import `OAuthConsentPage` from `./pages/OAuthConsentPage`
    3. Add a route for `/oauth/consent` that renders `OAuthConsentPage`
    4. This route should be PUBLIC (no auth guard) -- the consent page itself handles auth checking internally and redirects to login if needed. If the router has an auth wrapper, the consent page should be OUTSIDE it (alongside the login page).
    5. The route does NOT need to be in the sidebar navigation -- it is only accessed via Supabase OAuth redirect

    **Important:** Do not modify any existing routes. Only add the new one.
  </action>
  <verify>
    1. `grep "oauth/consent\|OAuthConsentPage" /Users/Naegele/dev/brain/src/App.tsx` shows the route is registered
    2. The app builds: `cd /Users/Naegele/dev/brain && npm run build 2>&1 | tail -5` (or whatever the build command is)
    3. Navigate to `http://localhost:8080/oauth/consent` in browser -- page renders (will show error about missing authorization_id, which is expected)
  </verify>
  <done>
    /oauth/consent route wired into CallVault frontend router as a public route. Page accessible for Supabase OAuth redirects.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify consent page UI and routing</name>
  <files>
    /Users/Naegele/dev/brain/src/pages/OAuthConsentPage.tsx
    /Users/Naegele/dev/brain/src/App.tsx
  </files>
  <action>
    Present the consent page for human verification. The page was automated in Tasks 1 and 2 -- this checkpoint confirms the visual output and routing are correct.
  </action>
  <verify>
    1. Navigate to http://localhost:8080/oauth/consent in your browser
    2. Should see an error about missing authorization_id (expected -- real authorization_id comes from Supabase OAuth flow)
    3. Verify the page styling matches CallVault brand (centered card, logo, clean layout)
    4. Verify the page is accessible without login (public route)

    NOTE: Full end-to-end testing of the OAuth flow requires:
    - Supabase OAuth 2.1 Server enabled in dashboard (Plan 05 checkpoint)
    - Worker deployed with correct SUPABASE_URL secret (Plan 05)
    - An MCP client (Inspector) initiating the flow

    This checkpoint verifies the UI component is correctly built and routed.
  </verify>
  <done>
    Human verified: consent page renders with correct branding, error states work, and routing is accessible as a public route.
  </done>
</task>

</tasks>

<verification>
- OAuthConsentPage component exists with all three supabase.auth.oauth methods
- Route registered at /oauth/consent as public route
- Page handles: loading, consent display, approve, deny, error, expired, and unauthenticated states
- Styling follows CallVault brand guidelines
</verification>

<success_criteria>
The consent page is ready for the full OAuth 2.1 flow. When Supabase redirects a user to /oauth/consent?authorization_id=xxx, the page will show the requesting app's details and allow the user to approve or deny access, completing the authorization code exchange that MCP clients need.
</success_criteria>

<output>
After completion, create `.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/12-04-SUMMARY.md`
</output>
