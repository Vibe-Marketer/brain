---
phase: 12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/Naegele/Developer/mcp/callvault-mcp/wrangler.jsonc
  - /Users/Naegele/Developer/mcp/callvault-mcp/package.json
  - /Users/Naegele/Developer/mcp/callvault-mcp/tsconfig.worker.json
  - /Users/Naegele/Developer/mcp/callvault-mcp/src/types.ts
  - /Users/Naegele/Developer/mcp/callvault-mcp/src/supabase.ts
  - /Users/Naegele/Developer/mcp/callvault-mcp/src/utils.ts
autonomous: true

must_haves:
  truths:
    - "Cloudflare Worker project is configured and can run locally with `wrangler dev`"
    - "RequestContext type exists and provides supabase client + userId to handler functions"
    - "Supabase client is created per-request from an access token (no singletons, no filesystem)"
    - "Logging uses console.log (no filesystem), pagination uses cursor-based approach (no in-memory Map)"
  artifacts:
    - path: "/Users/Naegele/Developer/mcp/callvault-mcp/wrangler.jsonc"
      provides: "Cloudflare Worker deployment configuration"
      contains: "callvault-mcp"
    - path: "/Users/Naegele/Developer/mcp/callvault-mcp/tsconfig.worker.json"
      provides: "TypeScript config for Workers bundler module resolution"
      contains: "Bundler"
    - path: "/Users/Naegele/Developer/mcp/callvault-mcp/src/types.ts"
      provides: "RequestContext interface and Env type"
      exports: ["RequestContext", "Env"]
    - path: "/Users/Naegele/Developer/mcp/callvault-mcp/src/supabase.ts"
      provides: "Per-request Supabase client factory"
      exports: ["createSupabaseClient", "getUserIdFromToken"]
    - path: "/Users/Naegele/Developer/mcp/callvault-mcp/src/utils.ts"
      provides: "Console-based logging and cursor-based pagination"
      exports: ["log", "extractFields", "truncateList", "estimateTokens", "chunkResponse", "continueSession"]
  key_links:
    - from: "/Users/Naegele/Developer/mcp/callvault-mcp/src/types.ts"
      to: "/Users/Naegele/Developer/mcp/callvault-mcp/src/supabase.ts"
      via: "RequestContext uses SupabaseClient type"
      pattern: "SupabaseClient"
    - from: "/Users/Naegele/Developer/mcp/callvault-mcp/wrangler.jsonc"
      to: "/Users/Naegele/Developer/mcp/callvault-mcp/src/types.ts"
      via: "Env type matches wrangler vars/secrets bindings"
      pattern: "SUPABASE_URL"
---

<objective>
Set up the Cloudflare Worker project foundation for callvault-mcp, including wrangler config, Worker-compatible TypeScript setup, per-request Supabase client factory, and Workers-compatible utilities.

Purpose: Establish the foundational types (RequestContext, Env), dependency configuration, and stateless patterns that all subsequent plans depend on. Without this, no handler can be ported and no Worker entry point can be written.

Output: Wrangler config, tsconfig for Workers, RequestContext type, per-request supabase factory, and Workers-compatible logging/pagination utilities.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/ROADMAP.md
@/Users/Naegele/dev/brain/.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/12-RESEARCH.md
@/Users/Naegele/dev/brain/.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/RESEARCH-cloudflare-workers.md
@/Users/Naegele/dev/brain/.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/RESEARCH-codebase-analysis.md

@/Users/Naegele/Developer/mcp/callvault-mcp/package.json
@/Users/Naegele/Developer/mcp/callvault-mcp/tsconfig.json
@/Users/Naegele/Developer/mcp/callvault-mcp/src/supabase.ts
@/Users/Naegele/Developer/mcp/callvault-mcp/src/auth.ts
@/Users/Naegele/Developer/mcp/callvault-mcp/src/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wrangler.jsonc, install Worker deps, add tsconfig.worker.json</name>
  <files>
    /Users/Naegele/Developer/mcp/callvault-mcp/wrangler.jsonc
    /Users/Naegele/Developer/mcp/callvault-mcp/package.json
    /Users/Naegele/Developer/mcp/callvault-mcp/tsconfig.worker.json
  </files>
  <action>
    **Create `wrangler.jsonc`** in the callvault-mcp root with these settings:
    - `name`: `"callvault-mcp"`
    - `main`: `"src/worker.ts"` (will be created in Plan 03)
    - `compatibility_date`: `"2025-03-10"` (required for Streamable HTTP)
    - `compatibility_flags`: `["nodejs_compat"]` (required for @modelcontextprotocol/sdk Node.js builtins)
    - NO `durable_objects` or `migrations` sections (we are using stateless `createMcpHandler`, NOT McpAgent/Durable Objects)
    - NO `kv_namespaces` for initial deployment (cursor-based pagination eliminates KV need)
    - `observability.enabled`: `true`
    - `workers_dev`: `true` (deploy to *.workers.dev initially)
    - `vars`: `{ "ENVIRONMENT": "production", "MCP_SERVER_NAME": "callvault-mcp", "MCP_SERVER_VERSION": "1.0.0" }`
    - DO NOT include secrets in wrangler.jsonc (SUPABASE_URL, SUPABASE_ANON_KEY will be set via `wrangler secret put`)

    **Update `package.json`**:
    - Add `devDependencies`: `"wrangler": "^4"`, `"@cloudflare/workers-types": "^4"`
    - Add `dependencies`: `"jose": "^6"`, `"agents": "^0.1"` (provides createMcpHandler, getMcpAuthContext)
    - Remove `"open": "^10.1.0"` from dependencies (Node-only, used only in deleted authorize.ts)
    - Add scripts: `"dev:worker": "wrangler dev"`, `"deploy": "wrangler deploy"`, `"typecheck:worker": "tsc --noEmit -p tsconfig.worker.json"`
    - Keep existing `"build"`, `"dev"`, `"start"` scripts for the local stdio server (must remain functional per MCP-REMOTE-08)

    **Create `tsconfig.worker.json`** extending the base tsconfig:
    ```json
    {
      "extends": "./tsconfig.json",
      "compilerOptions": {
        "target": "ES2022",
        "module": "ESNext",
        "moduleResolution": "Bundler",
        "resolveJsonModule": true,
        "lib": ["ES2022"],
        "types": ["@cloudflare/workers-types"],
        "outDir": "./dist-worker",
        "noEmit": true
      },
      "include": ["src/**/*"],
      "exclude": ["node_modules", "dist", "dist-worker", "authorize.ts"]
    }
    ```

    **IMPORTANT:** The `resolveJsonModule: true` option is required because `src/worker.ts` (Plan 03) uses `import OPERATIONS from "./operations.json"`. Without this flag, TypeScript will reject the JSON import.

    **Run `npm install`** in the callvault-mcp directory to install new dependencies.
  </action>
  <verify>
    1. `cat /Users/Naegele/Developer/mcp/callvault-mcp/wrangler.jsonc` shows valid config with no DO/KV sections
    2. `cd /Users/Naegele/Developer/mcp/callvault-mcp && npm ls agents jose wrangler @cloudflare/workers-types` shows all installed
    3. `"open"` no longer in package.json dependencies
    4. `grep "resolveJsonModule" /Users/Naegele/Developer/mcp/callvault-mcp/tsconfig.worker.json` shows `true`
    5. Existing `npm run build` still works (stdio server preserved)
  </verify>
  <done>
    Worker project scaffolded with wrangler.jsonc (stateless, no DO), Worker-specific tsconfig (including resolveJsonModule for JSON imports), and all new dependencies installed. Local stdio server build scripts preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RequestContext type, per-request Supabase factory, and Workers-compatible utils</name>
  <files>
    /Users/Naegele/Developer/mcp/callvault-mcp/src/types.ts
    /Users/Naegele/Developer/mcp/callvault-mcp/src/supabase.ts
    /Users/Naegele/Developer/mcp/callvault-mcp/src/utils.ts
  </files>
  <action>
    **Create `src/types.ts`** with:
    ```typescript
    import type { SupabaseClient } from "@supabase/supabase-js";

    // Cloudflare Worker environment bindings
    export interface Env {
      SUPABASE_URL: string;
      SUPABASE_ANON_KEY: string;
      ENVIRONMENT: string;
      MCP_SERVER_NAME: string;
      MCP_SERVER_VERSION: string;
    }

    // Per-request context threaded through all handlers
    export interface RequestContext {
      supabase: SupabaseClient;
      userId: string;
    }
    ```

    **Rewrite `src/supabase.ts`** to a stateless per-request factory. The file currently has module-level singletons (`let client`, `let currentSession`) that are incompatible with Workers.

    New implementation:
    - `createSupabaseClient(supabaseUrl: string, supabaseAnonKey: string, accessToken: string): SupabaseClient` — creates a fresh client per request with `autoRefreshToken: false`, `persistSession: false`, and `global.headers.Authorization` set to the Bearer token. Do NOT use `client.auth.setSession()` (triggers browser storage paths in Workers).
    - `getUserIdFromToken(accessToken: string): string` — decodes the JWT payload using `atob()` to extract the `sub` claim. No crypto needed, just base64 decoding of the middle segment. Handle URL-safe base64 (`-` to `+`, `_` to `/`).
    - Remove all imports of `loadSession`, `saveSession`, `isSessionExpired` from `./auth.js`.
    - Remove module-level `let client` and `let currentSession` singletons.

    **Important for dual-mode support (MCP-REMOTE-08):** The existing `src/index.ts` (stdio entry) still imports from `./supabase.js`. To avoid breaking it, create the new factory functions as ADDITIONAL exports. The old `getSupabaseClient()` and `getCurrentUserId()` can remain in the file but should import from `./auth.js` only when running in Node.js mode (not Workers). Use a conditional approach:

    Actually, simpler: the stdio `index.ts` will continue to use the OLD supabase.ts exports. The Worker entry (`worker.ts`, created in Plan 03) will use the NEW exports. Both can coexist in the same file since they are just different exported functions. Keep the old `getSupabaseClient()` and `getCurrentUserId()` as-is for backward compatibility with the stdio server, and add the new `createSupabaseClient()` and `getUserIdFromToken()` alongside them.

    **Rewrite `src/utils.ts`** for Workers compatibility:

    1. **Replace filesystem logging** — The `log()` function currently uses `fs.appendFileSync`. Replace with `console.log`/`console.error`. Remove `fs` and `path` imports. Keep the same function signature `log(level: string, message: string): void`.

    2. **Replace in-memory pagination** — The `sessionsCache` Map does not persist across Worker requests. Replace `chunkResponse()` and `continueSession()` with a cursor-based approach:
       - `chunkResponse()` should still chunk data the same way, but instead of storing remaining chunks in a Map, it should return a `next_offset` number and `total` count in the response JSON. The MCP client can then call `callvault_execute` again with an `offset` parameter to get the next page.
       - `continueSession()` should be kept as a wrapper that returns "Use callvault_execute with offset parameter for pagination" message, so existing clients get a helpful message instead of a crash.
       - New format: `{ items: [...], total: N, offset: 0, limit: 50, has_more: true, next_offset: 50 }` instead of session IDs.

    3. **Keep pure functions unchanged**: `extractFields()`, `truncateList()`, `estimateTokens()`, `FIELD_CONFIGS` are all portable as-is.

    4. Remove `fs` and `path` imports from the top of the file.
  </action>
  <verify>
    1. `npx tsc --noEmit -p /Users/Naegele/Developer/mcp/callvault-mcp/tsconfig.worker.json` passes with no errors (may need to allow the worker.ts import to not exist yet -- verify types.ts and supabase.ts compile)
    2. `grep -r "import fs" /Users/Naegele/Developer/mcp/callvault-mcp/src/utils.ts` returns no results (fs removed)
    3. `grep -r "sessionsCache" /Users/Naegele/Developer/mcp/callvault-mcp/src/utils.ts` returns no results (Map removed)
    4. `grep "createSupabaseClient" /Users/Naegele/Developer/mcp/callvault-mcp/src/supabase.ts` returns a match (new factory exists)
    5. `grep "getSupabaseClient" /Users/Naegele/Developer/mcp/callvault-mcp/src/supabase.ts` returns a match (old function preserved for stdio)
    6. Existing `npm run build` still succeeds (stdio server not broken)
  </verify>
  <done>
    RequestContext type defined. Per-request Supabase client factory exports `createSupabaseClient` and `getUserIdFromToken`. Utils rewritten with console logging and cursor-based pagination. Old stdio-mode exports preserved for backward compatibility (MCP-REMOTE-08).
  </done>
</task>

</tasks>

<verification>
- `wrangler.jsonc` exists with stateless config (no DO bindings)
- `tsconfig.worker.json` uses ESNext/Bundler module resolution and includes `resolveJsonModule: true`
- `src/types.ts` exports `RequestContext` and `Env`
- `src/supabase.ts` has both old (stdio) and new (Worker) factory functions
- `src/utils.ts` has no `fs` imports and no `sessionsCache` Map
- `npm run build` still works for stdio server
- All new deps installed: `agents`, `jose`, `wrangler`, `@cloudflare/workers-types`
</verification>

<success_criteria>
The callvault-mcp project is scaffolded for Cloudflare Worker deployment with the foundational types and factories that Plans 02 and 03 depend on. The existing stdio server continues to build and run unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/12-01-SUMMARY.md`
</output>
