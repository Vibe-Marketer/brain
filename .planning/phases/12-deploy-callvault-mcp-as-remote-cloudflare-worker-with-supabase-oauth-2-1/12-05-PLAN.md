---
phase: 12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1
plan: 05
type: execute
wave: 4
depends_on: ["12-01", "12-02", "12-03", "12-04"]
files_modified:
  - /Users/Naegele/Developer/mcp/callvault-mcp/wrangler.jsonc
autonomous: false
user_setup:
  - service: supabase
    why: "Supabase OAuth 2.1 Server must be fully configured before deployment"
    env_vars: []
    dashboard_config:
      - task: "Verify OAuth 2.1 Server is enabled"
        location: "Supabase Dashboard > Authentication > OAuth Server"
      - task: "Verify Authorization Path is set to /oauth/consent"
        location: "Supabase Dashboard > Authentication > OAuth Server > Authorization Path"
      - task: "Verify Dynamic Client Registration is enabled"
        location: "Supabase Dashboard > Authentication > OAuth Server"
      - task: "Verify JWT signing is RS256 (not HS256)"
        location: "Supabase Dashboard > Authentication > Signing Keys"
      - task: "Verify Site URL is set to https://callvault.ai"
        location: "Supabase Dashboard > Authentication > URL Configuration > Site URL"
      - task: "Add OAuth redirect URLs to allowlist"
        location: "Supabase Dashboard > Authentication > URL Configuration > Redirect URLs"
        details: |
          Add ALL of these redirect URLs:
          - https://claude.ai/api/mcp/auth_callback
          - https://claude.com/api/mcp/auth_callback
          - https://chatgpt.com/connector_platform_oauth_redirect
          - https://platform.openai.com/apps-manage/oauth
          - http://localhost:5173/
          - http://127.0.0.1:5173/
  - service: cloudflare
    why: "Worker secrets must be set before first deploy"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard > Project Settings > API > Project URL"
      - name: SUPABASE_ANON_KEY
        source: "Supabase Dashboard > Project Settings > API > Project API keys > anon/public"

must_haves:
  truths:
    - "Worker is deployed and responding at callvault-mcp.callvault.workers.dev/mcp"
    - "GET /.well-known/oauth-protected-resource returns valid JSON"
    - "Unauthenticated POST /mcp returns 401 with WWW-Authenticate header"
    - "MCP Inspector can connect, authenticate, and list all 16 operations"
    - "Authenticated tool call returns real user data (not test/mock data)"
    - "Supabase RLS enforces data isolation between users"
  artifacts:
    - path: "https://callvault-mcp.callvault.workers.dev/mcp"
      provides: "Live MCP endpoint"
    - path: "https://callvault-mcp.callvault.workers.dev/.well-known/oauth-protected-resource"
      provides: "OAuth resource metadata endpoint"
  key_links:
    - from: "callvault-mcp.callvault.workers.dev/mcp"
      to: "Supabase project"
      via: "JWT validation + Supabase client"
      pattern: "Bearer token -> JWKS validation -> Supabase queries"
    - from: "callvault-mcp.callvault.workers.dev/.well-known/oauth-protected-resource"
      to: "Supabase /.well-known/oauth-authorization-server"
      via: "authorization_servers field in resource metadata"
      pattern: "authorization_servers"
---

<objective>
Configure Supabase OAuth 2.1 dashboard settings, deploy the Worker to Cloudflare, and validate the complete MCP server with MCP Inspector. Then verify end-to-end OAuth flow and client connectivity.

Purpose: This is the deployment and integration testing plan. All code is written -- now we configure the external services, deploy, and verify the entire chain works: Worker -> JWT validation -> Supabase queries -> real user data.

Output: A live, deployed, and verified remote MCP server that Claude Desktop and ChatGPT users can connect to.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/12-RESEARCH.md
@/Users/Naegele/dev/brain/.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/RESEARCH-supabase-oauth.md
@/Users/Naegele/dev/brain/.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/RESEARCH-mcp-client-compat.md

@/Users/Naegele/Developer/mcp/callvault-mcp/wrangler.jsonc (from Plan 01)
@/Users/Naegele/Developer/mcp/callvault-mcp/src/worker.ts (from Plan 03)
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Configure Supabase OAuth 2.1 Server and Cloudflare Worker secrets</name>
  <files>
    /Users/Naegele/Developer/mcp/callvault-mcp/wrangler.jsonc
  </files>
  <action>
    Human must configure external services that Claude cannot access. Present the following setup instructions and wait for confirmation.

    **Step 1: Supabase OAuth 2.1 Server (5 settings):**

    1. Go to Supabase Dashboard > Authentication > OAuth Server
       - Toggle ON the OAuth 2.1 Server
       - Set Authorization Path to: `/oauth/consent`
       - Enable Dynamic Client Registration

    2. Go to Supabase Dashboard > Authentication > Signing Keys
       - Click "Generate new key" and select RS256
       - Activate the new RS256 key (this replaces HS256)
       - WARNING: Existing sessions may be invalidated when switching signing algorithms. Plan for this during a low-traffic window.

    3. Go to Supabase Dashboard > Authentication > URL Configuration
       - Verify Site URL is: `https://callvault.ai`
       - Add these Redirect URLs to the allowlist:
         ```
         https://claude.ai/api/mcp/auth_callback
         https://claude.com/api/mcp/auth_callback
         https://chatgpt.com/connector_platform_oauth_redirect
         https://platform.openai.com/apps-manage/oauth
         http://localhost:5173/
         http://127.0.0.1:5173/
         ```

    **Step 2: Verify Supabase Discovery Endpoints:**

    Open these URLs in your browser and confirm they return valid JSON:
    - `https://<your-project-ref>.supabase.co/.well-known/openid-configuration`
      - Should include `code_challenge_methods_supported: ["S256"]`
    - `https://<your-project-ref>.supabase.co/.well-known/oauth-authorization-server/auth/v1`
      - Should include `authorization_endpoint`, `token_endpoint`, `registration_endpoint`

    **Step 3: Set Cloudflare Worker Secrets:**

    Run these commands from the callvault-mcp directory:
    ```bash
    cd /Users/Naegele/Developer/mcp/callvault-mcp
    npx wrangler secret put SUPABASE_URL
    # Paste: https://<your-project-ref>.supabase.co

    npx wrangler secret put SUPABASE_ANON_KEY
    # Paste: your Supabase anon/public key
    ```

    **Step 4: Verify the consent page is deployed:**
    - Push the CallVault frontend with the new /oauth/consent route
    - Verify https://callvault.ai/oauth/consent loads (shows missing authorization_id error, which is expected)
  </action>
  <verify>
    Human confirms all settings are configured and discovery endpoints return valid JSON.
  </verify>
  <done>
    All external service configuration complete: Supabase OAuth 2.1 enabled with RS256 signing, DCR enabled, redirect URLs allowlisted, and Cloudflare Worker secrets set.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy Worker and validate with curl and MCP Inspector</name>
  <files>
    /Users/Naegele/Developer/mcp/callvault-mcp/wrangler.jsonc
  </files>
  <action>
    **Deploy the Worker:**
    ```bash
    cd /Users/Naegele/Developer/mcp/callvault-mcp
    npx wrangler deploy
    ```

    Capture the deployed URL (should be `https://callvault-mcp.<account>.workers.dev`). If the subdomain is different from expected, that is fine -- use whatever wrangler reports.

    **Validation sequence (automated curl checks):**

    1. **CORS preflight:**
       ```bash
       curl -X OPTIONS https://callvault-mcp.<account>.workers.dev/mcp \
         -H "Origin: https://claude.ai" \
         -v 2>&1 | grep -E "Access-Control|HTTP/"
       ```
       Expected: 204 with Access-Control-Allow-Origin, Access-Control-Allow-Methods, Access-Control-Allow-Headers

    2. **OAuth Protected Resource metadata:**
       ```bash
       curl https://callvault-mcp.<account>.workers.dev/.well-known/oauth-protected-resource | jq .
       ```
       Expected: JSON with `resource`, `authorization_servers`, `scopes_supported`

    3. **Unauthenticated MCP request (should get 401):**
       ```bash
       curl -X POST https://callvault-mcp.<account>.workers.dev/mcp \
         -H "Content-Type: application/json" \
         -H "Accept: application/json, text/event-stream" \
         -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-03-26","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}' \
         -v 2>&1 | grep -E "HTTP/|WWW-Authenticate"
       ```
       Expected: 401 with `WWW-Authenticate: Bearer resource_metadata="..."` header

    4. **Supabase discovery chain (verify Supabase endpoints):**
       ```bash
       # Get the authorization_servers URL from step 2, then:
       curl https://<supabase-project>.supabase.co/.well-known/oauth-authorization-server/auth/v1 | jq .
       ```
       Expected: JSON with authorization_endpoint, token_endpoint, registration_endpoint, code_challenge_methods_supported

    **If any validation fails**, debug and fix. Common issues:
    - Missing `nodejs_compat` flag -> MCP SDK crashes
    - Wrong SUPABASE_URL secret -> auth middleware fails
    - Missing CORS headers -> browser clients blocked

    **MCP Inspector test:**
    ```bash
    npx @modelcontextprotocol/inspector
    ```
    In the Inspector UI:
    1. Select transport: "Streamable HTTP"
    2. Enter URL: `https://callvault-mcp.<account>.workers.dev/mcp`
    3. Connect -- should get 401 -> click "Open Auth settings" -> "Quick OAuth Flow"
    4. Complete OAuth authentication in the browser popup (log in with Google)
    5. After redirect back to Inspector, click Connect again
    6. Click "List tools" -- should show callvault_discover, callvault_get_schema, callvault_execute, callvault_continue
    7. Call `callvault_discover` with no params -- should return the 6 categories and 16 operations
    8. Call `callvault_execute` with `operation: "navigation.list_banks"` -- should return the user's banks

    Document any issues encountered during Inspector testing.
  </action>
  <verify>
    1. `curl https://callvault-mcp.<account>.workers.dev/.well-known/oauth-protected-resource` returns valid JSON
    2. `curl -X POST https://callvault-mcp.<account>.workers.dev/mcp` (unauthenticated) returns 401
    3. `curl -X OPTIONS https://callvault-mcp.<account>.workers.dev/mcp -H "Origin: https://claude.ai"` returns CORS headers
    4. MCP Inspector successfully lists 4 tools after OAuth authentication
  </verify>
  <done>
    Worker deployed, all curl validations pass (CORS, discovery, 401 challenge), and MCP Inspector can connect via OAuth, list tools, and execute operations against real user data.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify end-to-end client connectivity (Claude Desktop, ChatGPT)</name>
  <files>
    /Users/Naegele/Developer/mcp/callvault-mcp/wrangler.jsonc
  </files>
  <action>
    Present the deployed MCP server for human end-to-end testing with real MCP clients. Claude automated the deployment and curl validation -- this checkpoint confirms the full user experience works.
  </action>
  <verify>
    **Test 1: Claude Desktop / Claude.ai Connector**
    1. Open Claude Desktop (or claude.ai)
    2. Go to Settings > Connectors > "Add custom connector"
    3. Paste the MCP server URL: `https://callvault-mcp.<account>.workers.dev/mcp`
    4. Claude should initiate OAuth flow -- log in with your Google account
    5. Approve access on the CallVault consent page
    6. Back in Claude, ask: "What call recordings do I have?"
    7. Claude should use callvault_discover and callvault_execute to answer with real data
    8. Verify MCP-REMOTE-04 is satisfied

    **Test 2: ChatGPT Developer Mode (if available)**
    1. Open ChatGPT > Settings > Apps and Connectors > Advanced Settings > Developer Mode ON
    2. Settings > Connectors > Create
    3. Enter name: "CallVault", URL: `https://callvault-mcp.<account>.workers.dev/mcp`
    4. Complete OAuth flow
    5. Ask ChatGPT about your calls
    6. Verify MCP-REMOTE-05 is satisfied

    **Test 3: Data Isolation**
    If you have access to a second CallVault account:
    1. Connect from a second account
    2. Verify it only sees its own recordings (not yours)
    3. Verify MCP-REMOTE-07 (uses existing accounts) and RLS isolation

    **Test 4: Semantic Search (MCP-REMOTE-08)**
    In any connected client, ask: "Search my calls for discussions about pricing"
    This should trigger the semantic search operation (requires valid OpenAI API key in Supabase Edge Function secrets).

    Report: which tests passed, which failed, and any issues encountered.
  </verify>
  <done>
    Human verified: Remote MCP server works end-to-end with at least Claude Desktop. Users can connect by pasting a URL and signing in with Google. All requirements MCP-REMOTE-01 through MCP-REMOTE-08 evaluated.
  </done>
</task>

</tasks>

<verification>
- Worker deployed at callvault-mcp.*.workers.dev/mcp
- CORS, discovery, and auth challenge all validated via curl
- MCP Inspector connects via OAuth and executes operations
- Claude Desktop connector works end-to-end
- ChatGPT connector works end-to-end (if available)
- RLS data isolation confirmed
</verification>

<success_criteria>
The remote MCP server is deployed, publicly accessible, and verified working with at least Claude Desktop. Users can connect by pasting a URL and signing in with their Google account. All 16 operations execute against real user data with proper data isolation.
</success_criteria>

<output>
After completion, create `.planning/phases/12-deploy-callvault-mcp-as-remote-cloudflare-worker-with-supabase-oauth-2-1/12-05-SUMMARY.md`
</output>
