---
phase: 10.3-youtube-specific-vaults-video-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["10.3-01"]
files_modified:
  - src/components/vault/VaultSelector.tsx
  - supabase/functions/youtube-import/index.ts
autonomous: true

must_haves:
  truths:
    - "VaultSelector only shows YouTube vaults when integration='youtube'"
    - "If no YouTube vault exists at import time, one is auto-created named 'YouTube Vault'"
    - "Auto-created vault has vault_type='youtube' and user becomes vault_owner"
    - "YouTube imports always go into a YouTube vault (cannot select personal/team vault)"
  artifacts:
    - path: "src/components/vault/VaultSelector.tsx"
      provides: "YouTube-only vault filtering when integration='youtube'"
      contains: "vault_type.*youtube"
    - path: "supabase/functions/youtube-import/index.ts"
      provides: "Auto-create YouTube vault logic before import"
      contains: "YouTube Vault"
  key_links:
    - from: "src/components/vault/VaultSelector.tsx"
      to: "useBankContext"
      via: "filters vaults by vault_type when integration is youtube"
      pattern: "filter.*vault_type.*youtube"
    - from: "supabase/functions/youtube-import/index.ts"
      to: "vaults table"
      via: "SELECT/INSERT for auto-creating YouTube vault"
      pattern: "vault_type.*youtube"
---

<objective>
Update the YouTube import flow so VaultSelector only shows YouTube vaults and the youtube-import Edge Function auto-creates a YouTube vault if none exists on first import.

Purpose: Users must not accidentally import YouTube videos into non-YouTube vaults (which would show them in TranscriptTable format). The guardrail is in the selector, not a post-submit error. Auto-creation removes friction from the first import experience.

Output: VaultSelector with YouTube-only filtering + youtube-import with auto-vault-creation.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.3-youtube-specific-vaults-video-intelligence/10.3-CONTEXT.md
@.planning/phases/10.3-youtube-specific-vaults-video-intelligence/10.3-RESEARCH.md
@.planning/phases/10.3-youtube-specific-vaults-video-intelligence/10.3-01-SUMMARY.md

@src/components/vault/VaultSelector.tsx
@src/components/import/YouTubeImportForm.tsx
@supabase/functions/youtube-import/index.ts
@src/hooks/useBankContext.ts
@src/types/bank.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: VaultSelector YouTube-only filtering</name>
  <files>
    src/components/vault/VaultSelector.tsx
  </files>
  <action>
    Modify VaultSelector to filter vaults by type when integration is 'youtube':

    1. Import `VaultType` from `@/types/bank` (if not already imported)

    2. In the component body, add vault filtering logic BEFORE the `sortedVaults` memo:
       - When `integration === 'youtube'`, filter `vaults` to only include vaults where `vault_type === 'youtube'`
       - For all other integrations, keep current behavior (show all vaults)
       - Store filtered result as `filteredVaults`
       - Use `filteredVaults` instead of `vaults` throughout the component (length checks, sortedVaults memo, auto-select logic)

    3. Update the `sortedVaults` memo to use `filteredVaults`:
       ```typescript
       const filteredVaults = useMemo(() => {
         if (integration === 'youtube') {
           return vaults.filter(v => v.vault_type === 'youtube')
         }
         return vaults
       }, [vaults, integration])
       ```

    4. Update the auto-select `useEffect` to use `filteredVaults` instead of `vaults`:
       - If `filteredVaults.length > 0`, auto-select the first one
       - If `filteredVaults.length === 0` (no YouTube vaults yet), don't auto-select anything — the user will import and auto-creation will handle it

    5. Update the `sortedVaults` memo to sort `filteredVaults` instead of `vaults`:
       ```typescript
       const sortedVaults = useMemo(() => {
         const personal = filteredVaults.filter(v => v.vault_type === 'personal')
         const rest = filteredVaults
           .filter(v => v.vault_type !== 'personal')
           .sort((a, b) => a.name.localeCompare(b.name))
         return [...personal, ...rest]
       }, [filteredVaults])
       ```

    6. Update the early return for `vaults.length === 0` to use `filteredVaults.length === 0` — but for YouTube, show a helpful message instead of returning null:
       - If `integration === 'youtube'` and `filteredVaults.length === 0`, render:
         ```tsx
         <div className={cn('space-y-2', className)}>
           {label && (
             <label className="text-sm font-medium text-foreground flex items-center gap-2">
               <RiSafeLine className="w-4 h-4 text-muted-foreground" />
               {label}
             </label>
           )}
           <div className="flex items-center gap-2 h-10 px-3 rounded-md border border-input bg-muted/30 text-sm text-muted-foreground">
             A YouTube Hub will be created automatically
           </div>
         </div>
         ```
       - For non-YouTube integrations, keep `return null`

    7. Update single-vault display and Select dropdown to use `filteredVaults` and `sortedVaults` (already using sortedVaults, just make sure the memo source is correct)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `grep "vault_type.*youtube" src/components/vault/VaultSelector.tsx` shows filter
    - VaultSelector shows only YouTube vaults when integration='youtube'
    - VaultSelector shows all vaults for other integrations (no regression)
  </verify>
  <done>
    VaultSelector filters to YouTube-only vaults when integration='youtube'. Shows "A YouTube Hub will be created automatically" message when no YouTube vault exists. Non-YouTube integrations unaffected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Auto-create YouTube vault in youtube-import Edge Function</name>
  <files>
    supabase/functions/youtube-import/index.ts
  </files>
  <action>
    Add auto-creation of a YouTube vault before the import process begins:

    1. After user authentication (Step 1 area, before video URL validation), add a new section: **"Step 0: Ensure YouTube vault exists"**

    2. The logic should:
       a. Get the user's personal bank_id:
          ```typescript
          const { data: personalBank } = await supabase
            .from('banks')
            .select('id')
            .eq('type', 'personal')
            .single()
          ```
          Note: Service role key bypasses RLS, but we need the user's personal bank. The personal bank is created at signup and linked via bank_memberships. Query bank_memberships to find it:
          ```typescript
          const { data: bankMembership } = await supabase
            .from('bank_memberships')
            .select('bank_id, banks!inner(id, type)')
            .eq('user_id', user.id)
            .eq('banks.type', 'personal')
            .maybeSingle()
          ```
          If no personal bank found, log warning and continue without vault creation (shouldn't happen but don't block import).

       b. Check if user already has a YouTube vault in their personal bank:
          ```typescript
          const { data: existingYouTubeVault } = await supabase
            .from('vaults')
            .select('id')
            .eq('bank_id', personalBankId)
            .eq('vault_type', 'youtube')
            .maybeSingle()
          ```

       c. If no YouTube vault exists, create one:
          ```typescript
          const { data: newVault, error: createError } = await supabase
            .from('vaults')
            .insert({
              bank_id: personalBankId,
              name: 'YouTube Vault',
              vault_type: 'youtube',
              default_sharelink_ttl_days: 7,
            })
            .select('id')
            .single()
          ```
          Then create vault_membership for the user as vault_owner:
          ```typescript
          await supabase
            .from('vault_memberships')
            .insert({
              vault_id: newVault.id,
              user_id: user.id,
              role: 'vault_owner',
            })
          ```

       d. Set `youtubeVaultId` to either the existing vault ID or the newly created one.

       e. If `body.vault_id` was not provided in the request, use `youtubeVaultId` as the default. If `body.vault_id` WAS provided, keep using the user's explicit choice (they may have selected a specific YouTube vault).

    3. The auto-creation should be wrapped in try/catch. If vault creation fails, log the error but DON'T fail the import — just continue without vault entry (consistent with existing non-blocking vault entry pattern).

    4. Also: After the fathom_calls insert succeeds (Step 5), the existing vault entry creation code (Step 6) should also populate `recordings.source_metadata` when creating the recording entry. Currently youtube-import only creates fathom_calls records and then looks up recordings table for vault entry — but recordings might not exist yet (migration hasn't run). 
    
    **To fix the metadata propagation issue:** After creating the fathom_calls record, also create a recording in the recordings table directly (not relying on migration):
       ```typescript
       // Create recording entry for vault system
       const { data: newRecording, error: recordingError } = await supabase
         .from('recordings')
         .insert({
           legacy_recording_id: recordingId,
           bank_id: personalBankId, // from Step 0
           owner_user_id: user.id,
           title: videoDetails.title,
           full_transcript: transcriptText,
           summary: null,
           global_tags: [],
           source_app: 'youtube',
           source_metadata: metadata, // same metadata object used for fathom_calls
           duration: parseDurationToSeconds(videoDetails.duration), // parse ISO 8601 to seconds
           recording_start_time: publishedAt,
         })
         .select('id')
         .single()
       ```
       Then use `newRecording.id` for the vault_entry creation instead of looking up by legacy_recording_id.

    5. Add a simple `parseDurationToSeconds(iso: string): number` helper at the top of the file (similar to parseYouTubeDuration but just returns seconds):
       ```typescript
       function parseDurationToSeconds(iso8601: string): number {
         const match = iso8601?.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/)
         if (!match) return 0
         return (parseInt(match[1] || '0') * 3600) + (parseInt(match[2] || '0') * 60) + parseInt(match[3] || '0')
       }
       ```

    6. Update the vault_entry creation block (existing Step 6) to use the `youtubeVaultId` (from auto-creation) when `body.vault_id` is not provided. Remove the old recording lookup logic and use `newRecording.id` directly.
  </action>
  <verify>
    - Edge function file updated with auto-create logic
    - `grep "YouTube Vault" supabase/functions/youtube-import/index.ts` shows auto-create
    - `grep "source_metadata" supabase/functions/youtube-import/index.ts` shows metadata propagation to recordings table
    - `grep "vault_type.*youtube" supabase/functions/youtube-import/index.ts` shows vault type filter
  </verify>
  <done>
    youtube-import auto-creates a "YouTube Vault" on first import if none exists. Recordings table is populated directly during import (no reliance on migration for source_metadata). Vault entry creation uses the auto-created or explicitly selected YouTube vault. Import never fails due to vault issues (non-blocking pattern preserved).
  </done>
</task>

</tasks>

<verification>
1. VaultSelector shows only YouTube vaults when integration='youtube'
2. VaultSelector shows "A YouTube Hub will be created automatically" when no YouTube vault exists
3. youtube-import creates YouTube Vault automatically on first import
4. youtube-import creates recordings table entry with source_metadata populated
5. Vault entry is created linking recording to YouTube vault
6. Non-YouTube imports are unaffected (no regression)
</verification>

<success_criteria>
- First YouTube import auto-creates YouTube vault without user intervention
- Subsequent imports show the YouTube vault in VaultSelector
- Personal/team vaults are not selectable for YouTube imports
- Recordings table has source_metadata populated with YouTube metadata (thumbnails, views, etc.)
- Import flow is non-blocking on vault/recording table failures
</success_criteria>

<output>
After completion, create `.planning/phases/10.3-youtube-specific-vaults-video-intelligence/10.3-03-SUMMARY.md`
</output>
