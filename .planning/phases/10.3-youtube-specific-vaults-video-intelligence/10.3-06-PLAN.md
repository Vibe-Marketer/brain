---
phase: 10.3-youtube-specific-vaults-video-intelligence
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/youtube-import/index.ts
  - supabase/functions/youtube-import/__tests__/youtube-import-regression.test.ts
autonomous: true
gap_closure: true
user_setup:
  - service: youtube-data-api
    why: "youtube-api requires a valid key to fetch video metadata"
    env_vars:
      - name: YOUTUBE_DATA_API_KEY
        source: "Google Cloud Console -> APIs & Services -> Credentials"
  - service: transcript-api
    why: "youtube-api transcript action requires transcript provider key"
    env_vars:
      - name: TRANSCRIPT_API_KEY
        source: "Transcript provider dashboard/API key settings"

must_haves:
  truths:
    - "youtube-import no longer collapses all downstream failures to generic HTTP 400"
    - "When youtube-api fails, client receives the originating status and stage details"
    - "Authenticated import requests no longer fail due to missing auth context between youtube-import and youtube-api"
    - "Deployed functions and configured secrets allow at least one successful YouTube import in target environment"
  artifacts:
    - path: "supabase/functions/youtube-import/index.ts"
      provides: "Downstream error propagation with source/stage context and preserved status"
      contains: "source: 'youtube-api'"
    - path: "supabase/functions/youtube-import/index.ts"
      provides: "Explicit JWT forwarding for youtube-api calls"
      contains: "Authorization: `Bearer ${userJwtToken}`"
    - path: "supabase/functions/youtube-import/__tests__/youtube-import-regression.test.ts"
      provides: "Regression tests for status propagation and auth forwarding"
      contains: "youtube-import"
  key_links:
    - from: "supabase/functions/youtube-import/index.ts"
      to: "supabase/functions/youtube-api/index.ts"
      via: "internal fetch with user JWT Authorization header"
      pattern: "Authorization: `Bearer \$\{userJwtToken\}`"
    - from: "supabase/functions/youtube-import/index.ts"
      to: "client response"
      via: "returns downstream status/body details for youtube-api failures"
      pattern: "status: detailsResponse\.status"
---

<objective>
Close UAT blocker gaps (tests 2, 3, 4) by making youtube-import failure modes diagnosable, preventing auth forwarding regressions, and shipping verified runtime configuration/deployment for the import path.

Purpose: The current user-visible symptom is a generic HTTP 400, which masks root causes and blocks every downstream YouTube UX test. This plan restores transparent error semantics and verifies environment readiness so imports can succeed in real usage.

Output: Hardened youtube-import error handling, regression tests, deployed functions, and validated import-path readiness.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.3-youtube-specific-vaults-video-intelligence/10.3-UAT.md
@.planning/debug/phase-10-3-test-2-youtube-import-400.md
@.planning/debug/resolved/youtube-import-400-error.md

@supabase/functions/youtube-import/index.ts
@supabase/functions/youtube-api/index.ts
@src/components/import/YouTubeImportForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preserve downstream youtube-api status and diagnostics in youtube-import</name>
  <files>
    supabase/functions/youtube-import/index.ts
  </files>
  <action>
    Refactor youtube-import downstream error handling so actionable statuses reach the client:

    1. Keep request-validation failures as 400, but stop mapping youtube-api non-OK responses to generic 400.
    2. For each internal youtube-api call (`video-details`, `transcript`), parse downstream response safely and return:
       - `status`: the original downstream status code (401/403/404/429/500/etc)
       - `error`: stable message indicating import stage failure
       - `source`: `youtube-api`
       - `stage`: `video-details` or `transcript`
       - `details`: downstream error payload when available
    3. Keep `Authorization: Bearer ${userJwtToken}` forwarding for all youtube-api calls and consolidate into a helper/local constant to avoid drift.
    4. Ensure logs include stage + downstream status for troubleshooting without leaking secrets.
    5. Do not change successful response shape expected by `YouTubeImportForm`.
  </action>
  <verify>
    - `npx tsc --noEmit`
    - `rg 'Authorization: Bearer \\$\{userJwtToken\}' supabase/functions/youtube-import/index.ts`
    - `rg "source: 'youtube-api'|stage: 'video-details'|stage: 'transcript'" supabase/functions/youtube-import/index.ts`
  </verify>
  <done>
    youtube-import surfaces real downstream status/context instead of generic HTTP 400, while preserving successful import behavior and JWT forwarding.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression tests and execute deployment readiness checks</name>
  <files>
    supabase/functions/youtube-import/__tests__/youtube-import-regression.test.ts
  </files>
  <action>
    Add focused regression coverage and perform runtime readiness rollout checks:

    1. Add tests that prove youtube-import preserves downstream status/source/stage details for non-OK youtube-api responses (especially 401 and 500 cases).
    2. Add tests that fail if internal youtube-api requests stop forwarding `userJwtToken` in Authorization header.
    3. Resolve the target Supabase project ref once from `supabase/config.toml` and use it for all deployment/readiness commands:
       - `export SUPABASE_PROJECT_REF="$(awk -F '"' '/^project_id/{print $2}' supabase/config.toml)"`
    4. Deploy current `youtube-import` and `youtube-api` functions to `SUPABASE_PROJECT_REF`.
    5. Verify required function secrets exist in target environment (`YOUTUBE_DATA_API_KEY`, `TRANSCRIPT_API_KEY`).
    6. Run an authenticated smoke import against `/functions/v1/youtube-import` and confirm the flow no longer returns opaque generic 400 for downstream failures.
  </action>
  <verify>
    - `npx vitest run supabase/functions/youtube-import/__tests__/youtube-import-regression.test.ts`
    - `export SUPABASE_PROJECT_REF="$(awk -F '"' '/^project_id/{print $2}' supabase/config.toml)" && test -n "$SUPABASE_PROJECT_REF"`
    - `supabase functions deploy youtube-import --project-ref "$SUPABASE_PROJECT_REF"`
    - `supabase functions deploy youtube-api --project-ref "$SUPABASE_PROJECT_REF"`
    - `supabase secrets list --project-ref "$SUPABASE_PROJECT_REF" | rg 'YOUTUBE_DATA_API_KEY|TRANSCRIPT_API_KEY'`
    - `test -n "$SUPABASE_TEST_USER_JWT" && test -n "$SUPABASE_TEST_VAULT_ID"`
    - `curl -sS -i "https://$SUPABASE_PROJECT_REF.supabase.co/functions/v1/youtube-import" -H "Authorization: Bearer $SUPABASE_TEST_USER_JWT" -H "Content-Type: application/json" -d "{\"videoUrl\":\"https://www.youtube.com/watch?v=dQw4w9WgXcQ\",\"vault_id\":\"$SUPABASE_TEST_VAULT_ID\"}"`
  </verify>
  <done>
    Regression tests protect error semantics/auth forwarding, functions are deployed, secrets are confirmed present, and runtime import behavior is diagnosable and unblocked for UAT continuation.
  </done>
</task>

</tasks>

<verification>
1. Internal youtube-api failures no longer appear to client as generic 400 unless input is genuinely malformed.
2. youtube-import responses include `source` and `stage` for downstream failures.
3. JWT forwarding to youtube-api is covered by tests and confirmed in code.
4. Target environment has both YouTube-related secrets configured.
5. A post-deploy smoke import runs successfully or returns transparent actionable diagnostics.
6. Re-run UAT tests 2-4; sortable list and search can now be exercised with imported video data.
</verification>

<success_criteria>
- UAT blocker root cause (opaque youtube-import 400 chain) is closed with code-level and deployment-level remediation.
- YouTube import path in target environment is operable or returns precise status/source diagnostics that enable immediate fix-forward.
- Tests 2-4 are no longer blocked by inability to import any video.
</success_criteria>

<output>
After completion, create `.planning/phases/10.3-youtube-specific-vaults-video-intelligence/10.3-06-SUMMARY.md`
</output>
