---
phase: 04-team-collaboration
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/stores/teamContextStore.ts
  - supabase/migrations/20260129000001_add_active_team_id.sql
  - src/hooks/useActiveTeam.ts
autonomous: true

must_haves:
  truths:
    - "Active team context persists across page refreshes"
    - "Active team context is available to all components"
    - "User can have a personal workspace (null team) or a team context"
  artifacts:
    - path: "src/stores/teamContextStore.ts"
      provides: "Zustand store for active team state"
      exports: ["useTeamContextStore"]
    - path: "src/hooks/useActiveTeam.ts"
      provides: "Hook combining store with database persistence"
      exports: ["useActiveTeam"]
  key_links:
    - from: "src/stores/teamContextStore.ts"
      to: "user_settings.active_team_id"
      via: "Database sync in useActiveTeam hook"
      pattern: "active_team_id"
    - from: "src/hooks/useActiveTeam.ts"
      to: "src/stores/teamContextStore.ts"
      via: "Store subscription"
      pattern: "useTeamContextStore"
---

<objective>
Create team context infrastructure for tracking active team selection

Purpose: CONTEXT.md specifies "Active team context filters what data you see" and "Personal workspace exists alongside team workspaces". This requires a store to track which team (or personal workspace) is currently active.
Output: Zustand store + database migration + hook for team context with persistence
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-team-collaboration/04-CONTEXT.md
@.planning/phases/04-team-collaboration/04-RESEARCH.md

@src/stores/preferencesStore.ts (pattern reference for Zustand + DB persistence)
@src/hooks/useTeamHierarchy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create teamContextStore Zustand store</name>
  <files>src/stores/teamContextStore.ts</files>
  <action>
Create a new Zustand store for team context following the preferencesStore.ts pattern:

```typescript
import { create } from 'zustand';

export const TEAM_CONTEXT_UPDATED_KEY = 'team-context-updated';

interface TeamContextState {
  // State
  activeTeamId: string | null; // null = personal workspace
  isLoading: boolean;
  isInitialized: boolean;
  error: string | null;

  // Actions
  setActiveTeamId: (teamId: string | null) => void;
  initialize: (teamId: string | null) => void;
  setError: (error: string | null) => void;
}

/**
 * Team Context Store
 * Manages which team (or personal workspace) is currently active.
 * - null activeTeamId = Personal workspace (user's own data)
 * - string activeTeamId = Team workspace (team-shared data)
 * 
 * Database persistence handled by useActiveTeam hook.
 */
export const useTeamContextStore = create<TeamContextState>((set) => ({
  // Initial state
  activeTeamId: null,
  isLoading: true,
  isInitialized: false,
  error: null,

  // Set active team (triggers cross-tab sync via storage event)
  setActiveTeamId: (teamId) => {
    set({ activeTeamId: teamId, error: null });
    // Signal cross-tab sync
    if (typeof window !== 'undefined') {
      localStorage.setItem(TEAM_CONTEXT_UPDATED_KEY, Date.now().toString());
    }
  },

  // Initialize from database (called by useActiveTeam hook)
  initialize: (teamId) => {
    set({ 
      activeTeamId: teamId, 
      isLoading: false, 
      isInitialized: true,
      error: null 
    });
  },

  setError: (error) => {
    set({ error, isLoading: false });
  },
}));

/**
 * Cross-tab synchronization using storage events
 */
if (typeof window !== 'undefined') {
  window.addEventListener('storage', (event: StorageEvent) => {
    if (event.key === TEAM_CONTEXT_UPDATED_KEY) {
      // Another tab changed team context - will be synced via useActiveTeam
      // The hook will reload from database on next render
    }
  });
}
```

This store provides reactive state that components can subscribe to for rendering. The database persistence is handled separately in useActiveTeam hook.
  </action>
  <verify>
    - File exists at src/stores/teamContextStore.ts
    - `npm run build` succeeds
    - Store exports useTeamContextStore
  </verify>
  <done>
    Zustand store created for team context state management
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database migration for active_team_id</name>
  <files>supabase/migrations/20260129000001_add_active_team_id.sql</files>
  <action>
Create migration to add active_team_id column to user_settings table:

```sql
-- Migration: Add active_team_id to user_settings for team context persistence
-- This allows users to persist their active team selection across sessions

ALTER TABLE user_settings 
ADD COLUMN IF NOT EXISTS active_team_id UUID REFERENCES teams(id) ON DELETE SET NULL;

-- Add index for quick lookups
CREATE INDEX IF NOT EXISTS idx_user_settings_active_team_id 
ON user_settings(active_team_id) 
WHERE active_team_id IS NOT NULL;

-- Comment for documentation
COMMENT ON COLUMN user_settings.active_team_id IS 
'Currently active team context. NULL means personal workspace (no team filter).';
```

The ON DELETE SET NULL ensures that if a team is deleted, users revert to personal workspace rather than having an orphaned reference.
  </action>
  <verify>
    - Migration file exists at supabase/migrations/20260129000001_add_active_team_id.sql
    - SQL syntax is valid
    - Migration can be applied with `supabase db push` (or via Supabase dashboard)
  </verify>
  <done>
    Database schema updated to persist active team selection
  </done>
</task>

<task type="auto">
  <name>Task 3: Create useActiveTeam hook for store + DB sync</name>
  <files>src/hooks/useActiveTeam.ts</files>
  <action>
Create hook that combines Zustand store with database persistence:

```typescript
import { useEffect, useCallback } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { useAuth } from '@/contexts/AuthContext';
import { useTeamContextStore, TEAM_CONTEXT_UPDATED_KEY } from '@/stores/teamContextStore';
import { queryKeys } from '@/lib/query-config';
import { toast } from 'sonner';

interface UseActiveTeamResult {
  activeTeamId: string | null;
  isLoading: boolean;
  isPersonalWorkspace: boolean;
  switchTeam: (teamId: string | null) => Promise<void>;
  switchToPersonal: () => Promise<void>;
}

/**
 * Hook for managing active team context with database persistence.
 * 
 * - Loads active team from user_settings on mount
 * - Syncs changes to database
 * - Provides switchTeam/switchToPersonal actions
 */
export function useActiveTeam(): UseActiveTeamResult {
  const { user } = useAuth();
  const queryClient = useQueryClient();
  const { 
    activeTeamId, 
    isLoading: storeLoading, 
    isInitialized,
    setActiveTeamId,
    initialize,
    setError 
  } = useTeamContextStore();

  // Query to load active team from database on mount
  const { data: dbActiveTeamId, isLoading: queryLoading } = useQuery({
    queryKey: queryKeys.userSettings?.activeTeam?.() ?? ['user-settings', 'active-team'],
    queryFn: async () => {
      if (!user?.id) return null;
      
      const { data, error } = await supabase
        .from('user_settings')
        .select('active_team_id')
        .eq('user_id', user.id)
        .maybeSingle();
      
      if (error) {
        console.error('Error loading active team:', error);
        return null;
      }
      
      return data?.active_team_id ?? null;
    },
    enabled: !!user?.id,
    staleTime: 1000 * 60 * 5, // 5 minutes
  });

  // Initialize store from database when query completes
  useEffect(() => {
    if (!queryLoading && user?.id && !isInitialized) {
      initialize(dbActiveTeamId ?? null);
    }
  }, [queryLoading, dbActiveTeamId, user?.id, isInitialized, initialize]);

  // Mutation to persist team change to database
  const switchTeamMutation = useMutation({
    mutationFn: async (teamId: string | null) => {
      if (!user?.id) throw new Error('Not authenticated');
      
      const { error } = await supabase
        .from('user_settings')
        .upsert({
          user_id: user.id,
          active_team_id: teamId,
          updated_at: new Date().toISOString(),
        }, {
          onConflict: 'user_id',
        });
      
      if (error) throw error;
      return teamId;
    },
    onSuccess: (teamId) => {
      setActiveTeamId(teamId);
      queryClient.invalidateQueries({ 
        queryKey: queryKeys.userSettings?.activeTeam?.() ?? ['user-settings', 'active-team']
      });
    },
    onError: (error) => {
      const message = error instanceof Error ? error.message : 'Failed to switch team';
      toast.error(message);
      setError(message);
    },
  });

  const switchTeam = useCallback(async (teamId: string | null) => {
    await switchTeamMutation.mutateAsync(teamId);
  }, [switchTeamMutation]);

  const switchToPersonal = useCallback(async () => {
    await switchTeamMutation.mutateAsync(null);
  }, [switchTeamMutation]);

  return {
    activeTeamId,
    isLoading: storeLoading || queryLoading,
    isPersonalWorkspace: activeTeamId === null,
    switchTeam,
    switchToPersonal,
  };
}
```

Also add query keys to lib/query-config.ts if they don't exist:
```typescript
// In queryKeys object, add:
userSettings: {
  all: ['user-settings'] as const,
  activeTeam: () => ['user-settings', 'active-team'] as const,
},
```
  </action>
  <verify>
    - File exists at src/hooks/useActiveTeam.ts
    - `npm run build` succeeds
    - Hook exports useActiveTeam
  </verify>
  <done>
    Hook created that syncs team context between Zustand store and database
  </done>
</task>

</tasks>

<verification>
1. Store works: Import useTeamContextStore, verify setActiveTeamId updates state
2. DB migration: Apply migration, verify active_team_id column exists on user_settings
3. Hook works: Use useActiveTeam in a test component, verify switchTeam persists to DB
4. Build passes: `npm run build` completes without errors
</verification>

<success_criteria>
- Team context store exists and is reactive
- Database can persist active team selection
- Hook provides clean API for components to use
- Personal workspace (null) is the default state
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-team-collaboration/04-03-SUMMARY.md`
</output>
