---
phase: 04-team-collaboration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/teams/index.ts
  - supabase/functions/team-memberships/index.ts
  - src/pages/TeamManagement.tsx
  - src/components/settings/TeamTab.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a team (no silent failures)"
    - "Users can belong to multiple teams"
    - "Team creation collects only team name (minimal friction)"
  artifacts:
    - path: "supabase/functions/teams/index.ts"
      provides: "Team creation without single-team restriction"
    - path: "supabase/functions/team-memberships/index.ts"
      provides: "Team membership without single-team restriction"
    - path: "src/pages/TeamManagement.tsx"
      provides: "Simplified CreateTeamDialog"
  key_links:
    - from: "src/pages/TeamManagement.tsx"
      to: "supabase/functions/teams"
      via: "fetch POST"
      pattern: "createTeam"
---

<objective>
Enable multi-team membership and simplify team creation UX

Purpose: CONTEXT.md says "Users can belong to multiple teams" but Edge Functions currently block this. Also, team creation dialog has extra fields when CONTEXT.md specifies "Collect only team name (minimal friction)".
Output: Working multi-team support and streamlined team creation flow
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-team-collaboration/04-CONTEXT.md
@.planning/phases/04-team-collaboration/04-RESEARCH.md

@supabase/functions/teams/index.ts
@supabase/functions/team-memberships/index.ts
@src/pages/TeamManagement.tsx
@src/components/settings/TeamTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove single-team restriction from Edge Functions</name>
  <files>supabase/functions/teams/index.ts, supabase/functions/team-memberships/index.ts</files>
  <action>
**In supabase/functions/teams/index.ts (handleCreateTeam function):**

Find and remove the single-team check block (around lines 113-133). Delete or comment out:

```typescript
// Check if user is already in a team (one team per user in MVP)
const { data: existingMembership, error: membershipError } = await supabaseClient
  .from('team_memberships')
  .select('id, team_id')
  .eq('user_id', user_id)
  .eq('status', 'active')
  .maybeSingle();

if (membershipError) {
  return new Response(
    JSON.stringify({ error: 'Error checking existing membership' }),
    { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
  );
}

if (existingMembership) {
  return new Response(
    JSON.stringify({ error: 'User is already a member of a team. Users can only belong to one team.' }),
    { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
  );
}
```

Replace with a brief comment:
```typescript
// Per CONTEXT.md: Users can belong to multiple teams (no single-team restriction)
```

**In supabase/functions/team-memberships/index.ts:**

Find the similar single-team check in the invite acceptance flow (look for "Check if user is in another team" or "one team per user constraint") and remove it entirely. Users should be able to accept invites and join multiple teams.
  </action>
  <verify>
    - `grep -rn "only belong to one team" supabase/functions/teams/` returns no matches
    - `grep -rn "only belong to one team" supabase/functions/team-memberships/` returns no matches
    - `grep -rn "one team per user" supabase/functions/` returns no matches or only comment explaining removal
  </verify>
  <done>
    Users can belong to multiple teams per CONTEXT.md decision
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify CreateTeamDialog to name-only</name>
  <files>src/pages/TeamManagement.tsx, src/components/settings/TeamTab.tsx</files>
  <action>
Per CONTEXT.md: "Collect only team name (minimal friction, add details later)"

**In src/pages/TeamManagement.tsx (CreateTeamDialog component):**

1. Simplify CreateTeamFormData interface (around line 63):
```typescript
interface CreateTeamFormData {
  name: string;
}
```

2. Update initial state in CreateTeamDialog (around line 89):
```typescript
const [formData, setFormData] = useState<CreateTeamFormData>({
  name: "",
});
```

3. Update form reset in handleSubmit (around line 102):
```typescript
setFormData({ name: "" });
```

4. In the dialog form JSX: Remove the "Admin Visibility" switch and "Auto-Join Domain" input. Keep only the team name input with its label and any validation.

5. Update DialogDescription to be simpler:
```typescript
<DialogDescription>
  Create a new team to collaborate with your colleagues.
</DialogDescription>
```

**In src/pages/TeamManagement.tsx (handleCreateTeam callback, around lines 648-666):**

Simplify the createTeam call:
```typescript
const handleCreateTeam = useCallback(
  async (data: CreateTeamFormData) => {
    try {
      const newTeam = await createTeam({
        name: data.name,
      });
      setUserTeamId(newTeam.id);
      setShowCreateDialog(false);
      toast.success("Team created successfully");
    } catch (error) {
      const message = error instanceof Error ? error.message : "Failed to create team";
      toast.error(message);
    }
  },
  [createTeam]
);
```

**In src/components/settings/TeamTab.tsx:**

Apply the same simplification:
1. Remove admin_sees_all and domain_auto_join from createFormData state
2. Remove those fields from the form UI
3. Simplify handleCreateTeam to only pass name

The admin_sees_all and domain_auto_join settings can be configured later via team settings.
  </action>
  <verify>
    - CreateTeamDialog shows only team name field (verify via dev server)
    - `npm run build` succeeds
    - Team creation still works with default values for admin_sees_all=false, domain_auto_join=null
  </verify>
  <done>
    Team creation dialog is minimal-friction per CONTEXT.md: "Collect only team name"
  </done>
</task>

</tasks>

<verification>
1. Multi-team support: Create a team, then try to create another - should succeed (previously blocked)
2. Simplified dialog: Open CreateTeamDialog - should show only team name input
3. Team creation works: Create team with just a name - should succeed and show success toast
4. Build passes: `npm run build` completes without errors
</verification>

<success_criteria>
- TEAM-01 requirement met: Team creation works (no silent failures, multi-team enabled)
- CONTEXT.md decision honored: "Users can belong to multiple teams"
- CONTEXT.md decision honored: "Collect only team name (minimal friction)"
- No TypeScript errors
- Edge Functions ready for deploy
</success_criteria>

<output>
After completion, create `.planning/phases/04-team-collaboration/04-02-SUMMARY.md`
</output>
