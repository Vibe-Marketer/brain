---
phase: 04-team-collaboration
plan: 04
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - src/components/TeamSwitcher.tsx
  - src/components/ui/top-bar.tsx
autonomous: true

must_haves:
  truths:
    - "Teams appear in top-right dropdown near user avatar"
    - "User can see all their teams and personal workspace"
    - "Clear team badge in header shows current team context"
    - "User can switch between teams and personal workspace"
  artifacts:
    - path: "src/components/TeamSwitcher.tsx"
      provides: "Dropdown component for team switching"
      exports: ["TeamSwitcher"]
    - path: "src/components/ui/top-bar.tsx"
      provides: "TopBar with TeamSwitcher integrated"
      contains: "TeamSwitcher"
  key_links:
    - from: "src/components/TeamSwitcher.tsx"
      to: "src/hooks/useActiveTeam.ts"
      via: "Hook usage"
      pattern: "useActiveTeam"
    - from: "src/components/ui/top-bar.tsx"
      to: "src/components/TeamSwitcher.tsx"
      via: "Component import"
      pattern: "TeamSwitcher"
---

<objective>
Create team switcher dropdown in header for switching between teams and personal workspace

Purpose: CONTEXT.md specifies "Teams appear in top-right dropdown (team switcher near user avatar)" and "Clear team badge in header shows current team context". This is critical UX for multi-team support.
Output: TeamSwitcher component integrated into TopBar with active team badge
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-team-collaboration/04-CONTEXT.md
@.planning/phases/04-team-collaboration/04-RESEARCH.md
@.planning/phases/04-team-collaboration/04-03-SUMMARY.md

@src/components/ui/top-bar.tsx
@src/hooks/useActiveTeam.ts
@src/hooks/useTeamHierarchy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TeamSwitcher component</name>
  <files>src/components/TeamSwitcher.tsx</files>
  <action>
Create a dropdown component for switching between teams:

```tsx
import * as React from 'react';
import { RiTeamLine, RiUserLine, RiCheckLine, RiArrowDownSLine } from '@remixicon/react';
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { useAuth } from '@/contexts/AuthContext';
import { useActiveTeam } from '@/hooks/useActiveTeam';
import { queryKeys } from '@/lib/query-config';
import { cn } from '@/lib/utils';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
  DropdownMenuLabel,
} from '@/components/ui/dropdown-menu';
import { Button } from '@/components/ui/button';
import { Skeleton } from '@/components/ui/skeleton';

interface Team {
  id: string;
  name: string;
}

interface TeamMembership {
  id: string;
  team_id: string;
  teams: Team;
}

/**
 * TeamSwitcher - Dropdown for switching between teams and personal workspace
 * 
 * CONTEXT.md decisions:
 * - "Teams appear in top-right dropdown (team switcher near user avatar)"
 * - "Personal workspace exists alongside team workspaces"
 * - "Clear team badge in header shows current team context"
 */
export function TeamSwitcher() {
  const { user } = useAuth();
  const { activeTeamId, isLoading: contextLoading, switchTeam, switchToPersonal } = useActiveTeam();

  // Fetch user's teams via their memberships
  const { data: memberships, isLoading: teamsLoading } = useQuery({
    queryKey: queryKeys.teams?.userMemberships?.(user?.id ?? '') ?? ['team-memberships', 'user', user?.id],
    queryFn: async () => {
      if (!user?.id) return [];
      
      const { data, error } = await supabase
        .from('team_memberships')
        .select(`
          id,
          team_id,
          teams:teams(id, name)
        `)
        .eq('user_id', user.id)
        .eq('status', 'active');
      
      if (error) {
        console.error('Error fetching team memberships:', error);
        return [];
      }
      
      return (data ?? []) as TeamMembership[];
    },
    enabled: !!user?.id,
    staleTime: 1000 * 60 * 5, // 5 minutes
  });

  const isLoading = contextLoading || teamsLoading;
  const teams = memberships?.map(m => m.teams).filter(Boolean) ?? [];
  const hasTeams = teams.length > 0;
  
  // Find active team name
  const activeTeam = teams.find(t => t.id === activeTeamId);
  const isPersonal = !activeTeamId;

  // Don't render if user has no teams (just personal workspace)
  if (!isLoading && !hasTeams) {
    return null;
  }

  if (isLoading) {
    return (
      <div className="flex items-center gap-2">
        <Skeleton className="h-6 w-20" />
      </div>
    );
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button 
          variant="ghost" 
          size="sm"
          className="flex items-center gap-1.5 px-2 h-8 text-sm font-medium"
        >
          {isPersonal ? (
            <>
              <RiUserLine className="h-4 w-4 text-muted-foreground" />
              <span className="hidden sm:inline">Personal</span>
            </>
          ) : (
            <>
              <RiTeamLine className="h-4 w-4 text-vibe-orange" />
              <span className="hidden sm:inline max-w-[100px] truncate">{activeTeam?.name}</span>
            </>
          )}
          <RiArrowDownSLine className="h-4 w-4 text-muted-foreground" />
        </Button>
      </DropdownMenuTrigger>
      
      <DropdownMenuContent align="end" className="w-56 bg-background border-border z-50">
        <DropdownMenuLabel className="text-xs text-muted-foreground font-normal">
          Switch workspace
        </DropdownMenuLabel>
        
        {/* Personal workspace option */}
        <DropdownMenuItem 
          onClick={() => switchToPersonal()}
          className="cursor-pointer flex items-center justify-between"
        >
          <div className="flex items-center gap-2">
            <RiUserLine className="h-4 w-4" />
            <span>Personal</span>
          </div>
          {isPersonal && <RiCheckLine className="h-4 w-4 text-vibe-orange" />}
        </DropdownMenuItem>
        
        {hasTeams && <DropdownMenuSeparator />}
        
        {/* Team options */}
        {teams.map((team) => (
          <DropdownMenuItem
            key={team.id}
            onClick={() => switchTeam(team.id)}
            className="cursor-pointer flex items-center justify-between"
          >
            <div className="flex items-center gap-2">
              <RiTeamLine className="h-4 w-4" />
              <span className="truncate max-w-[150px]">{team.name}</span>
            </div>
            {activeTeamId === team.id && <RiCheckLine className="h-4 w-4 text-vibe-orange" />}
          </DropdownMenuItem>
        ))}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

This follows existing DropdownMenu patterns from top-bar.tsx and uses the established icon library (Remix Icons).
  </action>
  <verify>
    - File exists at src/components/TeamSwitcher.tsx
    - `npm run build` succeeds
    - Component exports TeamSwitcher
  </verify>
  <done>
    TeamSwitcher dropdown component created with personal workspace + team options
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate TeamSwitcher into TopBar</name>
  <files>src/components/ui/top-bar.tsx</files>
  <action>
Add TeamSwitcher to TopBar, positioned between the right-side utilities and the avatar dropdown:

1. Add import at top:
```typescript
import { TeamSwitcher } from '@/components/TeamSwitcher';
```

2. In the "Right: Utilities" section div, add TeamSwitcher before the notification bell:

```tsx
{/* Right: Utilities */}
<div className="flex items-center gap-1 md:gap-2">
  {/* Team Switcher - shows current team context */}
  <TeamSwitcher />
  
  {searchEnabled && <Button variant="hollow" size="icon" onClick={handleSearchClick} className="text-muted-foreground" aria-label="Search (Cmd+K)">
      <RiSearchLine className="w-4 h-4" />
    </Button>}
  
  {/* ... rest of utilities unchanged */}
</div>
```

The TeamSwitcher should be the first item in the utilities row. It auto-hides when user has no teams, so it won't show for users who haven't joined any teams yet.
  </action>
  <verify>
    - `grep -n "TeamSwitcher" src/components/ui/top-bar.tsx` shows import and usage
    - `npm run build` succeeds
    - TeamSwitcher appears in header on dev server (if user has teams)
  </verify>
  <done>
    TopBar shows TeamSwitcher with team badge indicating current context
  </done>
</task>

</tasks>

<verification>
1. Component renders: TeamSwitcher shows in header (if user has teams)
2. Personal workspace: Can switch to "Personal" and see checkmark
3. Team switching: Can switch to a team and see team name + vibe orange team icon
4. Badge updates: Header shows current team context clearly
5. Build passes: `npm run build` completes without errors
</verification>

<success_criteria>
- CONTEXT.md decision honored: "Teams appear in top-right dropdown"
- CONTEXT.md decision honored: "Personal workspace exists alongside team workspaces"
- CONTEXT.md decision honored: "Clear team badge in header shows current team context"
- Team switching persists (via useActiveTeam hook from 04-03)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-team-collaboration/04-04-SUMMARY.md`
</output>
