---
phase: 01-security-lockdown
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/contexts/AuthContext.tsx
  - src/pages/Chat.tsx
  - src/hooks/useChatSession.ts
  - src/lib/export-utils.ts
  - src/components/transcript-library/BulkActionToolbarEnhanced.tsx
autonomous: true

must_haves:
  truths:
    - "No console.log statements exposing PII in production"
    - "Export functions use properly typed interfaces (no any casting)"
  artifacts:
    - path: "src/hooks/useChatSession.ts"
      provides: "Line 232 PII dump replaced with logger.debug count-only"
      contains: "logger"
    - path: "src/contexts/AuthContext.tsx"
      provides: "console.log replaced with logger.debug"
      contains: "logger"
    - path: "src/pages/Chat.tsx"
      provides: "console.log/warn replaced with logger equivalents"
      contains: "logger"
    - path: "src/lib/export-utils.ts"
      provides: "Export functions accept Meeting[] (not just Call[])"
      contains: "Meeting"
    - path: "src/components/transcript-library/BulkActionToolbarEnhanced.tsx"
      provides: "Zero as any casts"
  key_links:
    - from: "src/components/transcript-library/BulkActionToolbarEnhanced.tsx"
      to: "src/lib/export-utils.ts"
      via: "Properly typed function calls"
      pattern: "export.*\\(selectedCalls(?!.*as any)"
    - from: "src/hooks/useChatSession.ts"
      to: "src/lib/logger.ts"
      via: "import logger"
      pattern: "import.*logger"
---

<objective>
Eliminate PII exposure in console logging (SEC-04) and remove type safety bypasses in export functions (SEC-05).

Purpose: SEC-04 addresses 26 console statements across 3 files — most critically line 232 of useChatSession.ts which dumps full message payloads (user conversations, session IDs) via JSON.stringify. SEC-05 fixes 7 `as any` casts that bypass TypeScript's safety checks in the bulk export toolbar.

Output: All console.log replaced with environment-aware logger, all `as any` casts eliminated with proper types.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-lockdown/01-RESEARCH.md

Key source files:
@src/contexts/AuthContext.tsx
@src/pages/Chat.tsx
@src/hooks/useChatSession.ts
@src/lib/logger.ts
@src/lib/export-utils.ts
@src/components/transcript-library/BulkActionToolbarEnhanced.tsx
@src/types/meetings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace console logging with environment-aware logger (SEC-04)</name>
  <files>
    src/contexts/AuthContext.tsx
    src/pages/Chat.tsx
    src/hooks/useChatSession.ts
  </files>
  <action>
    The project already has an environment-aware logger at `src/lib/logger.ts` that suppresses debug/info in production. Replace all console.log/console.warn statements in these 3 files.

    **File 1: `src/hooks/useChatSession.ts` (6 statements — HIGHEST PRIORITY)**

    CRITICAL — Line 232: `console.log('Saving messages:', JSON.stringify(messagesToInsert, null, 2))`
    - This dumps FULL message payloads (user text, AI responses, user IDs, session IDs) to browser console
    - Replace with: `logger.debug('Saving messages:', messagesToInsert.length)` — log COUNT only, never content
    - Add `import { logger } from '@/lib/logger';` at top of file

    Other 5 statements (lines 162, 199, 211, 228, 245):
    - Line 162: `console.log('No messages to save...')` → `logger.debug('No messages to save (empty or undefined)')`
    - Line 199: `console.warn('Failed to serialize message parts, skipping')` → `logger.warn('Failed to serialize message parts, skipping')`
    - Line 211: `console.warn('Skipping message with invalid role:', msg.role)` → `logger.warn('Skipping message with invalid role:', msg.role)`
    - Line 228: `console.log('No valid messages to insert')` → `logger.debug('No valid messages to insert')`
    - Line 245: `console.log('Saved messages successfully:', data?.length)` → `logger.debug('Saved messages successfully:', data?.length)`

    **File 2: `src/contexts/AuthContext.tsx` (5 statements)**

    Add `import { logger } from '@/lib/logger';` at top.
    - Line 25: `console.log('[AuthContext] Auth state changed:', event, ...)` → `logger.debug('[AuthContext] Auth state changed:', event, session ? 'Session valid' : 'No session')`
    - Line 29: `console.log('[AuthContext] User signed out')` → `logger.debug('[AuthContext] User signed out')`
    - Line 33: `console.log('[AuthContext] Token refreshed successfully')` → `logger.debug('[AuthContext] Token refreshed successfully')`
    - Line 37: `console.log('[AuthContext] User signed in')` → `logger.debug('[AuthContext] User signed in')`
    - Line 59: `console.log('[AuthContext] Initial session loaded:', ...)` → `logger.debug('[AuthContext] Initial session loaded:', session ? 'Valid' : 'None')`

    **File 3: `src/pages/Chat.tsx` (15 statements)**

    Add `import { logger } from '@/lib/logger';` at top.
    Replace ALL `console.log(...)` with `logger.debug(...)` and ALL `console.warn(...)` with `logger.warn(...)`.
    Specific lines: 432, 436-440, 448, 454, 546, 562, 571, 590, 600, 654, 750, 890-892, 916-917, 1030, 1104.

    NOTE: Preserve the exact same log messages and arguments — only change `console.log` → `logger.debug` and `console.warn` → `logger.warn`. The one exception is line 232 of useChatSession.ts where the argument must change from content dump to count.
  </action>
  <verify>
    - `grep -n "console\\.log\\|console\\.warn" src/hooks/useChatSession.ts` returns NO matches
    - `grep -n "console\\.log\\|console\\.warn" src/contexts/AuthContext.tsx` returns NO matches
    - `grep -n "console\\.log\\|console\\.warn" src/pages/Chat.tsx` returns NO matches
    - `grep -n "JSON.stringify(messagesToInsert" src/hooks/useChatSession.ts` returns NO matches (PII dump eliminated)
    - `grep -n "import.*logger" src/hooks/useChatSession.ts` confirms logger import
    - `grep -n "import.*logger" src/contexts/AuthContext.tsx` confirms logger import
    - `grep -n "import.*logger" src/pages/Chat.tsx` confirms logger import
    - `npx tsc --noEmit` — no new errors
  </verify>
  <done>
    - 26 console statements across 3 files replaced with environment-aware logger
    - Line 232 PII dump eliminated (logs count only, never message content)
    - All debug logging suppressed in production via logger.ts
    - No functional behavior changed (logging is observational only)
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix type safety bypasses in export functions (SEC-05)</name>
  <files>
    src/lib/export-utils.ts
    src/components/transcript-library/BulkActionToolbarEnhanced.tsx
  </files>
  <action>
    Fix 7 `as any` casts in BulkActionToolbarEnhanced.tsx by updating the types to be correct.

    **Step 1: Update export-utils.ts to accept Meeting[]**

    Read `src/lib/export-utils.ts` and find the `Call` type/interface (it's a local unexported type). The export functions (`exportToPDF`, `exportToDOCX`, `exportToTXT`, `exportToJSON`, `exportToZIP`) expect `Call[]`.

    Read `src/types/meetings.ts` and find the `Meeting` type.

    Update `export-utils.ts`:
    - Import `Meeting` from `@/types/meetings`
    - Change each export function signature to accept `Meeting[]` instead of `Call[]` (or create a union `Call | Meeting` type, or use `Meeting[]` directly since `Meeting` is the actual runtime type)
    - The `Call` interface is local to export-utils.ts and is only used by these functions. The simplest fix: replace `Call` with `Meeting` throughout, importing from `@/types/meetings`
    - If `Call` has fields that `Meeting` doesn't, create a mapped type or adapter. Per research, `Meeting` has ALL fields that `Call` has (with slightly different nullability). The key difference is `recording_id: string | number` (Meeting) vs `number` (Call) — make the export functions handle both.

    **Step 2: Remove `as any` from export calls in BulkActionToolbarEnhanced.tsx**

    Lines 55-67: Remove `as any[]` from all 5 export function calls:
    ```typescript
    // BEFORE
    await exportToPDF(selectedCalls as any[]);
    // AFTER
    await exportToPDF(selectedCalls);
    ```

    **Step 3: Fix API response type casts (lines 132, 187)**

    For line 132 (`generateAiTitles` response):
    - Check what `generateAiTitles` actually returns (look at the function in api-client.ts or wherever it's defined)
    - Define a proper response type (e.g., `{ titles: Record<string, string> }` or whatever the actual shape is)
    - Replace `const responseData = data as any` with properly typed access

    For line 187 (`autoTagCalls` response):
    - Same approach: check actual return type, define interface, remove `as any`

    IMPORTANT: Do NOT introduce new `as any` casts to fix existing ones. If a type is genuinely complex, use a properly defined interface even if verbose.
  </action>
  <verify>
    - `grep -n "as any" src/components/transcript-library/BulkActionToolbarEnhanced.tsx` returns NO matches (zero `as any` casts)
    - `grep -n "Meeting" src/lib/export-utils.ts` confirms Meeting type is imported/used
    - `npx tsc --noEmit` — no new errors (this is critical — type changes must compile)
  </verify>
  <done>
    - All 7 `as any` casts eliminated from BulkActionToolbarEnhanced.tsx
    - Export functions properly typed to accept Meeting[] (the actual runtime type)
    - API response types properly defined (no more untyped data access)
    - TypeScript compiler validates all type relationships
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -rn "console\\.log\|console\\.warn" src/contexts/AuthContext.tsx src/pages/Chat.tsx src/hooks/useChatSession.ts` — zero matches
2. `grep -n "as any" src/components/transcript-library/BulkActionToolbarEnhanced.tsx` — zero matches
3. `grep "JSON.stringify(messagesToInsert" src/hooks/useChatSession.ts` — zero matches (PII dump gone)
4. `npx tsc --noEmit` — no new TypeScript errors
</verification>

<success_criteria>
- Zero console.log/warn statements in AuthContext.tsx, Chat.tsx, useChatSession.ts
- Line 232 PII dump (full message JSON.stringify) eliminated
- All logging uses environment-aware logger (suppressed in production)
- Zero `as any` casts in BulkActionToolbarEnhanced.tsx
- Export functions properly typed for Meeting[]
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-lockdown/01-02-SUMMARY.md`
</output>
