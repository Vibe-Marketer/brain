---
phase: 01-security-lockdown
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai-agent.ts
  - src/hooks/useAIProcessing.ts
  - src/components/loop/ContentGenerator.tsx
  - supabase/functions/extract-knowledge/index.ts
  - supabase/functions/generate-content/index.ts
  - supabase/functions/test-env-vars/index.ts
  - supabase/functions/test-secrets/index.ts
autonomous: true

must_haves:
  truths:
    - "No API keys visible in browser DevTools or source code"
    - "No unauthenticated edge functions accessible to public"
    - "Test/debug endpoints only accessible to admin users"
  artifacts:
    - path: "src/lib/ai-agent.ts"
      provides: "DELETED — client-side API key exposure removed"
      exists: false
    - path: "src/hooks/useAIProcessing.ts"
      provides: "DELETED — wrapper for deleted ai-agent"
      exists: false
    - path: "supabase/functions/extract-knowledge/"
      provides: "DELETED — legacy unauthenticated function"
      exists: false
    - path: "supabase/functions/generate-content/"
      provides: "DELETED — legacy unauthenticated function"
      exists: false
    - path: "supabase/functions/test-env-vars/"
      provides: "DELETED — dangerous credential-exposing debug tool"
      exists: false
    - path: "supabase/functions/test-secrets/index.ts"
      provides: "Admin-only access via user_roles check"
      contains: "user_roles"
  key_links:
    - from: "src/components/loop/ContentGenerator.tsx"
      to: "NONE (ai-agent.ts deleted)"
      via: "Import removed or type moved inline"
      pattern: "no import.*ai-agent"
---

<objective>
Eliminate the three highest-severity security vulnerabilities: client-side API key exposure (SEC-01), unauthenticated edge functions (SEC-02), and open debug endpoints exposing full credentials (SEC-03).

Purpose: These are the most dangerous vulnerabilities — SEC-01 exposes an API key in browser source, SEC-02 allows unauthenticated function invocation, and SEC-03 exposes the full SUPABASE_SERVICE_ROLE_KEY and database URL to anyone who hits the endpoint. All must be eliminated before any feature work.

Output: Dead code deleted, dangerous functions removed, test-secrets secured with admin role check.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-lockdown/01-RESEARCH.md

Key source files:
@src/lib/ai-agent.ts
@src/hooks/useAIProcessing.ts
@src/components/loop/ContentGenerator.tsx
@supabase/functions/extract-knowledge/index.ts
@supabase/functions/generate-content/index.ts
@supabase/functions/test-env-vars/index.ts
@supabase/functions/test-secrets/index.ts
@supabase/functions/get-available-models/index.ts (admin check pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete client-side API key code and legacy unauthenticated functions (SEC-01 + SEC-02)</name>
  <files>
    src/lib/ai-agent.ts
    src/hooks/useAIProcessing.ts
    src/components/loop/ContentGenerator.tsx
    supabase/functions/extract-knowledge/index.ts
    supabase/functions/generate-content/index.ts
  </files>
  <action>
    1. Delete `src/lib/ai-agent.ts` entirely — this file exposes `VITE_OPENAI_API_KEY` on line 13 via `import.meta.env`. It's dead code (all functionality duplicated by edge functions).

    2. Delete `src/hooks/useAIProcessing.ts` entirely — wrapper hook for ai-agent.ts, also dead code.

    3. Fix `src/components/loop/ContentGenerator.tsx`:
       - Remove the import of `ExtractedInsight` from `@/lib/ai-agent`
       - Remove the import of `useAIProcessing` from `@/hooks/useAIProcessing`
       - Check if `ExtractedInsight` type is used in the component. If yes, define the type inline in ContentGenerator.tsx (it's a simple interface with fields like `topic`, `insight`, `source`, `confidence`). If the component itself is dead code (not rendered in any route), delete the entire file.
       - To check if ContentGenerator.tsx is dead code: grep for `ContentGenerator` in `src/` — if only self-references, delete it.

    4. Delete the entire `supabase/functions/extract-knowledge/` directory — no frontend callers (verified by grep), zero auth, legacy function superseded by content-classifier/content-insight-miner pipeline.

    5. Delete the entire `supabase/functions/generate-content/` directory — no frontend callers (verified by grep), zero auth, legacy function superseded by content-builder pipeline.

    IMPORTANT: Do NOT delete any other files. Do NOT modify any other edge functions. Only touch the 5 files listed above (plus ContentGenerator.tsx fix).
  </action>
  <verify>
    - `grep -r "VITE_OPENAI_API_KEY" src/` returns NO matches (only docs/archive may have references)
    - `grep -r "ai-agent" src/` returns NO matches (unless ContentGenerator was kept and type was moved)
    - `grep -r "useAIProcessing" src/` returns NO matches
    - `ls supabase/functions/extract-knowledge/` returns "No such file or directory"
    - `ls supabase/functions/generate-content/` returns "No such file or directory"
    - `npx tsc --noEmit` passes (or at minimum, no NEW errors introduced)
  </verify>
  <done>
    - ai-agent.ts deleted (no client-side API key exposure)
    - useAIProcessing.ts deleted (dead hook removed)
    - ContentGenerator.tsx cleaned up (no broken imports) or deleted if dead code
    - extract-knowledge/ directory deleted (no unauthenticated function)
    - generate-content/ directory deleted (no unauthenticated function)
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete test-env-vars and add admin check to test-secrets (SEC-03)</name>
  <files>
    supabase/functions/test-env-vars/index.ts
    supabase/functions/test-secrets/index.ts
  </files>
  <action>
    1. Delete the entire `supabase/functions/test-env-vars/` directory. This function:
       - Has ZERO authentication
       - Exposes the FULL SUPABASE_SERVICE_ROLE_KEY (not truncated)
       - Exposes the FULL SUPABASE_DB_URL
       - Has a `?action=export` mode that dumps the entire database
       - Self-documents as "DELETE AFTER USE"
       Do NOT attempt to secure it — delete it entirely.

    2. Add admin role check to `supabase/functions/test-secrets/index.ts`:
       - The function already has basic auth (validates Bearer token via `supabase.auth.getUser(token)`)
       - After the existing user validation, add an admin role check using the pattern from `get-available-models`:
         ```typescript
         const { data: roleData } = await supabaseClient
           .from('user_roles')
           .select('role')
           .eq('user_id', user.id)
           .maybeSingle();

         const isAdmin = roleData?.role === 'ADMIN';
         if (!isAdmin) {
           return new Response(
             JSON.stringify({ error: 'Admin access required' }),
             { status: 403, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
           );
         }
         ```
       - The supabaseClient used must be created with the service role key (since RLS would block non-admin reads of user_roles). The function already creates a service-level client — use that for the role query.
       - Place the admin check AFTER the user auth check but BEFORE any secret retrieval logic.
  </action>
  <verify>
    - `ls supabase/functions/test-env-vars/` returns "No such file or directory"
    - `grep -n "user_roles" supabase/functions/test-secrets/index.ts` returns the admin check line
    - `grep -n "Admin access required" supabase/functions/test-secrets/index.ts` returns the 403 response
    - Read test-secrets/index.ts and confirm the admin check is placed BEFORE any secret retrieval
  </verify>
  <done>
    - test-env-vars/ directory deleted (no credential-exposing endpoint exists)
    - test-secrets requires admin role to access (non-admin users get 403)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -r "VITE_OPENAI_API_KEY" src/` — zero matches
2. `ls supabase/functions/extract-knowledge/ supabase/functions/generate-content/ supabase/functions/test-env-vars/ 2>&1` — all return "No such file or directory"
3. `grep "user_roles" supabase/functions/test-secrets/index.ts` — confirms admin check exists
4. `npx tsc --noEmit` — no new TypeScript errors introduced
</verification>

<success_criteria>
- No API keys visible in browser source code (VITE_OPENAI_API_KEY eliminated)
- Legacy unauthenticated edge functions (extract-knowledge, generate-content) deleted
- test-env-vars (full credential exposure + DB export) deleted entirely
- test-secrets requires admin role check before returning any data
- No build errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-lockdown/01-01-SUMMARY.md`
</output>
