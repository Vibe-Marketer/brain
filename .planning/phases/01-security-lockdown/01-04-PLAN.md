---
phase: 01-security-lockdown
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/functions/auto-tag-calls/index.ts
  - supabase/functions/automation-email/index.ts
  - supabase/functions/automation-engine/index.ts
  - supabase/functions/automation-scheduler/index.ts
  - supabase/functions/automation-sentiment/index.ts
  - supabase/functions/automation-webhook/index.ts
  - supabase/functions/backfill-chunk-metadata/index.ts
  - supabase/functions/chat-stream/index.ts
  - supabase/functions/create-fathom-webhook/index.ts
  - supabase/functions/delete-all-calls/index.ts
  - supabase/functions/embed-chunks/index.ts
  - supabase/functions/enrich-chunk-metadata/index.ts
  - supabase/functions/fathom-oauth-callback/index.ts
  - supabase/functions/fathom-oauth-refresh/index.ts
  - supabase/functions/fathom-oauth-url/index.ts
  - supabase/functions/fetch-meetings/index.ts
  - supabase/functions/fetch-single-meeting/index.ts
  - supabase/functions/generate-ai-titles/index.ts
  - supabase/functions/generate-meta-summary/index.ts
  - supabase/functions/get-config-status/index.ts
  - supabase/functions/google-meet-fetch-meetings/index.ts
  - supabase/functions/google-meet-sync-meetings/index.ts
  - supabase/functions/google-oauth-callback/index.ts
  - supabase/functions/google-oauth-refresh/index.ts
autonomous: true

must_haves:
  truths:
    - "First 24 Group C edge functions use getCorsHeaders() with dynamic origin checking"
    - "No inline wildcard CORS headers remain in these functions"
  artifacts:
    - path: "supabase/functions/chat-stream/index.ts"
      provides: "Dynamic CORS via getCorsHeaders(origin)"
      contains: "getCorsHeaders"
    - path: "supabase/functions/delete-all-calls/index.ts"
      provides: "Dynamic CORS via getCorsHeaders(origin)"
      contains: "getCorsHeaders"
    - path: "supabase/functions/fetch-meetings/index.ts"
      provides: "Dynamic CORS via getCorsHeaders(origin)"
      contains: "getCorsHeaders"
  key_links:
    - from: "All 24 functions in this batch"
      to: "supabase/functions/_shared/cors.ts"
      via: "import { getCorsHeaders }"
      pattern: "getCorsHeaders"
---

<objective>
Migrate first 24 Group C edge functions from inline wildcard CORS to dynamic `getCorsHeaders()` (SEC-06, part 2 of 3).

Purpose: These functions define inline `const corsHeaders = { 'Access-Control-Allow-Origin': '*', ... }` and need full migration to `getCorsHeaders()` from `_shared/cors.ts`. This batch covers functions A-G alphabetically (auto-tag-calls through google-oauth-refresh).

Output: 24 functions migrated to dynamic CORS origin checking.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-lockdown/01-RESEARCH.md

Key reference:
@supabase/functions/_shared/cors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate functions auto-tag-calls through fetch-single-meeting (17 functions)</name>
  <files>
    supabase/functions/auto-tag-calls/index.ts
    supabase/functions/automation-email/index.ts
    supabase/functions/automation-engine/index.ts
    supabase/functions/automation-scheduler/index.ts
    supabase/functions/automation-sentiment/index.ts
    supabase/functions/automation-webhook/index.ts
    supabase/functions/backfill-chunk-metadata/index.ts
    supabase/functions/chat-stream/index.ts
    supabase/functions/create-fathom-webhook/index.ts
    supabase/functions/delete-all-calls/index.ts
    supabase/functions/embed-chunks/index.ts
    supabase/functions/enrich-chunk-metadata/index.ts
    supabase/functions/fathom-oauth-callback/index.ts
    supabase/functions/fathom-oauth-refresh/index.ts
    supabase/functions/fathom-oauth-url/index.ts
    supabase/functions/fetch-meetings/index.ts
    supabase/functions/fetch-single-meeting/index.ts
  </files>
  <action>
    For EACH of the 17 functions, apply this migration pattern:

    **Step 1: Remove inline CORS constant**
    Find and delete the inline definition (usually near top of file):
    ```typescript
    // DELETE THIS (exact text varies slightly per function)
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    };
    ```
    Note: Some functions may have slightly different headers (e.g., including `sentry-trace`, `baggage`). Delete regardless — `getCorsHeaders()` returns a standardized set.

    **Step 2: Add import at top of file**
    ```typescript
    import { getCorsHeaders } from '../_shared/cors.ts';
    ```

    **Step 3: Extract origin at handler entry**
    Inside the request handler (`serve(async (req) => {` or `Deno.serve(async (req) => {`), add at the very beginning:
    ```typescript
    const origin = req.headers.get('Origin');
    const headers = getCorsHeaders(origin);
    ```

    **Step 4: Replace all `corsHeaders` references with `headers`**
    Every place in the function body that uses `corsHeaders` must change to `headers`:
    ```typescript
    // OPTIONS handler
    return new Response(null, { headers });
    // Success responses
    return new Response(body, { headers: { ...headers, 'Content-Type': 'application/json' } });
    // Error responses
    { status: 401, headers: { ...headers, 'Content-Type': 'application/json' } }
    ```

    **SPECIAL CASES:**
    - `chat-stream/index.ts`: May have streaming response headers (SSE). Ensure the CORS headers are included in the streaming response as well. Look for `'Content-Type': 'text/event-stream'` responses and include `...headers` in those too.
    - `automation-engine/index.ts`: May have multiple files (index.ts + actions.ts). Only the index.ts needs CORS migration — actions.ts is internal logic.
    - Some functions may define `corsHeaders` in a helper function or differently — read each file and adapt.

    IMPORTANT: Do NOT change any business logic. Only change CORS handling.
  </action>
  <verify>
    - For each of the 17 functions: `grep -c "getCorsHeaders" supabase/functions/{name}/index.ts` returns >= 2 (import + usage)
    - `grep "'Access-Control-Allow-Origin': '\\*'" supabase/functions/auto-tag-calls/index.ts supabase/functions/chat-stream/index.ts supabase/functions/delete-all-calls/index.ts` returns NO matches
    - Spot-check chat-stream to verify SSE response includes dynamic headers
  </verify>
  <done>
    - 17 functions migrated from inline wildcard CORS to getCorsHeaders(origin)
    - All inline `const corsHeaders = { ... '*' ... }` removed
    - All responses use dynamic origin checking
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate functions generate-ai-titles through google-oauth-refresh (7 functions)</name>
  <files>
    supabase/functions/generate-ai-titles/index.ts
    supabase/functions/generate-meta-summary/index.ts
    supabase/functions/get-config-status/index.ts
    supabase/functions/google-meet-fetch-meetings/index.ts
    supabase/functions/google-meet-sync-meetings/index.ts
    supabase/functions/google-oauth-callback/index.ts
    supabase/functions/google-oauth-refresh/index.ts
  </files>
  <action>
    Apply the same migration pattern as Task 1:
    1. Remove inline `const corsHeaders = { 'Access-Control-Allow-Origin': '*', ... }`
    2. Add `import { getCorsHeaders } from '../_shared/cors.ts';`
    3. Extract `const origin = req.headers.get('Origin'); const headers = getCorsHeaders(origin);` at handler entry
    4. Replace all `corsHeaders` references with `headers`

    **SPECIAL CASES:**
    - `google-oauth-callback/index.ts`: OAuth callbacks redirect rather than return JSON. The CORS headers may only be needed for the OPTIONS preflight and error responses. Check if the success path does a redirect (`Response.redirect()` or `301/302` status) — if so, CORS headers aren't needed on the redirect response itself, only on error responses and OPTIONS.
    - Same applies to `google-meet-*` functions — check if they are invoked server-to-server (no CORS needed) vs from browser (CORS needed). If they have OPTIONS handling, they're browser-called and need CORS.

    IMPORTANT: Do NOT change any business logic. Only change CORS handling.
  </action>
  <verify>
    - For each of the 7 functions: `grep -c "getCorsHeaders" supabase/functions/{name}/index.ts` returns >= 2
    - `grep "'Access-Control-Allow-Origin': '\\*'" supabase/functions/generate-ai-titles/index.ts supabase/functions/google-oauth-callback/index.ts` returns NO matches
  </verify>
  <done>
    - 7 more functions migrated from inline wildcard CORS to getCorsHeaders(origin)
    - Total migrated so far (with Plan 03): 14 (Group B) + 24 (Group C batch 1) = 38 functions
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -rl "getCorsHeaders" supabase/functions/ --include="*.ts" | grep -v _shared | wc -l` — should be >= 38 (14 from Plan 03 + 24 from this plan)
2. Spot-check 3 functions from this batch to verify the pattern is correct
3. No function in this batch should contain `'Access-Control-Allow-Origin': '*'` as an inline constant
</verification>

<success_criteria>
- All 24 Group C batch 1 functions import and use getCorsHeaders(origin)
- No inline wildcard CORS constants remain in these functions
- CORS headers are included in all response types (success, error, OPTIONS, streaming)
- Zero business logic changes
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-lockdown/01-04-SUMMARY.md`
</output>
