---
phase: 01-security-lockdown
plan: 06
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03", "01-04", "01-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "No API keys visible in browser DevTools or source code"
    - "All edge functions require authentication"
    - "Test/debug endpoints only accessible to admin users"
    - "No console.log statements exposing PII"
    - "Export functions use properly typed interfaces (no any casting)"
    - "All production Edge Functions use getCorsHeaders() with dynamic origin checking"
    - "Security audit passes with zero critical findings"
  artifacts: []
  key_links: []
---

<objective>
Final security audit and verification of all Phase 1 requirements (SEC-01 through SEC-06).

Purpose: Verify that all 6 security requirements are fully satisfied before marking Phase 1 complete. This is the gate between Security Lockdown and the rest of the roadmap — nothing proceeds until this passes.

Output: Verified security posture, all 7 success criteria confirmed.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-lockdown/01-RESEARCH.md
@.planning/phases/01-security-lockdown/01-01-SUMMARY.md
@.planning/phases/01-security-lockdown/01-02-SUMMARY.md
@.planning/phases/01-security-lockdown/01-03-SUMMARY.md
@.planning/phases/01-security-lockdown/01-04-SUMMARY.md
@.planning/phases/01-security-lockdown/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run comprehensive security audit</name>
  <files></files>
  <action>
    Run all verification checks for SEC-01 through SEC-06. This is a read-only audit — no code changes.

    **SEC-01: No client-side API keys**
    ```bash
    grep -r "VITE_OPENAI_API_KEY" src/
    grep -r "VITE_.*KEY" src/ --include="*.ts" --include="*.tsx" | grep -v ".d.ts" | grep -v "node_modules"
    ```
    Expected: Zero matches (no API keys in frontend source)

    **SEC-02: No unauthenticated legacy functions**
    ```bash
    ls supabase/functions/extract-knowledge/ 2>&1
    ls supabase/functions/generate-content/ 2>&1
    ```
    Expected: "No such file or directory" for both

    **SEC-03: Admin-only test endpoints**
    ```bash
    ls supabase/functions/test-env-vars/ 2>&1
    grep "user_roles" supabase/functions/test-secrets/index.ts
    grep "Admin access required" supabase/functions/test-secrets/index.ts
    ```
    Expected: test-env-vars deleted, test-secrets has admin check

    **SEC-04: No PII logging**
    ```bash
    grep -n "console\\.log\|console\\.warn" src/contexts/AuthContext.tsx src/pages/Chat.tsx src/hooks/useChatSession.ts
    grep "JSON.stringify(messagesToInsert" src/hooks/useChatSession.ts
    ```
    Expected: Zero matches for console statements, zero matches for PII dump

    **SEC-05: No type safety bypasses**
    ```bash
    grep -c "as any" src/components/transcript-library/BulkActionToolbarEnhanced.tsx
    ```
    Expected: 0

    **SEC-06: No wildcard CORS**
    ```bash
    grep -rl "'Access-Control-Allow-Origin': '\\*'" supabase/functions/ --include="*.ts"
    grep -rl "const corsHeaders" supabase/functions/ --include="*.ts" | grep -v _shared
    grep -rl "getCorsHeaders" supabase/functions/ --include="*.ts" | grep -v _shared | wc -l
    ```
    Expected: Zero wildcard matches, zero inline corsHeaders, 61 functions using getCorsHeaders

    **Build verification:**
    ```bash
    npx tsc --noEmit 2>&1 | head -50
    ```
    Expected: No NEW errors introduced (pre-existing errors in unrelated files are acceptable)

    Record all findings in the summary.
  </action>
  <verify>
    All 7 success criteria from ROADMAP.md pass:
    1. No API keys visible in browser DevTools or source code ✓
    2. All edge functions require authentication ✓
    3. Test/debug endpoints only accessible to admin users ✓
    4. No console.log statements exposing PII ✓
    5. Export functions use properly typed interfaces ✓
    6. All production Edge Functions use getCorsHeaders() with dynamic origin checking ✓
    7. Security audit passes with zero critical findings ✓
  </verify>
  <done>
    Security audit complete with all 7 success criteria verified.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete security lockdown of the CallVault codebase:
    - Deleted client-side API key exposure (ai-agent.ts, useAIProcessing.ts)
    - Deleted legacy unauthenticated edge functions (extract-knowledge, generate-content)
    - Deleted dangerous test-env-vars function (full credential exposure)
    - Added admin role check to test-secrets
    - Replaced 26 console.log/warn statements with environment-aware logger
    - Eliminated critical PII dump (line 232 useChatSession.ts)
    - Fixed 7 type safety bypasses (as any → proper types)
    - Migrated all 61 edge functions from wildcard CORS to dynamic origin checking
  </what-built>
  <how-to-verify>
    1. Open the app at http://localhost:8080 in browser
    2. Open DevTools → Sources tab, search for "VITE_OPENAI_API_KEY" — should not appear
    3. Open DevTools → Console, perform a few chat interactions — verify no PII (message content) appears in console
    4. Navigate through the app (transcript library, exports, chat) — verify no functionality is broken
    5. Check that the build succeeds: `npm run build` in terminal
    6. OPTIONAL: Verify edge functions still work by testing a normal chat message or meeting sync
  </how-to-verify>
  <resume-signal>Type "approved" if security lockdown looks good, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 1 is complete when:
- All 7 success criteria verified by automated audit
- Human verification confirms no broken functionality
- Build succeeds
</verification>

<success_criteria>
All Phase 1 success criteria from ROADMAP.md verified:
1. No API keys visible in browser DevTools or source code
2. All edge functions require authentication (no unauthenticated endpoints exposed)
3. Test/debug endpoints only accessible to admin users
4. No console.log statements exposing PII (session data, auth tokens, message content)
5. Export functions use properly typed interfaces (no `any` casting)
6. All production Edge Functions use `getCorsHeaders()` with dynamic origin checking (no wildcard `*`)
7. Security audit passes with zero critical findings
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-lockdown/01-06-SUMMARY.md`
</output>
