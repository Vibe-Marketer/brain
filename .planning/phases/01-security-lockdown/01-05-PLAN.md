---
phase: 01-security-lockdown
plan: 05
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/functions/google-oauth-url/index.ts
  - supabase/functions/google-poll-sync/index.ts
  - supabase/functions/process-embeddings/index.ts
  - supabase/functions/rerank-results/index.ts
  - supabase/functions/resync-all-calls/index.ts
  - supabase/functions/retry-failed-embeddings/index.ts
  - supabase/functions/save-fathom-key/index.ts
  - supabase/functions/save-host-email/index.ts
  - supabase/functions/save-webhook-secret/index.ts
  - supabase/functions/semantic-search/index.ts
  - supabase/functions/send-coach-invite/index.ts
  - supabase/functions/sync-meetings/index.ts
  - supabase/functions/sync-openrouter-models/index.ts
  - supabase/functions/test-fathom-connection/index.ts
  - supabase/functions/test-secrets/index.ts
  - supabase/functions/webhook/index.ts
  - supabase/functions/youtube-api/index.ts
  - supabase/functions/zoom-fetch-meetings/index.ts
  - supabase/functions/zoom-oauth-callback/index.ts
  - supabase/functions/zoom-oauth-refresh/index.ts
  - supabase/functions/zoom-oauth-url/index.ts
  - supabase/functions/zoom-sync-meetings/index.ts
  - supabase/functions/zoom-webhook/index.ts
autonomous: true

must_haves:
  truths:
    - "All remaining Group C edge functions use getCorsHeaders() with dynamic origin checking"
    - "No edge function in the entire codebase contains inline wildcard CORS"
    - "All production Edge Functions use getCorsHeaders() with dynamic origin checking"
  artifacts:
    - path: "supabase/functions/semantic-search/index.ts"
      provides: "Dynamic CORS via getCorsHeaders(origin)"
      contains: "getCorsHeaders"
    - path: "supabase/functions/webhook/index.ts"
      provides: "Dynamic CORS via getCorsHeaders(origin)"
      contains: "getCorsHeaders"
    - path: "supabase/functions/zoom-oauth-url/index.ts"
      provides: "Dynamic CORS via getCorsHeaders(origin)"
      contains: "getCorsHeaders"
  key_links:
    - from: "All 23 functions in this batch"
      to: "supabase/functions/_shared/cors.ts"
      via: "import { getCorsHeaders }"
      pattern: "getCorsHeaders"
---

<objective>
Migrate remaining 23 Group C edge functions from inline wildcard CORS to dynamic `getCorsHeaders()` (SEC-06, part 3 of 3).

Purpose: This completes the CORS migration across the entire codebase. After this plan, all 61 production edge functions (14 Group B + 47 Group C) will use dynamic origin checking via `getCorsHeaders()`. Combined with the `ALLOWED_ORIGINS` env var, this eliminates the wildcard CORS vulnerability.

Output: All edge functions migrated. SEC-06 complete. Zero functions with wildcard CORS remaining.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-lockdown/01-RESEARCH.md

Key reference:
@supabase/functions/_shared/cors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate functions google-oauth-url through send-coach-invite (11 functions)</name>
  <files>
    supabase/functions/google-oauth-url/index.ts
    supabase/functions/google-poll-sync/index.ts
    supabase/functions/process-embeddings/index.ts
    supabase/functions/rerank-results/index.ts
    supabase/functions/resync-all-calls/index.ts
    supabase/functions/retry-failed-embeddings/index.ts
    supabase/functions/save-fathom-key/index.ts
    supabase/functions/save-host-email/index.ts
    supabase/functions/save-webhook-secret/index.ts
    supabase/functions/semantic-search/index.ts
    supabase/functions/send-coach-invite/index.ts
  </files>
  <action>
    Apply the standard CORS migration pattern to each function:

    1. Remove inline `const corsHeaders = { 'Access-Control-Allow-Origin': '*', ... }`
    2. Add `import { getCorsHeaders } from '../_shared/cors.ts';`
    3. Extract `const origin = req.headers.get('Origin'); const headers = getCorsHeaders(origin);` at handler entry
    4. Replace all `corsHeaders` references with `headers`

    **SPECIAL CASES:**
    - `semantic-search/index.ts`: This is a performance-critical function used by RAG chat. Extra care — verify the CORS header change doesn't affect the response structure. The function returns search results; only the CORS headers change, not the body.
    - `process-embeddings/index.ts` and `retry-failed-embeddings/index.ts`: These may be cron-triggered (no browser origin). If they have OPTIONS handling, they're also browser-callable. Apply the migration regardless — `getCorsHeaders()` handles null origin gracefully (returns `*` if ALLOWED_ORIGINS not set).
    - `google-poll-sync/index.ts`: May be a cron job. Same as above — apply migration if CORS headers exist.

    IMPORTANT: Do NOT change any business logic. Only change CORS handling.
  </action>
  <verify>
    - For each of the 11 functions: `grep -c "getCorsHeaders" supabase/functions/{name}/index.ts` returns >= 2
    - `grep "'Access-Control-Allow-Origin': '\\*'" supabase/functions/semantic-search/index.ts supabase/functions/save-fathom-key/index.ts` returns NO matches
  </verify>
  <done>
    - 11 functions migrated from inline wildcard CORS to getCorsHeaders(origin)
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate functions sync-meetings through zoom-webhook (12 functions)</name>
  <files>
    supabase/functions/sync-meetings/index.ts
    supabase/functions/sync-openrouter-models/index.ts
    supabase/functions/test-fathom-connection/index.ts
    supabase/functions/test-secrets/index.ts
    supabase/functions/webhook/index.ts
    supabase/functions/youtube-api/index.ts
    supabase/functions/zoom-fetch-meetings/index.ts
    supabase/functions/zoom-oauth-callback/index.ts
    supabase/functions/zoom-oauth-refresh/index.ts
    supabase/functions/zoom-oauth-url/index.ts
    supabase/functions/zoom-sync-meetings/index.ts
    supabase/functions/zoom-webhook/index.ts
  </files>
  <action>
    Apply the standard CORS migration pattern to each function:

    1. Remove inline `const corsHeaders = { 'Access-Control-Allow-Origin': '*', ... }`
    2. Add `import { getCorsHeaders } from '../_shared/cors.ts';`
    3. Extract `const origin = req.headers.get('Origin'); const headers = getCorsHeaders(origin);` at handler entry
    4. Replace all `corsHeaders` references with `headers`

    **SPECIAL CASES:**
    - `test-secrets/index.ts`: This function was already modified in Plan 01 (admin auth check added). It currently has inline CORS. Apply the same migration — replace inline corsHeaders with getCorsHeaders import. The admin check from Plan 01 should already be in place; just migrate the CORS portion.
    - `webhook/index.ts` and `zoom-webhook/index.ts`: Webhook receivers from external services (Fathom, Zoom). These are called server-to-server, not from browsers. They may still have CORS headers for consistency. Apply the migration — getCorsHeaders() with null origin will behave correctly.
    - `zoom-oauth-callback/index.ts`: Same as google-oauth-callback — may redirect on success. Ensure CORS headers on error responses and OPTIONS only.

    IMPORTANT: Do NOT change any business logic. Only change CORS handling.
  </action>
  <verify>
    - For each of the 12 functions: `grep -c "getCorsHeaders" supabase/functions/{name}/index.ts` returns >= 2
    - `grep "'Access-Control-Allow-Origin': '\\*'" supabase/functions/test-secrets/index.ts supabase/functions/webhook/index.ts supabase/functions/zoom-webhook/index.ts` returns NO matches
    - FINAL VERIFICATION: `grep -rl "'Access-Control-Allow-Origin': '\\*'" supabase/functions/ --include="*.ts" | grep -v _shared` returns ZERO matches across entire functions directory (excluding _shared/cors.ts which should also be clean after Plan 03)
  </verify>
  <done>
    - 12 final functions migrated from inline wildcard CORS to getCorsHeaders(origin)
    - FULL SEC-06 COMPLETE: All 61 production edge functions now use getCorsHeaders()
    - Zero inline wildcard CORS definitions remain anywhere in supabase/functions/
  </done>
</task>

</tasks>

<verification>
After both tasks complete — FULL SEC-06 VERIFICATION:
1. `grep -rl "getCorsHeaders" supabase/functions/ --include="*.ts" | grep -v _shared | wc -l` — should be 61 (14 Group B + 47 Group C)
2. `grep -rl "'Access-Control-Allow-Origin': '\\*'" supabase/functions/ --include="*.ts"` — should return ZERO matches (including _shared/cors.ts after Plan 03 cleanup)
3. `grep -rl "const corsHeaders" supabase/functions/ --include="*.ts" | grep -v _shared` — should return ZERO matches (no inline CORS constants)
4. Every function has: import getCorsHeaders, origin extraction, headers variable used in all responses
</verification>

<success_criteria>
- All 23 remaining Group C functions migrated to getCorsHeaders(origin)
- COMPLETE: All 61 production edge functions use dynamic CORS
- Zero inline wildcard CORS constants in any edge function
- Zero references to 'Access-Control-Allow-Origin': '*' anywhere in supabase/functions/
- SEC-06 fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-lockdown/01-05-SUMMARY.md`
</output>
