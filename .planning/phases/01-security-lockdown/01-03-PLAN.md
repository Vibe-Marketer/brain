---
phase: 01-security-lockdown
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/functions/_shared/cors.ts
  - supabase/functions/coach-notes/index.ts
  - supabase/functions/coach-relationships/index.ts
  - supabase/functions/coach-shares/index.ts
  - supabase/functions/content-builder/index.ts
  - supabase/functions/content-classifier/index.ts
  - supabase/functions/content-hook-generator/index.ts
  - supabase/functions/content-insight-miner/index.ts
  - supabase/functions/get-available-models/index.ts
  - supabase/functions/manager-notes/index.ts
  - supabase/functions/share-call/index.ts
  - supabase/functions/team-direct-reports/index.ts
  - supabase/functions/team-memberships/index.ts
  - supabase/functions/team-shares/index.ts
  - supabase/functions/teams/index.ts
autonomous: true

must_haves:
  truths:
    - "All Group B edge functions use getCorsHeaders() with dynamic origin checking"
    - "No edge function imports the wildcard corsHeaders constant"
  artifacts:
    - path: "supabase/functions/_shared/cors.ts"
      provides: "getCorsHeaders() function (already exists), corsHeaders removed after migration"
    - path: "supabase/functions/coach-notes/index.ts"
      provides: "Dynamic CORS via getCorsHeaders(origin)"
      contains: "getCorsHeaders"
    - path: "supabase/functions/teams/index.ts"
      provides: "Dynamic CORS via getCorsHeaders(origin)"
      contains: "getCorsHeaders"
  key_links:
    - from: "All 14 Group B functions"
      to: "supabase/functions/_shared/cors.ts"
      via: "import { getCorsHeaders }"
      pattern: "getCorsHeaders"
---

<objective>
Migrate 14 Group B edge functions from wildcard `corsHeaders` import to dynamic `getCorsHeaders()` (SEC-06, part 1 of 3).

Purpose: These 14 functions already import from `_shared/cors.ts` but use the `corsHeaders` constant which hardcodes `Access-Control-Allow-Origin: '*'`. Migrating them to `getCorsHeaders()` enables dynamic origin checking. This is the simplest batch since they already have the import — just need to change which export they use.

Output: All 14 Group B functions use `getCorsHeaders(origin)` with request origin extraction.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-lockdown/01-RESEARCH.md

Key source files:
@supabase/functions/_shared/cors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate 14 Group B functions to getCorsHeaders()</name>
  <files>
    supabase/functions/coach-notes/index.ts
    supabase/functions/coach-relationships/index.ts
    supabase/functions/coach-shares/index.ts
    supabase/functions/content-builder/index.ts
    supabase/functions/content-classifier/index.ts
    supabase/functions/content-hook-generator/index.ts
    supabase/functions/content-insight-miner/index.ts
    supabase/functions/get-available-models/index.ts
    supabase/functions/manager-notes/index.ts
    supabase/functions/share-call/index.ts
    supabase/functions/team-direct-reports/index.ts
    supabase/functions/team-memberships/index.ts
    supabase/functions/team-shares/index.ts
    supabase/functions/teams/index.ts
  </files>
  <action>
    For EACH of the 14 functions, apply this migration pattern:

    **Step 1: Change the import**
    ```typescript
    // BEFORE
    import { corsHeaders } from '../_shared/cors.ts';
    // AFTER
    import { getCorsHeaders } from '../_shared/cors.ts';
    ```

    **Step 2: Extract origin at handler entry**
    Add at the very beginning of the request handler (inside `serve(async (req) => {` or `Deno.serve(async (req) => {`):
    ```typescript
    const origin = req.headers.get('Origin');
    const headers = getCorsHeaders(origin);
    ```

    **Step 3: Replace all `corsHeaders` references with `headers`**
    Find every usage of `corsHeaders` in the function body and replace:
    ```typescript
    // BEFORE (various patterns found in these functions)
    return new Response(null, { headers: corsHeaders });
    return new Response(body, { headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
    { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }

    // AFTER
    return new Response(null, { headers });
    return new Response(body, { headers: { ...headers, 'Content-Type': 'application/json' } });
    { status: 401, headers: { ...headers, 'Content-Type': 'application/json' } }
    ```

    **IMPORTANT:**
    - Each function may use `corsHeaders` in multiple places (OPTIONS response, success response, error responses). Replace ALL occurrences.
    - Some functions may use `Deno.serve()` (newer) and some may use `serve()` from std (older). The CORS migration pattern works with both.
    - Do NOT change any other logic in these functions — only the CORS handling.
    - The variable name `headers` is clean and unambiguous in these functions. If any function already has a `headers` variable, use `corsHeaders` as the variable name (but assigned from `getCorsHeaders(origin)`).

    **Functions to migrate (all 14):**
    1. coach-notes
    2. coach-relationships
    3. coach-shares
    4. content-builder
    5. content-classifier
    6. content-hook-generator
    7. content-insight-miner
    8. get-available-models
    9. manager-notes
    10. share-call
    11. team-direct-reports
    12. team-memberships
    13. team-shares
    14. teams
  </action>
  <verify>
    - `grep -r "import.*corsHeaders.*from.*_shared/cors" supabase/functions/ --include="*.ts" | grep -v _shared/cors.ts` returns NO matches (no function imports the wildcard constant anymore)
    - `grep -rn "getCorsHeaders" supabase/functions/coach-notes/index.ts supabase/functions/teams/index.ts supabase/functions/content-builder/index.ts` confirms getCorsHeaders is used
    - `grep -c "getCorsHeaders" supabase/functions/coach-notes/index.ts` returns at least 2 (import + usage)
    - Spot-check 3 random functions to verify:
      - Import line says `getCorsHeaders` not `corsHeaders`
      - `origin` variable is extracted from request headers
      - All response headers use the dynamic headers variable
  </verify>
  <done>
    - All 14 Group B functions migrated from `corsHeaders` (wildcard) to `getCorsHeaders(origin)` (dynamic)
    - No function in the codebase still imports the `corsHeaders` constant from `_shared/cors.ts`
    - Zero other logic changes made to any function
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove backward-compatible corsHeaders export from _shared/cors.ts</name>
  <files>
    supabase/functions/_shared/cors.ts
  </files>
  <action>
    After all 14 Group B functions are migrated, remove the backward-compatible `corsHeaders` export from `_shared/cors.ts`:

    Remove lines 23-27:
    ```typescript
    // Backwards compatible export for existing code
    export const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type, sentry-trace, baggage',
    };
    ```

    This prevents any future code from accidentally importing the wildcard constant.

    NOTE: Only do this AFTER confirming Task 1 is complete and no function imports `corsHeaders` from this file. The Group C functions (Plans 04/05) have INLINE corsHeaders — they don't import from _shared/cors.ts, so removing this export won't affect them.
  </action>
  <verify>
    - `grep "export const corsHeaders" supabase/functions/_shared/cors.ts` returns NO matches
    - `grep "getCorsHeaders" supabase/functions/_shared/cors.ts` still returns the function export
    - `grep -r "corsHeaders.*from.*_shared/cors" supabase/functions/ --include="*.ts"` returns NO matches (nothing imports the removed export)
  </verify>
  <done>
    - Wildcard `corsHeaders` export removed from _shared/cors.ts
    - Only `getCorsHeaders()` function remains as the sole CORS export
    - No function references the removed export
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -r "import.*corsHeaders.*_shared" supabase/functions/ --include="*.ts" | grep -v _shared/` — zero matches
2. `grep -r "getCorsHeaders" supabase/functions/ --include="*.ts" | grep -v _shared/cors.ts | wc -l` — should be 14 (one per Group B function)
3. `grep "export const corsHeaders" supabase/functions/_shared/cors.ts` — zero matches (removed)
</verification>

<success_criteria>
- All 14 Group B functions import and use getCorsHeaders(origin)
- No function imports the wildcard corsHeaders constant
- The backward-compatible corsHeaders export is removed from _shared/cors.ts
- Only getCorsHeaders() remains as the sole CORS export
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-lockdown/01-03-SUMMARY.md`
</output>
