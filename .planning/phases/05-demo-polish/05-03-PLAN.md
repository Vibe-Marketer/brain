---
phase: 05-demo-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/tags/TagsTab.tsx
  - src/components/tags/RulesTab.tsx
  - src/components/analytics/OverviewTab.tsx
  - src/components/analytics/TagsTab.tsx
  - src/components/analytics/TalkTimeTab.tsx
  - src/components/analytics/SentimentTab.tsx
  - src/components/analytics/TopicsTab.tsx
  - src/components/analytics/TrendsTab.tsx
autonomous: true

must_haves:
  truths:
    - "Tags tab loads without error in settings"
    - "Rules tab loads without error in settings"
    - "All 6 analytics tabs render without crashes"
    - "Analytics tabs are accessible via routing (WIRE-02 verification)"
  artifacts:
    - path: "src/components/tags/TagsTab.tsx"
      provides: "Tags management with error handling"
      min_lines: 50
    - path: "src/components/tags/RulesTab.tsx"
      provides: "Tag rules management with error handling"
      min_lines: 50
    - path: "src/components/analytics/OverviewTab.tsx"
      provides: "Analytics overview with null safety"
      min_lines: 30
  key_links:
    - from: "src/components/tags/TagsTab.tsx"
      to: "call_tags table"
      via: "Supabase query"
      pattern: ".from\\('call_tags'\\)"
---

<objective>
Runtime test and fix Tags, Rules, and Analytics tabs that may error or crash

Purpose: Research indicates these tabs appear functional in code review but spec reports errors (spec-027, spec-028, spec-035). Need runtime testing to identify actual issues.
Output: All tabs load without errors, with proper null/empty handling
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-demo-polish/05-RESEARCH.md

@src/components/tags/TagsTab.tsx
@src/components/tags/RulesTab.tsx
@src/components/analytics/OverviewTab.tsx
@src/components/analytics/TagsTab.tsx
@src/components/analytics/TalkTimeTab.tsx
@src/components/analytics/SentimentTab.tsx
@src/components/analytics/TopicsTab.tsx
@src/components/analytics/TrendsTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test and fix Tags tab (FIX-01)</name>
  <files>src/components/tags/TagsTab.tsx</files>
  <action>
**Runtime Test Procedure:**
1. Start dev server: `npm run dev`
2. Navigate to `/settings?tab=tags` or `/sorting-tagging?category=tags`
3. Check browser console for errors
4. Test with both empty data and existing tags

**Common issues to fix (from RESEARCH.md):**
- Missing data causing undefined access
- RLS policy blocking queries
- Incorrect table/column references

**Add defensive null checks:**
```typescript
// Before any data mapping
const tags = data?.tags ?? [];
const tagCounts = data?.counts ?? {};

// In JSX
{tags.length > 0 ? (
  tags.map(tag => /* ... */)
) : (
  <EmptyState message="No tags created yet" />
)}
```

**Add error boundary or try-catch:**
```typescript
const { data, error, isLoading } = useQuery({
  queryKey: ['tags'],
  queryFn: async () => {
    const { data, error } = await supabase
      .from('call_tags')
      .select('*');
    
    if (error) {
      logger.error('Failed to load tags', error);
      throw error;
    }
    return data ?? [];
  }
});

if (error) {
  return <ErrorState message="Failed to load tags" onRetry={refetch} />;
}
```
  </action>
  <verify>
    - Navigate to tags tab - no console errors
    - Page renders (either with data or empty state)
    - `npm run build` succeeds
  </verify>
  <done>
    Tags tab loads without error, handles empty data gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Test and fix Rules tab (FIX-02)</name>
  <files>src/components/tags/RulesTab.tsx</files>
  <action>
**Runtime Test Procedure:**
1. Navigate to `/sorting-tagging?category=rules`
2. Check browser console for errors
3. Test "Apply Rules" button if present

**Potential issues (from RESEARCH.md):**
- Missing RPC `apply_tag_rules_to_untagged`
- RLS policy blocking `tag_rules` table access

**Add defensive error handling:**
```typescript
// For RPC calls that may not exist
const handleApplyRules = async () => {
  try {
    const { error } = await supabase.rpc('apply_tag_rules_to_untagged');
    if (error) {
      // Handle missing RPC gracefully
      if (error.message.includes('function') && error.message.includes('does not exist')) {
        toast.error('Auto-tagging feature not yet available');
        return;
      }
      throw error;
    }
    toast.success('Rules applied successfully');
  } catch (e) {
    logger.error('Failed to apply rules', e);
    toast.error('Failed to apply rules');
  }
};
```

**Ensure proper loading/error states:**
```typescript
if (isLoading) return <RulesTabSkeleton />;
if (error) return <ErrorState message="Failed to load rules" />;
if (!rules || rules.length === 0) return <EmptyState message="No rules defined" />;
```
  </action>
  <verify>
    - Navigate to rules tab - no console errors
    - Page renders with proper empty/error states
    - `npm run build` succeeds
  </verify>
  <done>
    Rules tab loads without error, handles missing RPC gracefully
  </done>
</task>

<task type="auto">
  <name>Task 3: Test and fix Analytics tabs (FIX-03)</name>
  <files>
    src/components/analytics/OverviewTab.tsx
    src/components/analytics/TagsTab.tsx
    src/components/analytics/TalkTimeTab.tsx
    src/components/analytics/SentimentTab.tsx
    src/components/analytics/TopicsTab.tsx
    src/components/analytics/TrendsTab.tsx
  </files>
  <action>
**Runtime Test Procedure:**
1. Navigate to `/analytics`
2. Click through each tab: Overview, Tags, Talk Time, Sentiment, Topics, Trends
3. Check browser console for each tab
4. Test with empty data (no calls in system)

**Per-file fixes checklist:**

**OverviewTab.tsx:**
- Add null coalescing for `analytics?.totalCalls ?? 0`, `analytics?.avgDuration ?? 0`, `analytics?.topTags ?? []`
- Add error boundary: `if (error) return <ErrorState message="Failed to load analytics" />`
- Wrap chart data in useMemo with empty array fallback

**TagsTab.tsx:**
- Add null check for tag distribution data before mapping
- Handle case where no tags exist: `if (!tagData?.length) return <EmptyState />`

**TalkTimeTab.tsx:**
- Null check participant data arrays before reduce/map operations
- Default to empty object for participant stats: `participantStats ?? {}`

**SentimentTab.tsx:**
- Add null check for sentiment scores before averaging
- Handle missing sentiment: `sentimentScore ?? 'neutral'`

**TopicsTab.tsx:**
- Null check topic extraction results before rendering
- Handle empty topics: `topics?.length ? topics.map(...) : <EmptyState />`

**TrendsTab.tsx:**
- Null check time series data before chart rendering
- Default chart data to empty array: `trendData ?? []`

**Common pattern for all tabs:**
```typescript
const { data: analytics, isLoading, error } = useCallAnalytics();
if (error) return <ErrorState message="Failed to load analytics" />;
if (isLoading) return <LoadingSkeleton />;
const safeData = analytics?.relevantField ?? defaultValue;
```
  </action>
  <verify>
    - Navigate to each analytics tab - no console errors
    - All tabs render (with data or empty states)
    - Charts don't crash on empty data
    - `npm run build` succeeds
  </verify>
  <done>
    All 6 analytics tabs render without crashes, handle empty data gracefully
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify WIRE-02 analytics tabs wiring</name>
  <files>src/App.tsx</files>
  <action>
**Verification task for WIRE-02 (per RESEARCH.md finding):**

Research confirmed analytics tabs are already wired via AnalyticsDetailPane at `/analytics/:category` route.

**Verify routing works:**
1. Start dev server: `npm run dev`
2. Navigate to `/analytics` - should load default tab
3. Navigate to `/analytics/overview`, `/analytics/tags`, `/analytics/talk-time`, `/analytics/sentiment`, `/analytics/topics`, `/analytics/trends`
4. Confirm each route renders corresponding tab content

**If routing fails:**
- Check App.tsx for `/analytics/:category` route
- Verify AnalyticsDetailPane reads `category` param
- Confirm tab component mappings exist

**Expected:** All routes work - this is verification only, not implementation.
  </action>
  <verify>
    - All 6 analytics tab URLs are accessible: `/analytics/overview`, `/analytics/tags`, `/analytics/talk-time`, `/analytics/sentiment`, `/analytics/topics`, `/analytics/trends`
    - Each URL renders the corresponding tab content
    - No 404 errors
  </verify>
  <done>
    WIRE-02 verified complete: Analytics tabs are properly routed
  </done>
</task>

</tasks>

<verification>
1. Tags tab: `/sorting-tagging?category=tags` loads without error
2. Rules tab: `/sorting-tagging?category=rules` loads without error
3. Analytics: Navigate to `/analytics` and click all 6 tabs - no crashes
4. Console: No JavaScript errors during navigation
5. Build: `npm run build` completes without errors
</verification>

<success_criteria>
- FIX-01 addressed: Tags tab loads without error
- FIX-02 addressed: Rules tab loads without error
- FIX-03 addressed: All analytics tabs render without crashes
- Proper error states shown when data unavailable
- Empty states shown when no data exists
</success_criteria>

<output>
After completion, create `.planning/phases/05-demo-polish/05-03-SUMMARY.md`
</output>
