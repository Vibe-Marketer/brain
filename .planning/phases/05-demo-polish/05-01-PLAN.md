---
phase: 05-demo-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
  - src/pages/CallDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "Automation Rules page accessible at /automation-rules route"
    - "CallDetailPage loads call data from fathom_calls table"
    - "Call detail page shows data for valid recording IDs"
  artifacts:
    - path: "src/App.tsx"
      provides: "AutomationRules route registration"
      contains: "/automation-rules"
    - path: "src/pages/CallDetailPage.tsx"
      provides: "fathom_calls query with recording_id"
      contains: "from('fathom_calls')"
  key_links:
    - from: "src/App.tsx"
      to: "src/pages/AutomationRules.tsx"
      via: "Route element"
      pattern: 'path="/automation-rules"'
    - from: "src/pages/CallDetailPage.tsx"
      to: "fathom_calls table"
      via: "Supabase query"
      pattern: ".from\\('fathom_calls'\\)"
---

<objective>
Route Automation Rules page and fix CallDetailPage database query

Purpose: Two critical wiring issues - AutomationRules page exists but has no route (404s), and CallDetailPage queries non-existent `calls` table instead of `fathom_calls`.
Output: Both pages accessible and functional
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-demo-polish/05-RESEARCH.md

@src/App.tsx
@src/pages/AutomationRules.tsx
@src/pages/CallDetailPage.tsx
@src/integrations/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Automation Rules routes to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Add 4 routes for the Automation Rules feature:

1. Add import at top with other page imports:
   `import AutomationRules from '@/pages/AutomationRules';`

2. Add routes BEFORE the 404 catch-all route (`<Route path="*"`). Place after Content Hub routes:

```tsx
{/* Automation Rules routes */}
<Route path="/automation-rules" element={<ProtectedRoute><Layout><AutomationRules /></Layout></ProtectedRoute>} />
<Route path="/automation-rules/new" element={<ProtectedRoute><Layout><AutomationRules /></Layout></ProtectedRoute>} />
<Route path="/automation-rules/:id" element={<ProtectedRoute><Layout><AutomationRules /></Layout></ProtectedRoute>} />
<Route path="/automation-rules/:id/history" element={<ProtectedRoute><Layout><AutomationRules /></Layout></ProtectedRoute>} />
```

Note: The page component handles route params internally to show create/edit/history views.
  </action>
  <verify>
    - `grep -n "automation-rules" src/App.tsx` shows 4 routes
    - `grep -n "AutomationRules" src/App.tsx` shows the import
    - `npm run build` succeeds with no TypeScript errors
  </verify>
  <done>
    All 4 automation-rules routes registered, page will render at /automation-rules
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix CallDetailPage to query fathom_calls table</name>
  <files>src/pages/CallDetailPage.tsx</files>
  <action>
Fix the database query in CallDetailPage.tsx:

**Current (BROKEN) around lines 44-55:**
```typescript
const { data: call, isLoading: callLoading } = useQuery({
  queryKey: ['call', callId],
  queryFn: async () => {
    const { data, error } = await supabase
      .from('calls')  // WRONG: Table doesn't exist
      .select('*')
      .eq('id', callId)
      .single();

    if (error) throw error;
    return data;
  },
  enabled: !!callId,
});
```

**Replace with:**
```typescript
const { data: call, isLoading: callLoading } = useQuery({
  queryKey: ['call', callId],
  queryFn: async () => {
    const { data, error } = await supabase
      .from('fathom_calls')           // CORRECT: Actual table name
      .select('*')
      .eq('recording_id', callId)     // CORRECT: Primary key is recording_id
      .single();

    if (error) throw error;
    return data;
  },
  enabled: !!callId,
});
```

Key changes:
1. `'calls'` → `'fathom_calls'` (correct table name)
2. `'id'` → `'recording_id'` (correct primary key column)

Note: The `callId` from URL params is the recording_id, not a UUID.
  </action>
  <verify>
    - `grep -n "fathom_calls" src/pages/CallDetailPage.tsx` shows the correct table
    - `grep -n "from('calls')" src/pages/CallDetailPage.tsx` returns no matches
    - `grep -n "recording_id" src/pages/CallDetailPage.tsx` shows correct column
    - `npm run build` succeeds
  </verify>
  <done>
    CallDetailPage queries correct table (fathom_calls) with correct key (recording_id)
  </done>
</task>

</tasks>

<verification>
1. Route registration: Visit `/automation-rules` - should show AutomationRules page
2. Sub-routes: Visit `/automation-rules/new` - should show create view
3. CallDetailPage: Visit `/call/[valid-recording-id]` - should load call data
4. Build: `npm run build` completes without errors
</verification>

<success_criteria>
- WIRE-01 addressed: Automation Rules page accessible at `/automation-rules`
- IMPL-03 addressed: CallDetailPage queries `fathom_calls` table
- No TypeScript errors
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-demo-polish/05-01-SUMMARY.md`
</output>
