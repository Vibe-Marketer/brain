---
phase: 05-demo-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/settings/UsersTab.tsx
  - src/components/settings/BillingTab.tsx
autonomous: true

must_haves:
  truths:
    - "Users tab shows functional elements (no placeholder buttons)"
    - "Billing section is functional if payments active"
    - "Non-functional elements removed or properly disabled"
  artifacts:
    - path: "src/components/settings/UsersTab.tsx"
      provides: "Functional user management"
      min_lines: 50
    - path: "src/components/settings/BillingTab.tsx"
      provides: "Billing display with appropriate state"
      min_lines: 50
  key_links:
    - from: "src/components/settings/UsersTab.tsx"
      to: "team_memberships table"
      via: "Supabase query"
      pattern: ".from\\('team_memberships'\\)"
---

<objective>
Fix Users and Billing tabs - remove placeholders, make elements functional or properly disabled

Purpose: Users tab has non-functional elements per spec-042, Billing section may have broken features per spec-043. Need runtime verification and fixes.
Output: Both tabs functional with clear user expectations
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-demo-polish/05-RESEARCH.md

@src/components/settings/UsersTab.tsx
@src/components/settings/BillingTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Users tab non-functional elements (FIX-04)</name>
  <files>src/components/settings/UsersTab.tsx</files>
  <action>
**Runtime Test Procedure:**
1. Navigate to `/settings?tab=users` (or team settings)
2. Identify buttons/actions that don't work
3. Check for admin vs non-admin behavior

**Common issues (from RESEARCH.md):**
- ADMIN-only operations blocked for TEAM users but buttons visible
- Missing user invite functionality
- Role change buttons that do nothing

**Fix approach:**

1. **Remove or hide non-functional buttons:**
```typescript
// Hide invite button if functionality not implemented
{canInvite && inviteFunctionExists && (
  <Button onClick={handleInvite}>Invite User</Button>
)}

// Or show disabled with explanation
<Button 
  disabled={!inviteFunctionExists}
  title={!inviteFunctionExists ? "Coming soon" : undefined}
>
  Invite User
</Button>
```

2. **Add permission checks for admin actions:**
```typescript
const { isAdmin } = useTeamRole();

// Only show admin actions to admins
{isAdmin && (
  <DropdownMenuItem onClick={() => handleRoleChange(user.id, 'MEMBER')}>
    Change Role
  </DropdownMenuItem>
)}
```

3. **Add proper loading/error feedback:**
```typescript
const [isUpdating, setIsUpdating] = useState<string | null>(null);

const handleRoleChange = async (userId: string, newRole: string) => {
  setIsUpdating(userId);
  try {
    const { error } = await supabase
      .from('team_memberships')
      .update({ role: newRole })
      .eq('user_id', userId);
    
    if (error) throw error;
    toast.success('Role updated');
    refetch();
  } catch (e) {
    toast.error('Failed to update role');
  } finally {
    setIsUpdating(null);
  }
};
```

4. **If "Remove User" doesn't work, implement or hide:**
```typescript
// Either implement:
const handleRemoveUser = async (userId: string) => {
  const { error } = await supabase
    .from('team_memberships')
    .delete()
    .eq('user_id', userId)
    .eq('team_id', currentTeamId);
  // ...
};

// Or hide until implemented:
// Comment out the Remove button entirely
```
  </action>
  <verify>
    - Navigate to Users tab - no console errors
    - All visible buttons have working click handlers
    - Admin actions only visible to admins
    - Non-functional features hidden or clearly marked
    - `npm run build` succeeds
  </verify>
  <done>
    Users tab has only functional elements, permissions enforced
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Billing section (FIX-05)</name>
  <files>src/components/settings/BillingTab.tsx</files>
  <action>
**Runtime Test Procedure:**
1. Navigate to `/settings?tab=billing`
2. Test any "Upgrade" or "Manage Subscription" buttons
3. Check if usage data displays correctly

**Current state (from RESEARCH.md):**
- Shows plan info and usage via `useEmbeddingCosts` hook
- May have placeholder upgrade buttons with no Stripe integration
- Role-based display (some features admin-only)

**Fix approach:**

1. **If Stripe NOT integrated (likely), make this clear:**
```typescript
const BILLING_ENABLED = false; // Feature flag

function BillingTab() {
  if (!BILLING_ENABLED) {
    return (
      <div className="space-y-6">
        <h2>Billing</h2>
        <Card>
          <CardContent className="py-6">
            <p className="text-muted-foreground">
              You're on the free plan. Billing features coming soon.
            </p>
            <p className="text-sm text-muted-foreground mt-2">
              Current usage displayed below for reference.
            </p>
          </CardContent>
        </Card>
        
        {/* Still show usage stats */}
        <UsageStats />
      </div>
    );
  }
  
  // Full billing UI when enabled
  return /* existing billing UI */;
}
```

2. **Remove or disable non-functional upgrade buttons:**
```typescript
// Instead of:
<Button onClick={() => toast.info("Coming soon")}>Upgrade to Pro</Button>

// Use:
<Button disabled className="opacity-50">
  Upgrade (Coming Soon)
</Button>
```

3. **Ensure usage display works:**
```typescript
const { data: costs, isLoading } = useEmbeddingCosts();

// Add null safety
const totalCost = costs?.total ?? 0;
const embeddingCount = costs?.count ?? 0;

{isLoading ? (
  <Skeleton className="h-20 w-full" />
) : (
  <div>
    <p>Embeddings: {embeddingCount.toLocaleString()}</p>
    <p>Estimated cost: ${totalCost.toFixed(4)}</p>
  </div>
)}
```

4. **If payments ARE active, verify Stripe integration:**
- Check for `STRIPE_SECRET_KEY` usage
- Verify webhook handling
- Test customer portal link
  </action>
  <verify>
    - Navigate to Billing tab - no console errors
    - Usage stats display correctly
    - No broken "Upgrade" buttons
    - Clear messaging about billing status
    - `npm run build` succeeds
  </verify>
  <done>
    Billing section shows appropriate state, no misleading CTAs
  </done>
</task>

</tasks>

<verification>
1. Users tab: `/settings?tab=users` - all buttons functional or hidden
2. Billing tab: `/settings?tab=billing` - clear status, usage displays
3. Console: No JavaScript errors during navigation
4. Build: `npm run build` completes without errors
</verification>

<success_criteria>
- FIX-04 addressed: Users tab functional elements only
- FIX-05 addressed: Billing section appropriate for payment status
- No misleading CTAs or placeholder buttons
- Permission-appropriate UI for admin vs member
</success_criteria>

<output>
After completion, create `.planning/phases/05-demo-polish/05-04-SUMMARY.md`
</output>
