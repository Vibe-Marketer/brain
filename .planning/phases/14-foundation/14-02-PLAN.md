---
phase: 14-foundation
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - /Users/Naegele/dev/callvault/src/lib/supabase.ts
  - /Users/Naegele/dev/callvault/src/types/supabase.ts
  - /Users/Naegele/dev/callvault/src/hooks/useAuth.tsx
  - /Users/Naegele/dev/callvault/src/routes/__root.tsx
  - /Users/Naegele/dev/callvault/src/routes/login.tsx
  - /Users/Naegele/dev/callvault/src/routes/oauth/callback.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated.tsx
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
autonomous: true
must_haves:
  truths:
    - "User can navigate to /login and see a sign-in page with Google OAuth button"
    - "Clicking Google sign-in initiates Supabase PKCE OAuth flow"
    - "After Google auth, user is redirected to /oauth/callback which exchanges the code and redirects to /"
    - "Unauthenticated users visiting / are redirected to /login"
    - "Authenticated user session persists across page refresh"
  artifacts:
    - path: "/Users/Naegele/dev/callvault/src/lib/supabase.ts"
      provides: "Typed Supabase client singleton"
      contains: "createClient"
    - path: "/Users/Naegele/dev/callvault/src/hooks/useAuth.tsx"
      provides: "Auth context with session state, sign-in, sign-out"
      exports: ["AuthProvider", "useAuth"]
    - path: "/Users/Naegele/dev/callvault/src/routes/__root.tsx"
      provides: "Root route with ThemeProvider, AuthProvider, Toaster"
      contains: "createRootRouteWithContext"
    - path: "/Users/Naegele/dev/callvault/src/routes/login.tsx"
      provides: "Login page with Google OAuth"
      contains: "signInWithOAuth"
    - path: "/Users/Naegele/dev/callvault/src/routes/oauth/callback.tsx"
      provides: "PKCE code exchange handler"
      contains: "onAuthStateChange"
    - path: "/Users/Naegele/dev/callvault/src/routes/_authenticated.tsx"
      provides: "Auth guard layout route for all protected pages"
      contains: "beforeLoad"
  key_links:
    - from: "/Users/Naegele/dev/callvault/src/routes/__root.tsx"
      to: "/Users/Naegele/dev/callvault/src/hooks/useAuth.tsx"
      via: "AuthProvider wraps entire app"
      pattern: "AuthProvider"
    - from: "/Users/Naegele/dev/callvault/src/routes/_authenticated.tsx"
      to: "/Users/Naegele/dev/callvault/src/lib/supabase.ts"
      via: "beforeLoad checks session"
      pattern: "supabase.auth.getSession"
    - from: "/Users/Naegele/dev/callvault/src/routes/login.tsx"
      to: "Supabase Auth"
      via: "signInWithOAuth provider google"
      pattern: "signInWithOAuth.*google"
---

<objective>
Wire Supabase auth with Google OAuth, PKCE callback, auth guard, and login page.

Purpose: FOUND-01 (users can log in with existing Supabase account). This is the auth foundation that all protected routes depend on. The new repo points at the SAME Supabase project as v1, so existing users' sessions and data are immediately accessible.
Output: Working login flow — /login renders sign-in page, Google OAuth works, /oauth/callback exchanges PKCE code, _authenticated layout guards all protected routes.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/ROADMAP.md
@/Users/Naegele/dev/brain/.planning/phases/14-foundation/14-RESEARCH.md
@/Users/Naegele/dev/brain/.planning/phases/14-foundation/14-CONTEXT.md
@/Users/Naegele/dev/brain/.planning/phases/14-foundation/14-01-SUMMARY.md
@/Users/Naegele/dev/brain/src/integrations/supabase/client.ts
@/Users/Naegele/dev/brain/src/pages/Login.tsx
@/Users/Naegele/dev/brain/src/pages/OAuthCallback.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Supabase client, auth hook, and type definitions</name>
  <files>
    /Users/Naegele/dev/callvault/src/lib/supabase.ts
    /Users/Naegele/dev/callvault/src/types/supabase.ts
    /Users/Naegele/dev/callvault/src/hooks/useAuth.tsx
  </files>
  <action>
    1. Create `src/lib/supabase.ts` — typed Supabase client singleton:
       - Import `createClient` from `@supabase/supabase-js`
       - Read `VITE_SUPABASE_URL` and `VITE_SUPABASE_PUBLISHABLE_KEY` from `import.meta.env`
       - Configure with `auth: { storage: localStorage, persistSession: true, autoRefreshToken: true }`
       - Type with `Database` from `@/types/supabase`
       - Pattern: identical to v1's `brain/src/integrations/supabase/client.ts`

    2. Create `src/types/supabase.ts` — generate fresh database types:
       - Run `pnpm dlx supabase gen types typescript --project-id vltmrnjsubfzrgrtdqey > src/types/supabase.ts`
       - If CLI auth is needed, the user will need to run `supabase login` first. If the generation fails, create a minimal placeholder type file that exports `Database` as a permissive type and add a comment noting it should be regenerated.

    3. Create `src/hooks/useAuth.tsx` — auth context provider and hook:
       - Create `AuthContext` with: `session: Session | null`, `user: User | null`, `loading: boolean`, `signInWithGoogle: () => Promise<void>`, `signOut: () => Promise<void>`
       - `AuthProvider` component:
         - Uses `useState` for session and loading
         - On mount: call `supabase.auth.getSession()` to restore persisted session
         - Subscribe to `supabase.auth.onAuthStateChange` to track sign-in/sign-out events
         - Cleanup subscription on unmount
       - `signInWithGoogle`: calls `supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: \`\${window.location.origin}/oauth/callback\` } })`
       - `signOut`: calls `supabase.auth.signOut()` then navigates to /login
       - `useAuth()` hook: consumes AuthContext, throws if used outside provider
       - NO Google Meet scopes — only basic Google OAuth for Supabase auth (FOUND-09)
  </action>
  <verify>
    - `cat /Users/Naegele/dev/callvault/src/lib/supabase.ts` shows createClient with env vars
    - `cat /Users/Naegele/dev/callvault/src/types/supabase.ts` exports Database type
    - `cat /Users/Naegele/dev/callvault/src/hooks/useAuth.tsx` exports AuthProvider and useAuth
    - `grep -i "google.meet\|meet.google\|calendar\|meet_scope" /Users/Naegele/dev/callvault/src/ -r` returns zero results
  </verify>
  <done>Supabase client configured pointing at same project as v1. Auth context provides session state, Google sign-in, and sign-out. Database types generated from live schema.</done>
</task>

<task type="auto">
  <name>Task 2: Root route, login page, OAuth callback, and auth guard</name>
  <files>
    /Users/Naegele/dev/callvault/src/routes/__root.tsx
    /Users/Naegele/dev/callvault/src/routes/login.tsx
    /Users/Naegele/dev/callvault/src/routes/oauth/callback.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
    /Users/Naegele/dev/callvault/src/main.tsx
  </files>
  <action>
    1. Create `src/routes/__root.tsx` — root route component:
       - Use `createRootRouteWithContext` to pass auth context to route `beforeLoad` handlers
       - Wrap `<Outlet />` with: `<ThemeProvider attribute="class" defaultTheme="system" enableSystem>`, `<AuthProvider>`, `<Toaster />` (from sonner)
       - The context type should include `auth: { session: Session | null }` so beforeLoad can check auth

    2. Update `src/main.tsx` to pass auth context to router:
       - Create router with `createRouter({ routeTree, context: { auth: { session: null } } })`
       - The actual session is populated at the root route level via the AuthProvider

    3. Create `src/routes/login.tsx` — public login page:
       - Use `createFileRoute('/login')` — this is a PUBLIC route (no auth guard)
       - If user is already authenticated (check via useAuth()), redirect to /
       - Render a centered card with:
         - CallVault logo/wordmark at top
         - "Sign in to CallVault" heading (Montserrat, uppercase per brand)
         - "Sign in with Google" button using the glossy slate gradient button style
         - Brief subtext: "Use your existing account"
       - Button calls `signInWithGoogle()` from useAuth hook
       - Show loading state while auth is initializing
       - Clean, minimal design matching v1 Login.tsx visual style
       - NO email/password form (Supabase Google OAuth only for now)
       - NO Google Meet references or scopes

    4. Create `src/routes/oauth/callback.tsx` — PKCE code exchange:
       - Use `createFileRoute('/oauth/callback')`
       - On mount: Supabase JS client automatically handles the PKCE exchange from URL params
       - Listen to `onAuthStateChange` — on `SIGNED_IN` event, navigate to /
       - Show a simple "Completing sign in..." message with a spinner while exchanging
       - Handle error state: if exchange fails, show error and link back to /login

    5. Create `src/routes/_authenticated.tsx` — auth guard layout route:
       - Use `createFileRoute('/_authenticated')`
       - `beforeLoad`: check `supabase.auth.getSession()`. If no session, `throw redirect({ to: '/login' })`
       - Component: `<Outlet />` (just passes through to child routes)
       - ALL protected pages will be nested under `src/routes/_authenticated/`

    6. Create `src/routes/_authenticated/index.tsx` — placeholder home page:
       - Use `createFileRoute('/_authenticated/')` — this renders at /
       - Render a simple placeholder: "Welcome to CallVault v2" with user email from useAuth()
       - This will be replaced by the AppShell in Plan 03

    IMPORTANT: The TanStack Router file-based routing convention means:
    - `_authenticated.tsx` is a layout route (underscore prefix means pathless layout)
    - `_authenticated/index.tsx` renders at / (inherits the auth guard from parent)
    - `login.tsx` renders at /login (NOT under _authenticated, so no auth guard)
    - `oauth/callback.tsx` renders at /oauth/callback (NOT under _authenticated)
  </action>
  <verify>
    - `cd /Users/Naegele/dev/callvault && pnpm dev` starts without TypeScript errors
    - `ls /Users/Naegele/dev/callvault/src/routes/__root.tsx` exists
    - `ls /Users/Naegele/dev/callvault/src/routes/login.tsx` exists
    - `ls /Users/Naegele/dev/callvault/src/routes/oauth/callback.tsx` exists
    - `ls /Users/Naegele/dev/callvault/src/routes/_authenticated.tsx` exists
    - `ls /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx` exists
    - Visiting localhost:3000 in browser redirects to /login (unauthenticated)
    - /login page renders sign-in button
  </verify>
  <done>Login page renders at /login with Google OAuth button. OAuth callback handles PKCE exchange. Auth guard redirects unauthenticated users to /login. Authenticated users see placeholder home page at /. Route tree auto-generates correctly.</done>
</task>

</tasks>

<verification>
1. `pnpm dev` starts without errors in the callvault repo
2. Visiting localhost:3000 unauthenticated redirects to /login
3. /login shows a styled sign-in page with Google OAuth button
4. Clicking sign-in initiates Google OAuth flow (redirects to Google)
5. After Google auth, /oauth/callback exchanges code and redirects to /
6. Authenticated user sees placeholder home at / with their email
7. Session persists across page refresh
8. No Google Meet scopes or references exist
</verification>

<success_criteria>
An existing v1 user can navigate to localhost:3000, be redirected to /login, click "Sign in with Google," authenticate via their existing Supabase account, and land on the authenticated home page showing their email. The session persists across refresh. FOUND-01 is satisfied at the local dev level.
</success_criteria>

<output>
After completion, create `.planning/phases/14-foundation/14-02-SUMMARY.md` in the brain repo.
</output>
