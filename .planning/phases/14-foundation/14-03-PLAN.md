---
phase: 14-foundation
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx
  - /Users/Naegele/dev/callvault/src/components/layout/SidebarToggle.tsx
  - /Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
  - /Users/Naegele/dev/callvault/src/components/layout/DetailPaneOutlet.tsx
  - /Users/Naegele/dev/callvault/src/hooks/useBreakpoint.ts
  - /Users/Naegele/dev/callvault/src/stores/panelStore.ts
  - /Users/Naegele/dev/callvault/src/stores/preferencesStore.ts
  - /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
autonomous: true
must_haves:
  truths:
    - "AppShell renders 4-pane layout with correct widths: sidebar 220/72px, secondary 280px, main flex-1, detail 360/320px"
    - "Sidebar collapses and expands with Motion spring animations (not CSS transitions)"
    - "Detail pane slides in/out with AnimatePresence spring animation"
    - "Panes animate with Motion spring physics (stiffness ~260, damping ~28) with a settle time equivalent to ~500ms"
    - "Panes have rounded-2xl corners, 12px gaps, card background with border and shadow"
    - "On tablet, sidebar auto-collapses to 72px icon rail"
    - "On mobile, panes stack as full-screen views (not overlays)"
    - "Sidebar toggle is edge-mounted 24x24px circular button (not hamburger)"
    - "AppShell accepts props: { children, secondaryPane?, showDetailPane? } for route-level composition"
  artifacts:
    - path: "/Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx"
      provides: "4-pane layout component with Motion animations and typed props interface"
      min_lines: 80
    - path: "/Users/Naegele/dev/callvault/src/components/layout/SidebarToggle.tsx"
      provides: "Edge-mounted circular toggle button"
      contains: "rounded-full"
    - path: "/Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx"
      provides: "Navigation items with org/workspace switchers"
      contains: "data-tour"
    - path: "/Users/Naegele/dev/callvault/src/components/layout/DetailPaneOutlet.tsx"
      provides: "Detail panel with AnimatePresence"
      contains: "AnimatePresence"
    - path: "/Users/Naegele/dev/callvault/src/hooks/useBreakpoint.ts"
      provides: "Responsive breakpoint detection"
      exports: ["useBreakpointFlags"]
    - path: "/Users/Naegele/dev/callvault/src/stores/panelStore.ts"
      provides: "Panel state management (Zustand v5)"
      contains: "create<PanelState>()(("
  key_links:
    - from: "/Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx"
      to: "motion/react"
      via: "motion.nav and AnimatePresence for pane animations"
      pattern: "from 'motion/react'"
    - from: "/Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx"
      to: "/Users/Naegele/dev/callvault/src/hooks/useBreakpoint.ts"
      via: "useBreakpointFlags for responsive behavior"
      pattern: "useBreakpointFlags"
    - from: "/Users/Naegele/dev/callvault/src/components/layout/DetailPaneOutlet.tsx"
      to: "/Users/Naegele/dev/callvault/src/stores/panelStore.ts"
      via: "Reads panel state to decide what to render"
      pattern: "usePanelStore"
---

<objective>
Build the 4-pane AppShell layout with Motion spring animations and responsive behavior.

Purpose: FOUND-04 (AppShell renders 4-pane layout with Motion for React v12 spring animations). This is the visual foundation of v2 — the layout users see on every page. Springs must feel native, not like CSS slide transitions.
Output: Working AppShell with sidebar (220/72px), secondary panel (280px), main content (flex-1), and detail panel (360/320px). All transitions use Motion springs. Mobile stacks panes as routes.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Naegele/dev/brain/.planning/ROADMAP.md
@/Users/Naegele/dev/brain/.planning/phases/14-foundation/14-RESEARCH.md
@/Users/Naegele/dev/brain/.planning/phases/14-foundation/14-CONTEXT.md
@/Users/Naegele/dev/brain/.planning/phases/14-foundation/14-01-SUMMARY.md
@/Users/Naegele/dev/brain/.planning/phases/14-foundation/14-02-SUMMARY.md
@/Users/Naegele/dev/brain/src/components/layout/AppShell.tsx
@/Users/Naegele/dev/brain/src/components/layout/SidebarToggle.tsx
@/Users/Naegele/dev/brain/src/components/layout/DetailPaneOutlet.tsx
@/Users/Naegele/dev/brain/src/components/ui/sidebar-nav.tsx
@/Users/Naegele/dev/brain/src/hooks/useBreakpoint.ts
@/Users/Naegele/dev/brain/src/stores/panelStore.ts
@/Users/Naegele/dev/brain/src/stores/preferencesStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stores, hooks, and support components</name>
  <files>
    /Users/Naegele/dev/callvault/src/stores/panelStore.ts
    /Users/Naegele/dev/callvault/src/stores/preferencesStore.ts
    /Users/Naegele/dev/callvault/src/hooks/useBreakpoint.ts
    /Users/Naegele/dev/callvault/src/components/layout/SidebarToggle.tsx
    /Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx
    /Users/Naegele/dev/callvault/src/components/layout/DetailPaneOutlet.tsx
  </files>
  <action>
    1. Create `src/stores/panelStore.ts` — Zustand v5 store for detail panel state:
       - MUST use `create<PanelState>()((...) => ...)` double-invocation syntax (Zustand v5 TypeScript)
       - Types: `PanelType = 'call-detail' | 'folder-detail' | 'workspace-detail' | 'settings-help' | null`
       - State: `isPanelOpen`, `panelType`, `panelData`
       - Actions: `openPanel(type, data?)`, `closePanel()`
       - Port from v1's `brain/src/stores/panelStore.ts` adapting types (vault -> workspace, hub -> folder)

    2. Create `src/stores/preferencesStore.ts` — Zustand v5 store for UI preferences:
       - `isSidebarExpanded: boolean` (default true)
       - `isSecondaryOpen: boolean` (default true)
       - Toggle actions for each
       - Cross-tab sync via localStorage (same pattern as v1)
       - MUST use `create<T>()(...)` double-invocation

    3. Create `src/hooks/useBreakpoint.ts` — responsive breakpoint detection:
       - Port from v1's `brain/src/hooks/useBreakpoint.ts`
       - Export `useBreakpointFlags()` returning `{ isMobile, isTablet, isDesktop }`
       - Breakpoints: mobile < 768px, tablet 768-1024px, desktop > 1024px
       - Uses `window.matchMedia` with event listeners for live updates

    4. Create `src/components/layout/SidebarToggle.tsx`:
       - Edge-mounted 24x24px circular button (NOT hamburger)
       - Position: absolute, vertically centered, -12px from right edge of sidebar (half outside)
       - Z-index: z-20
       - Chevron icon from @remixicon/react (RiArrowLeftSLine / RiArrowRightSLine)
       - Chevron rotates 180deg on toggle with 500ms transition
       - `stopPropagation()` on click to prevent double-toggle with sidebar overlay
       - Props: `isExpanded: boolean`, `onToggle: () => void`

    5. Create `src/components/layout/SidebarNav.tsx` — navigation rail content:
       - Port structure from v1's sidebar-nav.tsx, adapting for v2 naming:
         - Top: Org switcher dropdown (placeholder — just shows "Organization" label)
         - Below: Workspace switcher dropdown (placeholder — just shows "Workspace" label)
         - Nav items: "All Calls" (RiPhoneLine), divider, "Import" (RiDownloadLine), "Settings" (RiSettingsLine)
         - Keep v1's nav item order and grouping per CONTEXT.md
       - Collapsed state: show only icons, hide labels
       - Expanded state: show icons + labels
       - Add `data-tour="sidebar"` and `data-tour="workspace-switcher"` attributes for driver.js tour hooks
       - Props: `isCollapsed: boolean`, `className?: string`
       - Use TanStack Router `<Link>` component for navigation items (not react-router-dom)

    6. Create `src/components/layout/DetailPaneOutlet.tsx`:
       - Reads from `usePanelStore()` to decide visibility and content
       - Uses `AnimatePresence` from `motion/react` for enter/exit animations
       - Width: 360px desktop, 320px tablet (per `isTablet` prop)
       - Spring animation: `{ type: 'spring', stiffness: 260, damping: 28 }`
       - Renders placeholder content based on panelType (actual panel components come in Plan 04)
       - Props: `isTablet: boolean`
  </action>
  <verify>
    - `cat /Users/Naegele/dev/callvault/src/stores/panelStore.ts` contains `create<PanelState>()((`
    - `cat /Users/Naegele/dev/callvault/src/hooks/useBreakpoint.ts` exports useBreakpointFlags
    - `cat /Users/Naegele/dev/callvault/src/components/layout/SidebarToggle.tsx` contains "rounded-full"
    - `cat /Users/Naegele/dev/callvault/src/components/layout/SidebarNav.tsx` contains "data-tour"
    - `cat /Users/Naegele/dev/callvault/src/components/layout/DetailPaneOutlet.tsx` contains "AnimatePresence"
    - `cd /Users/Naegele/dev/callvault && pnpm dev` compiles without TypeScript errors
  </verify>
  <done>All support components for the AppShell are built: Zustand stores with v5 syntax, breakpoint hook, sidebar toggle (circular, edge-mounted), sidebar nav with org/workspace switchers, and detail pane with AnimatePresence. All compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: AppShell component with 4-pane Motion layout and responsive behavior</name>
  <files>
    /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx
    /Users/Naegele/dev/callvault/src/routes/_authenticated/index.tsx
  </files>
  <action>
    1. Create `src/components/layout/AppShell.tsx` — the master layout component:

       CRITICAL — Define and export a typed props interface at the top of the file:
       ```typescript
       export interface AppShellProps {
         children: React.ReactNode
         secondaryPane?: React.ReactNode
         showDetailPane?: boolean
       }
       ```
       This interface is the contract consumed by ALL route components in Plan 04. `children` renders as the main content (Pane 3). `secondaryPane` renders in Pane 2 (omit to hide). `showDetailPane` controls whether Pane 4 is rendered (defaults to false).

       Port from v1's AppShell.tsx with these CHANGES:
       - Replace CSS `transition-all duration-500` on sidebar with Motion spring animation:
         `<motion.nav animate={{ width: isSidebarExpanded ? 220 : 72 }} transition={{ type: 'spring', stiffness: 260, damping: 28 }}>`
       - Replace CSS transitions on secondary pane with Motion spring animation:
         `<motion.div animate={{ width: isSecondaryOpen ? 280 : 0, opacity: isSecondaryOpen ? 1 : 0 }} transition={{ type: 'spring', stiffness: 260, damping: 28 }}>`
       - Import `motion`, `AnimatePresence` from `motion/react` (NOT framer-motion)
       - Use `useBreakpointFlags()` from `@/hooks/useBreakpoint`
       - Use `preferencesStore` for sidebar/secondary state persistence

       DESKTOP LAYOUT (>1024px) — 4 panes side by side:
       - Container: `h-full flex gap-3 overflow-hidden p-1` (12px gap = gap-3)
       - Pane 1 (NavRail): `<motion.nav>` with spring width animation, bg-card rounded-2xl border border-border/60 shadow-sm
       - Pane 2 (Secondary): `<motion.div>` with spring width animation, bg-card/80 backdrop-blur-md rounded-2xl — ONLY rendered when `secondaryPane` prop is provided
       - Pane 3 (Main): `<div className="flex-1 min-w-0 bg-card rounded-2xl border border-border shadow-sm">` — renders `{children}`
       - Pane 4 (Detail): `<DetailPaneOutlet isTablet={false} />` — ONLY rendered when `showDetailPane` prop is true

       TABLET LAYOUT (768-1024px):
       - Sidebar auto-collapses to 72px on mount (useEffect watching isTablet)
       - Detail pane width: 320px instead of 360px
       - Otherwise same as desktop

       MOBILE LAYOUT (<768px) — ROUTE-BASED STACK NAVIGATION:
       - Per CONTEXT.md: "panes become full-screen views with back button navigation"
       - On mobile, AppShell renders ONLY Pane 3 (main content) full-screen
       - Sidebar content accessible via a bottom nav bar or hamburger that navigates to /nav route
       - Detail pane content opens as push route (/calls/$callId)
       - Add a thin mobile header bar with: hamburger menu icon (opens sidebar as route), back button when in sub-route
       - Do NOT use overlay/drawer approach from v1 — use route-based navigation for native feel

       VISUAL SPECS (from CONTEXT.md — LOCKED):
       - All panes: `rounded-2xl` (1rem border radius)
       - Gap between panes: `gap-3` (12px)
       - Container padding: `p-1`
       - Sidebar expanded: `w-[220px]`, collapsed: `w-[72px]`
       - Secondary: `w-[280px]` or `w-0`
       - Detail: `w-[360px]` desktop, `w-[320px]` tablet
       - Spring physics: stiffness 260, damping 28 (Claude's discretion within 200-300/25-30 range)
       - No emojis anywhere

    2. Update `src/routes/_authenticated/index.tsx` — wire AppShell as the home page:
       - Import and render `<AppShell secondaryPane={<FolderSidebarStub />} showDetailPane={true}>` wrapping a placeholder "Calls List" main content area
       - This proves the full 4-pane layout renders and the props interface works for authenticated users

    3. Add `initial={false}` to all Motion animations to prevent entry animation on page load (panes should start in their default position without animating in).
  </action>
  <verify>
    - `cd /Users/Naegele/dev/callvault && pnpm dev` starts and compiles
    - `grep "AppShellProps" /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx` returns match (exported interface)
    - `grep "secondaryPane" /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx` returns match (prop consumed)
    - `grep "showDetailPane" /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx` returns match (prop consumed)
    - `grep "motion/react" /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx` returns match
    - `grep "stiffness" /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx` returns match (spring physics)
    - `grep "framer-motion" /Users/Naegele/dev/callvault/src/ -r` returns zero results (using motion/react, not framer-motion)
    - `grep "rounded-2xl" /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx` returns matches
    - `grep "gap-3" /Users/Naegele/dev/callvault/src/components/layout/AppShell.tsx` returns match
    - Visit localhost:3000 after auth — AppShell renders with 4 panes visible on desktop
  </verify>
  <done>AppShell exports typed AppShellProps interface ({ children, secondaryPane?, showDetailPane? }) and renders 4-pane layout with Motion spring animations. Sidebar toggles between 220px/72px with spring physics. Secondary pane collapses with spring animation. Detail pane uses AnimatePresence for enter/exit. Mobile uses route-based stack navigation. All visual specs match CONTEXT.md locked decisions.</done>
</task>

</tasks>

<verification>
1. AppShell renders 4 distinct panes on desktop viewport
2. AppShell exports AppShellProps with children, secondaryPane?, showDetailPane?
3. Clicking sidebar toggle animates width with spring physics (not linear CSS transition)
4. Detail pane slides in/out with spring animation when panel is opened/closed
5. Panes have rounded-2xl corners, 12px gaps between them
6. On tablet viewport (resize to 768-1024px), sidebar auto-collapses to 72px
7. On mobile viewport (resize to <768px), only main content shows full-screen
8. Sidebar toggle is a 24x24px circular button at the edge of the sidebar
9. No framer-motion imports (all from motion/react)
</verification>

<success_criteria>
An authenticated user at localhost:3000 sees the 4-pane AppShell layout. Sidebar toggles with spring animation. Detail pane appears/disappears with spring animation. The layout feels like a native desktop app with spring physics, not a website with slide transitions. Mobile shows full-screen stacked views. FOUND-04 is satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/14-foundation/14-03-SUMMARY.md` in the brain repo.
</output>
