---
phase: 07-differentiators
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260131000002_add_folder_filter_to_chat_sessions.sql
  - supabase/functions/chat-stream-v2/index.ts
  - src/components/chat/ChatFilterPopover.tsx
  - src/types/chat.ts
  - src/hooks/useChatSession.ts
autonomous: true

must_haves:
  truths:
    - "User can select folders in chat filter popover"
    - "Chat only searches calls within selected folders"
    - "AI mentions scope in response ('Based on calls in [Folder]...')"
    - "Folder pills show in chat header and are removable"
  artifacts:
    - path: "supabase/migrations/20260131000002_add_folder_filter_to_chat_sessions.sql"
      provides: "filter_folder_ids column on chat_sessions"
      contains: "filter_folder_ids"
    - path: "src/components/chat/ChatFilterPopover.tsx"
      provides: "Folder selection UI section"
  key_links:
    - from: "src/components/chat/ChatFilterPopover.tsx"
      to: "src/hooks/useFolders.ts"
      via: "useFolders hook"
      pattern: "useFolders\\("
    - from: "supabase/functions/chat-stream-v2/index.ts"
      to: "folder_assignments table"
      via: "resolveFolderFilter JOIN"
      pattern: "folder_assignments"
---

<objective>
Implement Folder-Level Chat - allow users to scope chat searches to specific folders of calls.

Purpose: Users organize calls into folders (clients, projects, topics). Folder-level chat lets them ask questions about just those calls without noise from unrelated conversations.

Output: Database migration for filter_folder_ids, backend folder filter resolution, UI for folder selection in ChatFilterPopover, active scope display in chat header.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-differentiators/07-RESEARCH.md

# Existing patterns to follow
@src/components/chat/ChatFilterPopover.tsx
@src/hooks/useFolders.ts
@src/hooks/useChatSession.ts
@supabase/functions/chat-stream-v2/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filter_folder_ids column and update backend</name>
  <files>
    supabase/migrations/20260131000002_add_folder_filter_to_chat_sessions.sql
    supabase/functions/chat-stream-v2/index.ts
  </files>
  <action>
1. Create migration `20260131000002_add_folder_filter_to_chat_sessions.sql`:
   ```sql
   -- Add folder filter column to chat_sessions
   ALTER TABLE chat_sessions 
   ADD COLUMN IF NOT EXISTS filter_folder_ids UUID[];
   
   -- Add index for performance
   CREATE INDEX IF NOT EXISTS idx_chat_sessions_folder_filter 
   ON chat_sessions USING GIN (filter_folder_ids);
   
   COMMENT ON COLUMN chat_sessions.filter_folder_ids IS 
     'Array of folder UUIDs to filter search scope';
   ```

2. Update `chat-stream-v2/index.ts`:
   - Add `resolveFolderFilter()` helper function (see RESEARCH.md code example)
   - When loading session filters, include `filter_folder_ids`
   - Before search, resolve folder_ids to recording_ids via folder_assignments JOIN
   - Merge resolved recording_ids with any existing filter_recording_ids (intersection)
   - Pass merged list to search pipeline

   Key logic:
   ```typescript
   async function resolveFolderFilter(
     supabase: SupabaseClient,
     userId: string,
     folderIds: string[] | undefined,
     existingRecordingIds: number[] | undefined
   ): Promise<number[] | undefined> {
     if (!folderIds || folderIds.length === 0) {
       return existingRecordingIds;
     }
     
     const { data: assignments } = await supabase
       .from('folder_assignments')
       .select('call_recording_id')
       .in('folder_id', folderIds)
       .eq('user_id', userId);
     
     const folderRecordingIds = assignments?.map(a => a.call_recording_id) || [];
     
     if (existingRecordingIds?.length) {
       return folderRecordingIds.filter(id => existingRecordingIds.includes(id));
     }
     return folderRecordingIds.length > 0 ? folderRecordingIds : undefined;
   }
   ```

3. Update system prompt to include folder context:
   - If folder filter active, prepend: "The user has scoped this conversation to calls in folder(s): [folder names]. Base your answers only on calls within this scope."
  </action>
  <verify>
Apply migration: `supabase db push`
Test backend with curl: Send request with filter_folder_ids, verify only calls in those folders are searched.
  </verify>
  <done>
chat_sessions table has filter_folder_ids column. Backend resolves folder filters to recording_ids before search.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add folder filter UI to ChatFilterPopover</name>
  <files>
    src/components/chat/ChatFilterPopover.tsx
    src/types/chat.ts
    src/hooks/useChatSession.ts
  </files>
  <action>
1. Update `src/types/chat.ts`:
   - Add `folderIds: string[]` to ChatFilters interface

2. Update `src/hooks/useChatSession.ts`:
   - Add `filter_folder_ids` to session create/update params
   - Include in session fetch query

3. Update `src/components/chat/ChatFilterPopover.tsx`:
   - Add props: `availableFolders: Folder[]`, `toggleFolder: (folderId: string) => void`
   - Add new section after Categories (before Specific Calls):
   ```tsx
   <Separator className="my-4" />
   
   {/* Folders */}
   <div className="mb-4">
     <label className="text-xs font-medium text-ink-muted uppercase mb-2 block">
       Folders ({availableFolders.length})
     </label>
     <ScrollArea className="h-32">
       <div className="space-y-1">
         {availableFolders.map((folder) => (
           <button
             key={folder.id}
             onClick={() => toggleFolder(folder.id)}
             className={`flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm transition-colors ${
               filters.folderIds.includes(folder.id)
                 ? 'bg-vibe-orange/10 text-ink'
                 : 'hover:bg-hover text-ink-soft'
             }`}
           >
             <span 
               className="w-3 h-3 rounded-sm" 
               style={{ backgroundColor: folder.color }}
             />
             <span className="truncate flex-1">{folder.name}</span>
             {filters.folderIds.includes(folder.id) && (
               <RiCloseLine className="w-4 h-4" />
             )}
           </button>
         ))}
         {availableFolders.length === 0 && (
           <p className="text-sm text-ink-muted py-2">No folders created yet</p>
         )}
       </div>
     </ScrollArea>
   </div>
   ```

4. Wire up in parent component that renders ChatFilterPopover:
   - Import useFolders hook
   - Pass folders to popover
   - Handle toggleFolder to update filter state
  </action>
  <verify>
1. Navigate to chat page
2. Open filter popover
3. Verify Folders section appears with user's folders
4. Toggle a folder and verify it's added to filter state
5. Submit a query and verify only calls in selected folder are searched
  </verify>
  <done>
Folder section appears in filter popover. Selecting folders filters chat scope to calls within those folders.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add active folder scope display in chat header</name>
  <files>
    src/components/chat/chat-container.tsx
    src/components/chat/ChatSidebar.tsx
  </files>
  <action>
1. Find where active filters are displayed in chat UI (likely chat-container.tsx or similar)

2. Add folder pills to active filter display:
   - Similar pattern to existing call pills
   - Show folder color dot + folder name
   - Each pill has X button to remove folder filter
   - Clicking X removes that folder from filter_folder_ids

3. Style: Use existing filter pill pattern with folder-specific styling:
   ```tsx
   {selectedFolders.map((folder) => (
     <Badge
       key={folder.id}
       variant="outline"
       className="flex items-center gap-1 pr-1"
     >
       <span 
         className="w-2 h-2 rounded-sm" 
         style={{ backgroundColor: folder.color }}
       />
       <span className="text-xs">{folder.name}</span>
       <button
         onClick={() => removeFolder(folder.id)}
         className="hover:bg-muted rounded-full p-0.5"
       >
         <RiCloseLine className="w-3 h-3" />
       </button>
     </Badge>
   ))}
   ```

4. Per CONTEXT.md: Folder pills should be removable (click X to remove filter)
  </action>
  <verify>
1. Select folder filters in popover
2. Verify folder pills appear in chat header/filter area
3. Click X on a folder pill
4. Verify folder is removed from filter
5. Send a message and verify AI response mentions scope if folders selected
  </verify>
  <done>
Active folder filters display as removable pills. Removing a folder updates the filter scope. AI responses acknowledge folder context.
  </done>
</task>

</tasks>

<verification>
1. Database migration applies without error
2. Filter popover shows folder section with user's folders
3. Selecting folders filters search to only those folders' calls
4. Active folder pills appear in chat header and are removable
5. AI responses mention scope when folder filter is active
6. Multi-folder selection works (combines calls from multiple folders)
</verification>

<success_criteria>
- User can select one or more folders in chat filter popover
- Chat searches only return results from calls in selected folders
- AI mentions the folder scope in responses
- Active folder filters show as pills that can be removed
- Folder filter persists with chat session
</success_criteria>

<output>
After completion, create `.planning/phases/07-differentiators/07-02-SUMMARY.md`
</output>
