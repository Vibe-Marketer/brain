---
phase: 07-differentiators
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/check-client-health/index.ts
  - src/components/ui/top-bar.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User receives email alert when client engagement drops below threshold"
    - "User sees in-app notification for health alerts (bell in header)"
  artifacts:
    - path: "supabase/functions/check-client-health/index.ts"
      provides: "Health check with email alerts"
      contains: "supabase.functions.invoke('automation-email'"
    - path: "src/components/ui/top-bar.tsx"
      provides: "TopBar with NotificationBell"
      contains: "NotificationBell"
  key_links:
    - from: "supabase/functions/check-client-health/index.ts"
      to: "automation-email"
      via: "supabase.functions.invoke"
      pattern: "invoke\\('automation-email'"
    - from: "src/components/ui/top-bar.tsx"
      to: "src/components/notifications/NotificationBell.tsx"
      via: "import"
      pattern: "import.*NotificationBell"
---

<objective>
Close verification gaps from 07-05: Wire email alerts into health check function and integrate NotificationBell into TopBar header.

Purpose: Complete the health alerts feature by enabling email notifications and surfacing the notification bell in the app header.
Output: Fully functional health alerts with both email and in-app notification channels.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-differentiators/07-05-SUMMARY.md

# Source files to modify
@supabase/functions/check-client-health/index.ts
@src/components/ui/top-bar.tsx
@src/components/notifications/NotificationBell.tsx

# Reference for automation-email interface
@supabase/functions/automation-email/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add email alerts to check-client-health function</name>
  <files>supabase/functions/check-client-health/index.ts</files>
  <action>
Add email alert sending after creating in-app notification. After the successful notification insert (around line 172-177):

1. Check if user has email alerts enabled (query user_contact_settings for a new `email_alerts_enabled` boolean field, default true)

2. If enabled, invoke automation-email with health alert content:
```typescript
// Send email alert if enabled
const { data: emailSettings } = await supabase
  .from('user_contact_settings')
  .select('email_alerts_enabled')
  .eq('user_id', userId)
  .maybeSingle();

const emailEnabled = emailSettings?.email_alerts_enabled ?? true;

if (emailEnabled) {
  // Get user's email
  const { data: userData } = await supabase.auth.admin.getUserById(userId);
  const userEmail = userData?.user?.email;

  if (userEmail) {
    await supabase.functions.invoke('automation-email', {
      body: {
        to: userEmail,
        subject: `Health Alert: ${contact.name || contact.email} needs attention`,
        body: `Your contact ${contact.name || contact.email} hasn't been engaged in ${daysSinceSeen === Infinity ? 'a while' : `${daysSinceSeen} days`}.\n\nThreshold: ${threshold} days\n\nLog in to CallVault to generate a re-engagement email.`,
        context: {
          custom: {
            contact_name: contact.name || contact.email,
            days_since_seen: daysSinceSeen === Infinity ? 'unknown' : String(daysSinceSeen),
            threshold_days: String(threshold),
          }
        }
      }
    });
  }
}
```

3. Add emailsSent counter to result tracking:
```typescript
interface HealthCheckResult {
  usersChecked: number;
  contactsChecked: number;
  alertsCreated: number;
  emailsSent: number;  // Add this
  errors: string[];
}
```

Note: The email_alerts_enabled column doesn't exist yet in user_contact_settings. The query will return null which defaults to true (opt-out model). A future migration can add the column when settings UI is built.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd supabase/functions && deno check check-client-health/index.ts
```
  </verify>
  <done>check-client-health function includes automation-email invocation when creating health alerts. Email sending is tracked in result.emailsSent counter.</done>
</task>

<task type="auto">
  <name>Task 2: Wire NotificationBell into TopBar header</name>
  <files>src/components/ui/top-bar.tsx</files>
  <action>
Replace the static bell button with the NotificationBell component:

1. Add import at top of file:
```typescript
import { NotificationBell } from '@/components/notifications/NotificationBell';
```

2. Find the static bell button (lines 109-112):
```tsx
<Button variant="hollow" size="icon" className="relative">
  <RiBellLine className="w-4 h-4" />
  {notificationCount > 0 && <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full" />}
</Button>
```

3. Replace with NotificationBell component:
```tsx
<NotificationBell />
```

4. Remove unused imports:
- Remove `RiBellLine` from the remixicon import (line 2)
- Remove `notificationCount` from TopBarProps interface (line 23)
- Remove `notificationCount = 0` from function parameters (line 29)

The NotificationBell component already:
- Uses variant="ghost" button with hollow styling
- Shows unread count badge
- Opens NotificationPanel popover on click
  </action>
  <verify>
TypeScript compiles and app runs without console errors:
```bash
npm run build && npm run dev
```
Navigate to any page and verify bell icon appears in header with notification popover.
  </verify>
  <done>TopBar uses NotificationBell component instead of static bell icon. Clicking bell shows NotificationPanel popover with real notifications.</done>
</task>

</tasks>

<verification>
1. **Email Alert Flow:**
   - check-client-health function includes supabase.functions.invoke('automation-email', ...) call
   - Email is sent only after successful notification insert
   - User email is fetched via admin.getUserById

2. **Notification Bell Integration:**
   - NotificationBell imported and rendered in TopBar
   - Static RiBellLine removed
   - notificationCount prop removed from TopBarProps
   - Bell click opens NotificationPanel popover

3. **Type Safety:**
   - No TypeScript errors in modified files
   - HealthCheckResult includes emailsSent counter
</verification>

<success_criteria>
- [ ] check-client-health invokes automation-email function
- [ ] TopBar renders NotificationBell component
- [ ] Clicking bell in header opens notification popover
- [ ] No TypeScript or runtime errors
- [ ] Both verification gaps from 07-VERIFICATION.md closed
</success_criteria>

<output>
After completion, create `.planning/phases/07-differentiators/07-06-SUMMARY.md`
</output>
