---
phase: 07-differentiators
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/extract-profits/index.ts
  - supabase/migrations/20260131000001_add_profits_types.sql
  - src/hooks/usePROFITS.ts
  - src/components/profits/PROFITSReport.tsx
  - src/components/profits/PROFITSSection.tsx
  - src/pages/CallDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can click 'Run PROFITS Analysis' on any call"
    - "PROFITS report shows 7 sections (P, R, O, F, I, T, S)"
    - "Each finding includes a clickable quote citation"
    - "Citations link back to transcript moments"
  artifacts:
    - path: "supabase/functions/extract-profits/index.ts"
      provides: "PROFITS extraction Edge Function"
      exports: ["Deno.serve handler"]
    - path: "src/hooks/usePROFITS.ts"
      provides: "usePROFITS hook for triggering and fetching"
      exports: ["usePROFITS"]
    - path: "src/components/profits/PROFITSReport.tsx"
      provides: "Full report view component"
  key_links:
    - from: "src/pages/CallDetailPage.tsx"
      to: "src/hooks/usePROFITS.ts"
      via: "usePROFITS hook call"
      pattern: "usePROFITS\\("
    - from: "src/hooks/usePROFITS.ts"
      to: "/extract-profits"
      via: "supabase.functions.invoke"
      pattern: "invoke\\(['\"]extract-profits"
---

<objective>
Implement PROFITS Framework v2 - sales psychology extraction from call transcripts with clickable citations.

Purpose: PROFITS (Pain, Results, Obstacles, Fears, Identity, Triggers, Success) is a differentiating feature that extracts sales psychology insights from call transcripts, making CallVault valuable for sales teams.

Output: Edge Function for extraction, React hook for triggering/fetching, report UI components, and wired CallDetailPage PROFITS tab.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-differentiators/07-RESEARCH.md

# Existing patterns to follow
@supabase/functions/content-insight-miner/index.ts
@src/pages/CallDetailPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extract-profits Edge Function</name>
  <files>
    supabase/functions/extract-profits/index.ts
  </files>
  <action>
Create new Edge Function `extract-profits` following `content-insight-miner` pattern:

1. Standard Deno.serve handler with CORS and auth
2. Accept `{ recording_id: number }` in request body
3. Fetch transcript chunks from `fathom_transcripts` for the recording
4. Call OpenRouter with system prompt for PROFITS extraction:
   - P (Pain): Problems, struggles, pain points
   - R (Results): Desired outcomes, goals
   - O (Obstacles): Barriers, blockers
   - F (Fears): Concerns, worries
   - I (Identity): Self-description, role, company
   - T (Triggers): Action motivators
   - S (Success): Wins, achievements

5. Each finding MUST include:
   - `text`: Summary of the finding
   - `quote`: Exact quote from transcript (verbatim)
   - `citation`: { transcript_id, chunk_index, timestamp }
   - `confidence`: 0-1 score

6. Store result in `fathom_calls.profits_framework` JSONB column (already exists)
7. Return the structured PROFITS report

Use Vercel AI SDK streamText pattern with OpenRouter. Process transcript in batches if needed to avoid context limits (see pitfall in RESEARCH.md).

Interface:
```typescript
interface PROFITSSection {
  letter: 'P' | 'R' | 'O' | 'F' | 'I' | 'T' | 'S';
  title: string;
  findings: Array<{
    text: string;
    quote: string;
    citation: {
      transcript_id: string;
      chunk_index: number;
      timestamp?: string;
    };
    confidence: number;
  }>;
}
```
  </action>
  <verify>
Deploy function: `supabase functions deploy extract-profits`
Test with curl: `curl -X POST [function-url] -H "Authorization: Bearer [token]" -d '{"recording_id": [valid_id]}'`
Response should contain 7 sections with findings array each.
  </verify>
  <done>
Edge Function deployed and returns structured PROFITS extraction with citations for any valid recording_id.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usePROFITS hook and UI components</name>
  <files>
    src/hooks/usePROFITS.ts
    src/components/profits/PROFITSReport.tsx
    src/components/profits/PROFITSSection.tsx
  </files>
  <action>
1. Create `src/hooks/usePROFITS.ts`:
   - `usePROFITS(recordingId: number)` hook
   - Query existing profits_framework from fathom_calls
   - `runExtraction()` mutation to invoke extract-profits function
   - Return: `{ data, isLoading, isExtracting, runExtraction }`
   - Use TanStack Query with queryKey pattern from queryKeys factory

2. Create `src/components/profits/PROFITSSection.tsx`:
   - Display single section (letter, title, findings)
   - Each finding shows summary + clickable quote
   - Quote click emits `onCitationClick(citation)` for transcript navigation
   - Visual: Collapsible section with letter badge (P, R, O, etc.)
   - Style per brand guidelines (Montserrat headings, Inter body)

3. Create `src/components/profits/PROFITSReport.tsx`:
   - Full report view with all 7 sections
   - "Run PROFITS Analysis" button (if no data yet)
   - Loading state during extraction
   - Pass `onCitationClick` through to sections
   - Shows extraction timestamp and model used
  </action>
  <verify>
TypeScript compiles without errors: `npm run typecheck`
Components render in isolation (create test if needed).
  </verify>
  <done>
Hook fetches/triggers PROFITS extraction. Report and Section components render structured data with clickable citations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire PROFITS tab in CallDetailPage</name>
  <files>
    src/pages/CallDetailPage.tsx
  </files>
  <action>
1. Import `usePROFITS` hook and `PROFITSReport` component
2. Replace placeholder content in PROFITS tab (lines ~251-256) with:
   ```tsx
   <TabsContent value="profits">
     <PROFITSReport 
       recordingId={recordingId}
       onCitationClick={(citation) => {
         // Navigate to transcript moment
         // Use existing transcript navigation pattern if available
         // Or scroll to chunk_index in transcript view
       }}
     />
   </TabsContent>
   ```
3. Handle citation click to jump to transcript moment:
   - Check if transcript tab/view exists on page
   - Either switch to transcript tab and scroll to citation
   - Or open transcript panel with citation highlighted
  </action>
  <verify>
1. Navigate to any call detail page in browser
2. Click PROFITS tab
3. Click "Run PROFITS Analysis" button
4. Verify 7 sections appear with findings
5. Click a quote citation and verify navigation to transcript moment
  </verify>
  <done>
PROFITS tab shows extraction UI, analysis runs on demand, citations navigate to transcript locations.
  </done>
</task>

</tasks>

<verification>
1. PROFITS Edge Function returns valid extraction for any recording with transcript data
2. UI renders all 7 PROFITS sections correctly
3. Citations are clickable and navigate to correct transcript moments
4. Data persists in fathom_calls.profits_framework column
5. Re-running extraction updates existing data
</verification>

<success_criteria>
- User can click "Run PROFITS Analysis" on any call with transcript
- Analysis completes and shows 7 structured sections
- Each finding includes a quote with source citation
- Clicking citation navigates to that moment in transcript
- PROFITS data persists and loads on page revisit
</success_criteria>

<output>
After completion, create `.planning/phases/07-differentiators/07-01-SUMMARY.md`
</output>
