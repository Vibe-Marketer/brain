---
phase: 07-differentiators
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - supabase/migrations/20260131000003_create_contacts_table.sql
  - src/hooks/useContacts.ts
  - src/components/contacts/ContactsTable.tsx
  - src/components/contacts/ContactCard.tsx
  - src/components/contacts/TrackingToggle.tsx
  - src/pages/SettingsPage.tsx
  - src/types/contacts.ts
autonomous: true

must_haves:
  truths:
    - "User can view Settings > Contacts tab"
    - "Contacts table shows people from call attendees"
    - "User can toggle 'Track all contacts' vs manual tracking"
    - "User can mark contacts as Client, Customer, or Lead"
    - "Contact cards show name, email, all calls, last seen"
  artifacts:
    - path: "supabase/migrations/20260131000003_create_contacts_table.sql"
      provides: "contacts and contact_call_appearances tables"
      contains: "CREATE TABLE contacts"
    - path: "src/hooks/useContacts.ts"
      provides: "useContacts hook for CRUD operations"
      exports: ["useContacts"]
    - path: "src/components/contacts/ContactsTable.tsx"
      provides: "Main contacts list view"
  key_links:
    - from: "src/hooks/useContacts.ts"
      to: "contacts table"
      via: "supabase query"
      pattern: "\\.from\\(['\"]contacts"
    - from: "src/pages/SettingsPage.tsx"
      to: "src/components/contacts/ContactsTable.tsx"
      via: "Contacts tab import"
      pattern: "ContactsTable"
---

<objective>
Implement Contacts Database - track call attendees with tagging and health monitoring support.

Purpose: DIFF-04 enables users to maintain a contacts database populated from call attendees. This provides the foundation for Client Health Alerts (DIFF-03) and gives users CRM-like tracking within CallVault.

Output: Database schema for contacts, React hook, ContactsTable UI in Settings, contact tagging and import functionality.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-differentiators/07-RESEARCH.md
@.planning/phases/07-differentiators/07-CONTEXT.md

# Existing patterns to follow
@src/hooks/useFolders.ts
@src/pages/SettingsPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contacts database schema</name>
  <files>
    supabase/migrations/20260131000003_create_contacts_table.sql
    src/types/contacts.ts
  </files>
  <action>
1. Create migration `20260131000003_create_contacts_table.sql`:
   ```sql
   -- ============================================================================
   -- TABLE: contacts
   -- ============================================================================
   -- Stores contacts derived from call attendees with tracking preferences
   
   CREATE TABLE contacts (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
     email TEXT NOT NULL,
     name TEXT,
     
     -- Tracking config
     track_health BOOLEAN DEFAULT false,
     contact_type TEXT CHECK (contact_type IN ('client', 'customer', 'lead', 'other')),
     
     -- Health tracking
     last_seen_at TIMESTAMPTZ,
     last_call_recording_id BIGINT,
     health_alert_threshold_days INTEGER,  -- NULL = use global default
     last_alerted_at TIMESTAMPTZ,  -- For cooldown tracking
     
     -- Metadata
     notes TEXT,
     tags TEXT[],
     created_at TIMESTAMPTZ DEFAULT NOW(),
     updated_at TIMESTAMPTZ DEFAULT NOW(),
     
     UNIQUE(user_id, email)
   );
   
   -- ============================================================================
   -- TABLE: contact_call_appearances
   -- ============================================================================
   -- Junction table linking contacts to calls they appeared in
   
   CREATE TABLE contact_call_appearances (
     contact_id UUID REFERENCES contacts(id) ON DELETE CASCADE,
     recording_id BIGINT NOT NULL,
     user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
     appeared_at TIMESTAMPTZ,
     FOREIGN KEY (recording_id, user_id) REFERENCES fathom_calls(recording_id, user_id) ON DELETE CASCADE,
     PRIMARY KEY (contact_id, recording_id, user_id)
   );
   
   -- ============================================================================
   -- TABLE: user_contact_settings
   -- ============================================================================
   -- User-level contact tracking preferences
   
   CREATE TABLE user_contact_settings (
     user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
     track_all_contacts BOOLEAN DEFAULT true,  -- Per CONTEXT.md: default ON
     default_health_threshold_days INTEGER DEFAULT 14,
     created_at TIMESTAMPTZ DEFAULT NOW(),
     updated_at TIMESTAMPTZ DEFAULT NOW()
   );
   
   -- ============================================================================
   -- INDEXES
   -- ============================================================================
   CREATE INDEX idx_contacts_user_id ON contacts(user_id);
   CREATE INDEX idx_contacts_email ON contacts(user_id, email);
   CREATE INDEX idx_contacts_track_health ON contacts(user_id, track_health) WHERE track_health = true;
   CREATE INDEX idx_contact_appearances_recording ON contact_call_appearances(recording_id, user_id);
   
   -- ============================================================================
   -- ROW LEVEL SECURITY
   -- ============================================================================
   ALTER TABLE contacts ENABLE ROW LEVEL SECURITY;
   ALTER TABLE contact_call_appearances ENABLE ROW LEVEL SECURITY;
   ALTER TABLE user_contact_settings ENABLE ROW LEVEL SECURITY;
   
   -- RLS policies for contacts
   CREATE POLICY "Users can view their own contacts"
     ON contacts FOR SELECT USING (auth.uid() = user_id);
   CREATE POLICY "Users can insert their own contacts"
     ON contacts FOR INSERT WITH CHECK (auth.uid() = user_id);
   CREATE POLICY "Users can update their own contacts"
     ON contacts FOR UPDATE USING (auth.uid() = user_id);
   CREATE POLICY "Users can delete their own contacts"
     ON contacts FOR DELETE USING (auth.uid() = user_id);
   
   -- RLS policies for appearances
   CREATE POLICY "Users can view their contact appearances"
     ON contact_call_appearances FOR SELECT USING (auth.uid() = user_id);
   CREATE POLICY "Users can insert their contact appearances"
     ON contact_call_appearances FOR INSERT WITH CHECK (auth.uid() = user_id);
   CREATE POLICY "Users can delete their contact appearances"
     ON contact_call_appearances FOR DELETE USING (auth.uid() = user_id);
   
   -- RLS policies for settings
   CREATE POLICY "Users can manage their contact settings"
     ON user_contact_settings FOR ALL USING (auth.uid() = user_id);
   
   -- ============================================================================
   -- COMMENTS
   -- ============================================================================
   COMMENT ON TABLE contacts IS 'User contacts derived from call attendees';
   COMMENT ON COLUMN contacts.track_health IS 'Whether to monitor this contact for health alerts';
   COMMENT ON COLUMN contacts.contact_type IS 'Classification: client, customer, lead, or other';
   COMMENT ON COLUMN contacts.last_alerted_at IS 'Last time health alert was sent for this contact';
   ```

2. Create `src/types/contacts.ts`:
   ```typescript
   export type ContactType = 'client' | 'customer' | 'lead' | 'other';
   
   export interface Contact {
     id: string;
     user_id: string;
     email: string;
     name: string | null;
     track_health: boolean;
     contact_type: ContactType | null;
     last_seen_at: string | null;
     last_call_recording_id: number | null;
     health_alert_threshold_days: number | null;
     last_alerted_at: string | null;
     notes: string | null;
     tags: string[] | null;
     created_at: string;
     updated_at: string;
   }
   
   export interface ContactCallAppearance {
     contact_id: string;
     recording_id: number;
     user_id: string;
     appeared_at: string | null;
   }
   
   export interface UserContactSettings {
     user_id: string;
     track_all_contacts: boolean;
     default_health_threshold_days: number;
   }
   ```
  </action>
  <verify>
Apply migration: `supabase db push`
Verify tables created: Check in Supabase dashboard or via SQL.
  </verify>
  <done>
contacts, contact_call_appearances, and user_contact_settings tables created with RLS policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useContacts hook</name>
  <files>
    src/hooks/useContacts.ts
    src/lib/query-config.ts
  </files>
  <action>
1. Add query keys to `src/lib/query-config.ts`:
   ```typescript
   contacts: {
     all: ['contacts'] as const,
     list: () => ['contacts', 'list'] as const,
     detail: (id: string) => ['contacts', 'detail', id] as const,
     settings: () => ['contacts', 'settings'] as const,
   },
   ```

2. Create `src/hooks/useContacts.ts` following useFolders pattern:
   - `useContacts()` hook with:
     - `contacts`: List of all contacts
     - `settings`: User contact settings (track_all toggle)
     - `isLoading`: Query loading state
     - `createContact(email, name?)`: Add new contact
     - `updateContact(id, updates)`: Update contact fields
     - `deleteContact(id)`: Remove contact
     - `updateSettings(updates)`: Update tracking settings
     - `importFromCall(recordingId)`: Import attendees from specific call
     - `importAllContacts()`: Bulk import all attendees from all calls
     - `getContactAppearances(contactId)`: Get calls this contact appeared in

   Key implementation notes:
   - Normalize emails (lowercase, trim) before insert (per RESEARCH.md pitfall)
   - Use optimistic updates pattern from useFolders
   - Handle upsert for duplicate emails (UNIQUE constraint)

3. Import attendees from fathom_calls.calendar_invitees:
   ```typescript
   async function importFromCall(recordingId: number) {
     const { data: call } = await supabase
       .from('fathom_calls')
       .select('calendar_invitees, recording_start_time')
       .eq('recording_id', recordingId)
       .single();
     
     if (!call?.calendar_invitees) return;
     
     const invitees = call.calendar_invitees as Array<{
       email: string;
       name?: string;
       external?: boolean;
     }>;
     
     for (const invitee of invitees) {
       // Normalize email
       const email = invitee.email.toLowerCase().trim();
       
       // Upsert contact
       await supabase
         .from('contacts')
         .upsert({
           user_id: userId,
           email,
           name: invitee.name || null,
           last_seen_at: call.recording_start_time,
           last_call_recording_id: recordingId,
         }, { onConflict: 'user_id,email' });
       
       // ... add to contact_call_appearances
     }
   }
   ```
  </action>
  <verify>
TypeScript compiles: `npm run typecheck`
Hook exports expected functions: Check imports work.
  </verify>
  <done>
useContacts hook provides full CRUD for contacts with import from call attendees.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Contacts UI in Settings</name>
  <files>
    src/components/contacts/ContactsTable.tsx
    src/components/contacts/ContactCard.tsx
    src/components/contacts/TrackingToggle.tsx
    src/pages/SettingsPage.tsx
  </files>
  <action>
1. Create `src/components/contacts/TrackingToggle.tsx`:
   - iPhone-style toggle for "Track all contacts" setting
   - Shows current state and toggles user_contact_settings.track_all_contacts
   - Description text explaining the difference

2. Create `src/components/contacts/ContactCard.tsx`:
   - Displays contact details: name, email, contact type badge, last seen
   - Shows number of calls this contact appears in
   - Type selector dropdown (Client, Customer, Lead, Other)
   - Health tracking toggle (per-contact)
   - Notes textarea
   - Delete button

3. Create `src/components/contacts/ContactsTable.tsx`:
   - TrackingToggle at top
   - Table/list of contacts with:
     - Name (or email if no name)
     - Email
     - Type badge
     - Last Seen date
     - Call count
     - Health tracking indicator
   - Click row to open ContactCard in 4th pane
   - "Import All" button to bulk import from all calls
   - Search/filter by name or email
   - Sort by name, email, last seen, call count

4. Add Contacts tab to `src/pages/SettingsPage.tsx`:
   - Add TabsTrigger for "Contacts"
   - Add TabsContent rendering ContactsTable
   - Follow existing settings tabs pattern
  </action>
  <verify>
1. Navigate to Settings page
2. Click Contacts tab
3. Verify TrackingToggle renders
4. Click "Import All" and verify contacts appear
5. Click a contact row and verify ContactCard opens
6. Change contact type and verify it saves
7. Toggle health tracking and verify it saves
  </verify>
  <done>
Contacts tab in Settings shows contacts table with import, filtering, and detail view functionality.
  </done>
</task>

</tasks>

<verification>
1. Database tables created with proper RLS
2. useContacts hook provides CRUD operations
3. Contacts tab appears in Settings
4. Import from calls works (calendar_invitees â†’ contacts)
5. Contact type tagging works (Client, Customer, Lead)
6. Health tracking toggle per contact works
7. Track all contacts toggle works
</verification>

<success_criteria>
- User can view Settings > Contacts tab
- Contacts populate from call attendees (manual or automatic)
- User can tag contacts as Client, Customer, Lead, Other
- User can toggle health tracking per contact
- Contact cards show name, email, calls, last seen
- "Track all contacts" toggle sets global preference
</success_criteria>

<output>
After completion, create `.planning/phases/07-differentiators/07-04-SUMMARY.md`
</output>
