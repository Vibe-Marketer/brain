---
phase: 03.2-integration-import-controls
plan: 02
type: execute
wave: 2
depends_on: ["03.2-01"]
files_modified:
  - src/components/sync/SourcesFilterPopover.tsx
  - src/components/transcripts/SyncTab.tsx
autonomous: true

must_haves:
  truths:
    - "User sees Sources filter button alongside date filter"
    - "User can toggle integrations on/off in dropdown"
    - "Meetings list filters immediately when toggle changes"
    - "At least one source must remain enabled"
    - "Visual feedback shows which sources are enabled"
  artifacts:
    - path: "src/components/sync/SourcesFilterPopover.tsx"
      provides: "Sources filter UI component"
      exports: ["SourcesFilterPopover"]
      min_lines: 80
    - path: "src/components/transcripts/SyncTab.tsx"
      provides: "Sync page with sources filter"
      contains: "SourcesFilterPopover"
  key_links:
    - from: "src/components/sync/SourcesFilterPopover.tsx"
      to: "useSyncSourceFilter"
      via: "hook import"
      pattern: "useSyncSourceFilter"
    - from: "src/components/transcripts/SyncTab.tsx"
      to: "SourcesFilterPopover"
      via: "component import"
      pattern: "SourcesFilterPopover"
    - from: "src/components/transcripts/SyncTab.tsx"
      to: "filteredExistingTranscripts"
      via: "client-side filter"
      pattern: "enabledSources\\.includes"
---

<objective>
Create Sources filter UI and wire it into the Sync page for client-side filtering.

Purpose: Allow users to toggle which integrations' meetings are shown when viewing the Sync page.
Output: SourcesFilterPopover component + SyncTab integration with immediate client-side filtering.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-integration-import-controls/03.2-CONTEXT.md
@.planning/phases/03.2-integration-import-controls/03.2-RESEARCH.md
@.planning/phases/03.2-integration-import-controls/03.2-01-SUMMARY.md

@src/components/transcript-library/TagFilterPopover.tsx
@src/components/transcript-library/FilterButton.tsx
@src/components/ui/switch.tsx
@src/components/transcript-library/SourcePlatformIcons.tsx
@src/components/transcripts/SyncTab.tsx
@src/hooks/useSyncSourceFilter.ts
@src/hooks/useIntegrationSync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SourcesFilterPopover component</name>
  <files>
    src/components/sync/SourcesFilterPopover.tsx
  </files>
  <action>
Create a filter popover component following the TagFilterPopover pattern but using Switch toggles.

Props interface:
```typescript
interface SourcesFilterPopoverProps {
  connectedIntegrations: IntegrationStatus[];  // From useIntegrationSync
  enabledSources: string[];                     // From useSyncSourceFilter
  onSourceToggle: (platform: string, enabled: boolean) => Promise<boolean>;  // Returns false if prevented
}
```

Component structure:
1. FilterButton trigger with:
   - Label "Sources"
   - Count badge showing number of enabled sources
   - Small circular integration icons for enabled sources (use FathomIcon, ZoomIcon, GoogleMeetIcon with size={14})
   - Ring highlight when filter is active (some sources disabled)

2. PopoverContent with:
   - Title "Filter by source"
   - List of connected integrations only (not all possible integrations)
   - Each row: Icon (size=20) + platform name + Switch toggle
   - Dimmed row appearance when toggle is off (opacity-50)
   - Switch disabled state + toast when trying to disable last source

Platform display names:
- fathom: "Fathom"
- zoom: "Zoom"
- google_meet: "Google Meet"

Order integrations: Fathom first, then Zoom, then Google Meet (same as SourcePlatformIndicator).

Use existing components:
- Popover, PopoverContent, PopoverTrigger from @/components/ui/popover
- FilterButton from @/components/transcript-library/FilterButton
- Switch from @/components/ui/switch
- FathomIcon, ZoomIcon, GoogleMeetIcon from @/components/transcript-library/SourcePlatformIcons
- cn from @/lib/utils
- toast from sonner

Handle the "prevent last disable" case:
- When onSourceToggle returns false (prevented), the Switch should stay in its current position
- Show toast.error("At least one source must be enabled")
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Component exports SourcesFilterPopover
3. Component uses Switch (not Checkbox)
4. Component handles prevent-last-disable case
  </verify>
  <done>
- SourcesFilterPopover.tsx exists in src/components/sync/
- Component matches FilterButton + Popover pattern
- Uses Switch toggles with dimmed state when off
- Shows integration icons in trigger button
- Handles prevent-last-disable with toast
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire SourcesFilterPopover into SyncTab</name>
  <files>
    src/components/transcripts/SyncTab.tsx
  </files>
  <action>
Integrate the sources filter into SyncTab with these changes:

1. Import new dependencies:
```typescript
import { SourcesFilterPopover } from "@/components/sync/SourcesFilterPopover";
import { useSyncSourceFilter } from "@/hooks/useSyncSourceFilter";
```

2. Add hook usage near the top of the component (after useIntegrationSync if used, or after other hooks):
```typescript
// Get connected integrations from useIntegrationSync (if not already present)
const { integrations } = useIntegrationSync();

// Get filter state
const connectedPlatforms = integrations.filter(i => i.connected).map(i => i.platform);
const { enabledSources, toggleSource, isLoading: filterLoading } = useSyncSourceFilter(connectedPlatforms);
```

3. Add SourcesFilterPopover next to DateRangePicker in the filter bar (line ~498-509 area):
   - Position it AFTER the DateRangePicker, BEFORE the buttons
   - Only show when there are connected integrations
   - Maintain the flex row layout

4. Update filteredExistingTranscripts filter (around line 465):
   - Add source platform filter that checks if transcript's source_platform is in enabledSources
   - Handle null/undefined source_platform as 'fathom' (default)

```typescript
const filteredExistingTranscripts = existingTranscripts.filter(t => {
  // Source platform filter - default to 'fathom' if not set
  const platform = (t as any).source_platform || 'fathom';
  if (!enabledSources.includes(platform)) {
    return false;
  }

  // Existing category filter
  if (selectedCategory !== "all" && !tagAssignments[t.recording_id]?.includes(selectedCategory)) {
    return false;
  }

  return true;
});
```

Note: The Meeting type may not have source_platform - use type assertion (as any) for now since the DB query already returns it but types may not reflect it.

5. Ensure the filter is in the correct visual position - should be a peer of DateRangePicker, not nested inside it.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. SourcesFilterPopover appears in the filter bar on Sync page
3. Toggling a source immediately filters the meetings list (no page refresh)
4. Cannot disable all sources (toast appears, last toggle stays on)
5. Filter state persists across page navigation (refresh Sync tab, filter still applied)
  </verify>
  <done>
- SyncTab imports and uses SourcesFilterPopover
- SyncTab imports and uses useSyncSourceFilter
- Filter appears alongside date filter in UI
- Meetings list filters by enabled sources client-side
- Filter state persists to database
  </done>
</task>

<task type="auto">
  <name>Task 3: Visual verification with Playwright</name>
  <files>None (verification only)</files>
  <action>
Use Playwright to verify the feature works correctly:

1. Start dev server if not running: `npm run dev`
2. Navigate to http://localhost:8080/?tab=sync
3. Screenshot the filter bar showing Sources button
4. Click Sources button to open dropdown
5. Screenshot the dropdown showing toggle switches
6. Toggle one source off (if multiple connected)
7. Verify meetings list updates
8. Screenshot final state

Document any visual issues or behavior that doesn't match requirements.
  </action>
  <verify>
1. Screenshots captured showing:
   - Sources button in filter bar
   - Dropdown with toggle switches
   - Filtered meeting list
2. No console errors during interaction
3. Visual appearance matches established filter patterns
  </verify>
  <done>
- Feature visually verified working
- Screenshots captured for documentation
- No blocking visual issues found
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (no TypeScript errors)
2. Sources filter appears on Sync page alongside date filter
3. Filter dropdown shows connected integrations with Switch toggles
4. Toggling sources immediately filters the meetings list
5. Cannot disable all sources (last one protected with toast)
6. Filter state persists across page refresh
7. Newly connected integrations appear in filter (enabled by default)
</verification>

<success_criteria>
1. SourcesFilterPopover component created and working
2. SyncTab integrates filter with immediate client-side filtering
3. Filter state persists to database
4. Visual verification confirms feature works as designed
5. All three requirements met: UI-INT-04, UI-INT-05, UI-INT-06
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-integration-import-controls/03.2-02-SUMMARY.md`
</output>
