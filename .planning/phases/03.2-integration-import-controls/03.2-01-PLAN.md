---
phase: 03.2-integration-import-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/YYYYMMDDHHMMSS_add_sync_source_filter.sql
  - src/integrations/supabase/types.ts
  - src/hooks/useSyncSourceFilter.ts
autonomous: true

must_haves:
  truths:
    - "Filter preferences are stored in database"
    - "Filter state loads on page visit"
    - "Filter state persists across sessions"
    - "New integrations are enabled by default"
  artifacts:
    - path: "supabase/migrations/*_add_sync_source_filter.sql"
      provides: "Database column for storing filter preferences"
      contains: "sync_source_filter"
    - path: "src/hooks/useSyncSourceFilter.ts"
      provides: "Filter state management hook"
      exports: ["useSyncSourceFilter"]
  key_links:
    - from: "src/hooks/useSyncSourceFilter.ts"
      to: "user_settings table"
      via: "supabase query"
      pattern: "from\\(['\"]user_settings['\"]\\)"
---

<objective>
Add database column and hook for managing sync source filter preferences.

Purpose: Enable persistent storage and retrieval of which integrations are included when viewing meetings on the Sync page.
Output: Database migration + useSyncSourceFilter hook that manages filter state with database persistence.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-integration-import-controls/03.2-CONTEXT.md
@.planning/phases/03.2-integration-import-controls/03.2-RESEARCH.md

@src/hooks/useIntegrationSync.ts
@src/integrations/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sync_source_filter column to user_settings</name>
  <files>
    supabase/migrations/YYYYMMDDHHMMSS_add_sync_source_filter.sql
  </files>
  <action>
Create a new Supabase migration file with timestamp format (use current timestamp).

The migration should:
1. Add `sync_source_filter text[] DEFAULT NULL` column to `user_settings` table
2. NULL means "all connected platforms enabled" (default behavior)
3. When set, array contains platform strings like ['fathom', 'zoom', 'google_meet']

SQL:
```sql
-- Add sync_source_filter column to user_settings
-- NULL = all connected platforms enabled (default)
-- Array of platform strings when user has customized filter

ALTER TABLE public.user_settings
ADD COLUMN IF NOT EXISTS sync_source_filter text[] DEFAULT NULL;

-- Add comment explaining the column
COMMENT ON COLUMN public.user_settings.sync_source_filter IS 
  'Array of enabled platform strings for Sync page filter. NULL means all connected platforms enabled.';
```

After creating the migration file, run `supabase db push` to apply to local database.
Then run `supabase gen types typescript --local > src/integrations/supabase/types.ts` to regenerate TypeScript types.
  </action>
  <verify>
1. Run `supabase db push` - should succeed
2. Run `supabase gen types typescript --local > src/integrations/supabase/types.ts` - types regenerated
3. Check types.ts contains `sync_source_filter: string[] | null` in user_settings Row type
  </verify>
  <done>
- Migration file exists in supabase/migrations/
- Column added to database (verified via db push)
- TypeScript types regenerated with sync_source_filter field
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useSyncSourceFilter hook</name>
  <files>
    src/hooks/useSyncSourceFilter.ts
  </files>
  <action>
Create a new hook that manages sync source filter state with database persistence.

The hook should:
1. Load filter preferences from user_settings on mount
2. Intersect saved filter with currently connected platforms (handle orphaned state)
3. Default to all connected platforms if no saved preference
4. Provide toggle function that saves to database
5. Prevent disabling last enabled source (return false and show toast)
6. Auto-enable newly connected integrations

Interface:
```typescript
interface UseSyncSourceFilterReturn {
  enabledSources: string[];           // Currently enabled platform strings
  isLoading: boolean;                 // Initial load state
  toggleSource: (platform: string, enabled: boolean) => Promise<boolean>;  // Returns false if prevented
  setEnabledSources: (platforms: string[]) => Promise<void>;  // Bulk update
}
```

Implementation pattern (from RESEARCH.md):
- Use getSafeUser() for auth
- Query user_settings.sync_source_filter
- On toggle: check if would result in zero sources, if so show toast.error and return false
- Save via upsert pattern to user_settings

Take connectedPlatforms as a prop (from useIntegrationSync) so the hook can intersect saved filter with currently connected platforms.
  </action>
  <verify>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Hook exports useSyncSourceFilter function
3. Hook handles: initial load, toggle, prevent-last-disable, persistence
  </verify>
  <done>
- useSyncSourceFilter.ts exists in src/hooks/
- Hook loads filter from database on mount
- Hook saves filter changes to database
- Hook prevents disabling all sources (shows toast, returns false)
- Hook intersects saved filter with connected platforms
  </done>
</task>

</tasks>

<verification>
1. Database column exists: Query `SELECT sync_source_filter FROM user_settings LIMIT 1` succeeds
2. TypeScript types include sync_source_filter field
3. Hook compiles and exports correctly
4. No TypeScript errors: `npx tsc --noEmit`
</verification>

<success_criteria>
1. Migration file created and applied to local database
2. TypeScript types regenerated with new column
3. useSyncSourceFilter hook created with all required functionality
4. All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-integration-import-controls/03.2-01-SUMMARY.md`
</output>
