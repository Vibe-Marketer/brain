---
phase: 18-import-routing-rules
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - callvault/package.json
  - callvault/src/lib/query-config.ts
  - callvault/src/types/routing.ts
  - callvault/src/stores/routingRuleStore.ts
  - callvault/src/hooks/useRoutingRules.ts
  - callvault/src/components/import/DestinationPicker.tsx
  - callvault/src/components/import/DefaultDestinationBar.tsx
  - callvault/src/components/import/RoutingRuleCard.tsx
  - callvault/src/components/import/RoutingRulesList.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a list of routing rule cards ordered by priority"
    - "User can drag to reorder rules and priority persists across page refresh (IMP-06)"
    - "User can toggle a rule enabled/disabled"
    - "Default destination setting appears above the rule list (IMP-07)"
    - "User can set the default destination to any workspace/folder in the org"
    - "Destination picker shows workspace > folder cascade"
  artifacts:
    - path: "callvault/src/types/routing.ts"
      provides: "RoutingRule, RoutingCondition, RoutingDestination, RoutingDefault types"
      min_lines: 20
    - path: "callvault/src/hooks/useRoutingRules.ts"
      provides: "CRUD hooks for routing rules + reorder mutation + default destination hooks"
      min_lines: 80
    - path: "callvault/src/stores/routingRuleStore.ts"
      provides: "Zustand store for slide-over open/close state and active rule ID"
      min_lines: 15
    - path: "callvault/src/components/import/RoutingRulesList.tsx"
      provides: "Drag-to-reorder rule card list using @dnd-kit/sortable"
      min_lines: 50
    - path: "callvault/src/components/import/RoutingRuleCard.tsx"
      provides: "Single rule card with drag handle, summary, destination, match count, enabled toggle"
      min_lines: 40
    - path: "callvault/src/components/import/DefaultDestinationBar.tsx"
      provides: "Top-level default destination setting with helper text"
      min_lines: 30
    - path: "callvault/src/components/import/DestinationPicker.tsx"
      provides: "Cascading workspace > folder select"
      min_lines: 30
  key_links:
    - from: "callvault/src/hooks/useRoutingRules.ts"
      to: "import_routing_rules table"
      via: "supabase.from('import_routing_rules') queries"
      pattern: "from\\('import_routing_rules'\\)"
    - from: "callvault/src/hooks/useRoutingRules.ts"
      to: "update_routing_rule_priorities RPC"
      via: "supabase.rpc('update_routing_rule_priorities')"
      pattern: "rpc\\('update_routing_rule_priorities'\\)"
    - from: "callvault/src/components/import/RoutingRulesList.tsx"
      to: "@dnd-kit/sortable"
      via: "SortableContext + useSortable + arrayMove"
      pattern: "import.*@dnd-kit/sortable"
    - from: "callvault/src/components/import/DestinationPicker.tsx"
      to: "callvault/src/hooks/useWorkspaces.ts"
      via: "useWorkspaces for workspace list"
      pattern: "useWorkspaces"
---

<objective>
Build the frontend data layer and rule list UI with drag-to-reorder, default destination bar, and destination picker.

Purpose: This plan creates everything needed to display, reorder, toggle, and set the default destination for routing rules. After this plan, the user can see the rule list, drag to reorder, toggle rules on/off, and configure the default destination. Creating/editing rules (slide-over + condition builder) comes in Plan 03.

Output: Types, hooks, store, query keys, and 4 UI components: RoutingRulesList, RoutingRuleCard, DefaultDestinationBar, DestinationPicker.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-import-routing-rules/18-CONTEXT.md
@.planning/phases/18-import-routing-rules/18-RESEARCH.md
@.planning/phases/18-import-routing-rules/18-01-SUMMARY.md
@callvault/src/lib/query-config.ts
@callvault/src/hooks/useWorkspaces.ts
@callvault/src/hooks/useFolders.ts
@callvault/src/hooks/useImportSources.ts
@callvault/src/stores/orgContextStore.ts
@callvault/src/components/import/SourceCard.tsx
@callvault/src/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data layer — types, query keys, hooks, store, install @dnd-kit/sortable</name>
  <files>callvault/package.json, callvault/src/types/routing.ts, callvault/src/lib/query-config.ts, callvault/src/hooks/useRoutingRules.ts, callvault/src/stores/routingRuleStore.ts</files>
  <action>
**Install @dnd-kit/sortable:**
```bash
cd /Users/Naegele/dev/callvault && npm install @dnd-kit/sortable
```

**Create `src/types/routing.ts`:**
```typescript
export interface RoutingCondition {
  field: 'title' | 'participant' | 'source' | 'duration' | 'tag' | 'date'
  operator: string  // varies by field: contains, equals, greater_than, after, etc.
  value: string | number
}

export interface RoutingRule {
  id: string
  bank_id: string
  name: string
  priority: number
  enabled: boolean
  conditions: RoutingCondition[]
  logic_operator: 'AND' | 'OR'
  target_vault_id: string
  target_folder_id: string | null
  created_by: string
  created_at: string
  updated_at: string
}

export interface RoutingDefault {
  bank_id: string
  target_vault_id: string
  target_folder_id: string | null
  updated_by: string
  updated_at: string
}

export interface RoutingDestination {
  vaultId: string
  folderId: string | null
}
```

**Add to `src/lib/query-config.ts`:**
Add a `routingRules` key to the queryKeys object:
```typescript
routingRules: {
  all: ['routing-rules'] as const,
  list: (bankId?: string) => ['routing-rules', 'list', bankId] as const,
  defaults: (bankId?: string) => ['routing-rules', 'defaults', bankId] as const,
  preview: (bankId?: string) => ['routing-rules', 'preview', bankId] as const,
},
```

**Create `src/stores/routingRuleStore.ts`:**
Zustand store for slide-over state (UI-only, per FOUND-06 hard boundary):
- `isSlideOverOpen: boolean`
- `activeRuleId: string | null` — null means "create new"
- `openSlideOver(ruleId: string | null): void`
- `closeSlideOver(): void`

**Create `src/hooks/useRoutingRules.ts`:**
This hook module provides all CRUD operations and the reorder mutation.

1. `useRoutingRules()` — useQuery fetching all rules for the active bank (from orgContextStore.activeBankId), ordered by priority ASC. Returns `RoutingRule[]`.

2. `useCreateRule()` — useMutation that inserts a new rule. On success, invalidate routingRules.list. The mutation accepts `{ name, conditions, logic_operator, target_vault_id, target_folder_id, enabled }`. Priority is set to MAX(existing priorities) + 1 (append to bottom of list).

3. `useUpdateRule()` — useMutation that updates an existing rule by ID. Invalidates routingRules.list on success.

4. `useDeleteRule()` — useMutation that deletes a rule by ID. Invalidates routingRules.list on success.

5. `useToggleRule()` — useMutation that updates `enabled` field. Uses optimistic update pattern (same as useToggleSource in useImportSources.ts): cancel queries, snapshot, optimistic set, rollback on error.

6. `useReorderRules()` — useMutation that calls `supabase.rpc('update_routing_rule_priorities', { p_bank_id, p_rule_ids })`. Uses optimistic update: reorder the local list immediately, rollback on error, invalidate on settle. Show toast.error on failure.

7. `useRoutingDefault()` — useQuery fetching the default destination from `import_routing_defaults` for the active bank. Returns `RoutingDefault | null`.

8. `useUpsertRoutingDefault()` — useMutation that upserts the default destination. On success, invalidate routingRules.defaults.

Use `useOrgContextStore` (not useBankContext — the callvault v2 repo uses orgContextStore) for `activeBankId`. Use `useAuth` for `session` enabling.

Follow the existing hook patterns in `useImportSources.ts` and `useFolders.ts` for consistency: queryKey from factory, enabled guard, toast on error.
  </action>
  <verify>
`cd /Users/Naegele/dev/callvault && npx tsc --noEmit` — no type errors in new files.
Verify `@dnd-kit/sortable` installed: `ls node_modules/@dnd-kit/sortable/package.json` exists.
Verify query-config.ts still exports queryKeys with the new routingRules key.
  </verify>
  <done>@dnd-kit/sortable installed. RoutingRule/RoutingCondition/RoutingDefault types defined. Query keys for routing rules added. Zustand store for slide-over state created. All CRUD + reorder + default destination hooks created with optimistic updates.</done>
</task>

<task type="auto">
  <name>Task 2: Create rule list and destination UI components</name>
  <files>callvault/src/components/import/RoutingRulesList.tsx, callvault/src/components/import/RoutingRuleCard.tsx, callvault/src/components/import/DefaultDestinationBar.tsx, callvault/src/components/import/DestinationPicker.tsx</files>
  <action>
**Create `DestinationPicker.tsx`:**
A cascading two-step select: workspace first, then optional folder.
- Props: `value: RoutingDestination | null`, `onChange: (dest: RoutingDestination) => void`, `orgId: string`
- Uses `useWorkspaces(orgId)` to fetch workspace list for the active org
- Uses `useFolders(selectedVaultId)` to fetch folders for the selected workspace
- First Select: workspace name. On change, reset folder to null.
- Second Select (shown only after workspace selected): folder name with "No folder (root)" as default option.
- Use shadcn/ui Select components. Compact styling to fit inline.

**Create `DefaultDestinationBar.tsx`:**
Top-level bar above the rule list showing the org default destination.
- Uses `useRoutingDefault()` to read current default
- Uses `useUpsertRoutingDefault()` to save changes
- Layout: Card with left text "Unmatched calls go to:" and right side has DestinationPicker
- If no default set: show prompt "Set a default destination for calls that don't match any rule"
- Helper text below: "All imported calls that don't match a routing rule will be sent here."
- Auto-saves on selection change (no explicit Save button — one-click promise)
- Show toast.success("Default destination updated") on save
- Per CONTEXT.md locked decision: this sits ABOVE the rule list, not as a rule card

**Create `RoutingRuleCard.tsx`:**
A single rule card used inside the sortable list.
- Props: `rule: RoutingRule`, `onEdit: (id: string) => void`, `onToggle: (id: string, enabled: boolean) => void`, `sortableProps` (from useSortable)
- Uses `useSortable` from `@dnd-kit/sortable` with `id: rule.id`
- Layout per locked decision (card list):
  - Left: drag handle icon (RiDraggable from @remixicon/react) with `{...attributes} {...listeners}` — only the handle triggers drag, not the whole card
  - Center: rule name (bold), sentence summary of conditions below (e.g., "When title contains 'Q1' AND source is Fathom"), destination workspace > folder
  - Right: enabled/disabled Switch (shadcn/ui), click handler calls onToggle
- Card styling: border, rounded-xl, bg-card, hover:bg-muted/30 transition
- When disabled: lower opacity (opacity-60), strikethrough on name
- Transform + transition via `CSS.Transform.toString(transform)` from `@dnd-kit/utilities`
- isDragging state: opacity 0.5
- On card body click (not drag handle, not switch): call `onEdit(rule.id)` to open slide-over

Build a helper function `summarizeConditions(conditions, logicOperator)` that generates the sentence-like summary: "When title contains 'review' AND source is Fathom" — joins conditions with logic_operator.

**Create `RoutingRulesList.tsx`:**
The drag-to-reorder container for RoutingRuleCards.
- Props: `rules: RoutingRule[]`, `onReorder: (orderedIds: string[]) => void`, `onEdit: (id: string) => void`, `onToggle: (id: string, enabled: boolean) => void`
- Uses `DndContext` from `@dnd-kit/core` with `PointerSensor` (plus `KeyboardSensor` for accessibility)
- Uses `SortableContext` from `@dnd-kit/sortable` with `verticalListSortingStrategy`
- Local state `items` synced from `rules` prop. On `onDragEnd`: compute new order via `arrayMove`, update local state optimistically, call `onReorder` with new ID array.
- Renders RoutingRuleCard for each item
- `closestCenter` collision detection (import from @dnd-kit/core)
- Wrap in a div with `space-y-2` for card spacing
  </action>
  <verify>
`cd /Users/Naegele/dev/callvault && npx tsc --noEmit` — no type errors.
All 4 components export default or named exports.
RoutingRulesList imports from @dnd-kit/sortable and @dnd-kit/core.
DestinationPicker uses useWorkspaces and useFolders hooks.
  </verify>
  <done>Four UI components created: DestinationPicker (cascading workspace > folder), DefaultDestinationBar (org default with auto-save), RoutingRuleCard (sortable card with drag handle, summary, toggle), RoutingRulesList (DnD container with vertical list strategy). All use existing hooks and shadcn/ui components.</done>
</task>

</tasks>

<verification>
- `@dnd-kit/sortable` in package.json dependencies
- Types in routing.ts match the DB schema (same field names)
- Query keys added to query-config.ts
- Hooks use orgContextStore.activeBankId (not useBankContext)
- RoutingRulesList uses SortableContext + verticalListSortingStrategy
- RoutingRuleCard drag handle uses useSortable with listeners on handle only
- DefaultDestinationBar auto-saves via useUpsertRoutingDefault
- DestinationPicker cascades workspace -> folder
</verification>

<success_criteria>
1. `npx tsc --noEmit` passes with zero errors
2. @dnd-kit/sortable installed and importable
3. useRoutingRules returns RoutingRule[] from Supabase
4. useReorderRules calls update_routing_rule_priorities RPC with optimistic update
5. RoutingRulesList renders sortable cards that can be dragged to reorder
6. DefaultDestinationBar displays and saves org default destination
7. DestinationPicker shows workspace > folder cascade from existing hooks
</success_criteria>

<output>
After completion, create `.planning/phases/18-import-routing-rules/18-02-SUMMARY.md`
</output>
