---
phase: 18-import-routing-rules
plan: 03
type: execute
wave: 3
depends_on: ["18-02"]
files_modified:
  - callvault/src/components/import/RoutingConditionBuilder.tsx
  - callvault/src/hooks/useRulePreview.ts
  - callvault/src/components/import/RulePreviewCount.tsx
  - callvault/src/components/import/RoutingRuleSlideOver.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a routing rule using sentence-like condition builder (IMP-04)"
    - "Condition builder supports 6 condition types: title contains, participant is, source is, duration greater than, tag is, date range (IMP-05)"
    - "User sees live preview 'This rule would match X of your last 20 calls' as conditions change (IMP-08)"
    - "User can expand 'See matching calls' to see actual call titles that match"
    - "Zero-match yellow warning appears when no calls match"
    - "Overlap warning shows when another rule with higher priority also matches some calls"
    - "AND/OR toggle between conditions works"
    - "Up to 5 conditions per rule enforced"
    - "Slide-over panel opens from right, rule list stays visible underneath"
    - "UI explicitly states 'Rules apply to new imports only' (IMP-09)"
  artifacts:
    - path: "callvault/src/components/import/RoutingConditionBuilder.tsx"
      provides: "Sentence-like condition builder with 6 types, AND/OR toggle, up to 5 conditions"
      min_lines: 120
    - path: "callvault/src/hooks/useRulePreview.ts"
      provides: "Client-side preview evaluation against last 20 calls"
      min_lines: 60
    - path: "callvault/src/components/import/RulePreviewCount.tsx"
      provides: "Match count badge with expandable call list, zero-match warning, overlap warning"
      min_lines: 50
    - path: "callvault/src/components/import/RoutingRuleSlideOver.tsx"
      provides: "Fixed-position slide-over editor panel with form, preview, save/cancel"
      min_lines: 100
  key_links:
    - from: "callvault/src/components/import/RoutingRuleSlideOver.tsx"
      to: "callvault/src/components/import/RoutingConditionBuilder.tsx"
      via: "renders ConditionBuilder inside slide-over form"
      pattern: "RoutingConditionBuilder"
    - from: "callvault/src/components/import/RoutingRuleSlideOver.tsx"
      to: "callvault/src/hooks/useRoutingRules.ts"
      via: "useCreateRule and useUpdateRule mutations"
      pattern: "useCreateRule|useUpdateRule"
    - from: "callvault/src/components/import/RulePreviewCount.tsx"
      to: "callvault/src/hooks/useRulePreview.ts"
      via: "useRulePreview for match count and matching calls"
      pattern: "useRulePreview"
    - from: "callvault/src/hooks/useRulePreview.ts"
      to: "recordings table"
      via: "supabase.from('recordings') to fetch last 20 calls for preview"
      pattern: "from\\('recordings'\\)"
---

<objective>
Build the rule editor slide-over panel with condition builder, live preview, and overlap warnings.

Purpose: This is the core rule creation/editing experience. Users need to build conditions using the sentence-like builder, see real-time preview of which calls would match, receive warnings about zero matches and overlapping rules, and save the rule. The slide-over floats over the rule list so users maintain context.

Output: RoutingConditionBuilder, useRulePreview hook, RulePreviewCount component, RoutingRuleSlideOver panel.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-import-routing-rules/18-CONTEXT.md
@.planning/phases/18-import-routing-rules/18-RESEARCH.md
@.planning/phases/18-import-routing-rules/18-02-SUMMARY.md
@callvault/src/types/routing.ts
@callvault/src/hooks/useRoutingRules.ts
@callvault/src/stores/routingRuleStore.ts
@callvault/src/components/import/DestinationPicker.tsx
@src/components/automation/ConditionBuilder.tsx
@callvault/src/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create condition builder and rule preview hook</name>
  <files>callvault/src/components/import/RoutingConditionBuilder.tsx, callvault/src/hooks/useRulePreview.ts</files>
  <action>
**Create `useRulePreview.ts`:**

This hook evaluates conditions client-side against the user's last 20 recordings. NO server-side evaluation (per research pitfall 4).

1. Fetch last 20 recordings for the active bank via `supabase.from('recordings').select('id, title, source_app, duration, recording_start_time, source_metadata, global_tags').eq('owner_user_id', user.id).order('recording_start_time', { ascending: false }).limit(20)`. Use useQuery with queryKeys.routingRules.preview(activeBankId) and staleTime 5 minutes.

2. Export `useRulePreview(conditions: RoutingCondition[], logicOperator: 'AND' | 'OR')`:
   - Uses useMemo to filter recentCalls against conditions using `evaluateConditionsClientSide()`
   - Returns `{ matchingCount: number, matchingCalls: Array<{id, title, source_app}>, totalChecked: number }`

3. Implement `evaluateConditionsClientSide(conditions, logicOperator, call)` — mirrors the server-side routing-engine.ts logic:
   - For each condition, evaluate against the call record
   - AND: all must match. OR: any must match.
   - Field handlers:
     - `title`: compare call.title with string operators (contains, not_contains, equals, starts_with)
     - `source`: compare call.source_app with string operators
     - `duration`: compare call.duration with number operators (greater_than, less_than, equals). Duration in seconds; user enters minutes — multiply user value by 60 before comparing.
     - `participant`: extract from call.source_metadata?.calendar_invitees (email/name), check any match
     - `tag`: check call.global_tags array for string match
     - `date`: compare call.recording_start_time with date operators (after, before)
   - All string comparisons case-insensitive

4. Export `useOverlapCheck(conditions: RoutingCondition[], logicOperator: 'AND' | 'OR', currentRuleId: string | null)`:
   - Uses the same preview calls data
   - Fetches all other rules via useRoutingRules()
   - For each OTHER rule with higher priority (lower priority number), check how many of the preview calls would match that rule
   - Returns `{ hasOverlap: boolean, overlappingRules: Array<{ruleId, ruleName, matchCount}> }` — only rules that match at least 1 of the SAME calls as the current conditions

**Create `RoutingConditionBuilder.tsx`:**

This is a SIMPLIFIED version of the existing `/src/components/automation/ConditionBuilder.tsx` (600 lines in brain repo). Do NOT import from brain repo — create fresh in callvault repo but use the same shadcn/ui component patterns.

Props:
- `conditions: RoutingCondition[]`
- `logicOperator: 'AND' | 'OR'`
- `onConditionsChange: (conditions: RoutingCondition[]) => void`
- `onLogicOperatorChange: (op: 'AND' | 'OR') => void`

Define the 6 condition field configs:
```typescript
const ROUTING_CONDITION_FIELDS = [
  { value: 'title',       label: 'Title',         operators: ['contains', 'not_contains', 'equals', 'starts_with'], valueType: 'text' },
  { value: 'participant', label: 'Participant',    operators: ['contains', 'equals'],                               valueType: 'text' },
  { value: 'source',      label: 'Source',         operators: ['equals'],                                           valueType: 'select', options: ['fathom', 'zoom', 'youtube', 'file-upload'] },
  { value: 'duration',    label: 'Duration (min)', operators: ['greater_than', 'less_than'],                        valueType: 'number' },
  { value: 'tag',         label: 'Tag',            operators: ['equals', 'contains'],                               valueType: 'text' },
  { value: 'date',        label: 'Date',           operators: ['after', 'before'],                                  valueType: 'date' },
]
```

Sentence-like layout (locked decision): "When [field dropdown] [operator dropdown] [value input]"
- Each condition is a row reading like a sentence
- Between rows: AND/OR toggle button. Clicking toggles the logic_operator for ALL conditions (not per-pair — it's a global toggle per locked decision). Style: small pill badge showing "AND" or "OR", clickable to toggle.
- Below conditions: "+ Add another condition" link with RiAddLine icon. Disabled if conditions.length >= 5 (locked: up to 5 per rule).
- Each row has a delete button (RiDeleteBinLine) on the right. First condition cannot be deleted if it's the only one.
- Field dropdown: shadcn Select with field labels
- Operator dropdown: shadcn Select, options filtered by selected field
- Value input: depends on valueType:
  - 'text': shadcn Input
  - 'number': shadcn Input type="number" with placeholder "minutes"
  - 'select': shadcn Select with source options (Fathom, Zoom, YouTube, File Upload)
  - 'date': native date input (type="date")

Operator labels for display (human-readable):
- contains -> "contains", not_contains -> "does not contain", equals -> "is", starts_with -> "starts with"
- greater_than -> "greater than", less_than -> "less than"
- after -> "is after", before -> "is before"
  </action>
  <verify>
`cd /Users/Naegele/dev/callvault && npx tsc --noEmit` — no type errors.
RoutingConditionBuilder renders 6 field types with correct operator sets.
useRulePreview returns matchingCount and matchingCalls.
useOverlapCheck returns overlapping rules with match counts.
  </verify>
  <done>RoutingConditionBuilder renders sentence-like condition rows with 6 field types, AND/OR toggle, 5-condition limit, and delete per row. useRulePreview evaluates conditions client-side against last 20 calls with no server round trips. useOverlapCheck identifies higher-priority rules matching the same calls.</done>
</task>

<task type="auto">
  <name>Task 2: Create rule editor slide-over panel with preview and save</name>
  <files>callvault/src/components/import/RulePreviewCount.tsx, callvault/src/components/import/RoutingRuleSlideOver.tsx</files>
  <action>
**Create `RulePreviewCount.tsx`:**

Displays live match count, expandable call list, and warnings.

Props:
- `matchingCount: number`
- `matchingCalls: Array<{id: string, title: string, source_app: string}>`
- `totalChecked: number`
- `overlapInfo: { hasOverlap: boolean, overlappingRules: Array<{ruleName: string, matchCount: number}> }`

Layout:
1. Match count badge: "This rule would match **{matchingCount}** of your last {totalChecked} calls" (IMP-08 required text)
2. If matchingCount > 0: "See matching calls" disclosure/expander (use useState toggle). When expanded, show list of matching call titles with source_app badge.
3. If matchingCount === 0: Yellow warning box with RiAlertLine icon: "This rule didn't match any of your last {totalChecked} calls. It may match future imports." (locked decision — allows save anyway)
4. If overlapInfo.hasOverlap: Non-blocking info box: "Heads up: Rule '{overlappingRules[0].ruleName}' also matches {overlappingRules[0].matchCount} of these calls and has higher priority. It will run first." (locked decision — informational only, does not block save)

Use motion/react AnimatePresence for the expand/collapse of the call list.

**Create `RoutingRuleSlideOver.tsx`:**

Fixed-position slide-over panel that floats over the rule list (locked decision: NOT panelStore pane).

Props: none — reads from routingRuleStore (isSlideOverOpen, activeRuleId, closeSlideOver)

Structure:
- Outer wrapper: AnimatePresence from `motion/react` (NOT framer-motion — established convention)
- When isSlideOverOpen:
  - Backdrop: fixed inset-0, bg-black opacity-0.3, z-40, onClick closes slide-over
  - Panel: fixed right-0 top-0 bottom-0, w-[480px] (mobile: w-full), bg-card, border-l, shadow-2xl, z-50
  - Spring transition: `{ type: 'spring', damping: 30, stiffness: 300 }` (matches app conventions)
  - Panel slides in from right (initial x: '100%', animate x: 0, exit x: '100%')

Panel content (inside a form):
1. Header: "Create Rule" or "Edit Rule" based on activeRuleId. Close button (RiCloseLine) top-right.
2. Rule name input: required, placeholder "e.g., Q1 Reviews, Acme Meetings" (locked decision: name required)
3. "Rules apply to new imports only" info text in a subtle muted banner (IMP-09 — must be explicit)
4. RoutingConditionBuilder — renders the condition rows with AND/OR toggle
5. Destination section: "Route matching calls to:" label + DestinationPicker
6. RulePreviewCount — live preview below destination, updates as conditions change
7. Footer: Cancel button (variant="hollow") and Save button (variant="default"). Save disabled if: no name, no conditions, no destination selected.

State management:
- If activeRuleId is null: create mode. Initialize empty form: name='', conditions=[{field:'title', operator:'contains', value:''}], logicOperator='AND', destination=null
- If activeRuleId is set: edit mode. Load existing rule data from useRoutingRules() query cache (find by ID). Populate form with existing values.
- On save (create): call useCreateRule().mutate(). On success, close slide-over, toast.success("Rule created").
- On save (edit): call useUpdateRule().mutate(). On success, close slide-over, toast.success("Rule updated").
- On cancel: close slide-over. If form has unsaved changes, no confirmation needed (keep simple).

First-rule suggestion (locked decision): When creating the first rule AND no rules exist yet, pre-populate the first condition with `field: 'source', operator: 'equals', value: 'fathom'` as a suggestion. User can change it. This is a suggestion, NOT a pre-created rule.
  </action>
  <verify>
`cd /Users/Naegele/dev/callvault && npx tsc --noEmit` — no type errors.
RoutingRuleSlideOver uses motion/react (NOT framer-motion).
RoutingRuleSlideOver reads from routingRuleStore.
RulePreviewCount shows match count, expandable list, zero-match warning, and overlap warning.
Save button properly calls useCreateRule or useUpdateRule based on mode.
  </verify>
  <done>RulePreviewCount shows live "X of last 20 calls" count with expandable call list, zero-match yellow warning, and overlap info. RoutingRuleSlideOver is a fixed-position panel (z-50, 480px, spring animation) with rule name input, condition builder, destination picker, preview, and save/cancel. Create and edit modes both work. "Rules apply to new imports only" message displayed.</done>
</task>

</tasks>

<verification>
- Condition builder supports all 6 types: title, participant, source, duration, tag, date
- AND/OR toggle switches logic for all conditions
- Max 5 conditions enforced (add button disabled)
- Preview evaluates client-side with no server round trips
- Preview updates in real-time as conditions change
- Zero-match warning shown but save is not blocked
- Overlap warning shown but save is not blocked
- Slide-over uses position:fixed (not panelStore)
- motion/react used for animations (not framer-motion)
- "Rules apply to new imports only" text visible in editor
</verification>

<success_criteria>
1. User can add up to 5 conditions using sentence-like builder with 6 field types (IMP-05)
2. Preview shows "This rule would match X of your last 20 calls" updating live (IMP-08)
3. "See matching calls" expander shows actual call titles
4. Zero-match warning appears in yellow when no calls match
5. Overlap warning appears when higher-priority rule matches same calls
6. Slide-over panel slides in from right over rule list with spring animation
7. "Rules apply to new imports only" explicitly stated in editor (IMP-09)
8. Save creates/updates rule and closes slide-over with toast
</success_criteria>

<output>
After completion, create `.planning/phases/18-import-routing-rules/18-03-SUMMARY.md`
</output>
