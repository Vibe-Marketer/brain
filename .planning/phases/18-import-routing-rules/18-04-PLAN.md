---
phase: 18-import-routing-rules
plan: 04
type: execute
wave: 4
depends_on: ["18-03"]
files_modified:
  - callvault/src/routes/_authenticated/import/index.tsx
  - callvault/src/components/import/RoutingRulesTab.tsx
  - callvault/src/components/import/RoutingTraceBadge.tsx
autonomous: false

must_haves:
  truths:
    - "Rules tab is accessible inside Import Hub as 'Sources | Rules' tabs (IMP-04)"
    - "Guided empty state appears when no rules exist with headline, description, and CTA"
    - "Default destination must be set before 'Create your first rule' button is enabled (IMP-07)"
    - "Routing trace badge 'Routed by: [Rule Name]' appears on routed call rows"
    - "Badge hover/click shows popover with rule name and timestamp"
    - "User can create a rule in under 2 minutes using the full flow"
    - "Drag-to-reorder persists after page refresh (IMP-06)"
  artifacts:
    - path: "callvault/src/routes/_authenticated/import/index.tsx"
      provides: "Import Hub with Sources and Rules tabs"
      min_lines: 100
    - path: "callvault/src/components/import/RoutingRulesTab.tsx"
      provides: "Rules tab content: default destination bar, rule list, empty state, slide-over"
      min_lines: 80
    - path: "callvault/src/components/import/RoutingTraceBadge.tsx"
      provides: "Routed by badge with popover for call list rows"
      min_lines: 30
  key_links:
    - from: "callvault/src/routes/_authenticated/import/index.tsx"
      to: "callvault/src/components/import/RoutingRulesTab.tsx"
      via: "Tab rendering — Sources tab shows source grid, Rules tab shows RoutingRulesTab"
      pattern: "RoutingRulesTab"
    - from: "callvault/src/components/import/RoutingRulesTab.tsx"
      to: "callvault/src/components/import/RoutingRulesList.tsx"
      via: "Renders rule list when rules exist"
      pattern: "RoutingRulesList"
    - from: "callvault/src/components/import/RoutingRulesTab.tsx"
      to: "callvault/src/components/import/RoutingRuleSlideOver.tsx"
      via: "Renders slide-over for create/edit"
      pattern: "RoutingRuleSlideOver"
    - from: "callvault/src/components/import/RoutingTraceBadge.tsx"
      to: "source_metadata.routed_by_rule_name"
      via: "Reads routing trace from recording source_metadata"
      pattern: "routed_by_rule_name"
---

<objective>
Integrate the routing rules UI into the Import Hub with tab navigation, create the guided empty state, add the routing trace badge to call rows, and perform human verification of the complete flow.

Purpose: This is the final integration plan that wires everything together into a usable feature. The user should be able to navigate to Import Hub, switch to the Rules tab, set a default destination, create rules, see them in the list, reorder, and verify that the routing trace badge appears on call rows. This plan also includes the human verification checkpoint.

Output: Import Hub with Sources/Rules tabs, RoutingRulesTab with empty state, RoutingTraceBadge for call rows, fully integrated feature ready for verification.
</objective>

<execution_context>
@/Users/Naegele/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Naegele/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-import-routing-rules/18-CONTEXT.md
@.planning/phases/18-import-routing-rules/18-RESEARCH.md
@.planning/phases/18-import-routing-rules/18-03-SUMMARY.md
@callvault/src/routes/_authenticated/import/index.tsx
@callvault/src/components/import/RoutingRulesList.tsx
@callvault/src/components/import/RoutingRuleSlideOver.tsx
@callvault/src/components/import/DefaultDestinationBar.tsx
@callvault/src/hooks/useRoutingRules.ts
@callvault/src/stores/routingRuleStore.ts
@callvault/src/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tab navigation to Import Hub and create Rules tab with empty state</name>
  <files>callvault/src/routes/_authenticated/import/index.tsx, callvault/src/components/import/RoutingRulesTab.tsx</files>
  <action>
**Modify `import/index.tsx`:**

Add tab navigation to the Import Hub page. The existing content becomes the "Sources" tab. Add a "Rules" tab.

Tab implementation:
- Use local state `activeTab: 'sources' | 'rules'` (default: 'sources')
- Tab bar: two inline buttons below the page heading. Active tab gets an underline (2px solid, brand color or foreground). Inactive tab gets muted text color.
- Tab labels: "Sources" and "Rules"
- When 'sources' is active: render the existing source grid, file upload dropzone, and failed imports section (move existing content into this branch)
- When 'rules' is active: render `<RoutingRulesTab />`
- Keep all existing imports and functionality for the Sources tab intact — do NOT break anything

**Create `RoutingRulesTab.tsx`:**

This component assembles the full rules management UI.

Uses:
- `useRoutingRules()` for the rule list
- `useRoutingDefault()` for default destination state
- `useReorderRules()` for drag reorder
- `useToggleRule()` for enable/disable
- `useDeleteRule()` for deletion (add a delete button inside the slide-over or rule card context menu — per Claude's discretion, add it inside the slide-over footer as a "Delete Rule" destructive button)
- `routingRuleStore` for slide-over open/close

Layout (top to bottom):
1. `<DefaultDestinationBar />` — always shown at top
2. If rules exist: `<RoutingRulesList />` with rules ordered by priority
3. Below rule list: "Create Rule" button (variant="default") to open slide-over in create mode. Disabled if no default destination set — show tooltip "Set a default destination above before creating rules" (IMP-07 gate)
4. If no rules exist: Guided empty state (locked decision):
   - Illustration: use RiRouteLine or RiGuideLine icon (large, 48px, muted-foreground/30 opacity)
   - Headline: "Route new calls automatically" (font-montserrat, font-extrabold, uppercase, tracking-wide)
   - Subtext: "Send calls from each source to the right workspace and folder as soon as they're imported. No more dragging recordings around." (text-sm, text-muted-foreground)
   - Primary CTA: "Create your first rule" button (variant="default"). Disabled if no default destination set — show message "Set a default destination above to get started"
   - Secondary: "Learn how routing works" text link (for now, this can be a no-op or show a simple tooltip/sheet — Claude's discretion on help sheet content)
5. `<RoutingRuleSlideOver />` — always rendered (visibility controlled by store)

Pass handlers to RoutingRulesList:
- `onReorder`: call reorderMutation.mutate(orderedIds)
- `onEdit`: call routingRuleStore.openSlideOver(ruleId)
- `onToggle`: call toggleMutation.mutate({ruleId, enabled})
  </action>
  <verify>
`cd /Users/Naegele/dev/callvault && npx tsc --noEmit` — no type errors.
Import Hub page has two functional tabs: Sources and Rules.
Sources tab renders exactly the same content as before (no regression).
Rules tab renders DefaultDestinationBar, empty state or rule list, and slide-over.
  </verify>
  <done>Import Hub has Sources | Rules tab navigation. Rules tab renders DefaultDestinationBar at top, RoutingRulesList when rules exist, guided empty state when no rules exist, and RoutingRuleSlideOver for create/edit. "Create your first rule" disabled without default destination.</done>
</task>

<task type="auto">
  <name>Task 2: Create routing trace badge for call list rows</name>
  <files>callvault/src/components/import/RoutingTraceBadge.tsx</files>
  <action>
**Create `RoutingTraceBadge.tsx`:**

A small badge component that displays "Routed by: [Rule Name]" on call rows that were auto-routed.

Props:
- `sourceMetadata: Record<string, unknown> | null` — the recording's source_metadata field

Logic:
- Extract `routed_by_rule_name` and `routed_at` from sourceMetadata
- If `routed_by_rule_name` is falsy, render nothing (return null)
- If present, render:

Badge (using shadcn Badge, variant="secondary"):
- Text: "Routed by: {ruleName}" in text-xs, text-muted-foreground
- Cursor: pointer
- Subtle gray styling per locked decision

Popover (using shadcn Popover + PopoverTrigger + PopoverContent):
- On hover or click, show popover with:
  - "Rule: {ruleName}" (bold)
  - "When: {formatted routed_at date}" (text-sm, text-muted-foreground)
- Popover width: w-64

NOTE: This component is created here but will need to be integrated into the call list row component. The call list row integration depends on how the call list is currently structured. For this task, create the component and add a brief comment at the top explaining where to integrate it:
```
// Integration: Add <RoutingTraceBadge sourceMetadata={recording.source_metadata} />
// to the call list row component, next to the call title.
```

The actual integration into the call list can be done here if the call list component is straightforward, or deferred as a quick follow-up. Check `callvault/src/routes/_authenticated/calls/` or the workspace calls component for the call list row.

If a clear integration point exists (a component rendering call rows with access to `source_metadata`), integrate the badge directly. If the call list is complex or spread across multiple files, create the component and leave the integration comment.
  </action>
  <verify>
`cd /Users/Naegele/dev/callvault && npx tsc --noEmit` — no type errors.
RoutingTraceBadge renders a Badge with Popover when sourceMetadata contains routed_by_rule_name.
RoutingTraceBadge renders null when no routing trace exists.
  </verify>
  <done>RoutingTraceBadge component created with subtle gray badge showing "Routed by: [Rule Name]" and popover with rule details. Component renders conditionally — only when source_metadata contains routing trace. Integration point documented or completed.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete routing rules flow</name>
  <files>n/a</files>
  <action>
Human verification checkpoint. Present the following verification steps to the user and pause for their approval.

What was built across Plans 01-04:
- DB schema with routing rules and defaults tables (deployed to production)
- Server-side routing engine integrated into connector pipeline
- Import Hub with Sources | Rules tabs
- Default destination bar with auto-save
- Drag-to-reorder rule card list
- Slide-over editor with sentence-like condition builder (6 types, AND/OR, up to 5 conditions)
- Live preview with match count and overlap warnings
- "Rules apply to new imports only" messaging
- Routing trace badge for call rows

Verification steps for the user:
1. Navigate to Import Hub (http://localhost:8080/import)
2. Verify two tabs appear: "Sources" and "Rules"
3. Click "Sources" tab — confirm existing source cards still render correctly (no regression)
4. Click "Rules" tab:
   a. Confirm empty state appears with "Route new calls automatically" headline
   b. Confirm "Create your first rule" button is disabled until default destination is set
5. Set default destination:
   a. Use the DefaultDestinationBar to select a workspace and optional folder
   b. Confirm toast "Default destination updated" appears
   c. Confirm "Create your first rule" button is now enabled
6. Create a rule:
   a. Click "Create your first rule" — slide-over opens from right
   b. Confirm "Rules apply to new imports only" message is visible
   c. Enter rule name "Test Rule"
   d. First condition should suggest Source = Fathom (pre-populated suggestion)
   e. Change condition to Title contains "review"
   f. Confirm live preview shows "This rule would match X of your last 20 calls"
   g. Click "See matching calls" to expand — verify call titles shown
   h. Add a second condition — AND/OR toggle should appear between conditions
   i. Select a destination workspace and folder
   j. Click Save — confirm toast "Rule created", slide-over closes
   k. Rule card appears in the list with name, condition summary, destination
7. Test drag-to-reorder:
   a. Create a second rule
   b. Drag the second rule above the first using the drag handle
   c. Refresh the page — confirm the new order persists
8. Test enable/disable toggle:
   a. Toggle a rule off — confirm it appears dimmed/muted
   b. Toggle back on — confirm it appears normal
9. Test routing trace badge (if integrated):
   a. Check a call that was recently imported — if routing was applied, a "Routed by: [Rule Name]" badge should appear
   b. Hover/click the badge — popover shows rule name and timestamp
  </action>
  <verify>User confirms all 9 verification steps pass, or describes specific issues to fix.</verify>
  <done>User types "approved" — Phase 18 complete. Or user describes issues — create gap closure tasks.</done>
</task>

</tasks>

<verification>
- Import Hub has functional Sources | Rules tabs with no regression on Sources tab
- Empty state shows correct heading, description, and disabled CTA
- Default destination gate prevents rule creation until destination is set
- Full create/edit/reorder/toggle flow works end-to-end
- Preview shows match count against last 20 calls
- "Rules apply to new imports only" is explicitly stated
- Routing trace badge appears on routed call rows (if calls have been routed)
- Page refresh preserves rule order
</verification>

<success_criteria>
1. Import Hub renders Sources | Rules tabs (locked decision: "Rules live inside Import Hub as a tab")
2. Guided empty state matches locked decision (headline, subtext, CTA, secondary link)
3. Default destination must be set before rules can be created (IMP-07)
4. User can create a routing rule in under 2 minutes (success criterion 1 from ROADMAP)
5. Live preview shows match count before save (IMP-08, success criterion 2)
6. Drag-to-reorder persists across refresh (IMP-06, success criterion 3)
7. Routing trace badge visible on routed calls
8. "Rules apply to new imports only" explicitly stated (IMP-09, success criterion 5)
</success_criteria>

<output>
After completion, create `.planning/phases/18-import-routing-rules/18-04-SUMMARY.md`
</output>
